# CONCAT OUTPUT
# Root: C:\Users\Francois\source\repos\LoGeCui
# Files: 102


================================================================================
FILE: LoGeCui\App.xaml
================================================================================

Ôªø<Application x:Class="LoGeCui.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    <Application.Resources>
         
    </Application.Resources>
</Application>

================================================================================
FILE: LoGeCui\App.xaml.cs
================================================================================

Ôªøusing System;
using System.Windows;
using LoGeCuiShared.Services;

namespace LoGeCui
{
    public partial class App : Application
    {
        // AJOUT√â : Instance unique de SupabaseService
        public static SupabaseService SupabaseService { get; private set; }
        public static SupabaseRestClient? RestClient { get; private set; }
        public static RecipesService? RecipesService { get; private set; }
        public static Guid? CurrentUserId { get; private set; }

        protected override void OnStartup(StartupEventArgs e)
        {
            base.OnStartup(e);

            // AJOUT√â : Initialiser le service Supabase UNE SEULE FOIS
            string url = ConfigurationHelper.GetSupabaseUrl();
            string key = ConfigurationHelper.GetSupabaseKey(); // Remplace par ta cl√© anon

            // Cr√©er l'instance UNE SEULE FOIS
            SupabaseService = new SupabaseService(url, key);

            // afficher login
            new LoginWindow().Show();

            // Ouvrir la fen√™tre de connexion en premier
            var loginWindow = new LoginWindow();
            loginWindow.Show();
        }

        public static void InitRestServices(string accessToken, Guid userId)
        {
            string url = ConfigurationHelper.GetSupabaseUrl();
            string key = ConfigurationHelper.GetSupabaseKey();

            var client = new SupabaseRestClient(url, key);
            client.SetBearerToken(accessToken);

            RestClient = client;
            RecipesService = new RecipesService(client);
            CurrentUserId = userId;
        }
    }
}

================================================================================
FILE: LoGeCui\appsettings.example.json
================================================================================

Ôªø{
  "Supabase": {
    "Url": "https://VOTRE_PROJECT_ID.supabase.co",
    "Key": "VOTRE_PUBLISHABLE_KEY"
  }
}

================================================================================
FILE: LoGeCui\appsettings.json
================================================================================

{
  "Supabase": {
    "Url": "https://wzctiypsadqktzcnswri.supabase.co",
    "Key": "sb_publishable_ZFk8ONON5qMA0vZ3V0nVAg_TZZrO1F1"
  }

}

================================================================================
FILE: LoGeCui\AssemblyInfo.cs
================================================================================

using System.Windows;

[assembly: ThemeInfo(
    ResourceDictionaryLocation.None,            //where theme specific resource dictionaries are located
                                                //(used if a resource is not found in the page,
                                                // or application resource dictionaries)
    ResourceDictionaryLocation.SourceAssembly   //where the generic resource dictionary is located
                                                //(used if a resource is not found in the page,
                                                // app, or any theme specific resource dictionaries)
)]

================================================================================
FILE: LoGeCui\ConfigurationHelper.cs
================================================================================

Ôªøusing Microsoft.Extensions.Configuration;
using System;
using System.IO;

namespace LoGeCui
{
    public static class ConfigurationHelper
    {
        private static IConfiguration? _configuration;

        public static IConfiguration Configuration
        {
            get
            {
                if (_configuration == null)
                {
                    var builder = new ConfigurationBuilder()
                        .SetBasePath(AppDomain.CurrentDomain.BaseDirectory)
                        .AddJsonFile("appsettings.json", optional: false, reloadOnChange: true);

                    _configuration = builder.Build();
                }
                return _configuration;
            }
        }

        public static string GetSupabaseUrl()
        {
            return Configuration["Supabase:Url"] ?? throw new Exception("Supabase URL non configur√©e");
        }

        public static string GetSupabaseKey()
        {
            return Configuration["Supabase:Key"] ?? throw new Exception("Supabase Key non configur√©e");
        }
    }
}

================================================================================
FILE: LoGeCui\Dialogs\AjouterArticleCourseDialog.xaml
================================================================================

Ôªø<Window x:Class="LoGeCui.Dialogs.AjouterArticleCourseDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Ajouter un article" 
        Height="400" 
        Width="400"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize"
        Background="#ECF0F1">

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0"
                   Text="üõí Ajouter √† la liste de courses"
                   FontSize="18"
                   FontWeight="Bold"
                   Foreground="#2C3E50"
                   Margin="0,0,0,15"/>

        <StackPanel Grid.Row="1" Margin="0,0,0,10">
            <TextBlock Text="Nom *"
                       FontSize="13"
                       FontWeight="SemiBold"
                       Margin="0,0,0,5"/>
            <TextBox x:Name="TxtNom"
                     Height="30"
                     FontSize="13"
                     Padding="5"/>
        </StackPanel>

        <StackPanel Grid.Row="2" Margin="0,0,0,10">
            <TextBlock Text="Quantit√© *"
                       FontSize="13"
                       FontWeight="SemiBold"
                       Margin="0,0,0,5"/>
            <TextBox x:Name="TxtQuantite"
                     Height="30"
                     FontSize="13"
                     Padding="5"/>
        </StackPanel>

        <StackPanel Grid.Row="3" Margin="0,0,0,10">
            <TextBlock Text="Unit√© *"
                       FontSize="13"
                       FontWeight="SemiBold"
                       Margin="0,0,0,5"/>
            <ComboBox x:Name="CmbUnite"
                      Height="30"
                      FontSize="13"
                      Padding="5">
                <ComboBoxItem Content="g"/>
                <ComboBoxItem Content="kg"/>
                <ComboBoxItem Content="ml"/>
                <ComboBoxItem Content="L"/>
                <ComboBoxItem Content="pi√®ces" IsSelected="True"/>
                <ComboBoxItem Content="bo√Ætes"/>
                <ComboBoxItem Content="sachets"/>
            </ComboBox>
        </StackPanel>

        <StackPanel Grid.Row="5"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    Margin="0,10,0,0">

            <Button Content="Annuler"
                    Width="100"
                    Height="35"
                    Margin="0,0,10,0"
                    Background="#95A5A6"
                    Foreground="White"
                    FontSize="13"
                    BorderThickness="0"
                    Click="BtnAnnuler_Click"/>

            <Button Content="Ajouter"
                    Width="100"
                    Height="35"
                    Background="#27AE60"
                    Foreground="White"
                    FontSize="13"
                    BorderThickness="0"
                    Click="BtnAjouter_Click"/>

        </StackPanel>

    </Grid>

</Window>

================================================================================
FILE: LoGeCui\Dialogs\AjouterArticleCourseDialog.xaml.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Shapes;
using LoGeCuiShared.Models;

namespace LoGeCui.Dialogs
{
    public partial class AjouterArticleCourseDialog : Window
    {
        public ArticleCourse? NouvelArticle { get; private set; }

        public AjouterArticleCourseDialog()
        {
            InitializeComponent();
            TxtNom.Focus();
        }

        private void BtnAjouter_Click(object sender, RoutedEventArgs e)
        {
            if (string.IsNullOrWhiteSpace(TxtNom.Text))
            {
                MessageBox.Show("Veuillez entrer un nom.", "Champ requis", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            if (string.IsNullOrWhiteSpace(TxtQuantite.Text))
            {
                MessageBox.Show("Veuillez entrer une quantit√©.", "Champ requis", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            NouvelArticle = new ArticleCourse
            {
                Nom = TxtNom.Text.Trim(),
                Quantite = TxtQuantite.Text.Trim(),
                Unite = (CmbUnite.SelectedItem as System.Windows.Controls.ComboBoxItem)?.Content.ToString() ?? "pi√®ces",
                EstAchete = false
            };

            DialogResult = true;
            Close();
        }

        private void BtnAnnuler_Click(object sender, RoutedEventArgs e)
        {
            DialogResult = false;
            Close();
        }
    }
}

================================================================================
FILE: LoGeCui\Dialogs\AjouterIngredientDialog.xaml
================================================================================

Ôªø<Window x:Class="LoGeCui.Dialogs.AjouterIngredientDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Ajouter un ingr√©dient" 
        Height="700" 
        Width="450"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize"
        Background="#ECF0F1">
    
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Titre -->
        <TextBlock Grid.Row="0"
                   Text="‚ûï Nouvel ingr√©dient"
                   FontSize="22"
                   FontWeight="Bold"
                   Foreground="#2C3E50"
                   Margin="0,0,0,20"/>
        
        <!-- Nom -->
        <StackPanel Grid.Row="1" Margin="0,0,0,15">
            <TextBlock Text="Nom de l'ingr√©dient *"
                       FontSize="14"
                       FontWeight="SemiBold"
                       Foreground="#34495E"
                       Margin="0,0,0,5"/>
            <TextBox x:Name="TxtNom"
                     Height="35"
                     FontSize="14"
                     Padding="8"
                     BorderBrush="#BDC3C7"
                     BorderThickness="1"/>
        </StackPanel>
        
        <!-- Quantit√© -->
        <StackPanel Grid.Row="2" Margin="0,0,0,15">
            <TextBlock Text="Quantit√© *"
                       FontSize="14"
                       FontWeight="SemiBold"
                       Foreground="#34495E"
                       Margin="0,0,0,5"/>
            <TextBox x:Name="TxtQuantite"
                     Height="35"
                     FontSize="14"
                     Padding="8"
                     BorderBrush="#BDC3C7"
                     BorderThickness="1"/>
        </StackPanel>
        
        <!-- Unit√© -->
        <StackPanel Grid.Row="3" Margin="0,0,0,15">
            <TextBlock Text="Unit√© *"
                       FontSize="14"
                       FontWeight="SemiBold"
                       Foreground="#34495E"
                       Margin="0,0,0,5"/>
            <ComboBox x:Name="CmbUnite"
                      Height="35"
                      FontSize="14"
                      Padding="8,5"
                      BorderBrush="#BDC3C7"
                      BorderThickness="1">
                <ComboBoxItem Content="kg" IsSelected="True"/>
                <ComboBoxItem Content="g"/>
                <ComboBoxItem Content="L"/>
                <ComboBoxItem Content="ml"/>
                <ComboBoxItem Content="pi√®ces"/>
                <ComboBoxItem Content="sachets"/>
                <ComboBoxItem Content="bo√Ætes"/>
            </ComboBox>
        </StackPanel>
        
        <!-- Boutons -->
        <StackPanel Grid.Row="5"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right">
            
            <Button Content="‚ùå Annuler"
                    Width="120"
                    Height="40"
                    Margin="0,0,10,0"
                    Background="#95A5A6"
                    Foreground="White"
                    FontSize="14"
                    FontWeight="Bold"
                    BorderThickness="0"
                    Cursor="Hand"
                    Click="BtnAnnuler_Click">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#95A5A6"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#7F8C8D"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>
            
            <Button Content="‚úÖ Ajouter"
                    Width="120"
                    Height="40"
                    Background="#27AE60"
                    Foreground="White"
                    FontSize="14"
                    FontWeight="Bold"
                    BorderThickness="0"
                    Cursor="Hand"
                    Click="BtnAjouter_Click">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#27AE60"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#229954"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>
            
        </StackPanel>
        
    </Grid>
    
</Window>

================================================================================
FILE: LoGeCui\Dialogs\AjouterIngredientDialog.xaml.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Shapes;
using LoGeCuiShared.Models;

namespace LoGeCui.Dialogs
{
    public partial class AjouterIngredientDialog : Window
    {
        // Propri√©t√© pour r√©cup√©rer l'ingr√©dient cr√©√©
        public Ingredient? NouvelIngredient { get; private set; }

        public AjouterIngredientDialog()
        {
            InitializeComponent();

            // Focus sur le premier champ
            TxtNom.Focus();
        }

        private void BtnAjouter_Click(object sender, RoutedEventArgs e)
        {
            // Validation : v√©rifier que tous les champs sont remplis
            if (string.IsNullOrWhiteSpace(TxtNom.Text))
            {
                MessageBox.Show("Veuillez entrer un nom d'ingr√©dient.",
                    "Champ requis",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
                TxtNom.Focus();
                return;
            }

            if (string.IsNullOrWhiteSpace(TxtQuantite.Text))
            {
                MessageBox.Show("Veuillez entrer une quantit√©.",
                    "Champ requis",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
                TxtQuantite.Focus();
                return;
            }

            // Cr√©er l'ingr√©dient
            NouvelIngredient = new Ingredient
            {
                Nom = TxtNom.Text.Trim(),
                Quantite = TxtQuantite.Text.Trim(),
                Unite = (CmbUnite.SelectedItem as ComboBoxItem)?.Content.ToString() ?? "pi√®ces",
                EstDisponible = true
            };

            // Fermer la fen√™tre avec succ√®s
            DialogResult = true;
            Close();
        }

        private void BtnAnnuler_Click(object sender, RoutedEventArgs e)
        {
            // Fermer sans rien faire
            DialogResult = false;
            Close();
        }
    }
}

================================================================================
FILE: LoGeCui\Dialogs\AjouterIngredientRecetteDialog.xaml
================================================================================

Ôªø<Window x:Class="LoGeCui.Dialogs.AjouterIngredientRecetteDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Ajouter un ingr√©dient" 
        Height="400" 
        Width="400"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize"
        Background="#ECF0F1">

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Titre -->
        <TextBlock Grid.Row="0"
                   Text="ü•ò Ajouter un ingr√©dient"
                   FontSize="18"
                   FontWeight="Bold"
                   Foreground="#2C3E50"
                   Margin="0,0,0,15"/>

        <!-- Nom -->
        <StackPanel Grid.Row="1" Margin="0,0,0,10">
            <TextBlock Text="Nom *"
                       FontSize="13"
                       FontWeight="SemiBold"
                       Margin="0,0,0,5"/>
            <TextBox x:Name="TxtNom"
                     Height="30"
                     FontSize="13"
                     Padding="5"/>
        </StackPanel>

        <!-- Quantit√© -->
        <StackPanel Grid.Row="2" Margin="0,0,0,10">
            <TextBlock Text="Quantit√© *"
                       FontSize="13"
                       FontWeight="SemiBold"
                       Margin="0,0,0,5"/>
            <TextBox x:Name="TxtQuantite"
                     Height="30"
                     FontSize="13"
                     Padding="5"/>
        </StackPanel>

        <!-- Unit√© -->
        <StackPanel Grid.Row="3" Margin="0,0,0,10">
            <TextBlock Text="Unit√© *"
                       FontSize="13"
                       FontWeight="SemiBold"
                       Margin="0,0,0,5"/>
            <ComboBox x:Name="CmbUnite"
                      Height="30"
                      FontSize="13"
                      Padding="5">
                <ComboBoxItem Content="g"/>
                <ComboBoxItem Content="kg"/>
                <ComboBoxItem Content="ml"/>
                <ComboBoxItem Content="L"/>
                <ComboBoxItem Content="pi√®ces" IsSelected="True"/>
                <ComboBoxItem Content="cuill√®res √† soupe"/>
                <ComboBoxItem Content="cuill√®res √† caf√©"/>
            </ComboBox>
        </StackPanel>

        <!-- Boutons -->
        <StackPanel Grid.Row="5"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    Margin="0,10,0,0">

            <Button Content="Annuler"
                    Width="100"
                    Height="35"
                    Margin="0,0,10,0"
                    Background="#95A5A6"
                    Foreground="White"
                    FontSize="13"
                    BorderThickness="0"
                    Click="BtnAnnuler_Click"/>

            <Button Content="Ajouter"
                    Width="100"
                    Height="35"
                    Background="#27AE60"
                    Foreground="White"
                    FontSize="13"
                    BorderThickness="0"
                    Click="BtnAjouter_Click"/>

        </StackPanel>

    </Grid>

</Window>

================================================================================
FILE: LoGeCui\Dialogs\AjouterIngredientRecetteDialog.xaml.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Shapes;
using LoGeCuiShared.Models;

namespace LoGeCui.Dialogs
{
    /// <summary>
    /// Logique d'interaction pour AjouterIngredientRecetteDialog.xaml
    /// </summary>
    public partial class AjouterIngredientRecetteDialog : Window
    {
        public IngredientRecette? NouvelIngredient { get; private set; }  // ‚Üê LIGNE AJOUT√âE !

        public AjouterIngredientRecetteDialog()
        {
            InitializeComponent();
            TxtNom.Focus();
        }

        private void BtnAjouter_Click(object sender, RoutedEventArgs e)
        {
            if (string.IsNullOrWhiteSpace(TxtNom.Text))
            {
                MessageBox.Show("Veuillez entrer un nom.", "Champ requis", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            if (string.IsNullOrWhiteSpace(TxtQuantite.Text))
            {
                MessageBox.Show("Veuillez entrer une quantit√©.", "Champ requis", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            NouvelIngredient = new IngredientRecette  // ‚Üê CHANG√â aussi ici !
            {
                Nom = TxtNom.Text.Trim(),
                Quantite = TxtQuantite.Text.Trim(),
                Unite = (CmbUnite.SelectedItem as System.Windows.Controls.ComboBoxItem)?.Content.ToString() ?? "pi√®ces"
            };

            DialogResult = true;
            Close();
        }

        private void BtnAnnuler_Click(object sender, RoutedEventArgs e)
        {
            DialogResult = false;
            Close();
        }
    }
}

================================================================================
FILE: LoGeCui\Dialogs\AjouterRecetteDialog.xaml
================================================================================

Ôªø<Window x:Class="LoGeCui.Dialogs.AjouterRecetteDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Ajouter une recette" 
        Height="700" 
        Width="600"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize"
        Background="#ECF0F1">

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <Grid Margin="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Titre -->
            <TextBlock Grid.Row="0"
                       Text="‚ûï Nouvelle recette"
                       FontSize="22"
                       FontWeight="Bold"
                       Foreground="#2C3E50"
                       Margin="0,0,0,20"/>

            <!-- Nom -->
            <StackPanel Grid.Row="1" Margin="0,0,0,15">
                <TextBlock Text="Nom de la recette *"
                           FontSize="14"
                           FontWeight="SemiBold"
                           Foreground="#34495E"
                           Margin="0,0,0,5"/>
                <TextBox x:Name="TxtNom"
                         Height="35"
                         FontSize="14"
                         Padding="8"
                         BorderBrush="#BDC3C7"
                         BorderThickness="1"/>
            </StackPanel>

            <!-- Type et Temps sur la m√™me ligne -->
            <Grid Grid.Row="2" Margin="0,0,0,15">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="10"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Type -->
                <StackPanel Grid.Column="0">
                    <TextBlock Text="Type *"
                               FontSize="14"
                               FontWeight="SemiBold"
                               Foreground="#34495E"
                               Margin="0,0,0,5"/>
                    <ComboBox x:Name="CmbType"
                              Height="35"
                              FontSize="14"
                              Padding="8,5"
                              BorderBrush="#BDC3C7"
                              BorderThickness="1">
                        <ComboBoxItem Content="Entr√©e" Tag="Entree"/>
                        <ComboBoxItem Content="Plat" Tag="Plat" IsSelected="True"/>
                        <ComboBoxItem Content="Dessert" Tag="Dessert"/>
                    </ComboBox>
                </StackPanel>

                <!-- Temps -->
                <StackPanel Grid.Column="2">
                    <TextBlock Text="Temps (minutes) *"
                               FontSize="14"
                               FontWeight="SemiBold"
                               Foreground="#34495E"
                               Margin="0,0,0,5"/>
                    <TextBox x:Name="TxtTemps"
                             Height="35"
                             FontSize="14"
                             Padding="8"
                             BorderBrush="#BDC3C7"
                             BorderThickness="1"/>
                </StackPanel>
            </Grid>

            <!-- Difficult√© -->
            <StackPanel Grid.Row="3" Margin="0,0,0,15">
                <TextBlock Text="Difficult√© *"
                           FontSize="14"
                           FontWeight="SemiBold"
                           Foreground="#34495E"
                           Margin="0,0,0,5"/>
                <StackPanel Orientation="Horizontal">
                    <Slider x:Name="SliderDifficulte"
                            Width="400"
                            Minimum="1"
                            Maximum="5"
                            Value="3"
                            TickFrequency="1"
                            IsSnapToTickEnabled="True"
                            VerticalAlignment="Center"
                            ValueChanged="SliderDifficulte_ValueChanged"/>
                    <TextBlock x:Name="TxtDifficulte"
                               Text="‚≠ê‚≠ê‚≠ê"
                               FontSize="18"
                               Margin="10,0,0,0"
                               VerticalAlignment="Center"/>
                </StackPanel>
            </StackPanel>

            <!-- Ingr√©dients -->
            <StackPanel Grid.Row="4" Margin="0,0,0,15">
                <TextBlock Text="Ingr√©dients *"
                           FontSize="14"
                           FontWeight="SemiBold"
                           Foreground="#34495E"
                           Margin="0,0,0,5"/>

                <!-- Liste des ingr√©dients ajout√©s -->
                <Border BorderBrush="#BDC3C7"
                        BorderThickness="1"
                        CornerRadius="3"
                        Background="White"
                        MinHeight="100"
                        MaxHeight="150"
                        Margin="0,0,0,10">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ListBox x:Name="ListeIngredients"
                                 BorderThickness="0"
                                 Background="Transparent">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="5">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <TextBlock Grid.Column="0"
                                                   Text="{Binding}"
                                                   VerticalAlignment="Center"/>

                                        <Button Grid.Column="1"
                                                Content="‚ùå"
                                                Width="25"
                                                Height="25"
                                                FontSize="10"
                                                Background="#E74C3C"
                                                Foreground="White"
                                                BorderThickness="0"
                                                Cursor="Hand"
                                                Click="BtnSupprimerIngredient_Click"
                                                Tag="{Binding}"/>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </ScrollViewer>
                </Border>

                <Button Content="‚ûï Ajouter un ingr√©dient"
                        Height="35"
                        Background="#27AE60"
                        Foreground="White"
                        FontSize="13"
                        FontWeight="Bold"
                        BorderThickness="0"
                        Cursor="Hand"
                        Click="BtnAjouterIngredient_Click"/>
            </StackPanel>

            <!-- Instructions -->
            <StackPanel Grid.Row="5" Margin="0,0,0,15">
                <TextBlock Text="Instructions *"
                           FontSize="14"
                           FontWeight="SemiBold"
                           Foreground="#34495E"
                           Margin="0,0,0,5"/>
                <TextBox x:Name="TxtInstructions"
                         Height="100"
                         FontSize="14"
                         Padding="8"
                         BorderBrush="#BDC3C7"
                         BorderThickness="1"
                         TextWrapping="Wrap"
                         AcceptsReturn="True"
                         VerticalScrollBarVisibility="Auto"/>
            </StackPanel>

            <!-- Boutons -->
            <StackPanel Grid.Row="8"
                        Orientation="Horizontal"
                        HorizontalAlignment="Right"
                        Margin="0,20,0,0">

                <Button Content="‚ùå Annuler"
                        Width="120"
                        Height="40"
                        Margin="0,0,10,0"
                        Background="#95A5A6"
                        Foreground="White"
                        FontSize="14"
                        FontWeight="Bold"
                        BorderThickness="0"
                        Cursor="Hand"
                        Click="BtnAnnuler_Click"/>

                <Button Content="‚úÖ Ajouter"
                        Width="120"
                        Height="40"
                        Background="#27AE60"
                        Foreground="White"
                        FontSize="14"
                        FontWeight="Bold"
                        BorderThickness="0"
                        Cursor="Hand"
                        Click="BtnAjouter_Click"/>

            </StackPanel>

        </Grid>
    </ScrollViewer>

</Window>

================================================================================
FILE: LoGeCui\Dialogs\AjouterRecetteDialog.xaml.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Shapes;
using System.Collections.ObjectModel;
using LoGeCuiShared.Models;


namespace LoGeCui.Dialogs
{
    /// <summary>
    /// Logique d'interaction pour AjouterRecetteDialog.xaml
    /// </summary>
    public partial class AjouterRecetteDialog : Window
    {

        public Recette? NouvelleRecette { get; private set; }
        private ObservableCollection<IngredientRecette> _ingredients;

        public AjouterRecetteDialog()
        {
            InitializeComponent();

            _ingredients = new ObservableCollection<IngredientRecette>();
            ListeIngredients.ItemsSource = _ingredients;

            TxtNom.Focus();
        }

        private void SliderDifficulte_ValueChanged(object sender, RoutedPropertyChangedEventArgs<double> e)
        {
            if (TxtDifficulte != null)
            {
                int valeur = (int)SliderDifficulte.Value;
                TxtDifficulte.Text = new string('‚≠ê', valeur);
            }
        }

        private void BtnAjouterIngredient_Click(object sender, RoutedEventArgs e)
        {
            // Cr√©er une petite fen√™tre pour ajouter un ingr√©dient
            var dialogIngredient = new AjouterIngredientRecetteDialog();
            dialogIngredient.Owner = this;

            bool? resultat = dialogIngredient.ShowDialog();

            if (resultat == true && dialogIngredient.NouvelIngredient != null)
            {
                _ingredients.Add(dialogIngredient.NouvelIngredient);
            }
        }

        private void BtnSupprimerIngredient_Click(object sender, RoutedEventArgs e)
        {
            var bouton = sender as System.Windows.Controls.Button;
            var ingredient = bouton?.Tag as IngredientRecette;

            if (ingredient != null)
            {
                _ingredients.Remove(ingredient);
            }
        }

        private void BtnAjouter_Click(object sender, RoutedEventArgs e)
        {
            // Validation
            if (string.IsNullOrWhiteSpace(TxtNom.Text))
            {
                MessageBox.Show("Veuillez entrer un nom de recette.",
                    "Champ requis",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
                TxtNom.Focus();
                return;
            }

            if (!int.TryParse(TxtTemps.Text, out int temps) || temps <= 0)
            {
                MessageBox.Show("Veuillez entrer un temps de pr√©paration valide.",
                    "Champ requis",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
                TxtTemps.Focus();
                return;
            }

            if (_ingredients.Count == 0)
            {
                MessageBox.Show("Veuillez ajouter au moins un ingr√©dient.",
                    "Ingr√©dients requis",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
                return;
            }

            if (string.IsNullOrWhiteSpace(TxtInstructions.Text))
            {
                MessageBox.Show("Veuillez entrer les instructions.",
                    "Champ requis",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
                TxtInstructions.Focus();
                return;
            }

            // R√©cup√©rer le type
            var selectedItem = CmbType.SelectedItem as System.Windows.Controls.ComboBoxItem;
            var typeTag = selectedItem?.Tag?.ToString() ?? "Plat";

            TypePlat type = typeTag switch
            {
                "Entree" => TypePlat.Entree,
                "Dessert" => TypePlat.Dessert,
                _ => TypePlat.Plat
            };

            // Cr√©er la recette
            NouvelleRecette = new Recette
            {
                Nom = TxtNom.Text.Trim(),
                Type = type,
                TempsPreparation = temps,
                Difficulte = (int)SliderDifficulte.Value,
                Ingredients = new System.Collections.Generic.List<IngredientRecette>(_ingredients),
                Instructions = TxtInstructions.Text.Trim()
            };

            DialogResult = true;
            Close();
        }

        private void BtnAnnuler_Click(object sender, RoutedEventArgs e)
        {
            DialogResult = false;
            Close();
        }
    }
}

================================================================================
FILE: LoGeCui\LoGeCui.csproj
================================================================================

Ôªø<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net10.0-windows</TargetFramework>
	  <SelfContained>true</SelfContained>
	  <PublishSingleFile>true</PublishSingleFile>
	  <IncludeNativeLibrariesForSelfExtract>true</IncludeNativeLibrariesForSelfExtract>
	  <IncludeAllContentForSelfExtract>true</IncludeAllContentForSelfExtract>
	  <RuntimeIdentifier>win-x64</RuntimeIdentifier>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <UseWPF>true</UseWPF>
    <Version>1.1.5</Version>
	  <ApplicationIcon>postriticone.ico</ApplicationIcon>
  </PropertyGroup>

	<ItemGroup>
		<EmbeddedResource Include="appsettings.json" />
	</ItemGroup>

  <ItemGroup>
    <None Remove="appsettings.json" />
    <None Remove="postriticone.ico" />
  </ItemGroup>

  <ItemGroup>
    <Content Include="appsettings.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </Content>
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.Extensions.Configuration.Json" Version="10.0.2" />
    <PackageReference Include="Supabase.Postgrest" Version="4.1.0" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\LoGeCuiShared\LoGeCuiShared.csproj" />
  </ItemGroup>

  <ItemGroup>
    <Resource Include="postriticone.ico">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </Resource>
  </ItemGroup>

</Project>

================================================================================
FILE: LoGeCui\LoginWindow.xaml
================================================================================

Ôªø<Window x:Class="LoGeCui.LoginWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="LoGeCui - Connexion"
        Height="600" Width="500"
        WindowStartupLocation="CenterScreen"
        ResizeMode="NoResize">
    <Grid Background="#F5F5F5">
        <Border Background="White"
                CornerRadius="10"
                Padding="40"
                Margin="40">
            <StackPanel>
                <!-- Logo / Titre -->
                <TextBlock Text="üõí LoGeCui"
                          FontSize="48"
                          FontWeight="Bold"
                          HorizontalAlignment="Center"
                          Foreground="#27AE60"
                          Margin="0,0,0,40"/>

                <!-- Email -->
                <TextBlock Text="Email :" FontWeight="SemiBold" Margin="0,0,0,5"/>
                <TextBox x:Name="TxtEmail"
                        Padding="10"
                        FontSize="14"
                        Margin="0,0,0,15"/>

                <!-- Mot de passe -->
                <TextBlock Text="Mot de passe :" FontWeight="SemiBold" Margin="0,0,0,5"/>
                <PasswordBox x:Name="TxtPassword"
                            Padding="10"
                            FontSize="14"
                            Margin="0,0,0,20"/>

                <!-- Boutons -->
                <Button x:Name="BtnConnexion"
                       Content="Se connecter"
                       Background="#27AE60"
                       Foreground="White"
                       Padding="15"
                       FontSize="16"
                       FontWeight="SemiBold"
                       BorderThickness="0"
                       Cursor="Hand"
                       Margin="0,0,0,10"
                       Click="BtnConnexion_Click"/>

                <Button x:Name="BtnInscription"
                       Content="Cr√©er un compte"
                       Background="#3498DB"
                       Foreground="White"
                       Padding="15"
                       FontSize="16"
                       FontWeight="SemiBold"
                       BorderThickness="0"
                       Cursor="Hand"
                       Click="BtnInscription_Click"/>

                <!-- Message -->
                <TextBlock x:Name="TxtMessage"
                          Foreground="Red"
                          TextWrapping="Wrap"
                          HorizontalAlignment="Center"
                          Margin="0,15,0,0"
                          FontSize="12"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>

================================================================================
FILE: LoGeCui\LoginWindow.xaml.cs
================================================================================

Ôªøusing System;
using System.Threading.Tasks;
using System.Windows;
using LoGeCuiShared.Services;

namespace LoGeCui
{
    public partial class LoginWindow : Window
    {
        public LoginWindow()
        {
            InitializeComponent();
        }

        private async void BtnConnexion_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                SetStatus("Connexion en cours...", isError: false);

                string email = TxtEmail.Text.Trim();
                string password = TxtPassword.Password;

                if (string.IsNullOrWhiteSpace(email) || string.IsNullOrWhiteSpace(password))
                {
                    SetStatus("Veuillez remplir tous les champs.", isError: true);
                    return;
                }

                var (success, accessToken, userIdString, error) = await App.SupabaseService.SignInAsync(email, password);


                if (!success)
                {
                    SetStatus(error ?? "Erreur de connexion", isError: true);
                    return;
                }
                if (!Guid.TryParse(userIdString, out var userId))
                {
                    SetStatus("ID utilisateur invalide.", isError: true);
                    return;
                }

                App.InitRestServices(accessToken, userId);


                // ‚¨áÔ∏è ICI : import des recettes locales vers Supabase (une seule fois)
                await ImporterRecettesLocalVersSupabaseSiBesoinAsync(userId);

                // V√©rifier les mises √† jour (optionnel)
                await CheckForUpdatesAsync();

                // Ouvrir l'app
                var mainWindow = new MainWindow();
                mainWindow.Show();
                Close();
            }
            catch (Exception ex)
            {
                SetStatus($"Erreur : {ex.Message}", isError: true);
            }
        }

        private async void BtnInscription_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                SetStatus("Inscription en cours...", isError: false);

                string email = TxtEmail.Text.Trim();
                string password = TxtPassword.Password;

                if (string.IsNullOrWhiteSpace(email) || string.IsNullOrWhiteSpace(password))
                {
                    SetStatus("Veuillez remplir tous les champs.", isError: true);
                    return;
                }

                if (password.Length < 6)
                {
                    SetStatus("Le mot de passe doit contenir au moins 6 caract√®res.", isError: true);
                    return;
                }

                var (success, userId, error) = await App.SupabaseService.SignUpAsync(email, password);

                if (success)
                {
                    MessageBox.Show(
                        "Compte cr√©√© avec succ√®s !\n\nVous pouvez maintenant vous connecter.",
                        "Inscription r√©ussie",
                        MessageBoxButton.OK,
                        MessageBoxImage.Information);

                    TxtPassword.Password = "";
                    SetStatus("Compte cr√©√© ! Connectez-vous.", isError: false);
                }
                else
                {
                    SetStatus(error ?? "Erreur lors de l'inscription", isError: true);
                }
            }
            catch (Exception ex)
            {
                SetStatus($"Erreur : {ex.Message}", isError: true);
            }
        }

        private void SetStatus(string message, bool isError)
        {
            TxtMessage.Text = message;
            TxtMessage.Foreground = isError
                ? System.Windows.Media.Brushes.Red
                : System.Windows.Media.Brushes.Blue;
        }

        private async Task CheckForUpdatesAsync()
        {
            try
            {
                string url = ConfigurationHelper.GetSupabaseUrl();
                string key = ConfigurationHelper.GetSupabaseKey();

                var updateService = new LoGeCuiShared.Services.UpdateService(url, key);
                var updateInfo = await updateService.CheckForUpdateAsync("wpf", "1.0.0");

                if (updateInfo != null)
                {
                    var result = MessageBox.Show(
                        $"Une nouvelle version {updateInfo.Version} est disponible !\n\n" +
                        $"Notes de version :\n{updateInfo.ReleaseNotes}\n\n" +
                        $"Voulez-vous t√©l√©charger la mise √† jour ?",
                        "Mise √† jour disponible",
                        MessageBoxButton.YesNo,
                        MessageBoxImage.Information);

                    if (result == MessageBoxResult.Yes)
                    {
                        System.Diagnostics.Process.Start(new System.Diagnostics.ProcessStartInfo
                        {
                            FileName = updateInfo.DownloadUrl,
                            UseShellExecute = true
                        });
                    }
                }
            }
            catch
            {
                // Erreur silencieuse
            }
        }

        private async Task ImporterRecettesLocalVersSupabaseSiBesoinAsync(Guid userId)
        {
            try
            {
                // üìÅ M√™me chemin que ton ancien RecetteService (JSON)
                string dossier = System.IO.Path.Combine(
                    Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
                    "LoGeCui"
                );

                string cheminJson = System.IO.Path.Combine(dossier, "recettes.json");

                // ‚ùå Pas de fichier ‚Üí rien √† importer
                if (!System.IO.File.Exists(cheminJson))
                    return;

                // üè∑Ô∏è Fichier "flag" pour √©viter de r√©importer √† chaque login
                string flagPath = System.IO.Path.Combine(dossier, "recettes_import_done.txt");
                if (System.IO.File.Exists(flagPath))
                    return;

                // üìñ Lecture du JSON
                var json = await System.IO.File.ReadAllTextAsync(cheminJson);

                var options = new System.Text.Json.JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                };

                var recettes = System.Text.Json.JsonSerializer
                    .Deserialize<List<LoGeCuiShared.Models.Recette>>(json, options)
                    ?? new List<LoGeCuiShared.Models.Recette>();

                if (recettes.Count == 0)
                {
                    // Rien √† importer mais on marque comme fait
                    await System.IO.File.WriteAllTextAsync(flagPath, "empty");
                    return;
                }

                // üîå Service Supabase d√©j√† initialis√© dans App.InitRestServices
                var recipesService = App.RecipesService;
                if (recipesService == null)
                    return;

                // üöÄ Import / upsert
                foreach (var r in recettes)
                {
                    // ExternalId obligatoire pour l'upsert
                    if (string.IsNullOrWhiteSpace(r.ExternalId))
                        r.ExternalId = Guid.NewGuid().ToString("N");

                    // Nettoyage cat√©gorie (important pour mobile)
                    if (!string.IsNullOrWhiteSpace(r.CategorieDb))
                        r.CategorieDb = r.CategorieDb.Trim();

                    await recipesService.UpsertRecetteAsync(userId, r);
                }

                // ‚úÖ Marqueur "import termin√©"
                await System.IO.File.WriteAllTextAsync(
                    flagPath,
                    $"done:{DateTime.UtcNow:O}"
                );
            }
            catch (Exception ex)
            {
                // ‚ö†Ô∏è Import non bloquant : on log mais on n'emp√™che pas le login
                System.Diagnostics.Debug.WriteLine("[ImportRecettes] " + ex);
            }
        }
    }
}


================================================================================
FILE: LoGeCui\MainWindow.xaml
================================================================================

Ôªø<Window x:Class="LoGeCui.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:LoGeCui"
        xmlns:views="clr-namespace:LoGeCui.Views"
        mc:Ignorable="d"
        Title="LoGeCui" Height="900" Width="1200"
        WindowStartupLocation="CenterScreen"
        Background="#ECF0F1">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="80"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="250"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        
        <!-- En T√™te (sur toute la largeur -->
        <Border Grid.Row="0"
                Grid.ColumnSpan="2"
                Background="#2C3E50">
            <StackPanel Orientation="Horizontal"
                        VerticalAlignment="Center"
                        Margin="20 , 0">
                <TextBlock Text="üç≥"
                           FontSize="40"
                           Margin="0, 0,15,0"/>
                <StackPanel>
                    <TextBlock Text="LoGeCui"
                           FontSize="28"
                           FontWeight="Bold"
                           Foreground="White"/>
                    <TextBlock Text=" Logiciel de Gestion de Cuisine"
                           FontSize="12"
                           Foreground="#BDC3C7"/>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- MENU GAUCHE -->
        <Border Grid.Row="1" 
                Grid.Column="0"
                Background="#34495E"
                BorderBrush="#2C3E50"
                BorderThickness="0,0,1,0">

            <StackPanel Margin="0,20,0,0">

                <!-- Bouton Ingr√©dients -->
                <Button Content="üì¶ Mes Ingr√©dients"
                        Height="60"
                        Background="#3498DB"
                        Foreground="White"
                        FontSize="16"
                        FontWeight="Bold"
                        Margin="10,5"
                        BorderThickness="0"
                        Cursor="Hand"
                        Click="BtnIngredients_Click">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="#3498DB"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#2980B9"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <!-- Bouton Recettes -->
                <Button Content="üìñ Mes Recettes"
                        Height="60"
                        Background="#2ECC71"
                        Foreground="White"
                        FontSize="16"
                        FontWeight="Bold"
                        Margin="10,5"
                        BorderThickness="0"
                        Cursor="Hand"
                        Click="BtnRecettes_Click">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="#2ECC71"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#27AE60"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <!-- Bouton Ajouter Recette -->
                <Button Content="‚ûï Ajouter Recette"
                        Height="60"
                        Background="#F39C12"
                        Foreground="White"
                        FontSize="16"
                        FontWeight="Bold"
                        Margin="10,5"
                        BorderThickness="0"
                        Cursor="Hand"
                        Click="BtnAjouterRecette_Click">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="#F39C12"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#E67E22"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
                <!-- Bouton Menu Al√©atoire -->
                <Button Content="üé≤ Menu Al√©atoire"
                        Height="60"
                        Background="#9B59B6"
                        Foreground="White"
                        FontSize="16"
                        FontWeight="Bold"
                        Margin="10,5"
                        BorderThickness="0"
                        Cursor="Hand"
                        Click="BtnMenuAleatoire_Click">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="#9B59B6"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#8E44AD"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <!-- Bouton Liste de Courses -->
                <Button Content="üõí Liste de Courses"
                        Height="60"
                        Background="#E74C3C"
                        Foreground="White"
                        FontSize="16"
                        FontWeight="Bold"
                        Margin="10,5"
                        BorderThickness="0"
                        Cursor="Hand"
                        Click="BtnListeCourses_Click">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="#E74C3C"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#C0392B"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <Button
                    Content="Synchroniser recettes"
                    Click="BtnSyncRecettes_Click"
                    Margin="10"/>

            </StackPanel>
        </Border>

        <!-- ZONE DE CONTENU PRINCIPAL -->
        <Border Grid.Row="1" 
        Grid.Column="1"
        Background="White"
        Margin="10">

            <ContentControl x:Name="MainContent">
                <TextBlock Text="Bienvenue dans LoGeCui ! üç≥&#x0a;&#x0a;S√©lectionnez une option dans le menu."
                   FontSize="24"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"
                   TextAlignment="Center"
                   Foreground="#7F8C8D"/>
            </ContentControl>

        </Border>



    </Grid>
</Window>

================================================================================
FILE: LoGeCui\MainWindow.xaml.cs
================================================================================

Ôªøusing LoGeCuiShared.Services;
using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;
using LoGeCui.Services;
using LoGeCui.Views;

namespace LoGeCui
{
    /// <summary>
    /// Interaction logic for MainWindow.xaml
    /// </summary>
    public partial class MainWindow : Window
    {
        // SUPPRIM√â : private SupabaseService _supabase;

        public MainWindow()
        {
            InitializeComponent();

            // SUPPRIM√â : Ne plus cr√©er une nouvelle instance !
            // _supabase = new SupabaseService(url, key);

            // Maintenant on utilisera App.SupabaseService partout
        }

        private void BtnIngredients_Click(object sender, RoutedEventArgs e)
        {
            MainContent.Content = new Views.IngredientsView();
        }

        private void BtnRecettes_Click(object sender, RoutedEventArgs e)
        {
            MainContent.Content = new Views.RecettesView();
        }

        private async void BtnAjouterRecette_Click(object sender, RoutedEventArgs e)
        {
            var dialog = new Dialogs.AjouterRecetteDialog();
            dialog.Owner = this;

            bool? resultat = dialog.ShowDialog();

            if (resultat == true && dialog.NouvelleRecette != null)
            {
                try
                {
                    if (App.RecipesService == null || App.CurrentUserId == null)
                    {
                        MessageBox.Show("Utilisateur non connect√© ou services non initialis√©s.");
                        return;
                    }

                    var r = dialog.NouvelleRecette;

                    // ExternalId obligatoire pour l'upsert (√©vite les doublons)
                    if (string.IsNullOrWhiteSpace(r.ExternalId))
                        r.ExternalId = Guid.NewGuid().ToString("N");

                    // Sauvegarde vers Supabase
                    await App.RecipesService.UpsertRecetteAsync(App.CurrentUserId.Value, r);

                    // Recharge la vue Recettes (qui doit lire Supabase)
                    var view = new RecettesView();
                    MainContent.Content = view;

                    MessageBox.Show(
                        $"La recette '{r.Nom}' a √©t√© ajout√©e avec succ√®s !",
                        "Succ√®s",
                        MessageBoxButton.OK,
                        MessageBoxImage.Information);
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Erreur lors de l'ajout :\n{ex}", "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }


        private void BtnMenuAleatoire_Click(object sender, RoutedEventArgs e)
        {
            MainContent.Content = new Views.MenuAleatoireView();
        }

        private void BtnListeCourses_Click(object sender, RoutedEventArgs e)
        {
            MainContent.Content = new Views.ListeCoursesView();
        }

        public async Task SyncRecettesToSupabaseAsync(IEnumerable<LoGeCuiShared.Models.Recette> recettesLocales)
        {
            if (App.RecipesService == null || App.CurrentUserId == null)
                throw new InvalidOperationException("Services REST non initialis√©s. Connecte-toi d'abord.");

            foreach (var r in recettesLocales)
            {
                if (string.IsNullOrWhiteSpace(r.ExternalId))
                    throw new InvalidOperationException($"Recette '{r.Nom}' sans ExternalId. Il faut un identifiant stable pour √©viter les doublons.");

                await App.RecipesService.UpsertRecetteAsync(App.CurrentUserId.Value, r);
            }
        }

        private async void BtnSyncRecettes_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                if (App.RecipesService == null || App.CurrentUserId == null)
                {
                    MessageBox.Show("Utilisateur non connect√© ou services non initialis√©s.");
                    return;
                }

                // üîπ ICI tu dois r√©cup√©rer TA liste de recettes WPF
                // Adapte cette ligne √† TON code existant

                MessageBox.Show("Synchronisation termin√©e avec succ√®s.");
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur de synchronisation :\n{ex.Message}");
            }
        }


    }
}

================================================================================
FILE: LoGeCui\Models\ArticleCourse.cs
================================================================================

Ôªønamespace LoGeCui.Models
{
    public class ArticleCourse
    {
        public string Nom { get; set; }
        public string Quantite { get; set; }
        public string Unite { get; set; }
        public bool EstAchete { get; set; }

        public ArticleCourse()
        {
            Nom = "";
            Quantite = "";
            Unite = "";
            EstAchete = false;
        }

        // Pour l'affichage
        public override string ToString()
        {
            return $"{Nom} - {Quantite} {Unite}";
        }
    }
}

================================================================================
FILE: LoGeCui\Models\Ingredient.cs
================================================================================

Ôªønamespace LoGeCui.Models
{
    public class Ingredient
    {
        public Guid Id { get; set; }          // correspond √† id
        public Guid? UserId { get; set; }
        public string Nom { get; set; }
        public string Quantite { get; set; }
        public string Unite { get; set; }
        public bool EstDisponible { get; set; }

        // Constructeur (optionnel mais pratique)
        public Ingredient()
        {
            Nom = "";
            Quantite = "";
            Unite = "";
            EstDisponible = true;
        }
    }
}

================================================================================
FILE: LoGeCui\Models\IngredientRecette.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;


namespace LoGeCui.Models
{
    public class IngredientRecette
    {
        public string Nom { get; set; }
        public string Quantite { get; set; }
        public string Unite { get; set; }

        public IngredientRecette()
        {
            Nom = "";
            Quantite = "";
            Unite = "";
        }

        // Pour l'affichage
        public override string ToString()
        {
            return $"{Nom} - {Quantite} {Unite}";
        }
    }
}

================================================================================
FILE: LoGeCui\Models\MenuJournalier.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using LoGeCuiShared.Models;

namespace LoGeCui.Models
{
    public class MenuJournalier
    {
        public DateTime Date { get; set; }
        public Recette? Entree { get; set; }
        public Recette? Plat { get; set; }
        public Recette? Dessert { get; set; }
        public List<IngredientRecette> IngredientsManquants { get; set; }

        public MenuJournalier()
        {
            Date = DateTime.Now;
            IngredientsManquants = new List<IngredientRecette>();
        }
    }
}

================================================================================
FILE: LoGeCui\Services\IngredientService.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.IO;
using System.Text.Json;
using LoGeCuiShared.Models;
using System.Linq;

namespace LoGeCui.Services
{
    public class IngredientService
    {
        // Chemin du fichier de sauvegarde
        private readonly string _cheminFichier;
        private List<Ingredient> _ingredients = new List<Ingredient>();

        public IngredientService()
        {
            // Le fichier sera sauvegard√© dans AppData de l'utilisateur
            string dossier = Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
                "LoGeCui"
            );

            // Cr√©er le dossier s'il n'existe pas
            Directory.CreateDirectory(dossier);

            _cheminFichier = Path.Combine(dossier, "ingredients.json");
        }

        /// <summary>
        /// Charge les ingr√©dients depuis le fichier JSON
        /// </summary>
        public List<Ingredient> ChargerIngredients()
        {
            try
            {
                // V√©rifier si le fichier existe
                if (!File.Exists(_cheminFichier))
                {
                    // Pas de fichier = liste vide
                    return new List<Ingredient>();
                }

                // Lire le contenu du fichier
                string json = File.ReadAllText(_cheminFichier);

                // Convertir le JSON en liste d'ingr√©dients
                var ingredients = JsonSerializer.Deserialize<List<Ingredient>>(json);

                return ingredients ?? new List<Ingredient>();
            }
            catch (Exception ex)
            {
                // En cas d'erreur, afficher un message et retourner une liste vide
                System.Windows.MessageBox.Show(
                    $"Erreur lors du chargement des ingr√©dients : {ex.Message}",
                    "Erreur",
                    System.Windows.MessageBoxButton.OK,
                    System.Windows.MessageBoxImage.Error);

                return new List<Ingredient>();
            }
        }

        public List<Ingredient> ObtenirTousLesIngredients()
        {
            return _ingredients.ToList();
        }

        public List<Ingredient> ObtenirIngredientsDisponibles()
        {
            return _ingredients.Where(i => i.EstDisponible).ToList();
        }

        /// <summary>
        /// Sauvegarde les ingr√©dients dans le fichier JSON
        /// </summary>
        public void SauvegarderIngredients(List<Ingredient> ingredients)
        {
            try
            {
                // Options pour rendre le JSON lisible (avec indentation)
                var options = new JsonSerializerOptions
                {
                    WriteIndented = true  // Pour avoir un JSON "joli"
                };

                // Convertir la liste en JSON
                string json = JsonSerializer.Serialize(ingredients, options);

                // √âcrire dans le fichier
                File.WriteAllText(_cheminFichier, json);
            }
            catch (Exception ex)
            {
                // En cas d'erreur, afficher un message
                System.Windows.MessageBox.Show(
                    $"Erreur lors de la sauvegarde des ingr√©dients : {ex.Message}",
                    "Erreur",
                    System.Windows.MessageBoxButton.OK,
                    System.Windows.MessageBoxImage.Error);
            }
        }

        /// <summary>
        /// Retourne le chemin du fichier de sauvegarde
        /// </summary>
        public string ObtenirCheminFichier()
        {
            return _cheminFichier;
        }
    }
}

================================================================================
FILE: LoGeCui\Services\ListeCoursesService.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.IO;
using System.Text.Json;
using LoGeCuiShared.Models;

namespace LoGeCui.Services
{
    public class ListeCoursesService
    {
        private readonly string _cheminFichier;

        public ListeCoursesService()
        {
            string dossier = Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
                "LoGeCui"
            );
                    Directory.CreateDirectory(dossier);
                    _cheminFichier = Path.Combine(dossier, "liste_courses.json");
        }

        public List<ArticleCourse> ChargerListeCourses()
        {
            try
            {
                if (!File.Exists(_cheminFichier))
                {
                    return new List<ArticleCourse>();
                }

                string json = File.ReadAllText(_cheminFichier);
                var liste = JsonSerializer.Deserialize<List<ArticleCourse>>(json);
                return liste ?? new List<ArticleCourse>();
            }
            catch (Exception ex)
            {
                System.Windows.MessageBox.Show(
                    $"Erreur lors du chargement de la liste de courses : {ex.Message}",
                    "Erreur",
                    System.Windows.MessageBoxButton.OK,
                    System.Windows.MessageBoxImage.Error);
                return new List<ArticleCourse>();
            }
        }

        public void SauvegarderListeCourses(List<ArticleCourse> articles)
        {
            try
            {
                var options = new JsonSerializerOptions { WriteIndented = true };
                string json = JsonSerializer.Serialize(articles, options);
                File.WriteAllText(_cheminFichier, json);
            }
            catch (Exception ex)
            {
                System.Windows.MessageBox.Show(
                    $"Erreur lors de la sauvegarde de la liste de courses : {ex.Message}",
                    "Erreur",
                    System.Windows.MessageBoxButton.OK,
                    System.Windows.MessageBoxImage.Error);
            }
        }
    }
}

================================================================================
FILE: LoGeCui\Services\RecetteService.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.IO;
using System.Text.Json;
using LoGeCuiShared.Models;

namespace LoGeCui.Services
{
    public class RecetteService
    {
        private readonly string _cheminFichier;

        public RecetteService()
        {
            string dossier = Path.Combine(
             Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
             "LoGeCui"
            );
            Directory.CreateDirectory(dossier);
            _cheminFichier = Path.Combine(dossier, "recettes.json");
        }

        public List<Recette> ChargerRecettes()
        {
            try
            {
                if (!File.Exists(_cheminFichier))
                {
                    return new List<Recette>();
                }

                string json = File.ReadAllText(_cheminFichier);
                var options = new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                };

                var recettes = JsonSerializer.Deserialize<List<Recette>>(json, options);
                return recettes ?? new List<Recette>();
            }
            catch (Exception ex)
            {
                System.Windows.MessageBox.Show(
                    $"Erreur lors du chargement des recettes : {ex.Message}",
                    "Erreur",
                    System.Windows.MessageBoxButton.OK,
                    System.Windows.MessageBoxImage.Error);
                return new List<Recette>();
            }
        }

        public void SauvegarderRecettes(List<Recette> recettes)
        {
            try
            {
                var options = new JsonSerializerOptions
                {
                    WriteIndented = true
                };
                string json = JsonSerializer.Serialize(recettes, options);
                File.WriteAllText(_cheminFichier, json);
            }
            catch (Exception ex)
            {
                System.Windows.MessageBox.Show(
                    $"Erreur lors de la sauvegarde des recettes : {ex.Message}",
                    "Erreur",
                    System.Windows.MessageBoxButton.OK,
                    System.Windows.MessageBoxImage.Error);
            }
        }
    }
}

================================================================================
FILE: LoGeCui\Views\IngredientsView.xaml
================================================================================

Ôªø<UserControl x:Class="LoGeCui.Views.IngredientsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Background="White">

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- Titre -->
            <RowDefinition Height="Auto"/>
            <!-- Boutons -->
            <RowDefinition Height="*"/>
            <!-- Liste -->
        </Grid.RowDefinitions>

        <!-- TITRE -->
        <TextBlock Grid.Row="0"
                   Text="üì¶ Gestion des Ingr√©dients"
                   FontSize="28"
                   FontWeight="Bold"
                   Foreground="#2C3E50"
                   Margin="0,0,0,20"/>

        <!-- ZONE DE BOUTONS -->
        <StackPanel Grid.Row="1" 
                    Orientation="Horizontal"
                    Margin="0,0,0,20">

            <Button Content="‚ûï Ajouter un ingr√©dient"
                    Height="40"
                    Width="200"
                    Background="#27AE60"
                    Foreground="White"
                    FontSize="14"
                    FontWeight="Bold"
                    BorderThickness="0"
                    Cursor="Hand"
                    Click="BtnAjouter_Click"/>

        </StackPanel>

        <!-- LISTE DES INGR√âDIENTS -->
        <Border Grid.Row="2"
                BorderBrush="#BDC3C7"
                BorderThickness="1"
                CornerRadius="5">

            <ListBox x:Name="ListeIngredients"
                     Background="#F8F9FA"
                     BorderThickness="0">

                <!-- Template pour afficher chaque ingr√©dient -->
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Border Background="White"
            BorderBrush="#E0E0E0"
            BorderThickness="1"
            CornerRadius="5"
            Margin="5"
            Padding="15">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- Informations de l'ingr√©dient -->
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="{Binding Nom}"
                           FontSize="16"
                           FontWeight="Bold"
                           Foreground="#2C3E50"/>
                                    <TextBlock Foreground="#7F8C8D"
                           FontSize="14">
                    <Run Text="Quantit√© : "/>
                    <Run Text="{Binding Quantite}"/>
                    <Run Text=" "/>
                    <Run Text="{Binding Unite}"/>
                                    </TextBlock>
                                </StackPanel>

                                <!-- CheckBox Disponible -->
                                <CheckBox Grid.Column="1"
                     IsChecked="{Binding EstDisponible}"
                     Content="Disponible"
                     VerticalAlignment="Center"
                     Margin="10,0"
                     Checked="ChkDisponible_Changed"
                     Unchecked="ChkDisponible_Changed"/>

                                <!-- Bouton Supprimer -->
                                <Button Grid.Column="2"
                    Content="üóëÔ∏è"
                    Width="40"
                    Height="40"
                    Background="#E74C3C"
                    Foreground="White"
                    FontSize="18"
                    BorderThickness="0"
                    Cursor="Hand"
                    ToolTip="Supprimer cet ingr√©dient"
                    Click="BtnSupprimer_Click"
                    Tag="{Binding}">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Background" Value="#E74C3C"/>
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="#C0392B"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>

                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListBox.ItemTemplate>

            </ListBox>
        </Border>

    </Grid>

</UserControl>

================================================================================
FILE: LoGeCui\Views\IngredientsView.xaml.cs
================================================================================

Ôªøusing System;
using System.Collections.ObjectModel;
using System.Linq;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using LoGeCuiShared.Models;

namespace LoGeCui.Views
{
    public partial class IngredientsView : UserControl
    {
        private readonly ObservableCollection<Ingredient> _ingredients = new();

        public IngredientsView()
        {
            InitializeComponent();

            ListeIngredients.ItemsSource = _ingredients;

            Loaded += IngredientsView_Loaded;
        }

        private async void IngredientsView_Loaded(object sender, RoutedEventArgs e)
        {
            // Evite de recharger plusieurs fois si Loaded se d√©clenche √† nouveau
            Loaded -= IngredientsView_Loaded;
            await ReloadIngredientsAsync();
        }

        private async Task ReloadIngredientsAsync()
        {
            try
            {
                var data = await App.SupabaseService.GetIngredientsAsync();

                _ingredients.Clear();
                foreach (var ing in data.OrderBy(i => i.Nom))
                    _ingredients.Add(ing);
            }
            catch (InvalidOperationException ex)
            {
                MessageBox.Show(ex.Message, "Connexion requise", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur chargement ingr√©dients (Supabase) : {ex.Message}",
                    "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private async void BtnAjouter_Click(object sender, RoutedEventArgs e)
        {
            var dialog = new Dialogs.AjouterIngredientDialog
            {
                Owner = Window.GetWindow(this)
            };

            bool? resultat = dialog.ShowDialog();
            if (resultat != true || dialog.NouvelIngredient == null)
                return;

            try
            {
                var saved = await App.SupabaseService.AddIngredientAsync(dialog.NouvelIngredient);

                if (saved == null)
                {
                    MessageBox.Show("L'ajout a √©chou√© (aucune donn√©e retourn√©e).",
                        "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
                    return;
                }

                _ingredients.Add(saved);

                MessageBox.Show(
                    $"L'ingr√©dient '{saved.Nom}' a √©t√© ajout√© avec succ√®s !",
                    "Succ√®s",
                    MessageBoxButton.OK,
                    MessageBoxImage.Information);
            }
            catch (InvalidOperationException ex)
            {
                MessageBox.Show(ex.Message, "Connexion requise", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur lors de l'ajout (Supabase) : {ex.Message}",
                    "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private async void BtnSupprimer_Click(object sender, RoutedEventArgs e)
        {
            if (sender is not Button bouton)
                return;

            // On r√©cup√®re l'objet li√© √† la ligne (plus fiable que Tag si ton XAML est bind√© correctement)
            if (bouton.DataContext is not Ingredient ingredient)
                return;

            var confirmation = MessageBox.Show(
                $"Voulez-vous vraiment supprimer '{ingredient.Nom}' ?",
                "Confirmation de suppression",
                MessageBoxButton.YesNo,
                MessageBoxImage.Question);

            if (confirmation != MessageBoxResult.Yes)
                return;

            try
            {
                if (ingredient.Id == Guid.Empty)
                {
                    MessageBox.Show("Impossible de supprimer : l'ingr√©dient n'a pas d'Id.",
                        "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
                    return;
                }

                bool ok = await App.SupabaseService.DeleteIngredientAsync(ingredient.Id);
                if (!ok)
                {
                    MessageBox.Show("La suppression a √©chou√© c√¥t√© serveur.",
                        "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
                    return;
                }

                _ingredients.Remove(ingredient);

                MessageBox.Show(
                    $"L'ingr√©dient '{ingredient.Nom}' a √©t√© supprim√©.",
                    "Suppression r√©ussie",
                    MessageBoxButton.OK,
                    MessageBoxImage.Information);
            }
            catch (InvalidOperationException ex)
            {
                MessageBox.Show(ex.Message, "Connexion requise", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur lors de la suppression (Supabase) : {ex.Message}",
                    "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private async void ChkDisponible_Changed(object sender, RoutedEventArgs e)
        {
            if (sender is not CheckBox cb)
                return;

            // Objet li√© √† la ligne
            if (cb.DataContext is not Ingredient ingredient)
                return;

            try
            {
                if (ingredient.Id == Guid.Empty)
                    return; // pas persist√© c√¥t√© Supabase

                bool ok = await App.SupabaseService.UpdateIngredientAsync(ingredient);
                if (!ok)
                {
                    MessageBox.Show("La mise √† jour a √©chou√© c√¥t√© serveur.",
                        "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
            catch (InvalidOperationException ex)
            {
                MessageBox.Show(ex.Message, "Connexion requise", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur mise √† jour (Supabase) : {ex.Message}",
                    "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }
    }
}

================================================================================
FILE: LoGeCui\Views\ListeCoursesView.xaml
================================================================================

Ôªø<UserControl x:Class="LoGeCui.Views.ListeCoursesView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Background="White">

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- TITRE -->
        <TextBlock Grid.Row="0"
                   Text="üõí Liste de Courses"
                   FontSize="28"
                   FontWeight="Bold"
                   Foreground="#2C3E50"
                   Margin="0,0,0,20"/>

        <!-- BOUTONS -->
        <!-- BOUTONS -->
        <StackPanel Grid.Row="1"
            Orientation="Horizontal"
            Margin="0,0,0,20">

            <Button Content="‚ûï Ajouter un article"
            Height="40"
            Width="180"
            Background="#27AE60"
            Foreground="White"
            FontSize="14"
            FontWeight="Bold"
            BorderThickness="0"
            Cursor="Hand"
            Click="BtnAjouterArticle_Click"
            Margin="0,0,10,0">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#27AE60"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#229954"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

            <Button Content="üóëÔ∏è Supprimer les articles achet√©s"
            Height="40"
            Width="230"
            Background="#E74C3C"
            Foreground="White"
            FontSize="14"
            FontWeight="Bold"
            BorderThickness="0"
            Cursor="Hand"
            Click="BtnSupprimerAchetes_Click"
            Margin="0,0,10,0">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#E74C3C"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#C0392B"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

            <!-- NOUVEAU : Tout s√©lectionner -->
            <Button Content="‚úÖ Tout s√©lectionner"
            Height="40"
            Width="170"
            Background="#3498DB"
            Foreground="White"
            FontSize="14"
            FontWeight="Bold"
            BorderThickness="0"
            Cursor="Hand"
            Click="BtnToutSelectionner_Click"
            Margin="0,0,10,0">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#3498DB"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#2E86C1"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

            <!-- NOUVEAU : Supprimer la s√©lection -->
            <Button Content="üóëÔ∏è Supprimer la s√©lection"
            Height="40"
            Width="210"
            Background="#E67E22"
            Foreground="White"
            FontSize="14"
            FontWeight="Bold"
            BorderThickness="0"
            Cursor="Hand"
            Click="BtnSupprimerSelection_Click">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#E67E22"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#D35400"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

        </StackPanel>

        <!-- LISTE DES COURSES -->
        <Border Grid.Row="2"
                BorderBrush="#BDC3C7"
                BorderThickness="1"
                CornerRadius="5">

            <ListBox x:Name="ListeCourses"
                     Background="#F8F9FA"
                     BorderThickness="0"
                     SelectionMode="Extended">

                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Border Background="White"
                                BorderBrush="#E0E0E0"
                                BorderThickness="1"
                                CornerRadius="5"
                                Margin="5"
                                Padding="15">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- CheckBox Achet√© -->
                                <CheckBox Grid.Column="0"
                                         IsChecked="{Binding EstAchete}"
                                         VerticalAlignment="Center"
                                         Margin="0,0,15,0"
                                         Checked="ChkAchete_Changed"
                                         Unchecked="ChkAchete_Changed"/>

                                <!-- Informations -->
                                <StackPanel Grid.Column="1">
                                    <TextBlock FontSize="16"
                                               FontWeight="Bold"
                                               Foreground="#2C3E50">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Text" Value="{Binding Nom}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding EstAchete}" Value="True">
                                                        <Setter Property="TextDecorations" Value="Strikethrough"/>
                                                        <Setter Property="Foreground" Value="#95A5A6"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>

                                    <TextBlock Foreground="#7F8C8D"
                                               FontSize="14">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding EstAchete}" Value="True">
                                                        <Setter Property="TextDecorations" Value="Strikethrough"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                        <Run Text="Quantit√© : "/>
                                        <Run Text="{Binding Quantite, Mode=OneWay}"/>
                                        <Run Text=" "/>
                                        <Run Text="{Binding Unite, Mode=OneWay}"/>
                                    </TextBlock>
                                </StackPanel>

                                <!-- Bouton Supprimer -->
                                <Button Grid.Column="2"
                                        Content="üóëÔ∏è"
                                        Width="40"
                                        Height="40"
                                        Background="#E74C3C"
                                        Foreground="White"
                                        FontSize="18"
                                        BorderThickness="0"
                                        Cursor="Hand"
                                        ToolTip="Supprimer cet article"
                                        Click="BtnSupprimerArticle_Click"
                                        Tag="{Binding}">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Background" Value="#E74C3C"/>
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="#C0392B"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>
                                

                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListBox.ItemTemplate>

            </ListBox>
        </Border>

    </Grid>

</UserControl>

================================================================================
FILE: LoGeCui\Views\ListeCoursesView.xaml.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using LoGeCuiShared.Models;

namespace LoGeCui.Views
{
    public partial class ListeCoursesView : UserControl
    {
        private readonly ObservableCollection<ArticleCourse> _articles = new ObservableCollection<ArticleCourse>();

        public ListeCoursesView()
        {
            InitializeComponent();

            // Binding une fois
            ListeCourses.ItemsSource = _articles;

            ChargerDonnees();
        }

        private async void ChargerDonnees()
        {
            try
            {
                var articles = await App.SupabaseService.GetArticlesAsync();

                _articles.Clear();
                foreach (var article in articles)
                    _articles.Add(article);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur de chargement : {ex.Message}", "Erreur",
                    MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private async void BtnAjouterArticle_Click(object sender, RoutedEventArgs e)
        {
            var dialog = new Dialogs.AjouterArticleCourseDialog
            {
                Owner = Window.GetWindow(this)
            };

            bool? resultat = dialog.ShowDialog();

            if (resultat == true && dialog.NouvelArticle != null)
            {
                try
                {
                    var added = await App.SupabaseService.AddArticleAsync(dialog.NouvelArticle);

                    if (added != null)
                    {
                        _articles.Add(added);
                        MessageBox.Show($"'{added.Nom}' ajout√© avec succ√®s !", "Succ√®s",
                            MessageBoxButton.OK, MessageBoxImage.Information);
                    }
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Erreur : {ex.Message}", "Erreur",
                        MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        private async void BtnSupprimerArticle_Click(object sender, RoutedEventArgs e)
        {
            var bouton = sender as Button;
            var article = bouton?.Tag as ArticleCourse;

            if (article == null)
                return;

            var resultat = MessageBox.Show(
                $"Voulez-vous vraiment supprimer '{article.Nom}' ?",
                "Confirmation",
                MessageBoxButton.YesNo,
                MessageBoxImage.Question);

            if (resultat != MessageBoxResult.Yes)
                return;

            try
            {
                await App.SupabaseService.DeleteArticleAsync(article.Id);
                _articles.Remove(article);

                MessageBox.Show("Article supprim√© !", "Succ√®s",
                    MessageBoxButton.OK, MessageBoxImage.Information);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur : {ex.Message}", "Erreur",
                    MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private async void ChkAchete_Changed(object sender, RoutedEventArgs e)
        {
            var checkbox = sender as CheckBox;
            var article = checkbox?.DataContext as ArticleCourse;

            if (article == null)
                return;

            try
            {
                await App.SupabaseService.UpdateArticleAsync(article.Id, article);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur de synchronisation : {ex.Message}", "Erreur",
                    MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void BtnToutSelectionner_Click(object sender, RoutedEventArgs e)
        {
            ListeCourses.SelectAll();
        }

        private async void BtnSupprimerSelection_Click(object sender, RoutedEventArgs e)
        {
            // NOTE: SelectedItems est un IList -> on copie avant toute suppression
            var selected = ListeCourses.SelectedItems.Cast<ArticleCourse>().ToList();

            if (!selected.Any())
            {
                MessageBox.Show("Aucun article s√©lectionn√©.", "Information",
                    MessageBoxButton.OK, MessageBoxImage.Information);
                return;
            }

            var resultat = MessageBox.Show(
                $"Voulez-vous supprimer {selected.Count} article(s) s√©lectionn√©(s) ?",
                "Confirmation",
                MessageBoxButton.YesNo,
                MessageBoxImage.Question);

            if (resultat != MessageBoxResult.Yes)
                return;

            try
            {
                // Variante qui fonctionne tout de suite, sans ajouter de m√©thode Supabase en lot :
                // on supprime en boucle via la m√©thode existante DeleteArticleAsync(id).
                foreach (var article in selected)
                {
                    await App.SupabaseService.DeleteArticleAsync(article.Id);
                    _articles.Remove(article);
                }

                MessageBox.Show($"{selected.Count} article(s) supprim√©(s).", "Succ√®s",
                    MessageBoxButton.OK, MessageBoxImage.Information);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur : {ex.Message}", "Erreur",
                    MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private async void BtnSupprimerAchetes_Click(object sender, RoutedEventArgs e)
        {
            var achetes = _articles.Where(a => a.EstAchete).ToList();

            if (!achetes.Any())
            {
                MessageBox.Show("Aucun article achet√© √† supprimer.", "Information",
                    MessageBoxButton.OK, MessageBoxImage.Information);
                return;
            }

            var resultat = MessageBox.Show(
                $"Voulez-vous supprimer les {achetes.Count} article(s) achet√©(s) ?",
                "Confirmation",
                MessageBoxButton.YesNo,
                MessageBoxImage.Question);

            if (resultat != MessageBoxResult.Yes)
                return;

            try
            {
                await App.SupabaseService.DeleteAchetesAsync();

                foreach (var article in achetes)
                    _articles.Remove(article);

                MessageBox.Show($"{achetes.Count} article(s) supprim√©(s).", "Succ√®s",
                    MessageBoxButton.OK, MessageBoxImage.Information);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur : {ex.Message}", "Erreur",
                    MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }
    }
}



================================================================================
FILE: LoGeCui\Views\MenuAleatoireView.xaml
================================================================================

Ôªø<UserControl x:Class="LoGeCui.Views.MenuAleatoireView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Background="White">

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <Grid Margin="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- TITRE -->
            <TextBlock Grid.Row="0"
                       Text="üé≤ Menu Al√©atoire"
                       FontSize="28"
                       FontWeight="Bold"
                       Foreground="#2C3E50"
                       Margin="0,0,0,20"/>

            <!-- BOUTON GENERER -->
            <Button Grid.Row="1"
                    Content="üé≤ G√©n√©rer un nouveau menu"
                    Width="250"
                    Height="50"
                    Background="#9B59B6"
                    Foreground="White"
                    FontSize="16"
                    FontWeight="Bold"
                    BorderThickness="0"
                    Cursor="Hand"
                    Click="BtnGenererMenu_Click"
                    HorizontalAlignment="Center"
                    Margin="0,0,0,30">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#9B59B6"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#8E44AD"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

            <!-- CONTENU DU MENU -->
            <StackPanel Grid.Row="2" x:Name="MenuPanel" Visibility="Collapsed">

                <!-- Date -->
                <TextBlock x:Name="TxtDate"
                           FontSize="16"
                           Foreground="#7F8C8D"
                           Margin="0,0,0,20"
                           HorizontalAlignment="Center"/>

                <!-- Entr√©e -->
                <Border Background="#E8F5E9"
                        CornerRadius="10"
                        Padding="20"
                        Margin="0,0,0,15">
                    <StackPanel>
                        <TextBlock Text="ü•ó ENTR√âE"
                                   FontSize="18"
                                   FontWeight="Bold"
                                   Foreground="#27AE60"
                                   Margin="0,0,0,10"/>

                        <TextBlock x:Name="TxtEntree"
                                   Text="Aucune entr√©e"
                                   FontSize="20"
                                   FontWeight="Bold"
                                   Foreground="#2C3E50"
                                   Margin="0,0,0,5"/>

                        <TextBlock x:Name="TxtEntreeDetails"
                                   FontSize="14"
                                   Foreground="#7F8C8D"
                                   TextWrapping="Wrap"/>
                    </StackPanel>
                </Border>

                <!-- Plat -->
                <Border Background="#E3F2FD"
                        CornerRadius="10"
                        Padding="20"
                        Margin="0,0,0,15">
                    <StackPanel>
                        <TextBlock Text="üçΩÔ∏è PLAT PRINCIPAL"
                                   FontSize="18"
                                   FontWeight="Bold"
                                   Foreground="#2196F3"
                                   Margin="0,0,0,10"/>

                        <TextBlock x:Name="TxtPlat"
                                   Text="Aucun plat"
                                   FontSize="20"
                                   FontWeight="Bold"
                                   Foreground="#2C3E50"
                                   Margin="0,0,0,5"/>

                        <TextBlock x:Name="TxtPlatDetails"
                                   FontSize="14"
                                   Foreground="#7F8C8D"
                                   TextWrapping="Wrap"/>
                    </StackPanel>
                </Border>

                <!-- Dessert -->
                <Border Background="#FFF3E0"
                        CornerRadius="10"
                        Padding="20"
                        Margin="0,0,0,20">
                    <StackPanel>
                        <TextBlock Text="üç∞ DESSERT"
                                   FontSize="18"
                                   FontWeight="Bold"
                                   Foreground="#FF9800"
                                   Margin="0,0,0,10"/>

                        <TextBlock x:Name="TxtDessert"
                                   Text="Aucun dessert"
                                   FontSize="20"
                                   FontWeight="Bold"
                                   Foreground="#2C3E50"
                                   Margin="0,0,0,5"/>

                        <TextBlock x:Name="TxtDessertDetails"
                                   FontSize="14"
                                   Foreground="#7F8C8D"
                                   TextWrapping="Wrap"/>
                    </StackPanel>
                </Border>

                <!-- Ingr√©dients manquants -->
                <Border x:Name="IngredientsManquantsPanel"
                        Background="#FFEBEE"
                        CornerRadius="10"
                        Padding="20"
                        Margin="0,0,0,20"
                        Visibility="Collapsed">
                    <StackPanel>
                        <TextBlock Text="‚ö†Ô∏è INGR√âDIENTS MANQUANTS"
                                   FontSize="18"
                                   FontWeight="Bold"
                                   Foreground="#E74C3C"
                                   Margin="0,0,0,10"/>

                        <ListBox x:Name="ListeIngredientsManquants"
                                 BorderThickness="0"
                                 Background="Transparent"
                                 MaxHeight="200">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding}"
                                               FontSize="14"
                                               Foreground="#E74C3C"
                                               Margin="5"/>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>

                        <Button Content="‚ûï Ajouter √† la liste de courses"
                                Height="40"
                                Background="#E74C3C"
                                Foreground="White"
                                FontSize="14"
                                FontWeight="Bold"
                                BorderThickness="0"
                                Cursor="Hand"
                                Click="BtnAjouterListeCourses_Click"
                                Margin="0,10,0,0"/>
                    </StackPanel>
                </Border>

                <!-- Tout est disponible -->
                <Border x:Name="ToutDisponiblePanel"
                        Background="#E8F5E9"
                        CornerRadius="10"
                        Padding="20"
                        Visibility="Collapsed">
                    <StackPanel Orientation="Horizontal"
                               HorizontalAlignment="Center">
                        <TextBlock Text="‚úÖ"
                                   FontSize="24"
                                   Margin="0,0,10,0"/>
                        <TextBlock Text="Tous les ingr√©dients sont disponibles !"
                                   FontSize="16"
                                   FontWeight="Bold"
                                   Foreground="#27AE60"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                </Border>

            </StackPanel>

        </Grid>
    </ScrollViewer>

</UserControl>

================================================================================
FILE: LoGeCui\Views\MenuAleatoireView.xaml.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using LoGeCuiShared.Models;
using LoGeCui.Services;

namespace LoGeCui.Views
{
    public partial class MenuAleatoireView : UserControl
    {
        private readonly RecetteService _recetteService;
        private MenuJournalier? _menuCourant;

        public MenuAleatoireView()
        {
            InitializeComponent();
            _recetteService = new RecetteService();
        }

        private void BtnGenererMenu_Click(object sender, RoutedEventArgs e)
        {
            // Charger les recettes (source locale actuelle)
            var recettes = _recetteService.ChargerRecettes();

            if (recettes.Count == 0)
            {
                MessageBox.Show(
                    "Vous n'avez aucune recette !\n\nAjoutez des recettes d'abord.",
                    "Aucune recette",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
                return;
            }

            // Filtrer par type
            var entrees = recettes.Where(r => r.Type == TypePlat.Entree).ToList();
            var plats = recettes.Where(r => r.Type == TypePlat.Plat).ToList();
            var desserts = recettes.Where(r => r.Type == TypePlat.Dessert).ToList();

            // Cr√©er le menu
            _menuCourant = new MenuJournalier
            {
                Date = DateTime.Now,
                Entree = ChoisirRecetteAleatoire(entrees),
                Plat = ChoisirRecetteAleatoire(plats),
                Dessert = ChoisirRecetteAleatoire(desserts)
            };

            // Afficher le menu
            AfficherMenu();

            // V√©rifier les ingr√©dients (async, Supabase)
            _ = VerifierIngredientsAsync();
        }

        private Recette? ChoisirRecetteAleatoire(List<Recette> recettes)
        {
            if (recettes.Count == 0)
                return null;

            var random = new Random();
            return recettes[random.Next(recettes.Count)];
        }

        private void AfficherMenu()
        {
            if (_menuCourant == null)
                return;

            MenuPanel.Visibility = Visibility.Visible;

            TxtDate.Text = $"Menu g√©n√©r√© le {_menuCourant.Date:dd/MM/yyyy √† HH:mm}";

            if (_menuCourant.Entree != null)
            {
                TxtEntree.Text = _menuCourant.Entree.Nom;
                TxtEntreeDetails.Text = $"{_menuCourant.Entree.DifficulteTexte} ‚Ä¢ {_menuCourant.Entree.TempsPreparation} min";
            }
            else
            {
                TxtEntree.Text = "Aucune entr√©e disponible";
                TxtEntreeDetails.Text = "Ajoutez des recettes de type 'Entr√©e'";
            }

            if (_menuCourant.Plat != null)
            {
                TxtPlat.Text = _menuCourant.Plat.Nom;
                TxtPlatDetails.Text = $"{_menuCourant.Plat.DifficulteTexte} ‚Ä¢ {_menuCourant.Plat.TempsPreparation} min";
            }
            else
            {
                TxtPlat.Text = "Aucun plat disponible";
                TxtPlatDetails.Text = "Ajoutez des recettes de type 'Plat'";
            }

            if (_menuCourant.Dessert != null)
            {
                TxtDessert.Text = _menuCourant.Dessert.Nom;
                TxtDessertDetails.Text = $"{_menuCourant.Dessert.DifficulteTexte} ‚Ä¢ {_menuCourant.Dessert.TempsPreparation} min";
            }
            else
            {
                TxtDessert.Text = "Aucun dessert disponible";
                TxtDessertDetails.Text = "Ajoutez des recettes de type 'Dessert'";
            }
        }

        /// <summary>
        /// V√©rifie les ingr√©dients disponibles dans Supabase et calcule les ingr√©dients manquants.
        /// </summary>
        private async System.Threading.Tasks.Task VerifierIngredientsAsync()
        {
            if (_menuCourant == null)
                return;

            try
            {
                // Ingr√©dients disponibles (Supabase)
                var ingredientsDisponibles = await App.SupabaseService.GetIngredientsAsync();

                var disponibles = ingredientsDisponibles
                    .Where(i => i.EstDisponible)
                    .Select(i => (i.Nom ?? "").Trim().ToLower())
                    .Where(n => !string.IsNullOrWhiteSpace(n))
                    .ToHashSet();

                // Collecter tous les ingr√©dients n√©cessaires du menu
                var necessaires = new List<IngredientRecette>();

                if (_menuCourant.Entree != null)
                    necessaires.AddRange(_menuCourant.Entree.Ingredients);

                if (_menuCourant.Plat != null)
                    necessaires.AddRange(_menuCourant.Plat.Ingredients);

                if (_menuCourant.Dessert != null)
                    necessaires.AddRange(_menuCourant.Dessert.Ingredients);

                _menuCourant.IngredientsManquants.Clear();

                foreach (var ingredient in necessaires)
                {
                    var nom = (ingredient.Nom ?? "").Trim();
                    if (string.IsNullOrWhiteSpace(nom))
                        continue;

                    if (!disponibles.Contains(nom.ToLower()))
                    {
                        // √©viter doublons
                        if (!_menuCourant.IngredientsManquants.Any(i =>
                                i.Nom.Equals(nom, StringComparison.OrdinalIgnoreCase)))
                        {
                            _menuCourant.IngredientsManquants.Add(ingredient);
                        }
                    }
                }

                // Afficher
                if (_menuCourant.IngredientsManquants.Any())
                {
                    IngredientsManquantsPanel.Visibility = Visibility.Visible;
                    ToutDisponiblePanel.Visibility = Visibility.Collapsed;

                    ListeIngredientsManquants.ItemsSource = _menuCourant.IngredientsManquants
                        .Select(i => $"‚Ä¢ {i.Nom} - {i.Quantite} {i.Unite}")
                        .ToList();
                }
                else
                {
                    IngredientsManquantsPanel.Visibility = Visibility.Collapsed;
                    ToutDisponiblePanel.Visibility = Visibility.Visible;

                    ListeIngredientsManquants.ItemsSource = null;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(
                    $"Erreur v√©rification ingr√©dients (Supabase) : {ex.Message}",
                    "Erreur",
                    MessageBoxButton.OK,
                    MessageBoxImage.Error);
            }
        }

        private async void BtnAjouterListeCourses_Click(object sender, RoutedEventArgs e)
        {
            if (_menuCourant == null || !_menuCourant.IngredientsManquants.Any())
            {
                MessageBox.Show("Aucun ingr√©dient √† ajouter.", "Information", MessageBoxButton.OK, MessageBoxImage.Information);
                return;
            }

            try
            {
                // IMPORTANT : utiliser l'instance connect√©e (session OK)
                var supabase = App.SupabaseService;

                var articlesExistants = await supabase.GetArticlesAsync();
                var nomsExistants = articlesExistants
                    .Select(a => (a.Nom ?? "").Trim().ToLower())
                    .Where(n => !string.IsNullOrWhiteSpace(n))
                    .ToHashSet();

                int nbAjoutes = 0;

                foreach (var ingredient in _menuCourant.IngredientsManquants)
                {
                    var nom = (ingredient.Nom ?? "").Trim();
                    if (string.IsNullOrWhiteSpace(nom))
                        continue;

                    if (!nomsExistants.Contains(nom.ToLower()))
                    {
                        var article = new ArticleCourse
                        {
                            Nom = nom,
                            Quantite = ingredient.Quantite,
                            Unite = ingredient.Unite,
                            EstAchete = false
                        };

                        await supabase.AddArticleAsync(article);
                        nbAjoutes++;

                        // Mettre √† jour le set pour √©viter doublons dans la m√™me ex√©cution
                        nomsExistants.Add(nom.ToLower());
                    }
                }

                if (nbAjoutes > 0)
                {
                    MessageBox.Show(
                        $"{nbAjoutes} ingr√©dient(s) ajout√©(s) √† la liste de courses !\n\n" +
                        "Consultez 'Liste de Courses' pour les voir.",
                        "Succ√®s",
                        MessageBoxButton.OK,
                        MessageBoxImage.Information);
                }
                else
                {
                    MessageBox.Show(
                        "Tous ces ingr√©dients sont d√©j√† dans votre liste de courses.",
                        "Information",
                        MessageBoxButton.OK,
                        MessageBoxImage.Information);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(
                    $"Erreur lors de l'ajout : {ex.Message}",
                    "Erreur",
                    MessageBoxButton.OK,
                    MessageBoxImage.Error);
            }
        }
    }
}


================================================================================
FILE: LoGeCui\Views\RecetteView.xaml
================================================================================

Ôªø<UserControl x:Class="LoGeCui.Views.RecettesView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Background="White">

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- TITRE -->
        <!-- TITRE ET BOUTON -->
        <Grid Grid.Row="0" Margin="0,0,0,20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <TextBlock Grid.Column="0"
               Text="üìñ Mes Recettes"
               FontSize="28"
               FontWeight="Bold"
               Foreground="#2C3E50"
               VerticalAlignment="Center"/>

            <Button Grid.Column="1"
            Content="‚ûï Nouvelle recette"
            Width="180"
            Height="45"
            Background="#27AE60"
            Foreground="White"
            FontSize="14"
            FontWeight="Bold"
            BorderThickness="0"
            Cursor="Hand"
            Click="BtnNouvelleRecette_Click">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#27AE60"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#229954"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>
        </Grid>

        <!-- FILTRES -->
        <StackPanel Grid.Row="1" 
                    Orientation="Horizontal"
                    Margin="0,0,0,20">

            <Button Content="Toutes"
                    Width="100"
                    Height="40"
                    Margin="0,0,10,0"
                    Background="#95A5A6"
                    Foreground="White"
                    FontSize="14"
                    FontWeight="Bold"
                    BorderThickness="0"
                    Cursor="Hand"
                    Click="BtnTous_Click">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#95A5A6"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#7F8C8D"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

            <Button Content="ü•ó Entr√©es"
                    Width="100"
                    Height="40"
                    Margin="0,0,10,0"
                    Background="#27AE60"
                    Foreground="White"
                    FontSize="14"
                    FontWeight="Bold"
                    BorderThickness="0"
                    Cursor="Hand"
                    Click="BtnEntrees_Click">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#27AE60"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#229954"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

            <Button Content="üçΩÔ∏è Plats"
                    Width="100"
                    Height="40"
                    Margin="0,0,10,0"
                    Background="#3498DB"
                    Foreground="White"
                    FontSize="14"
                    FontWeight="Bold"
                    BorderThickness="0"
                    Cursor="Hand"
                    Click="BtnPlats_Click">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#3498DB"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#2980B9"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

            <Button Content="üç∞ Desserts"
                    Width="100"
                    Height="40"
                    Margin="0,0,10,0"
                    Background="#F39C12"
                    Foreground="White"
                    FontSize="14"
                    FontWeight="Bold"
                    BorderThickness="0"
                    Cursor="Hand"
                    Click="BtnDesserts_Click">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#F39C12"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#E67E22"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>
            <Button Content="Synchroniser"
        Click="BtnSyncRecettes_Click"
        Margin="8"/>

        </StackPanel>

        <!-- LISTE DES RECETTES -->
        <Border Grid.Row="2"
                BorderBrush="#BDC3C7"
                BorderThickness="1"
                CornerRadius="5">

            <ListBox x:Name="ListeRecettes"
                     Background="#F8F9FA"
                     BorderThickness="0"
                     MouseDoubleClick="ListeRecettes_DoubleClick">

                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Border Background="White"
                                BorderBrush="#E0E0E0"
                                BorderThickness="1"
                                CornerRadius="5"
                                Margin="5"
                                Padding="15"
                                Cursor="Hand">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- Informations -->
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="{Binding Nom}"
                                               FontSize="18"
                                               FontWeight="Bold"
                                               Foreground="#2C3E50"/>

                                    <TextBlock Foreground="#7F8C8D"
                                               FontSize="13"
                                               Margin="0,5,0,0">
                                        <Run Text="{Binding TypeTexte, Mode=OneWay}"/>
                                        <Run Text=" ‚Ä¢ "/>
                                        <Run Text="{Binding TempsPreparation, Mode=OneWay}"/>
                                        <Run Text=" min"/>
                                    </TextBlock>

                                    <TextBlock Text="{Binding DifficulteTexte, Mode=OneWay}"
                                               FontSize="14"
                                               Margin="0,3,0,0"/>
                                </StackPanel>

                                <!-- Badge du type -->
                                <Border Grid.Column="1"
                                        Background="#E8F5E9"
                                        CornerRadius="10"
                                        Padding="10,5"
                                        Margin="10,0"
                                        VerticalAlignment="Center">
                                    <TextBlock Text="{Binding Type}"
                                       FontSize="12"
                                       FontWeight="SemiBold"
                                       Foreground="#27AE60"/>
                                </Border>

                                <!-- Bouton Supprimer -->
                                <Button Grid.Column="2"
                                        Content="üóëÔ∏è"
                                        Width="40"
                                        Height="40"
                                        Background="#E74C3C"
                                        Foreground="White"
                                        FontSize="18"
                                        BorderThickness="0"
                                        Cursor="Hand"
                                        ToolTip="Supprimer cette recette"
                                        Click="BtnSupprimerRecette_Click"
                                        Tag="{Binding}">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Background" Value="#E74C3C"/>
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="#C0392B"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>

                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListBox.ItemTemplate>

            </ListBox>
        </Border>

    </Grid>

</UserControl>

================================================================================
FILE: LoGeCui\Views\RecetteView.xaml.cs
================================================================================

Ôªøusing LoGeCuiShared.Models;
using LoGeCuiShared.Services;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;

namespace LoGeCui.Views
{
    public partial class RecettesView : UserControl
    {
        private ObservableCollection<Recette> _recettesAffichees = new();
        private List<Recette> _toutesLesRecettes = new();

        public RecettesView()
        {
            InitializeComponent();

            ListeRecettes.ItemsSource = _recettesAffichees;

            // Charge depuis Supabase d√®s que le contr√¥le est pr√™t
            Loaded += RecettesView_Loaded;
        }

        private async void RecettesView_Loaded(object sender, RoutedEventArgs e)
        {
            Loaded -= RecettesView_Loaded;
            await RefreshDepuisSupabaseAsync();
        }

        private async System.Threading.Tasks.Task RefreshDepuisSupabaseAsync()
        {
            if (App.RecipesService == null || App.CurrentUserId == null)
            {
                MessageBox.Show("Connecte-toi d'abord (services non initialis√©s).");
                return;
            }

            var recettes = await App.RecipesService.GetRecettesAsync(App.CurrentUserId.Value);

            _toutesLesRecettes = recettes ?? new List<Recette>();

            // Affichage initial = toutes
            _recettesAffichees.Clear();
            foreach (var r in _toutesLesRecettes)
                _recettesAffichees.Add(r);
        }

        private void BtnTous_Click(object sender, RoutedEventArgs e)
        {
            _recettesAffichees.Clear();
            foreach (var recette in _toutesLesRecettes)
                _recettesAffichees.Add(recette);
        }

        private void BtnEntrees_Click(object sender, RoutedEventArgs e) => FiltrerParType(TypePlat.Entree);
        private void BtnPlats_Click(object sender, RoutedEventArgs e) => FiltrerParType(TypePlat.Plat);
        private void BtnDesserts_Click(object sender, RoutedEventArgs e) => FiltrerParType(TypePlat.Dessert);

        private void FiltrerParType(TypePlat type)
        {
            _recettesAffichees.Clear();
            foreach (var recette in _toutesLesRecettes.Where(r => r.Type == type))
                _recettesAffichees.Add(recette);
        }

        private void ListeRecettes_DoubleClick(object sender, MouseButtonEventArgs e)
        {
            var recette = ListeRecettes.SelectedItem as Recette;
            if (recette != null)
                AfficherDetailsRecette(recette);
        }

        private async void AfficherDetailsRecette(Recette recette)
        {
            try
            {
                if (App.RestClient == null)
                {
                    MessageBox.Show("RestClient non initialis√©.");
                    return;
                }

                var ingSvc = new LoGeCuiShared.Services.RecetteIngredientsService(App.RestClient);
                var items = await ingSvc.GetForRecetteAsync(recette.Id);

                var ingredientsText = (items.Count == 0)
                    ? "(aucun ingr√©dient renseign√©)"
                    : string.Join("\n", items.Select(x =>
                        string.IsNullOrWhiteSpace(x.quantite) && string.IsNullOrWhiteSpace(x.unite)
                            ? $"  ‚Ä¢ {x.nom}"
                            : $"  ‚Ä¢ {x.quantite} {x.unite} {x.nom}".Replace("  ", " ").Trim()
                    ));

                MessageBox.Show(
                    $"üìñ {recette.Nom}\n\n" +
                    $"Cat√©gorie: {recette.CategorieDb}\n" +
                    $"Temps: {recette.TempsPreparation} minutes\n\n" +
                    $"Ingr√©dients:\n{ingredientsText}\n\n" +
                    $"Instructions:\n{recette.Instructions}",
                    "D√©tails de la recette",
                    MessageBoxButton.OK,
                    MessageBoxImage.Information);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur chargement ingr√©dients:\n{ex}");
            }
        }

        private async void BtnNouvelleRecette_Click(object sender, RoutedEventArgs e)
        {
            var dialog = new Dialogs.AjouterRecetteDialog();
            dialog.Owner = Window.GetWindow(this);

            bool? resultat = dialog.ShowDialog();
            if (resultat != true || dialog.NouvelleRecette == null)
                return;

            if (App.RecipesService == null || App.CurrentUserId == null)
            {
                MessageBox.Show("Connecte-toi d'abord (services non initialis√©s).");
                return;
            }

            var r = dialog.NouvelleRecette;

            if (string.IsNullOrWhiteSpace(r.ExternalId))
                r.ExternalId = System.Guid.NewGuid().ToString("N");

            await App.RecipesService.UpsertRecetteAsync(App.CurrentUserId.Value, r);

            // r√©cup√©rer recetteId DB (uuid) √† partir de ExternalId
            var recetteId = await App.RecipesService.GetRecetteIdByExternalIdAsync(r.ExternalId);
            if (recetteId == null) throw new Exception("Recette introuvable apr√®s upsert.");

            // envoyer ingr√©dients
            var ingSvc = new RecetteIngredientsService(App.RestClient!);
            var items = (r.Ingredients ?? new List<IngredientRecette>())
                .Select(i => (i.Nom, i.Quantite, i.Unite));

            await ingSvc.ReplaceForRecetteAsync(recetteId.Value, items);

            await RefreshDepuisSupabaseAsync();

            MessageBox.Show(
                $"La recette '{r.Nom}' a √©t√© ajout√©e avec succ√®s !",
                "Succ√®s",
                MessageBoxButton.OK,
                MessageBoxImage.Information);
        }

        private async void BtnSupprimerRecette_Click(object sender, RoutedEventArgs e)
        {
            var bouton = sender as Button;
            var recette = bouton?.Tag as Recette;

            if (recette == null)
                return;

            var resultat = MessageBox.Show(
                $"Voulez-vous vraiment supprimer la recette '{recette.Nom}' ?",
                "Confirmation de suppression",
                MessageBoxButton.YesNo,
                MessageBoxImage.Question);

            if (resultat != MessageBoxResult.Yes)
                return;

            try
            {
                if (App.RecipesService == null || App.CurrentUserId == null)
                {
                    MessageBox.Show("Connecte-toi d'abord (services non initialis√©s).");
                    return;
                }

                // Suppression c√¥t√© Supabase (il faut une m√©thode dans RecipesService)
                await App.RecipesService.DeleteRecetteAsync(recette.Id);

                await RefreshDepuisSupabaseAsync();

                MessageBox.Show(
                    $"La recette '{recette.Nom}' a √©t√© supprim√©e.",
                    "Suppression r√©ussie",
                    MessageBoxButton.OK,
                    MessageBoxImage.Information);
            }
            catch (System.Exception ex)
            {
                MessageBox.Show($"Erreur suppression :\n{ex}");
            }
        }

        private async void BtnSyncRecettes_Click(object sender, RoutedEventArgs e)
        {
            // En mode Supabase-first, ce bouton devient un "Rafra√Æchir"
            await RefreshDepuisSupabaseAsync();
            MessageBox.Show("Recettes recharg√©es depuis Supabase.");
        }
    }
}

================================================================================
FILE: LoGeCuiMobile\App.xaml
================================================================================

Ôªø<?xml version = "1.0" encoding = "UTF-8" ?>
<Application xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:LoGeCuiMobile"
             x:Class="LoGeCuiMobile.App">
    <Application.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="Resources/Styles/Colors.xaml" />
                <ResourceDictionary Source="Resources/Styles/Styles.xaml" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Application.Resources>
</Application>

================================================================================
FILE: LoGeCuiMobile\App.xaml.cs
================================================================================

Ôªøusing LoGeCuiMobile.Pages;
using LoGeCuiShared.Services;
using Microsoft.Maui.Storage;
using Microsoft.Maui.ApplicationModel;
using System;
using Microsoft.Extensions.Configuration;
using Microsoft.Maui.Storage;


namespace LoGeCuiMobile
{
    public partial class App : Application
    {
        public RecetteIngredientsService? RecetteIngredientsService { get; private set; }

        public SupabaseService? Supabase { get; private set; }
        public SupabaseRestClient? RestClient { get; private set; }

        public RecipesService? RecipesService { get; private set; }
        public IngredientsService? IngredientsService { get; private set; }
        public ListeCoursesSupabaseService? ListeCoursesSupabaseService { get; private set; }


        public Guid? CurrentUserId { get; private set; }
        public string OcrApiKey { get; private set; } = "";

        public bool IsConnected =>
            CurrentUserId != null &&
            RestClient != null &&
            RecipesService != null &&
            IngredientsService != null &&
            ListeCoursesSupabaseService != null;

        public App()
        {
            InitializeComponent();

            MainPage = RootPage.CreateLoginRoot();
            Init();
            Task.Run(async () =>
            {
                await InitConfigurationAsync();
                MainThread.BeginInvokeOnMainThread(Init);
            });
        }

        private IConfigurationRoot? _config;


        private void Init()
        {
            // SUPABASE (anon)
            var url = ConfigurationHelper.GetSupabaseUrl();
            var key = ConfigurationHelper.GetSupabaseKey();
            Supabase = new SupabaseService(url, key);

            // OCR (charg√©e UNE FOIS)
            try
            {
                OcrApiKey = ConfigurationHelper.GetOcrApiKey();
                System.Diagnostics.Debug.WriteLine($"‚úÖ OCR Key charg√©e: {OcrApiKey.Substring(0, 5)}...");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå ERREUR OCR: {ex.Message}");
                // Temporairement, hardcodez pour tester
                OcrApiKey = "K86867725288957"; // ‚ö†Ô∏è METTEZ VOTRE VRAIE CL√â ICI TEMPORAIREMENT
            }

            // ‚ùå PAS d‚Äôauto-login : nettoyage SYNCHRONE (API correcte)
            SecureStorage.Remove("sb_access_token");
            SecureStorage.Remove("sb_user_id");
        }

        // APPEL√â UNIQUEMENT APR√àS LOGIN
        public void OnLoginSuccess(string accessToken, string userId)
        {
            Supabase!.SetSession(accessToken, userId);
            CurrentUserId = Guid.Parse(userId);

            InitRestServices(accessToken);
            ShowAppShell();
        }

        private void InitRestServicesInternal(string accessToken)
        {
            var url = ConfigurationHelper.GetSupabaseUrl();
            var key = ConfigurationHelper.GetSupabaseKey();

            var client = new SupabaseRestClient(url, key);
            client.SetBearerToken(accessToken);

            RestClient = client;
            RecipesService = new RecipesService(client);
            IngredientsService = new IngredientsService(client);
            ListeCoursesSupabaseService = new ListeCoursesSupabaseService(client);
            // ‚úÖ AJOUTER CETTE LIGNE ICI
            RecetteIngredientsService = new RecetteIngredientsService(client);
        }

        private async Task InitConfigurationAsync()
        {
            using var stream = await FileSystem.OpenAppPackageFileAsync("appsettings.json");

            var builder = new ConfigurationBuilder()
                .AddJsonStream(stream);

            _config = builder.Build();

            
        }


        public void ShowAppShell()
        {
            if (!IsConnected)
            {
                ShowLogin();
                return;
            }

            MainThread.BeginInvokeOnMainThread(() =>
            {
                MainPage = new AppShell();
            });
        }

        // ‚úÖ M√âTHODE R√âTABLIE (utilis√©e ailleurs)
        public void ShowLogin()
        {
            MainThread.BeginInvokeOnMainThread(() =>
            {
                MainPage = RootPage.CreateLoginRoot();
            });
        }

        public void Logout()
        {
            SecureStorage.Remove("sb_access_token");
            SecureStorage.Remove("sb_user_id");

            Supabase?.ClearSession();
            CurrentUserId = null;
            RestClient = null;
            RecipesService = null;
            IngredientsService = null;
            ListeCoursesSupabaseService = null;

            ShowLogin();
        }

        // =========================
        // M√âTHODES DE COMPATIBILIT√â
        // (utilis√©es ailleurs dans l'app)
        // =========================

        // Ancien point d'entr√©e DeepLink (Android)
        public async Task HandleDeepLinkAsync(Uri uri)
        {
            // Tu peux garder la logique existante si elle est ailleurs.
            // Ici, on emp√™che juste le crash / erreur de compilation.
            await Task.CompletedTask;
        }

        // Ancien setter Supabase (appel√© depuis LoginPage)
        public void SetSupabase(SupabaseService supabase)
        {
            Supabase = supabase;
        }

        // Ancien setter UserId
        public void SetCurrentUserId(Guid userId)
        {
            CurrentUserId = userId;
        }

        // Ancienne m√©thode publique (appel√©e depuis LoginPage)
        public void InitRestServices(string accessToken)
        {
            // Appelle la m√©thode priv√©e existante
            InitRestServicesInternal(accessToken);
        }

        // üîí On renomme l'ancienne m√©thode priv√©e
       

    }
}







================================================================================
FILE: LoGeCuiMobile\appsettings.json
================================================================================

{
  "Supabase": {
    "Url": "https://wzctiypsadqktzcnswri.supabase.co",
    "Key": "sb_publishable_ZFk8ONON5qMA0vZ3V0nVAg_TZZrO1F1"
  },

  "OCR": {
    "ApiKey": "K86867725288957"
  }

}

================================================================================
FILE: LoGeCuiMobile\AppShell.xaml
================================================================================

<?xml version="1.0" encoding="UTF-8" ?>
<Shell
    x:Class="LoGeCuiMobile.AppShell"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:pages="clr-namespace:LoGeCuiMobile.Pages"
    FlyoutBehavior="Flyout">

    <FlyoutItem Title="Liste de course" Route="liste-courses">
        <ShellContent Route="liste-courses"
                      ContentTemplate="{DataTemplate pages:ListeCoursesPage}" />
    </FlyoutItem>

    <FlyoutItem Title="Mes Recettes" Route="mes-recettes">
        <ShellContent Route="mes-recettes"
                      ContentTemplate="{DataTemplate pages:MesRecettesPage}" />
    </FlyoutItem>

    <FlyoutItem Title="Menu Al√©atoire" Route="menu-aleatoire">
        <ShellContent Route="menu-aleatoire"
                      ContentTemplate="{DataTemplate pages:MenuAleatoirePage}" />
    </FlyoutItem>

    <FlyoutItem Title="Mes ingr√©dients" Route="mes-ingredients">
        <ShellContent Route="mes-ingredients"
                      ContentTemplate="{DataTemplate pages:MesIngredientsPage}" />
    </FlyoutItem>

    <FlyoutItem Title="Param√®tres" Route="settings">
        <ShellContent Route="settings"
                      ContentTemplate="{DataTemplate pages:SettingsPage}" />
    </FlyoutItem>

</Shell>


================================================================================
FILE: LoGeCuiMobile\AppShell.xaml.cs
================================================================================

Ôªøusing LoGeCuiMobile.Pages;
using LoGeCuiMobile; // si ForgotPasswordPage est √† la racine du projet

namespace LoGeCuiMobile;

public partial class AppShell : Shell
{
    public AppShell()
    {
        InitializeComponent();

        Routing.RegisterRoute(nameof(ListeCoursesPage), typeof(ListeCoursesPage));
        Routing.RegisterRoute(nameof(ForgotPasswordPage), typeof(ForgotPasswordPage));

    }
}

================================================================================
FILE: LoGeCuiMobile\ConfigurationHelper.cs
================================================================================

Ôªøusing Microsoft.Extensions.Configuration;
using Microsoft.Maui.Storage;
using System;
using System.IO;

namespace LoGeCuiMobile
{
    public static class ConfigurationHelper
    {
        private static IConfiguration? _configuration;
        private static readonly object _lock = new();

        private static IConfiguration Configuration
        {
            get
            {
                if (_configuration != null)
                    return _configuration;

                lock (_lock)
                {
                    if (_configuration != null)
                        return _configuration;

                    try
                    {
                        // Lire le fichier depuis le package MAUI
                        using var streamTask = FileSystem.OpenAppPackageFileAsync("appsettings.json");
                        streamTask.Wait();
                        using var stream = streamTask.Result;

                        // Copie en m√©moire pour √©viter tout souci de stream non seekable / lecture partielle
                        using var ms = new MemoryStream();
                        stream.CopyTo(ms);
                        ms.Position = 0;

                        var builder = new ConfigurationBuilder()
                            .AddJsonStream(ms);

                        _configuration = builder.Build();

#if DEBUG
                        System.Diagnostics.Debug.WriteLine("[CONFIG] appsettings.json charg√©");
                        System.Diagnostics.Debug.WriteLine("[CONFIG] Supabase:Url=" + (_configuration["Supabase:Url"] ?? "<null>"));
                        System.Diagnostics.Debug.WriteLine("[CONFIG] OCR:ApiKey present=" + (!string.IsNullOrWhiteSpace(_configuration["OCR:ApiKey"])));
#endif

                        return _configuration;
                    }
                    catch (Exception ex)
                    {
                        throw new Exception(
                            "Impossible de charger appsettings.json depuis le package MAUI. " +
                            "V√©rifie qu'il est bien dans LoGeCuiMobile, Build Action = MauiAsset, et que tu as fait Clean/Rebuild. " +
                            $"D√©tail: {ex.Message}", ex);
                    }
                }
            }
        }


        // =========================
        // SUPABASE
        // =========================

        public static string GetSupabaseUrl()
            => Configuration["Supabase:Url"]
               ?? throw new Exception("Supabase:Url manquant dans appsettings.json");

        public static string GetSupabaseKey()
            => Configuration["Supabase:Key"]
               ?? throw new Exception("Supabase:Key manquant dans appsettings.json");

        // =========================
        // OCR
        // =========================

        public static string GetOcrApiKey()
        {
            var key = Configuration["OCR:ApiKey"];

            if (string.IsNullOrWhiteSpace(key))
                throw new Exception("OCR:ApiKey manquant dans appsettings.json");

            return key;
        }
    }
}





================================================================================
FILE: LoGeCuiMobile\Converters\BoolToStrikethroughConverter.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;
using System.Globalization;

namespace LoGeCuiMobile.Converters
{
    public class BoolToStrikethroughConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
            => (value is bool b && b) ? TextDecorations.Strikethrough : TextDecorations.None;

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
            => throw new NotImplementedException();
    }
}

================================================================================
FILE: LoGeCuiMobile\ForgotPasswordPage.xaml
================================================================================

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="LoGeCuiMobile.ForgotPasswordPage"
    Title="Mot de passe oubli√©">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="12">

            <Label Text="Mot de passe oubli√©"
                   FontSize="20"
                   FontAttributes="Bold" />

            <Label Text="Entrez votre email pour recevoir un lien de r√©initialisation."
                   FontSize="14" />

            <Entry x:Name="EmailEntry"
                   Placeholder="Adresse email"
                   Keyboard="Email" />

            <Button x:Name="SendButton"
                    Text="Envoyer"
                    Clicked="OnSendClicked" />

            <Label x:Name="StatusLabel"
                   FontSize="13" />

            <Button Text="Retour"
                    Clicked="OnBackClicked" />

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>

================================================================================
FILE: LoGeCuiMobile\ForgotPasswordPage.xaml.cs
================================================================================

Ôªøusing LoGeCuiShared.Services;
using Microsoft.Maui.Controls;
using Microsoft.Maui.Graphics;
using System;

namespace LoGeCuiMobile
{
    // Optionnel : permet de pr√©-remplir l'email si tu navigues avec ?email=...
    [QueryProperty(nameof(PrefillEmail), "email")]
    public partial class ForgotPasswordPage : ContentPage
    {
        private readonly SupabaseService _supabaseService;

        // Valeur pass√©e via Shell : ?email=...
        public string PrefillEmail
        {
            set
            {
                // Evite crash si EmailEntry n'est pas encore pr√™t
                try
                {
                    var decoded = Uri.UnescapeDataString(value ?? "");
                    if (!string.IsNullOrWhiteSpace(decoded))
                        EmailEntry.Text = decoded;
                }
                catch { /* ignore */ }
            }
        }

        public ForgotPasswordPage()
        {
            InitializeComponent();

            var url = ConfigurationHelper.GetSupabaseUrl();
            var key = ConfigurationHelper.GetSupabaseKey();

            _supabaseService = new SupabaseService(url, key);

            StatusLabel.Text = "";
        }

        private async void OnSendClicked(object sender, EventArgs e)
        {
            try
            {
                // S√©curit√© si un contr√¥le est null (mauvais x:Name / x:Class)
                if (EmailEntry == null || SendButton == null || StatusLabel == null)
                {
                    await DisplayAlert("Erreur", "Interface non initialis√©e (XAML). V√©rifie x:Class et x:Name.", "OK");
                    return;
                }

                var email = (EmailEntry.Text ?? "").Trim();

                // ‚úÖ Validation obligatoire
                if (string.IsNullOrWhiteSpace(email) || !email.Contains("@") || !email.Contains("."))
                {
                    StatusLabel.TextColor = Colors.Red;
                    StatusLabel.Text = "Veuillez saisir une adresse email valide.";
                    return;
                }

                SendButton.IsEnabled = false;
                StatusLabel.TextColor = Colors.Black;
                StatusLabel.Text = "Envoi en cours‚Ä¶";

                var result = await _supabaseService.SendPasswordResetAsync(email);

                if (result.success)
                {
                    StatusLabel.TextColor = Colors.Green;
                    StatusLabel.Text = "Email envoy√© ‚úÖ V√©rifiez votre bo√Æte mail (et les spams).";
                }
                else
                {
                    StatusLabel.TextColor = Colors.Red;
                    StatusLabel.Text = result.error ?? "Impossible d'envoyer l'email.";
                }
            }
            catch (Exception ex)
            {
                // ‚úÖ √©vite le crash et donne une erreur lisible
                StatusLabel.TextColor = Colors.Red;
                StatusLabel.Text = "Erreur : " + ex.Message;
            }
            finally
            {
                if (SendButton != null)
                    SendButton.IsEnabled = true;
            }
        }

        private async void OnBackClicked(object sender, EventArgs e)
        {
            try
            {
                await Navigation.PopAsync();
            }
            catch
            {
                // au cas o√π
                await Shell.Current?.GoToAsync("..");
            }
        }
    }
}

================================================================================
FILE: LoGeCuiMobile\LoGeCuiMobile.csproj
================================================================================

Ôªø<Project Sdk="Microsoft.NET.Sdk">

	<PropertyGroup>
		<TargetFrameworks>net10.0-android;net10.0-ios;net10.0-maccatalyst</TargetFrameworks>
		<TargetFrameworks Condition="$([MSBuild]::IsOSPlatform('windows'))">$(TargetFrameworks);net10.0-windows10.0.19041.0</TargetFrameworks>

		<!-- Note for MacCatalyst:
		The default runtime is maccatalyst-x64, except in Release config, in which case the default is maccatalyst-x64;maccatalyst-arm64.
		When specifying both architectures, use the plural <RuntimeIdentifiers> instead of the singular <RuntimeIdentifier>.
		The Mac App Store will NOT accept apps with ONLY maccatalyst-arm64 indicated;
		either BOTH runtimes must be indicated or ONLY macatalyst-x64. -->
		<!-- For example: <RuntimeIdentifiers>maccatalyst-x64;maccatalyst-arm64</RuntimeIdentifiers> -->

		<OutputType>Exe</OutputType>
		<RootNamespace>LoGeCuiMobile</RootNamespace>
		<UseMaui>true</UseMaui>
		<SingleProject>true</SingleProject>
		<ImplicitUsings>enable</ImplicitUsings>
		<Nullable>enable</Nullable>

		<!-- Display name -->
		<ApplicationTitle>LoGeCuiMobile</ApplicationTitle>

		<!-- App Identifier -->
		<ApplicationId>com.companyname.logecuimobile</ApplicationId>

		<!-- Versions -->
		<ApplicationDisplayVersion>2.0.0</ApplicationDisplayVersion>
		<ApplicationVersion>6</ApplicationVersion>

		<!-- To develop, package, and publish an app to the Microsoft Store, see: https://aka.ms/MauiTemplateUnpackaged -->
		<WindowsPackageType>None</WindowsPackageType>

		<SupportedOSPlatformVersion Condition="$([MSBuild]::GetTargetPlatformIdentifier('$(TargetFramework)')) == 'ios'">15.0</SupportedOSPlatformVersion>
		<SupportedOSPlatformVersion Condition="$([MSBuild]::GetTargetPlatformIdentifier('$(TargetFramework)')) == 'maccatalyst'">15.0</SupportedOSPlatformVersion>
		<SupportedOSPlatformVersion Condition="$([MSBuild]::GetTargetPlatformIdentifier('$(TargetFramework)')) == 'android'">21.0</SupportedOSPlatformVersion>
		<SupportedOSPlatformVersion Condition="$([MSBuild]::GetTargetPlatformIdentifier('$(TargetFramework)')) == 'windows'">10.0.17763.0</SupportedOSPlatformVersion>
		<TargetPlatformMinVersion Condition="$([MSBuild]::GetTargetPlatformIdentifier('$(TargetFramework)')) == 'windows'">10.0.17763.0</TargetPlatformMinVersion>
		<AndroidSigningKeyStore>logecui.keystore</AndroidSigningKeyStore>
	</PropertyGroup>

	<PropertyGroup>
		<UserSecretsId>votre-guid-unique</UserSecretsId>
	</PropertyGroup>

	<PropertyGroup Condition="'$(Configuration)|$(TargetFramework)|$(Platform)'=='Debug|net10.0-android|AnyCPU'">
	  <AndroidKeyStore>True</AndroidKeyStore>
	  <AndroidSigningStorePass>LoGeCui2025</AndroidSigningStorePass>
	  <AndroidSigningKeyAlias>LoGeCui</AndroidSigningKeyAlias>
	  <AndroidSigningKeyPass>LoGeCui2025</AndroidSigningKeyPass>
	  <EmbedAssembliesIntoApk>False</EmbedAssembliesIntoApk>
	  <AndroidCreatePackagePerAbi>False</AndroidCreatePackagePerAbi>
	</PropertyGroup>

	<PropertyGroup Condition="'$(Configuration)|$(TargetFramework)|$(Platform)'=='Release|net10.0-android|AnyCPU'">
	  <AndroidKeyStore>True</AndroidKeyStore>
	  <AndroidSigningStorePass>LoGeCui2025</AndroidSigningStorePass>
	  <AndroidSigningKeyAlias>LoGeCui</AndroidSigningKeyAlias>
	  <AndroidSigningKeyPass>LoGeCui2025</AndroidSigningKeyPass>
	  <AndroidCreatePackagePerAbi>False</AndroidCreatePackagePerAbi>
	</PropertyGroup>

	<ItemGroup>
		<!-- App Icon -->
		<MauiIcon Include="Resources\AppIcon\postriticone.png" />

		<!-- Splash Screen -->
		<MauiSplashScreen Include="Resources\Splash\postriticone.png" Color="#FFFFFF" BaseSize="128,128" />

		<!-- Images -->
		<MauiImage Include="Resources\Images\*" />
		<MauiImage Update="Resources\Images\dotnet_bot.png" Resize="True" BaseSize="300,185" />
		
		<!-- Custom Fonts -->
		<MauiFont Include="Resources\Fonts\*" />

		<!-- Raw Assets (also remove the "Resources\Raw" prefix) -->
		<MauiAsset Include="Resources\Raw\**" LogicalName="%(RecursiveDir)%(Filename)%(Extension)" />
	</ItemGroup>

	<ItemGroup>
		<MauiAsset Include="appsettings.json">
		  <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
		</MauiAsset>
	</ItemGroup>

	<ItemGroup>
		<PackageReference Include="Microsoft.Extensions.Configuration.Json" Version="10.0.2" />
		<PackageReference Include="Microsoft.Maui.Controls" Version="10.0.30" />
		<PackageReference Include="Microsoft.Extensions.Logging.Debug" Version="10.0.2" />
		<PackageReference Include="SkiaSharp" Version="3.119.1" />
		<PackageReference Include="Supabase.Postgrest" Version="4.1.0" />
	</ItemGroup>

	<ItemGroup>
	  <ProjectReference Include="..\LoGeCuiShared\LoGeCuiShared.csproj" />
	</ItemGroup>

	<ItemGroup>
	  <MauiXaml Update="ForgotPasswordPage.xaml">
	    <Generator>MSBuild:Compile</Generator>
	  </MauiXaml>
	  <MauiXaml Update="LoginPage.xaml">
	    <Generator>MSBuild:Compile</Generator>
	  </MauiXaml>
	  <MauiXaml Update="Pages\AjouterIngredientPage.xaml">
	    <Generator>MSBuild:Compile</Generator>
	  </MauiXaml>
	  <MauiXaml Update="Pages\AjouterRecettePage.xaml">
	    <Generator>MSBuild:Compile</Generator>
	  </MauiXaml>
	  <MauiXaml Update="Pages\ListeCoursesPage.xaml">
	    <Generator>MSBuild:Compile</Generator>
	  </MauiXaml>
	  <MauiXaml Update="Pages\MenuAleatoirePage.xaml">
	    <Generator>MSBuild:Compile</Generator>
	  </MauiXaml>
	  <MauiXaml Update="Pages\MesIngredientsPage.xaml">
	    <Generator>MSBuild:Compile</Generator>
	  </MauiXaml>
	  <MauiXaml Update="Pages\MesRecettesPage.xaml">
	    <Generator>MSBuild:Compile</Generator>
	  </MauiXaml>
	  <MauiXaml Update="Pages\ResetPasswordPage.xaml">
	    <Generator>MSBuild:Compile</Generator>
	  </MauiXaml>
	  <MauiXaml Update="Pages\SettingsPage.xaml">
	    <Generator>MSBuild:Compile</Generator>
	  </MauiXaml>
	</ItemGroup>

	<ItemGroup>
	  <Folder Include="Platforms\Android\Resources\Raw\" />
	</ItemGroup>

</Project>

================================================================================
FILE: LoGeCuiMobile\LoginPage.xaml
================================================================================

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Class="LoGeCuiMobile.Pages.LoginPage"
             Title="LoGeCui - Connexion"
             BackgroundColor="#F5F5F5">

    <ScrollView>
        <VerticalStackLayout Padding="30" Spacing="20" VerticalOptions="Center">

            <!-- Logo / Titre -->
            <Label Text="üõí LoGeCui"
                   FontSize="48"
                   FontAttributes="Bold"
                   HorizontalOptions="Center"
                   TextColor="#27AE60"
                   Margin="0,0,0,40"/>

            <!-- Email -->
            <Label Text="Email :"
                   FontAttributes="Bold"
                   FontSize="16"/>
            <Entry x:Name="TxtEmail"
                   Placeholder="votre.email@example.com"
                   Keyboard="Email"
                   FontSize="16"
                   BackgroundColor="White"/>

            <!-- Mot de passe -->
            <Label Text="Mot de passe :"
                   FontAttributes="Bold"
                   FontSize="16"/>
            <Grid ColumnDefinitions="*, Auto"
                  BackgroundColor="White">

                <Entry x:Name="TxtPassword"
                       Placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                       IsPassword="True"
                       FontSize="16"
                       BackgroundColor="White"/>

                <Button Grid.Column="1"
                        Text="üëÅ"
                        FontSize="18"
                        BackgroundColor="Transparent"
                        Clicked="TogglePassword"/>


            </Grid>

            <!-- Bouton Connexion -->
            <Button x:Name="BtnConnexion"
                    Text="Se connecter"
                    BackgroundColor="#27AE60"
                    TextColor="White"
                    FontSize="18"
                    FontAttributes="Bold"
                    HeightRequest="50"
                    CornerRadius="10"
                    Clicked="BtnConnexion_Clicked"/>

            <!-- Bouton Inscription -->
            <Button x:Name="BtnInscription"
                    Text="Cr√©er un compte"
                    BackgroundColor="#3498DB"
                    TextColor="White"
                    FontSize="18"
                    FontAttributes="Bold"
                    HeightRequest="50"
                    CornerRadius="10"
                    Clicked="BtnInscription_Clicked"/>

            <!-- Message -->
            <Label x:Name="TxtMessage"
                   TextColor="Red"
                   FontSize="14"
                   HorizontalOptions="Center"
                   HorizontalTextAlignment="Center"
                   IsVisible="False"/>

            <Button Text="Mot de passe oubli√© ?"
                    FontSize="14"
                    TextColor="Blue"
                    BackgroundColor="Transparent"
                    Clicked="BtnForgotPassword_Clicked"/>

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>

================================================================================
FILE: LoGeCuiMobile\LoginPage.xaml.cs
================================================================================

Ôªøusing LoGeCuiShared.Services;
using Microsoft.Maui.Storage;
using LoGeCuiMobile; // si ForgotPasswordPage est √† la racine du projet

namespace LoGeCuiMobile.Pages
{
    public partial class LoginPage : ContentPage
    {
        private readonly SupabaseService _supabase;

        private bool _isPasswordVisible = false;

        public LoginPage()
        {
            InitializeComponent();

            var url = ConfigurationHelper.GetSupabaseUrl();
            var key = ConfigurationHelper.GetSupabaseKey();

            _supabase = new SupabaseService(url, key);
        }

        private async void BtnConnexion_Clicked(object sender, EventArgs e)
        {
            try
            {
                SetStatus("Connexion en cours...", Colors.Blue);

                var email = TxtEmail.Text?.Trim() ?? "";
                var password = TxtPassword.Text ?? "";

                if (string.IsNullOrWhiteSpace(email) || string.IsNullOrWhiteSpace(password))
                {
                    SetStatus("Veuillez remplir tous les champs.", Colors.Red);
                    return;
                }

                var (success, accessToken, userId, error) =
                    await _supabase.SignInAsync(email, password);

                System.Diagnostics.Debug.WriteLine("ACCESS_TOKEN=" + accessToken);


                if (!success)
                {
                    SetStatus(error ?? "Erreur de connexion", Colors.Red);
                    await Application.Current.MainPage.DisplayAlert("DEBUG", "Bouton cliqu√©", "OK");

                    return;
                }

                // 1) Sauvegarde session pour d√©sinscription / relance app
                await SecureStorage.SetAsync("sb_access_token", accessToken ?? "");
                await SecureStorage.SetAsync("sb_user_id", userId ?? "");

                // 2) Assure que le SupabaseService a bien la session (utile pour DeleteAccountAsync)
                _supabase.SetSession(accessToken!, userId!);

                // 3) Mise √† dispo pour le reste de l'app + bascule Shell
                var app = (App)Application.Current;
                app.SetSupabase(_supabase);
                app.SetCurrentUserId(Guid.Parse(userId!));
                app.InitRestServices(accessToken!);
                app.ShowAppShell();
            }
            catch (Exception ex)
            {
                SetStatus($"Erreur : {ex.Message}", Colors.Red);
            }
        }

        private async void BtnForgotPassword_Clicked(object sender, EventArgs e)
        {
            try
            {
                await Navigation.PushAsync(new ForgotPasswordPage());
            }
            catch (Exception ex)
            {
                await DisplayAlert("Erreur", ex.ToString(), "OK");
            }
        }



        private async void BtnInscription_Clicked(object sender, EventArgs e)
        {
            try
            {
                SetStatus("Cr√©ation du compte...", Colors.Blue);

                var email = TxtEmail.Text?.Trim() ?? "";
                var password = TxtPassword.Text ?? "";

                if (string.IsNullOrWhiteSpace(email) || string.IsNullOrWhiteSpace(password))
                {
                    SetStatus("Veuillez remplir tous les champs.", Colors.Red);
                    return;
                }

                var (success, accessToken, userId, error) =
                    await _supabase.SignUpThenSignInAsync(email, password);

                if (!success)
                {
                    SetStatus(error ?? "Erreur lors de l'inscription", Colors.Red);
                    return;
                }

                // Sauvegarde session
                await SecureStorage.SetAsync("sb_access_token", accessToken ?? "");
                await SecureStorage.SetAsync("sb_user_id", userId ?? "");

                _supabase.SetSession(accessToken!, userId!);

                var app = (App)Application.Current;
                app.SetSupabase(_supabase);
                app.SetCurrentUserId(Guid.Parse(userId!));
                app.InitRestServices(accessToken!);
                app.ShowAppShell();
            }
            catch (Exception ex)
            {
                SetStatus($"Erreur : {ex.Message}", Colors.Red);
            }
        }

        private void TogglePassword(object sender, EventArgs e)
        {
            _isPasswordVisible = !_isPasswordVisible;

            // Affiche/masque le mot de passe
            TxtPassword.IsPassword = !_isPasswordVisible;

            // Optionnel: change l'ic√¥ne texte
            if (sender is Button btn)
                btn.Text = _isPasswordVisible ? "üôà" : "üëÅ";

            // Optionnel Android: force refresh / curseur fin
            if (!string.IsNullOrEmpty(TxtPassword.Text))
            {
                var t = TxtPassword.Text;
                TxtPassword.Text = string.Empty;
                TxtPassword.Text = t;
            }
        }


        private void SetStatus(string message, Color color)
        {
            TxtMessage.Text = message;
            TxtMessage.TextColor = color;
            TxtMessage.IsVisible = true;
        }
    }
}




================================================================================
FILE: LoGeCuiMobile\MainPage.xaml
================================================================================

Ôªø<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="LoGeCuiMobile.MainPage">

    <ScrollView>
        <VerticalStackLayout
            Padding="30,0"
            Spacing="25">
            <Image
                Source="dotnet_bot.png"
                HeightRequest="185"
                Aspect="AspectFit"
                SemanticProperties.Description="dot net bot in a submarine number ten" />

            <Label
                Text="Hello, World!"
                Style="{StaticResource Headline}"
                SemanticProperties.HeadingLevel="Level1" />

            <Label
                Text="Welcome to &#10;.NET Multi-platform App UI"
                Style="{StaticResource SubHeadline}"
                SemanticProperties.HeadingLevel="Level2"
                SemanticProperties.Description="Welcome to dot net Multi platform App U I" />

            <Button
                x:Name="CounterBtn"
                Text="Click me" 
                SemanticProperties.Hint="Counts the number of times you click"
                Clicked="OnCounterClicked"
                HorizontalOptions="Fill" />
        </VerticalStackLayout>
    </ScrollView>

</ContentPage>

================================================================================
FILE: LoGeCuiMobile\MainPage.xaml.cs
================================================================================

Ôªønamespace LoGeCuiMobile
{
    public partial class MainPage : ContentPage
    {
        int count = 0;

        public MainPage()
        {
            InitializeComponent();
        }

        private void OnCounterClicked(object? sender, EventArgs e)
        {
            count++;

            if (count == 1)
                CounterBtn.Text = $"Clicked {count} time";
            else
                CounterBtn.Text = $"Clicked {count} times";

            SemanticScreenReader.Announce(CounterBtn.Text);
        }
    }
}

================================================================================
FILE: LoGeCuiMobile\MauiProgram.cs
================================================================================

Ôªøusing System;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
using Microsoft.Maui.Storage;

namespace LoGeCuiMobile
{
    public static class MauiProgram
    {
        public static IConfiguration Configuration { get; private set; } = new ConfigurationBuilder().Build();

        public static MauiApp CreateMauiApp()
        {
            var builder = MauiApp.CreateBuilder();

            builder
                .UseMauiApp<App>()
                .ConfigureFonts(fonts =>
                {
                    fonts.AddFont("OpenSans-Regular.ttf", "OpenSansRegular");
                    fonts.AddFont("OpenSans-Semibold.ttf", "OpenSansSemibold");
                });

#if DEBUG
            builder.Logging.AddDebug();
#endif

            // ‚úÖ Charge appsettings.json (MauiAsset) sans faire crasher l'app si absent
            try
            {
                using var stream = FileSystem.OpenAppPackageFileAsync("appsettings.json")
                                             .GetAwaiter()
                                             .GetResult();

                builder.Configuration.AddJsonStream(stream);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine("========== CONFIG ERROR ==========");
                System.Diagnostics.Debug.WriteLine("Impossible de charger appsettings.json depuis le package MAUI.");
                System.Diagnostics.Debug.WriteLine(ex.ToString());
                System.Diagnostics.Debug.WriteLine("==================================");
                // On continue volontairement pour √©viter le crash.
            }

            Configuration = builder.Configuration;

            // ‚úÖ IMPORTANT: on force le namespace exact (√©vite conflits)
            try
            {
                LoGeCuiShared.Services.ConfigurationHelper.Configure(key => Configuration[key]);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine("========== CONFIGHELPER ERROR ==========");
                System.Diagnostics.Debug.WriteLine(ex.ToString());
                System.Diagnostics.Debug.WriteLine("========================================");
                // On continue; l'erreur r√©elle ressortira quand une cl√© sera demand√©e.
            }

            return builder.Build();
        }
    }
}


================================================================================
FILE: LoGeCuiMobile\Pages\AjouterIngredientPage.xaml
================================================================================

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="LoGeCuiMobile.Pages.AjouterIngredientPage"
    Title="Ajouter un ingr√©dient">

    <VerticalStackLayout Padding="20" Spacing="14">

        <Entry
            x:Name="NomEntry"
            Placeholder="Nom de l‚Äôingr√©dient" />

        <Entry
            x:Name="QuantiteEntry"
            Placeholder="Quantit√© (ex: 10)"
            Keyboard="Numeric" />

        <Entry
            x:Name="UniteEntry"
            Placeholder="Unit√© (ex: kg, pi√®ces)" />

        <HorizontalStackLayout Spacing="10">
            <CheckBox x:Name="DisponibleCheckBox" IsChecked="True"/>
            <Label Text="Disponible"
                   VerticalTextAlignment="Center"/>
        </HorizontalStackLayout>

        <Button
            Text="üíæ Enregistrer"
            BackgroundColor="#28a745"
            TextColor="White"
            Clicked="OnSaveClicked"/>

    </VerticalStackLayout>
</ContentPage>

================================================================================
FILE: LoGeCuiMobile\Pages\AjouterIngredientPage.xaml.cs
================================================================================

using LoGeCuiShared.Models;
using Microsoft.Maui.Controls;

namespace LoGeCuiMobile.Pages;

[QueryProperty(nameof(Result), "result")]
public partial class AjouterIngredientPage : ContentPage
{
    public Ingredient? Result { get; set; }

    public AjouterIngredientPage()
    {
        InitializeComponent();
    }

    private async void OnSaveClicked(object sender, EventArgs e)
    {
        if (string.IsNullOrWhiteSpace(NomEntry.Text))
        {
            await DisplayAlert("Erreur", "Le nom est obligatoire.", "OK");
            return;
        }

        Result = new Ingredient
        {
            Nom = NomEntry.Text.Trim(),
            Quantite = QuantiteEntry.Text?.Trim() ?? "",
            Unite = UniteEntry.Text?.Trim() ?? "",
            EstDisponible = DisponibleCheckBox.IsChecked
        };

        // retour vers la page prÔøΩcÔøΩdente
        await Shell.Current.GoToAsync("..");
    }
}


================================================================================
FILE: LoGeCuiMobile\Pages\AjouterRecettePage.xaml
================================================================================

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="LoGeCuiMobile.Pages.AjouterRecettePage"
             Title="Ajouter une recette">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="12">

            <Label Text="Nom" />
            <Entry x:Name="NomEntry" Placeholder="Nom de la recette" />

            <Label Text="Cat√©gorie" />
            <Picker x:Name="CategoriePicker" />

            <Label Text="Temps (minutes)" />
            <Entry x:Name="TempsEntry" Keyboard="Numeric" />

            <Label Text="Ingr√©dients (1 par ligne)" />
            <Editor x:Name="IngredientsEditor" AutoSize="TextChanges" HeightRequest="140" />

            <Label Text="Instructions" />
            <Editor x:Name="InstructionsEditor" AutoSize="TextChanges" HeightRequest="180" />

            <Button Text="Scanner (OCR)" Clicked="OnScanClicked" />
            <Button Text="Enregistrer" Clicked="OnSaveClicked" />

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>


================================================================================
FILE: LoGeCuiMobile\Pages\AjouterRecettePage.xaml.cs
================================================================================

using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using LoGeCuiShared.Models;
using LoGeCuiShared.Services;
using LoGeCuiMobile.Services;
using Microsoft.Maui.ApplicationModel;
using Microsoft.Maui.Controls;
using Microsoft.Maui.Media;

namespace LoGeCuiMobile.Pages
{
    public partial class AjouterRecettePage : ContentPage
    {
        public AjouterRecettePage()
        {
            InitializeComponent();

            // Valeurs conformes ÔøΩ ta DB Supabase (Entree / Plat / Dessert)
            CategoriePicker.ItemsSource = new List<string> { "Entree", "Plat", "Dessert" };
            CategoriePicker.SelectedIndex = 1; // Plat par dÔøΩfaut
        }

        private async void OnSaveClicked(object sender, EventArgs e)
        {
            try
            {
                var app = (App)Application.Current;

                if (app.CurrentUserId == null || app.RecipesService == null)
                {
                    await DisplayAlert("Erreur", "Vous devez ÔøΩtre connectÔøΩ.", "OK");
                    return;
                }

                if (app.RecetteIngredientsService == null)
                {
                    await DisplayAlert("Erreur", "RecetteIngredientsService non initialisÔøΩ (InitRestServices).", "OK");
                    return;
                }

                if (string.IsNullOrWhiteSpace(NomEntry.Text))
                {
                    await DisplayAlert("Erreur", "Le nom est obligatoire.", "OK");
                    return;
                }

                var categorie = (CategoriePicker.SelectedItem as string) ?? "Plat";
                int temps = int.TryParse(TempsEntry.Text, out var t) ? t : 0;

                // ExternalId stable pour retrouver l'id aprÔøΩs upsert
                var externalId = Guid.NewGuid().ToString("N");

                var recette = new Recette
                {
                    Nom = NomEntry.Text.Trim(),
                    CategorieDb = categorie,
                    TempsPreparation = temps,
                    Difficulte = 1,
                    Instructions = InstructionsEditor.Text ?? "",
                    IsFavorite = false,
                    ExternalId = externalId
                };

                // 1) Upsert recette (table recettes)
                await app.RecipesService.UpsertRecetteAsync(app.CurrentUserId.Value, recette);

                // 2) RÔøΩcupÔøΩrer l'id rÔøΩel de la recette (UUID en DB) via ExternalId
                var recetteId = await app.RecipesService.GetRecetteIdByExternalIdAsync(externalId);
                if (recetteId == null)
                {
                    await DisplayAlert("Erreur", "Impossible de retrouver l'ID de la recette aprÔøΩs sauvegarde.", "OK");
                    return;
                }

                // 3) Parser les ingrÔøΩdients (1 par ligne)
                //    Format acceptÔøΩ: "pomme" OU "2 kg pomme" (simple)
                var lines = (IngredientsEditor.Text ?? "")
                    .Split('\n', StringSplitOptions.RemoveEmptyEntries)
                    .Select(l => l.Trim())
                    .Where(l => l.Length > 0)
                    .ToList();

                var items = new List<(string nom, string? quantite, string? unite)>();

                foreach (var line in lines)
                {
                    // Si vous ne gÔøΩrez pas quantite/unite maintenant, gardez simple:
                    // tout va dans ingredient_nom
                    items.Add((line, null, null));
                }

                // 4) ÔøΩcriture dans recette_ingredients (delete + insert)
                await app.RecetteIngredientsService.ReplaceForRecetteAsync(recetteId.Value, items);

                await DisplayAlert("OK", "Recette enregistrÔøΩe.", "OK");
                await Navigation.PopAsync();
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine(ex.ToString());
                await DisplayAlert("Erreur", ex.Message, "OK");
            }
        }


        // Transforme le texte du multi-line editor en liste (nom, quantite, unite)
        private static List<(string nom, string? quantite, string? unite)> ParseIngredientsEditor(string? text)
        {
            text ??= "";

            return text
                .Replace("\r\n", "\n")
                .Split('\n', StringSplitOptions.RemoveEmptyEntries)
                .Select(l => l.Trim())
                .Where(l => !string.IsNullOrWhiteSpace(l))
                .Select(ParseIngredientLine)
                .Where(x => !string.IsNullOrWhiteSpace(x.nom))
                .ToList();
        }

        // Supporte:
        // - "Tomate"
        // - "200 g Farine"
        // - "2 pcs Tomate"
        // - "Farine - 200 g" (si tu colles depuis ToString)
        private static (string nom, string? quantite, string? unite) ParseIngredientLine(string line)
        {
            // "Nom - Quantite Unite"
            var dashSplit = line.Split(" - ", StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
            if (dashSplit.Length >= 2)
            {
                var nomPart = dashSplit[0];
                var qtePart = dashSplit[1];

                var parts = qtePart.Split(' ', StringSplitOptions.RemoveEmptyEntries);
                if (parts.Length >= 2)
                    return (nomPart, parts[0], string.Join(" ", parts.Skip(1)));

                return (nomPart, qtePart, null);
            }

            // "200 g Farine"
            var tokens = line.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            if (tokens.Length >= 3 && char.IsDigit(tokens[0][0]))
            {
                var quantite = tokens[0];
                var unite = tokens[1];
                var nom = string.Join(" ", tokens.Skip(2));
                return (nom, quantite, unite);
            }

            // Sinon : juste le nom
            return (line, null, null);
        }

        private async void OnScanClicked(object sender, EventArgs e)
        {
            try
            {
                // Permission camÔøΩra (Android 6+)
                var status = await Permissions.CheckStatusAsync<Permissions.Camera>();
                if (status != PermissionStatus.Granted)
                    status = await Permissions.RequestAsync<Permissions.Camera>();

                if (status != PermissionStatus.Granted)
                {
                    await DisplayAlert("Permission", "L'accÔøΩs ÔøΩ la camÔøΩra est requis pour scanner.", "OK");
                    return;
                }

                // Capture supportÔøΩe ?
                if (!MediaPicker.Default.IsCaptureSupported)
                {
                    await DisplayAlert("Erreur", "Capture photo non supportÔøΩe sur cet appareil.", "OK");
                    return;
                }

                var photo = await MediaPicker.Default.CapturePhotoAsync(new MediaPickerOptions
                {
                    Title = "Scanner une recette"
                });

                if (photo == null)
                    return;

                byte[] bytes;
                using (var stream = await photo.OpenReadAsync())
                using (var ms = new MemoryStream())
                {
                    await stream.CopyToAsync(ms);
                    bytes = ms.ToArray();
                }

                Debug.WriteLine($"Image originale: {bytes.Length / 1024} KB");

                // Compression pour rester sous la limite OCR.Space (souvent 1024 KB)
                bytes = ImageCompressionHelper.CompressJpeg(bytes, maxWidth: 1600, jpegQuality: 75);
                Debug.WriteLine($"Image compressÔøΩe: {bytes.Length / 1024} KB");

                // Si encore trop gros, on retente plus agressif automatiquement
                if (bytes.Length > 1024 * 1024)
                {
                    bytes = ImageCompressionHelper.CompressJpeg(bytes, maxWidth: 1200, jpegQuality: 65);
                    Debug.WriteLine($"Image recompressÔøΩe: {bytes.Length / 1024} KB");
                }

                if (bytes.Length > 1024 * 1024)
                {
                    await DisplayAlert(
                        "Erreur",
                        "L'image est toujours trop lourde (> 1 Mo) pour l'OCR. Essayez de cadrer plus serrÔøΩ ou baissez la rÔøΩsolution.",
                        "OK");
                    return;
                }

                // OCR
                var ocrKey = LoGeCuiShared.Services.ConfigurationHelper.GetOcrApiKey();
                var ocr = new OcrService(ocrKey);

                var fullText = await ocr.ExtractTextFromImageAsync(bytes, photo.FileName);

                if (string.IsNullOrWhiteSpace(fullText))
                {
                    await DisplayAlert("OCR", "Aucun texte dÔøΩtectÔøΩ. Essayez avec plus de lumiÔøΩre et sans flou.", "OK");
                    return;
                }

                fullText = NormalizeOcrText(fullText);

                var (ingredients, instructions) = SplitRecipeText(fullText);

                if (!string.IsNullOrWhiteSpace(instructions))
                    InstructionsEditor.Text = instructions.Trim();

                if (!string.IsNullOrWhiteSpace(ingredients))
                    IngredientsEditor.Text = ingredients.Trim();

                if (string.IsNullOrWhiteSpace(NomEntry.Text))
                {
                    var title = GuessTitle(fullText);
                    if (!string.IsNullOrWhiteSpace(title))
                        NomEntry.Text = title;
                }

                await DisplayAlert("OK", "Texte scannÔøΩ et champs prÔøΩ-remplis. VÔøΩrifiez et corrigez si besoin.", "OK");
            }
            catch (Exception ex)
            {
                var msg = ex.Message ?? "Erreur inconnue.";

                if (msg.Contains("File failed validation", StringComparison.OrdinalIgnoreCase) ||
                    msg.Contains("maximum permissible file size", StringComparison.OrdinalIgnoreCase) ||
                    msg.Contains("1024kb", StringComparison.OrdinalIgnoreCase))
                {
                    msg = "L'image dÔøΩpasse la limite (1 Mo) du service OCR. Essayez de recadrer plus serrÔøΩ ou compresser davantage.";
                }

                await DisplayAlert("Erreur", msg, "OK");
            }
        }

        private static string NormalizeOcrText(string s)
        {
            s = s.Replace("\r\n", "\n").Replace("\r", "\n");
            while (s.Contains("\n\n\n")) s = s.Replace("\n\n\n", "\n\n");
            return s.Trim();
        }

        private static (string ingredients, string instructions) SplitRecipeText(string text)
        {
            var lower = text.ToLowerInvariant();

            int idxIng = IndexOfAny(lower, "ingrÔøΩdients", "ingredients");
            int idxPrep = IndexOfAny(lower, "prÔøΩparation", "preparation", "instructions", "rÔøΩalisation", "realisation", "ÔøΩtapes", "etapes");

            if (idxIng >= 0 && idxPrep > idxIng)
            {
                var ingPart = text.Substring(idxIng, idxPrep - idxIng);
                var prepPart = text.Substring(idxPrep);

                ingPart = RemoveHeaderLine(ingPart);
                prepPart = RemoveHeaderLine(prepPart);

                return (CleanupListLike(ingPart), CleanupParagraph(prepPart));
            }

            if (idxPrep >= 0)
            {
                var before = text.Substring(0, idxPrep);
                var after = text.Substring(idxPrep);

                after = RemoveHeaderLine(after);
                return (CleanupListLike(before), CleanupParagraph(after));
            }

            var lines = text.Split('\n').Select(l => l.Trim()).Where(l => l.Length > 0).ToList();

            var ingLines = new List<string>();
            var instrLines = new List<string>();

            bool inInstructions = false;
            foreach (var line in lines)
            {
                if (!inInstructions && LooksLikeStep(line))
                    inInstructions = true;

                if (!inInstructions && LooksLikeIngredientLine(line))
                    ingLines.Add(line);
                else
                    instrLines.Add(line);
            }

            return (string.Join("\n", ingLines), string.Join("\n", instrLines));
        }

        private static int IndexOfAny(string haystack, params string[] needles)
        {
            int best = -1;
            foreach (var n in needles)
            {
                var i = haystack.IndexOf(n, StringComparison.OrdinalIgnoreCase);
                if (i >= 0 && (best < 0 || i < best)) best = i;
            }
            return best;
        }

        private static string RemoveHeaderLine(string block)
        {
            var lines = block.Replace("\r\n", "\n").Split('\n').ToList();
            if (lines.Count == 0) return block;
            lines.RemoveAt(0);
            return string.Join("\n", lines).Trim();
        }

        private static string CleanupListLike(string s)
        {
            var lines = s.Replace("\r\n", "\n").Split('\n')
                .Select(l => l.Trim())
                .Where(l => l.Length > 0)
                .Select(l => l.TrimStart('-', 'ÔøΩ', '*', 'ÔøΩ', 'ÔøΩ', 'ÔøΩ', ' '))
                .Where(l => l.Length > 0);

            return string.Join("\n", lines);
        }

        private static string CleanupParagraph(string s)
        {
            var lines = s.Replace("\r\n", "\n").Split('\n')
                .Select(l => l.Trim())
                .Where(l => l.Length > 0);

            return string.Join("\n", lines);
        }

        private static bool LooksLikeIngredientLine(string line)
        {
            if (line.StartsWith("-") || line.StartsWith("ÔøΩ") || line.StartsWith("*")) return true;

            var l = line.ToLowerInvariant();
            string[] units = { " g", "kg", " ml", "cl", " l", "cÔøΩs", "cas", "cÔøΩc", "cac", "cuillÔøΩre", "pincÔøΩe", "tranche", "sachet" };
            if (units.Any(u => l.Contains(u))) return true;

            if (char.IsDigit(line.FirstOrDefault())) return true;

            return false;
        }

        private static bool LooksLikeStep(string line)
        {
            var l = line.Trim();
            if (l.StartsWith("1)") || l.StartsWith("1.") ||
                l.StartsWith("ÔøΩtape", StringComparison.OrdinalIgnoreCase) ||
                l.StartsWith("Etape", StringComparison.OrdinalIgnoreCase))
                return true;

            if (l.Length >= 2 && char.IsDigit(l[0]) && (l[1] == ')' || l[1] == '.'))
                return true;

            return false;
        }

        private static string GuessTitle(string text)
        {
            var first = text.Split('\n').Select(l => l.Trim()).FirstOrDefault(l => l.Length > 0) ?? "";
            if (first.Length >= 3 && first.Length <= 50) return first;
            return "";
        }
    }
}

================================================================================
FILE: LoGeCuiMobile\Pages\ListeCoursesPage.xaml
================================================================================

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:conv="clr-namespace:LoGeCuiMobile.Converters"
             x:Class="LoGeCuiMobile.Pages.ListeCoursesPage"
             Title="üõí Liste de Courses">

    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:BoolToStrikethroughConverter x:Key="BoolToStrikethroughConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid Padding="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Label Grid.Row="0"
               Text="Ma liste de courses"
               FontSize="24"
               FontAttributes="Bold"
               HorizontalOptions="Center"
               Margin="0,10,0,10"/>

        <Grid Grid.Row="1" ColumnSpacing="10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Button Grid.Column="0"
                    Text="‚ûï Ajouter un article"
                    BackgroundColor="#27AE60"
                    TextColor="White"
                    FontAttributes="Bold"
                    Clicked="BtnAjouter_Clicked" />

            <Button Grid.Column="1"
                    x:Name="BtnSupprimerSelection"
                    Text="üóëÔ∏è Supprimer s√©lection"
                    BackgroundColor="#E67E22"
                    TextColor="White"
                    FontAttributes="Bold"
                    Clicked="BtnSupprimerSelection_Clicked"/>
        </Grid>

        <Label Grid.Row="2"
               x:Name="SelectionInfoLabel"
               Text=""
               TextColor="Gray"
               Margin="0,8,0,8"/>

        <CollectionView Grid.Row="3"
                        x:Name="ListeCourses"
                        SelectionMode="None">

            <CollectionView.EmptyView>
                <Label Text="Aucun article pour l'instant."
                       HorizontalOptions="Center"
                       Margin="0,20,0,0"
                       TextColor="Gray"/>
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Frame Margin="6"
               Padding="14"
               BackgroundColor="White"
               BorderColor="#DDDDDD"
               CornerRadius="12"
               HasShadow="True">

                        <VerticalStackLayout Spacing="8">

                            <!-- Nom -->
                            <Label Text="{Binding Nom}"
                       FontSize="18"
                       FontAttributes="Bold"
                       TextDecorations="{Binding EstAchete, Converter={StaticResource BoolToStrikethroughConverter}}"/>

                            <!-- Quantit√© -->
                            <Label FontSize="14"
                       TextColor="Gray">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="{Binding Quantite}"/>
                                        <Span Text=" "/>
                                        <Span Text="{Binding Unite}"/>
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>

                            <!-- Actions -->
                            <HorizontalStackLayout Spacing="20">

                                <!-- Achet√© -->
                                <HorizontalStackLayout Spacing="6">
                                    <CheckBox IsChecked="{Binding EstAchete, Mode=TwoWay}"
                                  CheckedChanged="CheckBox_CheckedChanged"/>
                                    <Label Text="Achet√©"
                               VerticalOptions="Center"/>
                                </HorizontalStackLayout>

                                <!-- S√©lection suppression -->
                                <HorizontalStackLayout Spacing="6">
                                    <CheckBox IsChecked="{Binding IsSelectedForDelete}"/>
                                    <Label Text="Supprimer"
                               VerticalOptions="Center"/>
                                </HorizontalStackLayout>

                            </HorizontalStackLayout>

                        </VerticalStackLayout>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>

        </CollectionView>
    </Grid>

</ContentPage>




================================================================================
FILE: LoGeCuiMobile\Pages\ListeCoursesPage.xaml.cs
================================================================================

Ôªøusing System;
using System.Collections.ObjectModel;
using System.Linq;
using LoGeCuiShared.Models;
using LoGeCuiShared.Services;
using LoGeCuiMobile.Models;

namespace LoGeCuiMobile.Pages
{
    public partial class ListeCoursesPage : ContentPage
    {
        private readonly ObservableCollection<ArticleCourseUi> _articles = new();
        private readonly SupabaseService _supabase;

        public ListeCoursesPage()
        {
            InitializeComponent();

            _supabase = ((App)Application.Current).Supabase
                ?? throw new InvalidOperationException("Supabase non initialis√©.");

            // Plus besoin de SelectionChanged / SelectedItems : on passe par IsSelectedForDelete
            BtnSupprimerSelection.Clicked += BtnSupprimerSelection_Clicked;

            ListeCourses.ItemsSource = _articles;

            // Bouton actif en permanence; il affichera un message si rien n‚Äôest coch√©
            BtnSupprimerSelection.IsEnabled = true;

            if (SelectionInfoLabel != null)
                SelectionInfoLabel.Text = "";

            ChargerDonnees();
        }

        private async void ChargerDonnees()
        {
            try
            {
                var articles = await _supabase.GetArticlesAsync();

                _articles.Clear();
                foreach (var a in articles)
                    _articles.Add(new ArticleCourseUi(a));

                if (SelectionInfoLabel != null)
                    SelectionInfoLabel.Text = "";
            }
            catch (Exception ex)
            {
                await DisplayAlert("Erreur", $"Impossible de charger : {ex.Message}", "OK");
            }
        }

        private async void BtnSupprimerSelection_Clicked(object sender, EventArgs e)
        {
            var selected = _articles.Where(a => a.IsSelectedForDelete).ToList();

            if (selected.Count == 0)
            {
                await DisplayAlert("Information", "Aucun article s√©lectionn√©.", "OK");
                return;
            }

            bool confirm = await DisplayAlert(
                "Confirmation",
                $"Supprimer {selected.Count} article(s) s√©lectionn√©(s) ?",
                "Oui",
                "Non");

            if (!confirm)
                return;

            try
            {
                foreach (var articleUi in selected)
                {
                    await _supabase.DeleteArticleAsync(articleUi.Id);
                    _articles.Remove(articleUi);
                }

                if (SelectionInfoLabel != null)
                    SelectionInfoLabel.Text = "";

                await DisplayAlert("Succ√®s", $"{selected.Count} article(s) supprim√©(s).", "OK");
            }
            catch (Exception ex)
            {
                await DisplayAlert("Erreur", $"Suppression impossible : {ex.Message}", "OK");
                ChargerDonnees();
            }
        }

        private async void CheckBox_CheckedChanged(object sender, CheckedChangedEventArgs e)
        {
            var checkbox = (CheckBox)sender;
            var articleUi = checkbox.BindingContext as ArticleCourseUi;
            if (articleUi == null) return;

            var article = articleUi.Model;

            checkbox.IsEnabled = false;
            var oldValue = !e.Value;

            try
            {
                await _supabase.UpdateArticleAsync(article.Id, article);
            }
            catch (Exception ex)
            {
                article.EstAchete = oldValue;
                checkbox.IsChecked = oldValue;

                await DisplayAlert("Erreur", $"Synchronisation √©chou√©e : {ex.Message}", "OK");
            }
            finally
            {
                checkbox.IsEnabled = true;
            }
        }

        private async void BtnAjouter_Clicked(object sender, EventArgs e)
        {
            string nom = await DisplayPromptAsync("Ajouter", "Nom de l'article :");
            if (string.IsNullOrWhiteSpace(nom))
                return;

            string quantite = await DisplayPromptAsync("Ajouter", "Quantit√© :");
            if (string.IsNullOrWhiteSpace(quantite))
                return;

            string unite = await DisplayPromptAsync("Ajouter", "Unit√© (g, kg, L, pi√®ces...) :");
            if (string.IsNullOrWhiteSpace(unite))
                return;

            try
            {
                var app = (App)Application.Current;
                if (app.CurrentUserId == null)
                {
                    await DisplayAlert("Erreur", "Vous devez √™tre connect√©.", "OK");
                    return;
                }

                var article = new ArticleCourse
                {
                    UserId = app.CurrentUserId.Value,
                    Nom = nom,
                    Quantite = quantite,
                    Unite = unite,
                    EstAchete = false
                };

                var added = await _supabase.AddArticleAsync(article);
                if (added != null)
                {
                    _articles.Add(new ArticleCourseUi(added));
                    await DisplayAlert("Succ√®s", $"'{added.Nom}' ajout√© !", "OK");
                }
            }
            catch (Exception ex)
            {
                await DisplayAlert("Erreur", $"Impossible d'ajouter : {ex.Message}", "OK");
            }
        }
    }
}

================================================================================
FILE: LoGeCuiMobile\Pages\MenuAleatoirePage.xaml
================================================================================

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="LoGeCuiMobile.Pages.MenuAleatoirePage"
             Title="Menu al√©atoire">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">

            <Button
                Text="üé≤ Menu al√©atoire"
                Clicked="OnMenuAleatoireClicked" />

            <Label
                x:Name="ResultLabel"
                Text="Appuyez sur le bouton pour g√©n√©rer un menu"
                FontSize="18"
                HorizontalTextAlignment="Center" />

            <!-- Bouton visible uniquement apr√®s g√©n√©ration si ingr√©dients manquants -->
            <Button x:Name="SendMissingButton"
                    Text="üõí Envoyer les ingr√©dients manquants dans la liste de courses"
                    Clicked="OnSendMissingClicked"
                    HorizontalOptions="FillAndExpand"
                    IsVisible="False"
                    IsEnabled="False" />

            <Button
                Text="üõí Ouvrir la liste de courses"
                Clicked="OnOpenListeCoursesClicked"
                HorizontalOptions="FillAndExpand" />

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>



================================================================================
FILE: LoGeCuiMobile\Pages\MenuAleatoirePage.xaml.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using LoGeCuiShared.Models;
using Microsoft.Maui.Controls;

namespace LoGeCuiMobile.Pages;

public partial class MenuAleatoirePage : ContentPage
{
    private static readonly Random _random = new();

    private List<string> _lastMissing = new();
    private Guid? _lastUserId;
    private bool _lastIngredientsKnown = false;

    public MenuAleatoirePage()
    {
        InitializeComponent();
        SendMissingButton.IsVisible = false;
        SendMissingButton.IsEnabled = false;
    }

    // ------------------ UTIL ------------------

    private static string Norm(string s)
    {
        if (string.IsNullOrWhiteSpace(s))
            return "";

        var normalized = s.Trim().ToLowerInvariant().Normalize(NormalizationForm.FormD);
        var sb = new StringBuilder();

        foreach (var c in normalized)
            if (CharUnicodeInfo.GetUnicodeCategory(c) != UnicodeCategory.NonSpacingMark)
                sb.Append(c);

        return sb.ToString();
    }

    private sealed class RecetteIngredientRow
    {
        public string? ingredient_nom { get; set; }
    }

    private async Task<List<string>> GetRecetteIngredientsAsync(App app, Guid recetteId)
    {
        if (app.RestClient == null)
            return new List<string>();

        // Sch√©ma confirm√© : recette_ingredients(recette_id, ingredient_nom, quantite, unite)
        var q = $"recette_ingredients?select=ingredient_nom&recette_id=eq.{recetteId}";

        var rows = await app.RestClient.GetAsync<List<RecetteIngredientRow>>(q)
                   ?? new List<RecetteIngredientRow>();

        return rows
            .Select(r => r.ingredient_nom ?? "")
            .Where(n => !string.IsNullOrWhiteSpace(n))
            .Distinct()
            .ToList();
    }

    private async Task<List<string>> GetUserIngredientsAsync(App app, Guid userId)
    {
        if (app.IngredientsService == null)
            return new List<string>();

        var rows = await app.IngredientsService.GetIngredientsAsync(userId)
                   ?? new List<Ingredient>();

        // On ne consid√®re que ceux disponibles
        return rows
            .Where(i => i.EstDisponible)
            .Select(i => i.Nom ?? "")
            .Where(n => !string.IsNullOrWhiteSpace(n))
            .Distinct()
            .ToList();
    }

    // ------------------ EVENTS ------------------

    private async void OnMenuAleatoireClicked(object sender, EventArgs e)
    {
        try
        {
            await RunMenuAleatoireAsync();
        }
        catch (Exception ex)
        {
            await DisplayAlert("Erreur", ex.Message, "OK");
        }
    }

    private async void OnOpenListeCoursesClicked(object sender, EventArgs e)
    {
        try
        {
            var app = Application.Current as App;
            if (app?.ListeCoursesSupabaseService == null)
            {
                await DisplayAlert("Erreur", "Service indisponible.", "OK");
                return;
            }

            await Shell.Current.GoToAsync(nameof(ListeCoursesPage));
        }
        catch (Exception ex)
        {
            await DisplayAlert("Erreur", ex.Message, "OK");
        }
    }

    private async void OnSendMissingClicked(object sender, EventArgs e)
    {
        try
        {
            var app = Application.Current as App;

            if (app?.ListeCoursesSupabaseService == null || app.CurrentUserId == null)
                return;

            if (!_lastIngredientsKnown || _lastMissing.Count == 0)
                return;

            bool confirm = await DisplayAlert(
                "Envoyer ?",
                "Il manque :\n- " + string.Join("\n- ", _lastMissing),
                "Oui",
                "Non");

            if (!confirm)
                return;

            await app.ListeCoursesSupabaseService.AddMissingAsync(
                app.CurrentUserId.Value,
                _lastMissing);

            SendMissingButton.IsEnabled = false;
            SendMissingButton.Text = "üõí Ingr√©dients envoy√©s";
        }
        catch (Exception ex)
        {
            await DisplayAlert("Erreur", ex.Message, "OK");
        }
    }

    // ------------------ LOGIQUE ------------------

    private async Task RunMenuAleatoireAsync()
    {
        var app = Application.Current as App;
        if (app == null)
            return;

        // Reset UI
        SendMissingButton.IsVisible = false;
        SendMissingButton.IsEnabled = false;
        SendMissingButton.Text = "üõí Envoyer les ingr√©dients manquants dans la liste de courses";
        _lastMissing = new List<string>();
        _lastIngredientsKnown = false;
        _lastUserId = app.CurrentUserId;

        if (app.CurrentUserId == null ||
            app.RestClient == null ||
            app.RecipesService == null ||
            app.IngredientsService == null ||
            app.ListeCoursesSupabaseService == null)
        {
            ResultLabel.Text = "Vous devez √™tre connect√©.";
            return;
        }

        var userId = app.CurrentUserId.Value;
        ResultLabel.Text = "G√©n√©ration du menu (Entr√©e / Plat / Dessert)‚Ä¶";

        // 1) Recettes utilisateur
        var recettes = await app.RecipesService.GetMyRecettesAsync();

        if (recettes == null || recettes.Count == 0)
        {
            ResultLabel.Text = "Aucune recette disponible.";
            return;
        }

        // 2) Par type (enum)
        var entrees = recettes.Where(r => r.Type == TypePlat.Entree).ToList();
        var plats = recettes.Where(r => r.Type == TypePlat.Plat).ToList();
        var desserts = recettes.Where(r => r.Type == TypePlat.Dessert).ToList();

        if (entrees.Count == 0 || plats.Count == 0 || desserts.Count == 0)
        {
            ResultLabel.Text =
                "Impossible de g√©n√©rer un menu Entr√©e/Plat/Dessert.\n\n" +
                $"Entr√©es: {entrees.Count}\nPlats: {plats.Count}\nDesserts: {desserts.Count}\n\n" +
                "V√©rifie que tes recettes ont bien 'categorie' = Entree / Plat / Dessert en DB.";
            return;
        }

        // 3) Tirage al√©atoire
        var entree = entrees[_random.Next(entrees.Count)];
        var plat = plats[_random.Next(plats.Count)];
        var dessert = desserts[_random.Next(desserts.Count)];

        // 4) Ingr√©dients utilisateur
        var userIngredients = await GetUserIngredientsAsync(app, userId);
        var userSet = userIngredients
            .Select(Norm)
            .Where(x => !string.IsNullOrWhiteSpace(x))
            .ToHashSet();

        // 5) Analyse recette (avec garde-fou si pas d'ingr√©dients en DB)
        async Task<(List<string> ingredients, List<string> missing, bool hasData)> AnalyzeAsync(Recette r)
        {
            var ingredients = await GetRecetteIngredientsAsync(app, r.Id);
            var distinct = ingredients
                .Where(s => !string.IsNullOrWhiteSpace(s))
                .Distinct()
                .ToList();

            if (distinct.Count == 0)
                return (distinct, new List<string>(), false);

            var missing = distinct
                .Where(i => !userSet.Contains(Norm(i)))
                .Distinct()
                .ToList();

            return (distinct, missing, true);
        }

        var entreeA = await AnalyzeAsync(entree);
        var platA = await AnalyzeAsync(plat);
        var dessertA = await AnalyzeAsync(dessert);

        // 6) Agr√©gation des manquants (uniquement si on a des donn√©es)
        var allHaveData = entreeA.hasData && platA.hasData && dessertA.hasData;

        if (allHaveData)
        {
            _lastMissing = entreeA.missing
                .Concat(platA.missing)
                .Concat(dessertA.missing)
                .Where(s => !string.IsNullOrWhiteSpace(s))
                .Distinct()
                .ToList();
            _lastIngredientsKnown = true;
        }
        else
        {
            _lastMissing = new List<string>();
            _lastIngredientsKnown = false;
        }

        // 7) UI
        var sb = new StringBuilder();

        sb.AppendLine("Menu g√©n√©r√© :");
        sb.AppendLine($"- {entree.TypeTexte} : {entree.Nom}");
        sb.AppendLine($"- {plat.TypeTexte} : {plat.Nom}");
        sb.AppendLine($"- {dessert.TypeTexte} : {dessert.Nom}");
        sb.AppendLine();

        void AppendRecetteBlock(Recette r, List<string> ingredients, List<string> missing, bool hasData)
        {
            sb.AppendLine($"{r.TypeTexte} ‚Äî {r.Nom}");

            if (!hasData)
            {
                sb.AppendLine("Ingr√©dients : (aucun ingr√©dient enregistr√© pour cette recette)");
                sb.AppendLine();
                return;
            }

            sb.AppendLine("Ingr√©dients :");
            foreach (var i in ingredients)
                sb.AppendLine("- " + i);

            if (missing.Count == 0)
            {
                sb.AppendLine("Manquants : aucun");
            }
            else
            {
                sb.AppendLine("Manquants :");
                foreach (var m in missing)
                    sb.AppendLine("- " + m);
            }

            sb.AppendLine();
        }

        AppendRecetteBlock(entree, entreeA.ingredients, entreeA.missing, entreeA.hasData);
        AppendRecetteBlock(plat, platA.ingredients, platA.missing, platA.hasData);
        AppendRecetteBlock(dessert, dessertA.ingredients, dessertA.missing, dessertA.hasData);

        if (!allHaveData)
        {
            sb.AppendLine("Impossible de calculer les ingr√©dients manquants : certaines recettes n‚Äôont pas d‚Äôingr√©dients enregistr√©s.");
            SendMissingButton.IsVisible = false;
            SendMissingButton.IsEnabled = false;
        }
        else if (_lastMissing.Count == 0)
        {
            sb.AppendLine("Tout est disponible. Aucun ingr√©dient manquant.");
            SendMissingButton.IsVisible = false;
            SendMissingButton.IsEnabled = false;
        }
        else
        {
            sb.AppendLine("Liste globale des ingr√©dients manquants :");
            foreach (var m in _lastMissing)
                sb.AppendLine("- " + m);

            SendMissingButton.IsVisible = true;
            SendMissingButton.IsEnabled = true;
        }

        ResultLabel.Text = sb.ToString();
    }
}

================================================================================
FILE: LoGeCuiMobile\Pages\MesIngredientsPage.xaml
================================================================================

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="LoGeCuiMobile.Pages.MesIngredientsPage"
    Title="Gestion des ingr√©dients">

    <Grid Padding="16" RowDefinitions="Auto,*" RowSpacing="12">

        <!-- Bouton ajouter -->
        <Button
            Grid.Row="0"
            Text="‚ûï Ajouter un ingr√©dient"
            BackgroundColor="#28a745"
            TextColor="White"
            Clicked="OnAddIngredientClicked" />

        <!-- Liste des ingr√©dients (scroll natif) -->
        <CollectionView
            Grid.Row="1"
            x:Name="IngredientsCollection"
            SelectionMode="Single"
            SelectionChanged="OnIngredientSelected">

            <CollectionView.ItemTemplate>
                <DataTemplate>

                    <Frame
                        Padding="12"
                        Margin="0,4"
                        BorderColor="#ddd"
                        CornerRadius="10">

                        <Grid ColumnDefinitions="*,Auto">

                            <VerticalStackLayout Spacing="4">

                                <Label
                                    Text="{Binding Nom}"
                                    FontSize="18"
                                    FontAttributes="Bold" />

                                <Label FontSize="14" TextColor="Gray">
                                    <Label.Text>
                                        <MultiBinding StringFormat="Quantit√© : {0} {1}">
                                            <Binding Path="Quantite"/>
                                            <Binding Path="Unite"/>
                                        </MultiBinding>
                                    </Label.Text>
                                </Label>

                                <HorizontalStackLayout Spacing="6">
                                    <CheckBox IsChecked="{Binding EstDisponible}" />
                                    <Label Text="Disponible" VerticalTextAlignment="Center"/>
                                </HorizontalStackLayout>

                            </VerticalStackLayout>

                            <Button
                                Grid.Column="1"
                                Text="üóë"
                                BackgroundColor="#e74c3c"
                                TextColor="White"
                                Clicked="OnDeleteIngredientClicked" />

                        </Grid>
                    </Frame>

                </DataTemplate>
            </CollectionView.ItemTemplate>

        </CollectionView>

    </Grid>
</ContentPage>


================================================================================
FILE: LoGeCuiMobile\Pages\MesIngredientsPage.xaml.cs
================================================================================

using System.Collections.ObjectModel;
using LoGeCuiShared.Models;

namespace LoGeCuiMobile.Pages;

public partial class MesIngredientsPage : ContentPage
{
    private ObservableCollection<Ingredient> _ingredients =
        new ObservableCollection<Ingredient>();

    public MesIngredientsPage()
    {
        InitializeComponent();

        // DonnÔøΩes de test (comme ta capture)
        _ingredients.Add(new Ingredient { Nom = "Chocolat", Quantite = "1", Unite = "piÔøΩces", EstDisponible = true });
        _ingredients.Add(new Ingredient { Nom = "Nutella", Quantite = "1", Unite = "boÔøΩtes", EstDisponible = true });
        _ingredients.Add(new Ingredient { Nom = "Pain", Quantite = "1", Unite = "kg", EstDisponible = true });
        _ingredients.Add(new Ingredient { Nom = "Poivre", Quantite = "1", Unite = "kg", EstDisponible = true });
        _ingredients.Add(new Ingredient { Nom = "Poulet", Quantite = "1", Unite = "piÔøΩces", EstDisponible = true });
        _ingredients.Add(new Ingredient { Nom = "Sel", Quantite = "10", Unite = "kg", EstDisponible = true });

        IngredientsCollection.ItemsSource = _ingredients;
    }

    private async void OnAddIngredientClicked(object sender, EventArgs e)
    {
        await Shell.Current.GoToAsync(nameof(AjouterIngredientPage));
    }

    private void OnDeleteIngredientClicked(object sender, EventArgs e)
    {
        if (sender is Button btn && btn.BindingContext is Ingredient ingredient)
        {
            _ingredients.Remove(ingredient);
        }
    }

    private void OnIngredientSelected(object sender, SelectionChangedEventArgs e)
    {
        if (e.CurrentSelection.FirstOrDefault() is Ingredient ingredient)
        {
            // Plus tard : voir les recettes liÔøΩes
            DisplayAlert("IngrÔøΩdient", ingredient.Nom, "OK");
            IngredientsCollection.SelectedItem = null;
        }
    }
}

================================================================================
FILE: LoGeCuiMobile\Pages\MesRecettesPage.xaml
================================================================================

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="LoGeCuiMobile.Pages.MesRecettesPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    Title="Mes Recettes">

    <Grid Padding="12" RowDefinitions="Auto,*" RowSpacing="10">

        <!-- Zone haute fixe -->
        <VerticalStackLayout Grid.Row="0" Spacing="10">

            <Picker Title="Cat√©gorie"
                    ItemsSource="{Binding Categories}"
                    SelectedItem="{Binding SelectedCategorie}" />

            <HorizontalStackLayout Spacing="10">
                <Button Text="Rafra√Æchir"
                        Command="{Binding RefreshCommand}"
                        HorizontalOptions="StartAndExpand" />

                <Button Text="Ajouter une recette"
                        Clicked="OnAjouterRecetteClicked"
                        HorizontalOptions="EndAndExpand" />
            </HorizontalStackLayout>

            <ActivityIndicator IsRunning="{Binding IsBusy}"
                               IsVisible="{Binding IsBusy}" />

        </VerticalStackLayout>

        <!-- Liste scrollable -->
        <CollectionView Grid.Row="1"
                        x:Name="RecettesCollection"
                        ItemsSource="{Binding Recettes}"
                        SelectionMode="None">

            <CollectionView.EmptyView>
                <Label Text="Aucune recette pour l'instant."
                       HorizontalTextAlignment="Center"
                       VerticalTextAlignment="Center"
                       Margin="0,30,0,0" />
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Frame Padding="10"
                           Margin="0,6"
                           BorderColor="LightGray"
                           HasShadow="False">

                        <Frame.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnRecetteTapped"
                                                  CommandParameter="{Binding .}" />
                        </Frame.GestureRecognizers>

                        <VerticalStackLayout Spacing="4">
                            <Label Text="{Binding Nom}"
                                   FontSize="18" />

                            <Label Text="{Binding TypeTexte}" />

                            <Label Text="{Binding TempsPreparation, StringFormat='Temps: {0} min'}" />

                            <Label Text="{Binding DifficulteTexte}" />
                        </VerticalStackLayout>

                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>

        </CollectionView>

    </Grid>
</ContentPage>

================================================================================
FILE: LoGeCuiMobile\Pages\MesRecettesPage.xaml.cs
================================================================================

Ôªøusing LoGeCuiMobile.ViewModels;
using LoGeCuiShared.Models;

namespace LoGeCuiMobile.Pages;

public partial class MesRecettesPage : ContentPage
{
    private MesRecettesViewModel? _vm;

    public MesRecettesPage()
    {
        InitializeComponent();

        var app = (App)Application.Current;

        if (app.RecipesService == null)
        {
            MainThread.BeginInvokeOnMainThread(async () =>
                await DisplayAlert(
                    "Erreur",
                    "RecipesService est NULL (InitRestServices n'a pas √©t√© appel√© apr√®s login).",
                    "OK"));

            return;
        }

        _vm = new MesRecettesViewModel(app.RecipesService);
        BindingContext = _vm;
    }

    protected override async void OnAppearing()
    {
        base.OnAppearing();

        if (_vm == null)
            return;

        await _vm.LoadAsync();
    }

    private async void OnAjouterRecetteClicked(object sender, EventArgs e)
    {
        await Navigation.PushAsync(new AjouterRecettePage());
    }

    // ‚úÖ Tap fiable sur une recette
    private async void OnRecetteTapped(object sender, TappedEventArgs e)
    {
        if (e.Parameter is not Recette recette)
            return;

        var app = (App)Application.Current;

        if (app.RecetteIngredientsService == null)
        {
            await DisplayAlert("Erreur", "RecetteIngredientsService non initialis√©.", "OK");
            return;
        }

        // üîé Charge les ingr√©dients depuis la table recette_ingredients
        var items = await app.RecetteIngredientsService.GetForRecetteAsync(recette.Id);

        var ingredientsText = (items.Count == 0)
            ? "(aucun ingr√©dient renseign√©)"
            : string.Join("\n", items.Select(x =>
                string.IsNullOrWhiteSpace(x.quantite) && string.IsNullOrWhiteSpace(x.unite)
                    ? $"‚Ä¢ {x.nom}"
                    : $"‚Ä¢ {x.quantite} {x.unite} {x.nom}".Replace("  ", " ").Trim()
            ));

        await DisplayAlert(
            recette.Nom,
            $"Cat√©gorie: {recette.CategorieDb}\n" +
            $"Temps: {recette.TempsPreparation} min\n\n" +
            $"Ingr√©dients:\n{ingredientsText}\n\n" +
            $"Instructions:\n{recette.Instructions}",
            "OK"
        );
    }
}

================================================================================
FILE: LoGeCuiMobile\Pages\ResetPasswordPage.xaml
================================================================================

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="LoGeCuiMobile.Pages.ResetPasswordPage"
             Title="R√©initialisation">
    <VerticalStackLayout Padding="24" Spacing="12">
        <Label Text="R√©initialiser votre mot de passe"
               FontSize="20"
               FontAttributes="Bold" />

        <Entry x:Name="Pwd1" IsPassword="True" Placeholder="Nouveau mot de passe" />
        <Entry x:Name="Pwd2" IsPassword="True" Placeholder="Confirmer le mot de passe" />

        <Button Text="Valider" Clicked="OnSubmit" />

        <Label x:Name="Msg" />
    </VerticalStackLayout>
</ContentPage>


================================================================================
FILE: LoGeCuiMobile\Pages\ResetPasswordPage.xaml.cs
================================================================================

Ôªøusing System.Collections.ObjectModel;
using LoGeCuiShared.Models;
using LoGeCuiShared.Services;

namespace LoGeCuiMobile.Pages;

public partial class ResetPasswordPage : ContentPage
{
    private readonly string _accessToken;
    private readonly SupabaseService _supabase;

    public ResetPasswordPage(string accessToken)
    {
        InitializeComponent();
        _accessToken = accessToken;

        string url = ConfigurationHelper.GetSupabaseUrl();
        string key = ConfigurationHelper.GetSupabaseKey();
        _supabase = new SupabaseService(url, key);
    }

    private async void OnSubmit(object sender, EventArgs e)
    {
        var p1 = Pwd1.Text ?? "";
        var p2 = Pwd2.Text ?? "";

        if (string.IsNullOrWhiteSpace(p1) || p1.Length < 6)
        {
            Msg.Text = "Le mot de passe doit contenir au moins 6 caract√®res.";
            Msg.TextColor = Colors.Red;
            return;
        }

        if (p1 != p2)
        {
            Msg.Text = "Les mots de passe ne correspondent pas.";
            Msg.TextColor = Colors.Red;
            return;
        }

        Msg.Text = "Mise √† jour en cours...";
        Msg.TextColor = Colors.Blue;

        var (success, error) = await _supabase.UpdatePasswordAsync(_accessToken, p1);

        if (success)
        {
            await DisplayAlert("‚úÖ Termin√©", "Votre mot de passe a √©t√© modifi√©. Vous pouvez vous connecter.", "OK");
            await Navigation.PopToRootAsync();
        }
        else
        {
            Msg.Text = error ?? "Impossible de modifier le mot de passe.";
            Msg.TextColor = Colors.Red;
        }
    }
}

================================================================================
FILE: LoGeCuiMobile\Pages\SettingsPage.xaml
================================================================================

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="LoGeCuiMobile.Pages.SettingsPage"
             Title="Param√®tres">

    <ScrollView>
        <VerticalStackLayout Padding="16" Spacing="16">

            <Label Text="Compte"
                   FontSize="18"
                   FontAttributes="Bold" />

            <Frame Padding="12"
                   CornerRadius="12"
                   BorderColor="#DDDDDD"
                   BackgroundColor="White"
                   HasShadow="True">
                <VerticalStackLayout Spacing="12">

                    <Button Text="D√©connexion"
                            BackgroundColor="#34495E"
                            TextColor="White"
                            FontAttributes="Bold"
                            Clicked="OnLogoutClicked" />

                    <Label Text="Zone dangereuse"
                           FontSize="14"
                           TextColor="Gray"
                           Margin="0,6,0,0" />

                    <Button Text="D√©sinscription"
                            BackgroundColor="IndianRed"
                            TextColor="White"
                            FontAttributes="Bold"
                            Clicked="OnDesinscriptionClicked" />

                </VerticalStackLayout>
            </Frame>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>

================================================================================
FILE: LoGeCuiMobile\Pages\SettingsPage.xaml.cs
================================================================================

Ôªøusing System;
using LoGeCuiShared.Services;
using Microsoft.Maui.Storage;

namespace LoGeCuiMobile.Pages;

public partial class SettingsPage : ContentPage
{
    public SettingsPage()
    {
        InitializeComponent();
    }

    private async void OnDesinscriptionClicked(object sender, EventArgs e)
    {
        bool confirm = await DisplayAlert(
            "D√©sinscription",
            "Es-tu s√ªr de vouloir supprimer ton compte ? Cette action est irr√©versible.",
            "Oui, supprimer",
            "Annuler");

        if (!confirm) return;

        var app = (App)Application.Current;

        if (app.Supabase == null)
        {
            await DisplayAlert("Erreur", "Supabase non initialis√©. Reconnectez-vous.", "OK");
            app.ShowLogin();
            return;
        }

        // 1) Lire la session stock√©e
        var token = await SecureStorage.GetAsync("sb_access_token");
        var userId = await SecureStorage.GetAsync("sb_user_id");

        
        System.Diagnostics.Debug.WriteLine($"TOKEN_START={token?.Substring(0, Math.Min(10, token.Length))}");
        System.Diagnostics.Debug.WriteLine($"TOKEN_LEN={token?.Length ?? 0}");
        System.Diagnostics.Debug.WriteLine($"APP_SUPABASE_URL={ConfigurationHelper.GetSupabaseUrl()}");

        if (string.IsNullOrWhiteSpace(token) || string.IsNullOrWhiteSpace(userId))
        {
            await DisplayAlert("Session", "Session absente/expir√©e. Veuillez vous reconnecter.", "OK");
            app.ShowLogin();
            return;
        }

        // 2) CRUCIAL : r√©injecter la session dans SupabaseService AVANT delete
        app.Supabase.SetSession(token, userId);

        // 3) Appel Edge Function
        var (ok, err) = await app.Supabase.DeleteAccountAsync();

        if (!ok)
        {
            await DisplayAlert("Erreur", $"Suppression impossible : {err}", "OK");

            // Si JWT invalide ‚Üí forcer reconnexion
            if (!string.IsNullOrWhiteSpace(err) &&
                err.Contains("Invalid JWT", StringComparison.OrdinalIgnoreCase))
            {
                app.ShowLogin();
            }

            return;
        }

        // Nettoyage local (bonne pratique apr√®s suppression)
        SecureStorage.Remove("sb_access_token");
        SecureStorage.Remove("sb_user_id");

        await DisplayAlert("OK", "Votre compte a √©t√© supprim√©.", "OK");
        app.ShowLogin();
    }

    private void OnLogoutClicked(object sender, EventArgs e)
    {
        var app = (App)Application.Current;

        app.Supabase?.ClearSession();

        SecureStorage.Remove("sb_access_token");
        SecureStorage.Remove("sb_user_id");

        app.ShowLogin();
    }
}





================================================================================
FILE: LoGeCuiMobile\Platforms\Android\AndroidManifest.xml
================================================================================

Ôªø<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
	<application android:allowBackup="true" android:icon="@mipmap/postriticone" android:supportsRtl="true"></application>
	<uses-permission android:name="android.permission.INTERNET" />
	<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
	<uses-permission android:name="android.permission.CAMERA" />
	<queries>
		<intent>
			<action android:name="android.intent.action.VIEW" />
			<data android:scheme="logecui" />
		</intent>
	</queries>
</manifest>

================================================================================
FILE: LoGeCuiMobile\Platforms\Android\MainActivity.cs
================================================================================

Ôªøusing Android.App;
using Android.Content;
using Android.Content.PM;
using Android.OS;
using Microsoft.Maui.Controls;

namespace LoGeCuiMobile
{
    [Activity(
        Theme = "@style/Maui.SplashTheme",
        MainLauncher = true,
        LaunchMode = LaunchMode.SingleTop,
        ConfigurationChanges = ConfigChanges.ScreenSize | ConfigChanges.Orientation | ConfigChanges.UiMode | ConfigChanges.ScreenLayout | ConfigChanges.SmallestScreenSize | ConfigChanges.Density)]

    // Configuration du Deep Link pour la confirmation email
    [IntentFilter(
        new[] { Intent.ActionView },
        Categories = new[] { Intent.CategoryDefault, Intent.CategoryBrowsable },
        DataScheme = "logecui",
        DataHost = "confirm",
        AutoVerify = true)]

    // Deep Link - reset password
    [IntentFilter(
        new[] { Intent.ActionView },
        Categories = new[] { Intent.CategoryDefault, Intent.CategoryBrowsable },
        DataScheme = "logecui",
        DataHost = "reset-password")]

    public class MainActivity : MauiAppCompatActivity
    {
        protected override void OnCreate(Bundle? savedInstanceState)
        {
            base.OnCreate(savedInstanceState);

            // G√©rer le deep link si l'app est lanc√©e via un lien
            HandleIntent(Intent);
        }

        protected override void OnNewIntent(Intent? intent)
        {
            base.OnNewIntent(intent);

            if (intent != null)
            {
                Intent = intent;
                HandleIntent(intent);
            }
        }

        private void HandleIntent(Intent? intent)
        {
            var data = intent?.DataString;
            if (string.IsNullOrEmpty(data))
                return;

            var uri = new Uri(data);

            MainThread.BeginInvokeOnMainThread(async () =>
            {
                if (Microsoft.Maui.Controls.Application.Current is App app)
                    await app.HandleDeepLinkAsync(uri);
            });
        }
    }
}

================================================================================
FILE: LoGeCuiMobile\Platforms\Android\MainApplication.cs
================================================================================

Ôªøusing Android.App;
using Android.Runtime;

namespace LoGeCuiMobile
{
    [Application]
    public class MainApplication : MauiApplication
    {
        public MainApplication(IntPtr handle, JniHandleOwnership ownership)
            : base(handle, ownership)
        {
        }

        protected override MauiApp CreateMauiApp() => MauiProgram.CreateMauiApp();
    }
}

================================================================================
FILE: LoGeCuiMobile\Platforms\Android\Resources\values\colors.xml
================================================================================

<?xml version="1.0" encoding="utf-8"?>
<resources>
    <color name="colorPrimary">#512BD4</color>
    <color name="colorPrimaryDark">#2B0B98</color>
    <color name="colorAccent">#2B0B98</color>
</resources>

================================================================================
FILE: LoGeCuiMobile\Platforms\iOS\AppDelegate.cs
================================================================================

Ôªøusing Foundation;

namespace LoGeCuiMobile
{
    [Register("AppDelegate")]
    public class AppDelegate : MauiUIApplicationDelegate
    {
        protected override MauiApp CreateMauiApp() => MauiProgram.CreateMauiApp();
    }
}

================================================================================
FILE: LoGeCuiMobile\Platforms\iOS\Program.cs
================================================================================

Ôªøusing ObjCRuntime;
using UIKit;

namespace LoGeCuiMobile
{
    public class Program
    {
        // This is the main entry point of the application.
        static void Main(string[] args)
        {
            // if you want to use a different Application Delegate class from "AppDelegate"
            // you can specify it here.
            UIApplication.Main(args, null, typeof(AppDelegate));
        }
    }
}

================================================================================
FILE: LoGeCuiMobile\Platforms\MacCatalyst\AppDelegate.cs
================================================================================

Ôªøusing Foundation;

namespace LoGeCuiMobile
{
    [Register("AppDelegate")]
    public class AppDelegate : MauiUIApplicationDelegate
    {
        protected override MauiApp CreateMauiApp() => MauiProgram.CreateMauiApp();
    }
}

================================================================================
FILE: LoGeCuiMobile\Platforms\MacCatalyst\Program.cs
================================================================================

Ôªøusing ObjCRuntime;
using UIKit;

namespace LoGeCuiMobile
{
    public class Program
    {
        // This is the main entry point of the application.
        static void Main(string[] args)
        {
            // if you want to use a different Application Delegate class from "AppDelegate"
            // you can specify it here.
            UIApplication.Main(args, null, typeof(AppDelegate));
        }
    }
}

================================================================================
FILE: LoGeCuiMobile\Platforms\Windows\App.xaml
================================================================================

Ôªø<maui:MauiWinUIApplication
    x:Class="LoGeCuiMobile.WinUI.App"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:maui="using:Microsoft.Maui"
    xmlns:local="using:LoGeCuiMobile.WinUI">

</maui:MauiWinUIApplication>

================================================================================
FILE: LoGeCuiMobile\Platforms\Windows\App.xaml.cs
================================================================================

Ôªøusing Microsoft.UI.Xaml;

// To learn more about WinUI, the WinUI project structure,
// and more about our project templates, see: http://aka.ms/winui-project-info.

namespace LoGeCuiMobile.WinUI
{
    /// <summary>
    /// Provides application-specific behavior to supplement the default Application class.
    /// </summary>
    public partial class App : MauiWinUIApplication
    {
        /// <summary>
        /// Initializes the singleton application object.  This is the first line of authored code
        /// executed, and as such is the logical equivalent of main() or WinMain().
        /// </summary>
        public App()
        {
            this.InitializeComponent();
        }

        protected override MauiApp CreateMauiApp() => MauiProgram.CreateMauiApp();
    }

}

================================================================================
FILE: LoGeCuiMobile\Properties\launchSettings.json
================================================================================

{
  "profiles": {
    "Windows Machine": {
      "commandName": "Project",
      "nativeDebugging": false
    }
  }
}

================================================================================
FILE: LoGeCuiMobile\Resources\Raw\AboutAssets.txt
================================================================================

ÔªøAny raw assets you want to be deployed with your application can be placed in
this directory (and child directories). Deployment of the asset to your application
is automatically handled by the following `MauiAsset` Build Action within your `.csproj`.

	<MauiAsset Include="Resources\Raw\**" LogicalName="%(RecursiveDir)%(Filename)%(Extension)" />

These files will be deployed with your package and will be accessible using Essentials:

	async Task LoadMauiAsset()
	{
		using var stream = await FileSystem.OpenAppPackageFileAsync("AboutAssets.txt");
		using var reader = new StreamReader(stream);

		var contents = reader.ReadToEnd();
	}

================================================================================
FILE: LoGeCuiMobile\Resources\Styles\Colors.xaml
================================================================================

Ôªø<?xml version="1.0" encoding="UTF-8" ?>
<ResourceDictionary 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml">

    <!-- Note: For Android please see also Platforms\Android\Resources\values\colors.xml -->

    <Color x:Key="Primary">#512BD4</Color>
    <Color x:Key="PrimaryDark">#ac99ea</Color>
    <Color x:Key="PrimaryDarkText">#242424</Color>
    <Color x:Key="Secondary">#DFD8F7</Color>
    <Color x:Key="SecondaryDarkText">#9880e5</Color>
    <Color x:Key="Tertiary">#2B0B98</Color>

    <Color x:Key="White">White</Color>
    <Color x:Key="Black">Black</Color>
    <Color x:Key="Magenta">#D600AA</Color>
    <Color x:Key="MidnightBlue">#190649</Color>
    <Color x:Key="OffBlack">#1f1f1f</Color>

    <Color x:Key="Gray100">#E1E1E1</Color>
    <Color x:Key="Gray200">#C8C8C8</Color>
    <Color x:Key="Gray300">#ACACAC</Color>
    <Color x:Key="Gray400">#919191</Color>
    <Color x:Key="Gray500">#6E6E6E</Color>
    <Color x:Key="Gray600">#404040</Color>
    <Color x:Key="Gray900">#212121</Color>
    <Color x:Key="Gray950">#141414</Color>

    <SolidColorBrush x:Key="PrimaryBrush" Color="{StaticResource Primary}"/>
    <SolidColorBrush x:Key="SecondaryBrush" Color="{StaticResource Secondary}"/>
    <SolidColorBrush x:Key="TertiaryBrush" Color="{StaticResource Tertiary}"/>
    <SolidColorBrush x:Key="WhiteBrush" Color="{StaticResource White}"/>
    <SolidColorBrush x:Key="BlackBrush" Color="{StaticResource Black}"/>

    <SolidColorBrush x:Key="Gray100Brush" Color="{StaticResource Gray100}"/>
    <SolidColorBrush x:Key="Gray200Brush" Color="{StaticResource Gray200}"/>
    <SolidColorBrush x:Key="Gray300Brush" Color="{StaticResource Gray300}"/>
    <SolidColorBrush x:Key="Gray400Brush" Color="{StaticResource Gray400}"/>
    <SolidColorBrush x:Key="Gray500Brush" Color="{StaticResource Gray500}"/>
    <SolidColorBrush x:Key="Gray600Brush" Color="{StaticResource Gray600}"/>
    <SolidColorBrush x:Key="Gray900Brush" Color="{StaticResource Gray900}"/>
    <SolidColorBrush x:Key="Gray950Brush" Color="{StaticResource Gray950}"/>
</ResourceDictionary>

================================================================================
FILE: LoGeCuiMobile\Resources\Styles\Styles.xaml
================================================================================

Ôªø<?xml version="1.0" encoding="UTF-8" ?>
<ResourceDictionary 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml">

    <Style TargetType="ActivityIndicator">
        <Setter Property="Color" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource White}}" />
    </Style>

    <Style TargetType="IndicatorView">
        <Setter Property="IndicatorColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray500}}"/>
        <Setter Property="SelectedIndicatorColor" Value="{AppThemeBinding Light={StaticResource Gray950}, Dark={StaticResource Gray100}}"/>
    </Style>

    <Style TargetType="Border">
        <Setter Property="Stroke" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray500}}" />
        <Setter Property="StrokeShape" Value="Rectangle"/>
        <Setter Property="StrokeThickness" Value="1"/>
    </Style>

    <Style TargetType="BoxView">
        <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource Gray950}, Dark={StaticResource Gray200}}" />
    </Style>

    <Style TargetType="Button">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource PrimaryDarkText}}" />
        <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
        <Setter Property="FontFamily" Value="OpenSansRegular"/>
        <Setter Property="FontSize" Value="14"/>
        <Setter Property="BorderWidth" Value="0"/>
        <Setter Property="CornerRadius" Value="8"/>
        <Setter Property="Padding" Value="14,10"/>
        <Setter Property="MinimumHeightRequest" Value="44"/>
        <Setter Property="MinimumWidthRequest" Value="44"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray950}, Dark={StaticResource Gray200}}" />
                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                    <VisualState x:Name="PointerOver" />
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="CheckBox">
        <Setter Property="Color" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource White}}" />
        <Setter Property="MinimumHeightRequest" Value="44"/>
        <Setter Property="MinimumWidthRequest" Value="44"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="Color" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="DatePicker">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
        <Setter Property="BackgroundColor" Value="Transparent" />
        <Setter Property="FontFamily" Value="OpenSansRegular"/>
        <Setter Property="FontSize" Value="14"/>
        <Setter Property="MinimumHeightRequest" Value="44"/>
        <Setter Property="MinimumWidthRequest" Value="44"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray500}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="Editor">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}" />
        <Setter Property="BackgroundColor" Value="Transparent" />
        <Setter Property="FontFamily" Value="OpenSansRegular"/>
        <Setter Property="FontSize" Value="14" />
        <Setter Property="PlaceholderColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray500}}" />
        <Setter Property="MinimumHeightRequest" Value="44"/>
        <Setter Property="MinimumWidthRequest" Value="44"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="Entry">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}" />
        <Setter Property="BackgroundColor" Value="Transparent" />
        <Setter Property="FontFamily" Value="OpenSansRegular"/>
        <Setter Property="FontSize" Value="14" />
        <Setter Property="PlaceholderColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray500}}" />
        <Setter Property="MinimumHeightRequest" Value="44"/>
        <Setter Property="MinimumWidthRequest" Value="44"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="ImageButton">
        <Setter Property="Opacity" Value="1" />
        <Setter Property="BorderColor" Value="Transparent"/>
        <Setter Property="BorderWidth" Value="0"/>
        <Setter Property="CornerRadius" Value="0"/>
        <Setter Property="MinimumHeightRequest" Value="44"/>
        <Setter Property="MinimumWidthRequest" Value="44"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="Opacity" Value="0.5" />
                        </VisualState.Setters>
                    </VisualState>
                    <VisualState x:Name="PointerOver" />
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="Label">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}" />
        <Setter Property="BackgroundColor" Value="Transparent" />
        <Setter Property="FontFamily" Value="OpenSansRegular" />
        <Setter Property="FontSize" Value="14" />
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="Label" x:Key="Headline">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource MidnightBlue}, Dark={StaticResource White}}" />
        <Setter Property="FontSize" Value="32" />
        <Setter Property="HorizontalOptions" Value="Center" />
        <Setter Property="HorizontalTextAlignment" Value="Center" />
    </Style>

    <Style TargetType="Label" x:Key="SubHeadline">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource MidnightBlue}, Dark={StaticResource White}}" />
        <Setter Property="FontSize" Value="24" />
        <Setter Property="HorizontalOptions" Value="Center" />
        <Setter Property="HorizontalTextAlignment" Value="Center" />
    </Style>

    <Style TargetType="Picker">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
        <Setter Property="TitleColor" Value="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray200}}" />
        <Setter Property="BackgroundColor" Value="Transparent" />
        <Setter Property="FontFamily" Value="OpenSansRegular"/>
        <Setter Property="FontSize" Value="14" />
        <Setter Property="MinimumHeightRequest" Value="44"/>
        <Setter Property="MinimumWidthRequest" Value="44"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                            <Setter Property="TitleColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="ProgressBar">
        <Setter Property="ProgressColor" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource White}}" />
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="ProgressColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="RadioButton">
        <Setter Property="BackgroundColor" Value="Transparent"/>
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}" />
        <Setter Property="FontFamily" Value="OpenSansRegular"/>
        <Setter Property="FontSize" Value="14"/>
        <Setter Property="MinimumHeightRequest" Value="44"/>
        <Setter Property="MinimumWidthRequest" Value="44"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="RefreshView">
        <Setter Property="RefreshColor" Value="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray200}}" />
    </Style>

    <Style TargetType="SearchBar">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
        <Setter Property="PlaceholderColor" Value="{StaticResource Gray500}" />
        <Setter Property="CancelButtonColor" Value="{StaticResource Gray500}" />
        <Setter Property="BackgroundColor" Value="Transparent" />
        <Setter Property="FontFamily" Value="OpenSansRegular" />
        <Setter Property="FontSize" Value="14" />
        <Setter Property="MinimumHeightRequest" Value="44"/>
        <Setter Property="MinimumWidthRequest" Value="44"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                            <Setter Property="PlaceholderColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="SearchHandler">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
        <Setter Property="PlaceholderColor" Value="{StaticResource Gray500}" />
        <Setter Property="BackgroundColor" Value="Transparent" />
        <Setter Property="FontFamily" Value="OpenSansRegular" />
        <Setter Property="FontSize" Value="14" />
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                            <Setter Property="PlaceholderColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="Shadow">
        <Setter Property="Radius" Value="15" />
        <Setter Property="Opacity" Value="0.5" />
        <Setter Property="Brush" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}" />
        <Setter Property="Offset" Value="10,10" />
    </Style>

    <Style TargetType="Slider">
        <Setter Property="MinimumTrackColor" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource White}}" />
        <Setter Property="MaximumTrackColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}" />
        <Setter Property="ThumbColor" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource White}}" />
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="MinimumTrackColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"/>
                            <Setter Property="MaximumTrackColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"/>
                            <Setter Property="ThumbColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"/>
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="SwipeItem">
        <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Black}}" />
    </Style>

    <Style TargetType="Switch">
        <Setter Property="OnColor" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource White}}" />
        <Setter Property="ThumbColor" Value="{StaticResource White}" />
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="OnColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                            <Setter Property="ThumbColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                    <VisualState x:Name="On">
                        <VisualState.Setters>
                            <Setter Property="OnColor" Value="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource Gray200}}" />
                            <Setter Property="ThumbColor" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource White}}" />
                        </VisualState.Setters>
                    </VisualState>
                    <VisualState x:Name="Off">
                        <VisualState.Setters>
                            <Setter Property="ThumbColor" Value="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="TimePicker">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
        <Setter Property="BackgroundColor" Value="Transparent"/>
        <Setter Property="FontFamily" Value="OpenSansRegular"/>
        <Setter Property="FontSize" Value="14"/>
        <Setter Property="MinimumHeightRequest" Value="44"/>
        <Setter Property="MinimumWidthRequest" Value="44"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>
  
    <!--
    <Style TargetType="TitleBar">
        <Setter Property="MinimumHeightRequest" Value="32"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="TitleActiveStates">
                    <VisualState x:Name="TitleBarTitleActive">
                        <VisualState.Setters>
                            <Setter Property="BackgroundColor" Value="Transparent" />
                            <Setter Property="ForegroundColor" Value="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}" />
                        </VisualState.Setters>
                    </VisualState>
                    <VisualState x:Name="TitleBarTitleInactive">
                        <VisualState.Setters>
                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Black}}" />
                            <Setter Property="ForegroundColor" Value="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>
    -->

    <Style TargetType="Page" ApplyToDerivedTypes="True">
        <Setter Property="Padding" Value="0"/>
        <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource OffBlack}}" />
    </Style>

    <Style TargetType="Shell" ApplyToDerivedTypes="True">
        <Setter Property="Shell.BackgroundColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource OffBlack}}" />
        <Setter Property="Shell.ForegroundColor" Value="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource SecondaryDarkText}}" />
        <Setter Property="Shell.TitleColor" Value="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource SecondaryDarkText}}" />
        <Setter Property="Shell.DisabledColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray950}}" />
        <Setter Property="Shell.UnselectedColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray200}}" />
        <Setter Property="Shell.NavBarHasShadow" Value="False" />
        <Setter Property="Shell.TabBarBackgroundColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Black}}" />
        <Setter Property="Shell.TabBarForegroundColor" Value="{AppThemeBinding Light={StaticResource Magenta}, Dark={StaticResource White}}" />
        <Setter Property="Shell.TabBarTitleColor" Value="{AppThemeBinding Light={StaticResource Magenta}, Dark={StaticResource White}}" />
        <Setter Property="Shell.TabBarUnselectedColor" Value="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray200}}" />
    </Style>

    <Style TargetType="NavigationPage">
        <Setter Property="BarBackgroundColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource OffBlack}}" />
        <Setter Property="BarTextColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource White}}" />
        <Setter Property="IconColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource White}}" />
    </Style>

    <Style TargetType="TabbedPage">
        <Setter Property="BarBackgroundColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray950}}" />
        <Setter Property="BarTextColor" Value="{AppThemeBinding Light={StaticResource Magenta}, Dark={StaticResource White}}" />
        <Setter Property="UnselectedTabColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray950}}" />
        <Setter Property="SelectedTabColor" Value="{AppThemeBinding Light={StaticResource Gray950}, Dark={StaticResource Gray200}}" />
    </Style>

</ResourceDictionary>

================================================================================
FILE: LoGeCuiMobile\RootPage.cs
================================================================================

namespace LoGeCuiMobile;

public static class RootPage
{
    public static Page CreateLoginRoot()
        => new NavigationPage(new Pages.LoginPage());

    public static Page CreateAppShellRoot()
        => new AppShell();
}

================================================================================
FILE: LoGeCuiMobile\Services\OcrService.cs
================================================================================

Ôªøusing System.Net.Http.Headers;
using System.Text.Json;

namespace LoGeCuiMobile.Services
{
    public sealed class OcrService
    {
        private readonly HttpClient _http;
        private readonly string _apiKey;

        public OcrService(string apiKey)
        {
            _apiKey = apiKey ?? throw new ArgumentNullException(nameof(apiKey));
            _http = new HttpClient { Timeout = TimeSpan.FromSeconds(60) };
        }

        public async Task<string> ExtractTextFromImageAsync(byte[] imageBytes, string fileName = "scan.jpg")
        {
            if (imageBytes is null || imageBytes.Length == 0)
                throw new ArgumentException("Image vide.", nameof(imageBytes));

            if (string.IsNullOrWhiteSpace(_apiKey))
                throw new InvalidOperationException("Cl√© OCR manquante (apiKey).");

            var url = "https://api.ocr.space/parse/image";

            using var content = new MultipartFormDataContent();

            // Param√®tres utiles
            content.Add(new StringContent("fre"), "language");          // fre = fran√ßais
            content.Add(new StringContent("false"), "isOverlayRequired");
            content.Add(new StringContent("2"), "OCREngine");           // 1 ou 2 (2 souvent meilleur)
            content.Add(new StringContent("true"), "scale");
            content.Add(new StringContent("true"), "detectOrientation");

            var fileContent = new ByteArrayContent(imageBytes);
            fileContent.Headers.ContentType = MediaTypeHeaderValue.Parse("image/jpeg");
            content.Add(fileContent, "file", fileName);

            using var request = new HttpRequestMessage(HttpMethod.Post, url);
            request.Headers.Add("apikey", _apiKey); // ‚úÖ endroit le plus fiable
            request.Content = content;

            using var resp = await _http.SendAsync(request);
            var json = await resp.Content.ReadAsStringAsync();

            if (!resp.IsSuccessStatusCode)
                throw new Exception($"OCR HTTP {(int)resp.StatusCode}: {json}");

            using var doc = JsonDocument.Parse(json);

            // Si l‚ÄôAPI retourne une erreur applicative
            if (doc.RootElement.TryGetProperty("IsErroredOnProcessing", out var errored)
                && errored.ValueKind == JsonValueKind.True)
            {
                string msg = "Erreur OCR.";
                if (doc.RootElement.TryGetProperty("ErrorMessage", out var em))
                {
                    // ErrorMessage peut √™tre string ou tableau selon les cas
                    msg = em.ValueKind switch
                    {
                        JsonValueKind.Array => string.Join(" | ", em.EnumerateArray().Select(x => x.ToString())),
                        _ => em.ToString()
                    };
                }
                throw new Exception(msg);
            }

            if (!doc.RootElement.TryGetProperty("ParsedResults", out var parsedResults)
                || parsedResults.ValueKind != JsonValueKind.Array
                || parsedResults.GetArrayLength() == 0)
            {
                return "";
            }

            var first = parsedResults[0];
            if (!first.TryGetProperty("ParsedText", out var parsedTextEl))
                return "";

            return parsedTextEl.GetString() ?? "";
        }
    }
}



================================================================================
FILE: LoGeCuiMobile\Services\Skiasharp.cs
================================================================================

Ôªøusing SkiaSharp;

namespace LoGeCuiMobile.Services
{
    public static class ImageCompressionHelper
    {
        public static byte[] CompressJpeg(
            byte[] input,
            int maxWidth = 1600,
            int jpegQuality = 75)
        {
            using var inputStream = new SKMemoryStream(input);
            using var codec = SKCodec.Create(inputStream);
            using var bitmap = SKBitmap.Decode(codec);

            if (bitmap == null)
                throw new InvalidOperationException("Impossible de d√©coder l'image.");

            var width = bitmap.Width;
            var height = bitmap.Height;

            if (width > maxWidth)
            {
                var ratio = (float)maxWidth / width;
                var newW = maxWidth;
                var newH = (int)(height * ratio);

                using var resized = bitmap.Resize(
                    new SKImageInfo(newW, newH),
                    SKFilterQuality.Medium);

                using var image = SKImage.FromBitmap(resized);
                using var data = image.Encode(
                    SKEncodedImageFormat.Jpeg,
                    jpegQuality);

                return data.ToArray();
            }
            else
            {
                using var image = SKImage.FromBitmap(bitmap);
                using var data = image.Encode(
                    SKEncodedImageFormat.Jpeg,
                    jpegQuality);

                return data.ToArray();
            }
        }
    }
}


================================================================================
FILE: LoGeCuiMobile\Services\SupabaseConfig.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using LoGeCuiShared.Services;

namespace LoGeCuiMobile.Services
{
    public static class SupabaseConfig
    {
        public static string Url { get; } = ConfigurationHelper.GetSupabaseUrl();
        public static string Key { get; } = ConfigurationHelper.GetSupabaseKey();
    }
}

================================================================================
FILE: LoGeCuiMobile\ViewModels\ArticleCourseUi.cs
================================================================================

Ôªøusing System.ComponentModel;
using System.Runtime.CompilerServices;
using LoGeCuiShared.Models;

namespace LoGeCuiMobile.Models
{
    // Wrapper UI: on conserve ArticleCourse et on ajoute une s√©lection locale (non persist√©e)
    public class ArticleCourseUi : INotifyPropertyChanged
    {
        public ArticleCourseUi(ArticleCourse model) => Model = model;

        public ArticleCourse Model { get; }

        public int Id => Model.Id;

        public string Nom
        {
            get => Model.Nom;
            set { if (Model.Nom != value) { Model.Nom = value; OnPropertyChanged(); } }
        }

        public string Quantite
        {
            get => Model.Quantite;
            set { if (Model.Quantite != value) { Model.Quantite = value; OnPropertyChanged(); } }
        }

        public string Unite
        {
            get => Model.Unite;
            set { if (Model.Unite != value) { Model.Unite = value; OnPropertyChanged(); } }
        }

        public bool EstAchete
        {
            get => Model.EstAchete;
            set { if (Model.EstAchete != value) { Model.EstAchete = value; OnPropertyChanged(); } }
        }

        private bool _isSelectedForDelete;
        public bool IsSelectedForDelete
        {
            get => _isSelectedForDelete;
            set { if (_isSelectedForDelete != value) { _isSelectedForDelete = value; OnPropertyChanged(); } }
        }

        public event PropertyChangedEventHandler? PropertyChanged;
        private void OnPropertyChanged([CallerMemberName] string? name = null)
            => PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(name));
    }
}


================================================================================
FILE: LoGeCuiMobile\ViewModels\MesRecettesViewModel.cs
================================================================================

Ôªøusing System.Collections.ObjectModel;
using System.Windows.Input;
using LoGeCuiShared.Models;
using LoGeCuiShared.Services;

namespace LoGeCuiMobile.ViewModels
{
    public sealed class MesRecettesViewModel : BindableObject
    {
        private readonly RecipesService _recipesService;

        public ObservableCollection<Recette> Recettes { get; } = new();

        private bool _isBusy;
        public bool IsBusy
        {
            get => _isBusy;
            set { _isBusy = value; OnPropertyChanged(); }
        }

        private string _selectedCategorie = "Toutes";
        public string SelectedCategorie
        {
            get => _selectedCategorie;
            set
            {
                if (_selectedCategorie == value) return;
                _selectedCategorie = value;
                OnPropertyChanged();
                _ = LoadAsync(); // recharge quand le filtre change
            }
        }

        public IReadOnlyList<string> Categories { get; } = new[] { "Toutes", "Entree", "Plat", "Dessert" };

        public ICommand RefreshCommand { get; }

        public MesRecettesViewModel(RecipesService recipesService)
        {
            _recipesService = recipesService;
            RefreshCommand = new Command(async () => await LoadAsync());
        }

        public async Task LoadAsync()
        {
            if (IsBusy) return;

            try
            {
                IsBusy = true;
                Recettes.Clear();

                var cat = SelectedCategorie == "Toutes" ? null : SelectedCategorie;

                List<Recette> list;
                try
                {
                    list = await _recipesService.GetMyRecettesAsync(cat);
                }
                catch (Exception ex)
                {
                    await MainThread.InvokeOnMainThreadAsync(() =>
                        Application.Current.MainPage.DisplayAlert("Erreur API", ex.Message, "OK"));
                    return;
                }

                foreach (var r in list)
                    Recettes.Add(r);
            }
            finally
            {
                IsBusy = false;
            }
        }
    
    }
}


================================================================================
FILE: LoGeCuiShared\LoGeCuiShared.csproj
================================================================================

Ôªø<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net10.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Supabase" Version="1.1.1" />
    <PackageReference Include="Supabase.Core" Version="1.0.0" />
    <PackageReference Include="Supabase.Postgrest" Version="4.1.0" />
  </ItemGroup>

</Project>

================================================================================
FILE: LoGeCuiShared\Models\ArticleCourse.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;
using System.Text.Json.Serialization;
using System.ComponentModel;
using System.Runtime.CompilerServices;

namespace LoGeCuiShared.Models
{
    public class ArticleCourse : INotifyPropertyChanged
    {
        public event PropertyChangedEventHandler? PropertyChanged;

        private int _id;
        private Guid _userId;
        private string _nom = "";
        private string _quantite = "";
        private string _unite = "";
        private bool _estAchete;

        [JsonPropertyName("id")]
        public int Id
        {
            get => _id;
            set { _id = value; OnPropertyChanged(); }
        }

        [JsonPropertyName("user_id")]
        public Guid UserId
        {
            get => _userId;
            set { _userId = value; OnPropertyChanged(); }
        }

        [JsonPropertyName("nom")]
        public string Nom
        {
            get => _nom;
            set { _nom = value; OnPropertyChanged(); }
        }

        [JsonPropertyName("quantite")]
        public string Quantite
        {
            get => _quantite;
            set { _quantite = value; OnPropertyChanged(); }
        }

        [JsonPropertyName("unite")]
        public string Unite
        {
            get => _unite;
            set { _unite = value; OnPropertyChanged(); }
        }

        [JsonPropertyName("est_achete")]
        public bool EstAchete
        {
            get => _estAchete;
            set { _estAchete = value; OnPropertyChanged(); }
        }

        private void OnPropertyChanged([CallerMemberName] string? name = null)
            => PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(name));
    }
}

================================================================================
FILE: LoGeCuiShared\Models\Ingredient.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;

namespace LoGeCuiShared.Models
{
    public class Ingredient
    {
        public Guid Id { get; set; }          // id (uuid) dans Supabase
        public Guid? UserId { get; set; }     // user_id (uuid) dans Supabase
        public string Nom { get; set; }
        public string Quantite { get; set; }
        public string Unite { get; set; }
        public bool EstDisponible { get; set; }

        public Ingredient()
        {
            Nom = "";
            Quantite = "";
            Unite = "";
            EstDisponible = true;
        }
    }
}

================================================================================
FILE: LoGeCuiShared\Models\IngredientRecette.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;

namespace LoGeCuiShared.Models
{
    public class IngredientRecette
    {
        public string Nom { get; set; }
        public string Quantite { get; set; }
        public string Unite { get; set; }

        public IngredientRecette()
        {
            Nom = "";
            Quantite = "";
            Unite = "";
        }

        public override string ToString()
        {
            return $"{Nom} - {Quantite} {Unite}";
        }
    }
}

================================================================================
FILE: LoGeCuiShared\Models\MenuJournalier.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;

namespace LoGeCuiShared.Models
{
    public class MenuJournalier
    {
        public DateTime Date { get; set; }
        public Recette? Entree { get; set; }
        public Recette? Plat { get; set; }
        public Recette? Dessert { get; set; }
        public List<IngredientRecette> IngredientsManquants { get; set; }

        public MenuJournalier()
        {
            Date = DateTime.Now;
            IngredientsManquants = new List<IngredientRecette>();
        }
    }
}

================================================================================
FILE: LoGeCuiShared\Models\Recette.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text.Json.Serialization;

namespace LoGeCuiShared.Models
{
    public enum TypePlat
    {
        Entree,
        Plat,
        Dessert
    }

    public class Recette
    {
        // ----------------------------
        // Champs DB / JSON (Supabase)
        // ----------------------------

        [JsonPropertyName("id")]
        public Guid Id { get; set; }

        [JsonPropertyName("created_at")]
        public DateTimeOffset CreatedAt { get; set; }

        [JsonPropertyName("owner_user_id")]
        public Guid? OwnerUserId { get; set; }   // <-- nullable

        [JsonPropertyName("external_id")]
        public string? ExternalId { get; set; }

        [JsonPropertyName("nom")]
        public string Nom { get; set; } = "";

        [JsonPropertyName("categorie")]
        public string CategorieDb
        {
            get => Type switch
            {
                TypePlat.Entree => "Entree",
                TypePlat.Plat => "Plat",
                TypePlat.Dessert => "Dessert",
                _ => "Plat"
            };
            set
            {
                Type = value switch
                {
                    "Entree" => TypePlat.Entree,
                    "Plat" => TypePlat.Plat,
                    "Dessert" => TypePlat.Dessert,
                    _ => TypePlat.Plat
                };
            }
        }

        [JsonPropertyName("temps_minutes")]
        public int TempsMinutesDb
        {
            get => TempsPreparation;
            set => TempsPreparation = value;
        }

        [JsonPropertyName("note")]
        public int? NoteDb
        {
            get => Difficulte;
            set => Difficulte = Math.Clamp(value ?? 1, 1, 5);
        }

        [JsonPropertyName("is_favorite")]
        public bool IsFavorite { get; set; }

        [JsonPropertyName("instructions")]
        public string InstructionsDb
        {
            get => Instructions;
            set => Instructions = value ?? "";
        }

        // ----------------------------
        // Propri√©t√©s m√©tier
        // ----------------------------

        [JsonIgnore]
        public TypePlat Type { get; set; } = TypePlat.Plat;

        [JsonIgnore]
        public int TempsPreparation { get; set; } = 0;

        [JsonIgnore]
        public int Difficulte { get; set; } = 1;

        [JsonIgnore]
        public List<IngredientRecette> Ingredients { get; set; } = new();

        [JsonIgnore]
        public string Instructions { get; set; } = "";
    

    [JsonIgnore]
        public string TypeTexte => Type switch
        {
            TypePlat.Entree => "Entr√©e",
            TypePlat.Plat => "Plat",
            TypePlat.Dessert => "Dessert",
            _ => "Inconnu"
        };

        [JsonIgnore]
        public string DifficulteTexte => new string('‚≠ê', Math.Clamp(Difficulte, 1, 5));
    }
}




================================================================================
FILE: LoGeCuiShared\Services\ConfigurationHelper.cs
================================================================================

Ôªøusing System;

namespace LoGeCuiShared.Services
{
    public static class ConfigurationHelper
    {
        private static Func<string, string?>? _get;

        // Appel√© 1 fois au d√©marrage par le projet MAUI
        public static void Configure(Func<string, string?> getValue)
        {
            _get = getValue ?? throw new ArgumentNullException(nameof(getValue));
        }

        private static string Get(string key)
        {
            if (_get == null)
                throw new InvalidOperationException("ConfigurationHelper n'est pas configur√©. Appelez ConfigurationHelper.Configure(...) au d√©marrage.");

            return _get(key) ?? throw new InvalidOperationException($"Cl√© manquante : {key}");
        }

        // Versions s√ªres qui renvoient null si la cl√© est absente (pour permettre un d√©marrage sans crash)
        public static string? GetSupabaseUrlSafe() => _get?.Invoke("Supabase:Url");
        public static string? GetSupabaseKeySafe() => _get?.Invoke("Supabase:AnonKey");
        public static string? GetOcrApiKeySafe() => _get?.Invoke("OCR:ApiKey");

        // Les anciennes m√©thodes conservent le comportement strict (throw) ‚Äî vous pouvez les remplacer par les versions Safe si n√©cessaire.
        public static string GetSupabaseUrl() => Get("Supabase:Url");
        public static string GetSupabaseKey() => Get("Supabase:AnonKey");
        public static string GetOcrApiKey() => Get("OCR:ApiKey");
    }
}



================================================================================
FILE: LoGeCuiShared\Services\IngredientsService.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Threading.Tasks;
using LoGeCuiShared.Models;
using Supabase;

namespace LoGeCuiShared.Services
{
    public sealed class IngredientsService
    {
        private readonly SupabaseRestClient _client;
        private const string Table = "ingredients";

        public IngredientsService(SupabaseRestClient client)
        {
            _client = client ?? throw new ArgumentNullException(nameof(client));
        }

        public async Task<List<Ingredient>> GetIngredientsAsync(Guid userId)
        {
            var q =
                $"{Table}?" +
                "select=id,user_id,nom,quantite,unite,est_disponible,created_at" +
                $"&user_id=eq.{userId}" +
                "&order=created_at.desc";

            return await _client.GetAsync<List<Ingredient>>(q) ?? new List<Ingredient>();
        }

        public async Task<Ingredient?> CreateIngredientAsync(Guid userId, Ingredient i)
        {
            if (i == null) throw new ArgumentNullException(nameof(i));
            if (string.IsNullOrWhiteSpace(i.Nom)) throw new ArgumentException("Nom requis.", nameof(i));

            var payload = new
            {
                user_id = userId,
                nom = i.Nom,
                quantite = string.IsNullOrWhiteSpace(i.Quantite) ? null : i.Quantite,
                unite = string.IsNullOrWhiteSpace(i.Unite) ? null : i.Unite,
                est_disponible = i.EstDisponible
            };

            var created = await _client.PostAsync<List<Ingredient>>(
                $"{Table}?select=id,user_id,nom,quantite,unite,est_disponible,created_at",
                payload,
                returnRepresentation: true);

            return created?.Count > 0 ? created[0] : null;
        }

        public async Task UpdateDisponibiliteAsync(Guid ingredientId, bool estDisponible)
        {
            var payload = new { est_disponible = estDisponible };
            await _client.PatchAsync($"{Table}?id=eq.{ingredientId}", payload);
        }

        public async Task DeleteIngredientAsync(Guid ingredientId)
        {
            await _client.DeleteAsync($"{Table}?id=eq.{ingredientId}");
        }
    }
}



================================================================================
FILE: LoGeCuiShared\Services\ListeCoursesService.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;
using System.IO;
using System.Text.Json;
using LoGeCuiShared.Models;

namespace LoGeCuiShared.Services
{
    public class ListeCoursesService
    {
        private readonly string _cheminFichier;

        public ListeCoursesService(string cheminFichier)
        {
            _cheminFichier = cheminFichier;
        }

        public List<ArticleCourse> ChargerListeCourses()
        {
            try
            {
                if (!File.Exists(_cheminFichier))
                {
                    return new List<ArticleCourse>();
                }

                string json = File.ReadAllText(_cheminFichier);
                var liste = JsonSerializer.Deserialize<List<ArticleCourse>>(json);
                return liste ?? new List<ArticleCourse>();
            }
            catch (Exception)
            {
                return new List<ArticleCourse>();
            }
        }

        public void SauvegarderListeCourses(List<ArticleCourse> articles)
        {
            try
            {
                var options = new JsonSerializerOptions { WriteIndented = true };
                string json = JsonSerializer.Serialize(articles, options);

                // Cr√©er le dossier si n√©cessaire
                var dossier = Path.GetDirectoryName(_cheminFichier);
                if (!string.IsNullOrEmpty(dossier) && !Directory.Exists(dossier))
                {
                    Directory.CreateDirectory(dossier);
                }

                File.WriteAllText(_cheminFichier, json);
            }
            catch (Exception)
            {
                throw;
            }
        }
    }
}

================================================================================
FILE: LoGeCuiShared\Services\ListeCoursesSupabaseService.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Supabase;

namespace LoGeCuiShared.Services
{
    public sealed class ListeCoursesSupabaseService
    {
        private readonly SupabaseRestClient _client;
        private const string Table = "articles_courses";

        public ListeCoursesSupabaseService(SupabaseRestClient client)
        {
            _client = client ?? throw new ArgumentNullException(nameof(client));
        }

        /// <summary>
        /// Ajoute √† la liste de courses les ingr√©dients manquants (sans doublons),
        /// en s'appuyant sur le trigger set_user_id_on_insert (donc on n'envoie pas user_id).
        /// </summary>
        public async Task AddMissingAsync(Guid userId, IEnumerable<string> missingNames)
        {
            var names = missingNames
                .Where(n => !string.IsNullOrWhiteSpace(n))
                .Select(n => n.Trim())
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .ToList();

            if (names.Count == 0)
                return;

            // 1) Lire ce qui existe d√©j√† pour cet utilisateur (non achet√©)
            // (On filtre par user_id car ta table l'a bien, et le token bearer doit donner acc√®s via RLS/trigger)
            var existingQuery =
                $"{Table}?select=nom&user_id=eq.{userId}&est_achete=eq.false";

            var existingRows = await _client.GetAsync<List<Row>>(existingQuery) ?? new List<Row>();

            var existing = existingRows
                .Where(r => !string.IsNullOrWhiteSpace(r.nom))
                .Select(r => r.nom!.Trim())
                .ToHashSet(StringComparer.OrdinalIgnoreCase);

            // 2) Garder uniquement ceux qui n'existent pas
            var toInsert = names
                .Where(n => !existing.Contains(n))
                .Select(n => new
                {
                    nom = n,
                    quantite = (string?)null,
                    unite = (string?)null,
                    est_achete = false
                    // user_id est mis par trigger set_user_id_on_insert
                })
                .ToArray();

            if (toInsert.Length == 0)
                return;

            // 3) Insert batch
            await _client.PostAsync<object>(
                Table,
                toInsert,
                returnRepresentation: false);
        }

        private sealed class Row
        {
            public string? nom { get; set; }
        }
    }
}

================================================================================
FILE: LoGeCuiShared\Services\RecetteIngredientsService.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Supabase;

namespace LoGeCuiShared.Services
{
    public sealed class RecetteIngredientsService
    {
        private readonly SupabaseRestClient _client;
        private const string Table = "recette_ingredients";

        public RecetteIngredientsService(SupabaseRestClient client)
        {
            _client = client ?? throw new ArgumentNullException(nameof(client));
        }

        // DTO conforme au sch√©ma DB
        private sealed class Row
        {
            public string? ingredient_nom { get; set; }
            public string? quantite { get; set; }
            public string? unite { get; set; }
        }

        public async Task<List<(string nom, string? quantite, string? unite)>> GetForRecetteAsync(Guid recetteId)
        {
            var q = $"{Table}?select=ingredient_nom,quantite,unite&recette_id=eq.{recetteId}&order=created_at.asc";
            var rows = await _client.GetAsync<List<Row>>(q) ?? new List<Row>();

            return rows
                .Where(r => !string.IsNullOrWhiteSpace(r.ingredient_nom))
                .Select(r => (r.ingredient_nom!.Trim(), r.quantite, r.unite))
                .ToList();
        }

        // Remplace la liste compl√®te (simple et robuste)
        public async Task ReplaceForRecetteAsync(Guid recetteId, IEnumerable<(string nom, string? quantite, string? unite)> items)
        {
            // 1) delete
            await _client.DeleteAsync($"{Table}?recette_id=eq.{recetteId}");

            // 2) insert
            var payload = items
                .Where(i => !string.IsNullOrWhiteSpace(i.nom))
                .Select(i => new
                {
                    recette_id = recetteId,
                    ingredient_nom = i.nom.Trim(),
                    quantite = string.IsNullOrWhiteSpace(i.quantite) ? null : i.quantite.Trim(),
                    unite = string.IsNullOrWhiteSpace(i.unite) ? null : i.unite.Trim()
                })
                .ToArray();

            if (payload.Length == 0)
                return;

            await _client.PostAsync<object>(Table, payload, returnRepresentation: false);
        }
    }
}

================================================================================
FILE: LoGeCuiShared\Services\RecipesService.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using LoGeCuiShared.Models;
using Supabase;

namespace LoGeCuiShared.Services
{
    public sealed class RecipesService
    {
        private readonly SupabaseRestClient _client;

        public RecipesService(SupabaseRestClient client)
        {
            _client = client ?? throw new ArgumentNullException(nameof(client));
        }

        /// <summary>
        /// R√©cup√®re TOUTES les recettes de l‚Äôutilisateur courant
        /// (utilis√© notamment pour le menu al√©atoire)
        /// </summary>
        public async Task<List<Recette>> GetRecettesAsync(Guid userId)
        {
            var q =
                "recettes?" +
                "select=id,created_at,owner_user_id,nom,categorie,temps_minutes,note,is_favorite,instructions" +
                $"&owner_user_id=eq.{userId}" +
                "&order=created_at.desc";

            return await _client.GetAsync<List<Recette>>(q)
                   ?? new List<Recette>();
        }

        /// <summary>
        /// R√©cup√®re les recettes (optionnellement filtr√©es par cat√©gorie)
        /// </summary>
        public async Task<List<Recette>> GetMyRecettesAsync(string? categorie = null)
        {
            var q =
                "recettes?" +
                "select=id,created_at,owner_user_id,nom,categorie,temps_minutes,note,is_favorite,instructions" +
                "&order=created_at.desc";

            if (!string.IsNullOrWhiteSpace(categorie) &&
                !string.Equals(categorie, "Toutes", StringComparison.OrdinalIgnoreCase))
            {
                q += $"&categorie=eq.{Uri.EscapeDataString(categorie)}";
            }

            return await _client.GetAsync<List<Recette>>(q)
                   ?? new List<Recette>();
        }

        /// <summary>
        /// Cr√©e une recette et retourne la recette cr√©√©e
        /// </summary>
        public async Task<Recette?> CreateRecetteAsync(Guid ownerUserId, Recette r)
        {
            if (r == null) throw new ArgumentNullException(nameof(r));

            var payload = new
            {
                owner_user_id = ownerUserId,
                nom = r.Nom,
                categorie = r.CategorieDb,
                temps_minutes = r.TempsMinutesDb,
                note = r.NoteDb,
                is_favorite = r.IsFavorite,
                instructions = r.InstructionsDb
            };

            var created = await _client.PostAsync<List<Recette>>(
                "recettes?select=id,created_at,owner_user_id,nom,categorie,temps_minutes,note,is_favorite,instructions",
                payload,
                returnRepresentation: true);

            return created?.FirstOrDefault();
        }

        /// <summary>
        /// Supprime une recette
        /// </summary>
        public async Task DeleteRecetteAsync(Guid recetteId)
        {
            await _client.DeleteAsync($"recettes?id=eq.{recetteId}");
        }

        /// <summary>
        /// Insert ou met √† jour une recette via external_id
        /// </summary>
        public async Task UpsertRecetteAsync(Guid ownerUserId, Recette r)
        {
            if (r == null) throw new ArgumentNullException(nameof(r));

            if (string.IsNullOrWhiteSpace(r.ExternalId))
                throw new ArgumentException("ExternalId est requis pour upsert.", nameof(r));

            var payload = new[]
            {
                new
                {
                    owner_user_id = ownerUserId,
                    external_id = r.ExternalId,
                    nom = r.Nom,
                    categorie = r.CategorieDb,
                    temps_minutes = r.TempsMinutesDb,
                    note = r.NoteDb,
                    is_favorite = r.IsFavorite,
                    instructions = r.InstructionsDb
                }
            };

            await _client.PostAsync<object>(
                "recettes?on_conflict=external_id",
                payload,
                returnRepresentation: false,
                mergeDuplicates: true);
        }
        public async Task<Guid?> GetRecetteIdByExternalIdAsync(string externalId)
        {
            if (string.IsNullOrWhiteSpace(externalId))
                throw new ArgumentException("externalId requis", nameof(externalId));

            var q =
                "recettes?" +
                "select=id" +
                $"&external_id=eq.{Uri.EscapeDataString(externalId)}" +
                "&limit=1";

            var rows = await _client.GetAsync<List<RecetteIdRow>>(q);

            return rows?.FirstOrDefault()?.id;
        }

        private sealed class RecetteIdRow
        {
            public Guid id { get; set; }
        }

    }
}


================================================================================
FILE: LoGeCuiShared\Services\SupabaseRestClient.cs
================================================================================

Ôªøusing System.Net.Http.Headers;
using System.Text;
using System.Text.Json;

namespace LoGeCuiShared.Services
{
    public sealed class SupabaseRestClient
    {
        private readonly HttpClient _http;
        private readonly string _baseRestUrl;

        public SupabaseRestClient(string supabaseUrl, string supabaseAnonKey)
        {
            if (string.IsNullOrWhiteSpace(supabaseUrl)) throw new ArgumentException("supabaseUrl is required");
            if (string.IsNullOrWhiteSpace(supabaseAnonKey)) throw new ArgumentException("supabaseAnonKey is required");

            _baseRestUrl = supabaseUrl.TrimEnd('/') + "/rest/v1/";

            _http = new HttpClient();
            _http.DefaultRequestHeaders.Add("apikey", supabaseAnonKey);
            _http.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));
        }

        public void SetBearerToken(string accessToken)
        {
            _http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);
        }

        public async Task<T?> GetAsync<T>(string pathAndQuery)
        {
            var url = _baseRestUrl + pathAndQuery;

            using var resp = await _http.GetAsync(url);
            var body = await resp.Content.ReadAsStringAsync();

            if (!resp.IsSuccessStatusCode)
                throw new Exception($"Supabase GET failed: {(int)resp.StatusCode} {resp.ReasonPhrase}\n{body}");

            return JsonSerializer.Deserialize<T>(body, JsonOptions());
        }

        public async Task<T?> PostAsync<T>(string pathAndQuery, object payload, bool returnRepresentation = false)
        {
            var url = _baseRestUrl + pathAndQuery;
            var json = JsonSerializer.Serialize(payload, JsonOptions());

            using var req = new HttpRequestMessage(HttpMethod.Post, url)
            {
                Content = new StringContent(json, Encoding.UTF8, "application/json")
            };

            if (returnRepresentation)
                req.Headers.Add("Prefer", "return=representation");

            using var resp = await _http.SendAsync(req);
            var body = await resp.Content.ReadAsStringAsync();

            if (!resp.IsSuccessStatusCode)
                throw new Exception($"Supabase POST failed: {(int)resp.StatusCode} {resp.ReasonPhrase}\n{body}");

            if (string.IsNullOrWhiteSpace(body))
                return default;

            return JsonSerializer.Deserialize<T>(body, JsonOptions());
        }

        public async Task PatchAsync(string pathAndQuery, object payload)
        {
            var url = _baseRestUrl + pathAndQuery;
            var json = JsonSerializer.Serialize(payload, JsonOptions());

            using var req = new HttpRequestMessage(new HttpMethod("PATCH"), url)
            {
                Content = new StringContent(json, Encoding.UTF8, "application/json")
            };

            using var resp = await _http.SendAsync(req);
            var body = await resp.Content.ReadAsStringAsync();

            if (!resp.IsSuccessStatusCode)
                throw new Exception($"Supabase PATCH failed: {(int)resp.StatusCode} {resp.ReasonPhrase}\n{body}");
        }

        public async Task DeleteAsync(string pathAndQuery)
        {
            var url = _baseRestUrl + pathAndQuery;

            using var resp = await _http.DeleteAsync(url);
            var body = await resp.Content.ReadAsStringAsync();

            if (!resp.IsSuccessStatusCode)
                throw new Exception($"Supabase DELETE failed: {(int)resp.StatusCode} {resp.ReasonPhrase}\n{body}");
        }

        private static JsonSerializerOptions JsonOptions() => new()
        {
            PropertyNameCaseInsensitive = true
        };

        public async Task<T?> PostAsync<T>(
        string pathAndQuery,
        object payload,
        bool returnRepresentation = false,
        bool mergeDuplicates = false)
        {
            var url = _baseRestUrl + pathAndQuery;
            var json = JsonSerializer.Serialize(payload, JsonOptions());

            using var req = new HttpRequestMessage(HttpMethod.Post, url)
            {
                Content = new StringContent(json, Encoding.UTF8, "application/json")
            };

            // PostgREST Prefer headers
            if (returnRepresentation)
                req.Headers.Add("Prefer", "return=representation");

            if (mergeDuplicates)
                req.Headers.Add("Prefer", "resolution=merge-duplicates");

            using var resp = await _http.SendAsync(req);
            var body = await resp.Content.ReadAsStringAsync();

            if (!resp.IsSuccessStatusCode)
                throw new Exception($"Supabase POST failed: {(int)resp.StatusCode} {resp.ReasonPhrase}\n{body}");

            if (string.IsNullOrWhiteSpace(body))
                return default;

            return JsonSerializer.Deserialize<T>(body, JsonOptions());
        }

    }
}


================================================================================
FILE: LoGeCuiShared\Services\SupabaseService.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Text.Json;
using System.Threading.Tasks;
using LoGeCuiShared.Models;
using Supabase.Postgrest;
using Supabase.Postgrest.Attributes;
using Supabase.Postgrest.Models;
using System.Net.Http.Headers;


namespace LoGeCuiShared.Services
{
    public class SupabaseService
    {
        private readonly HttpClient _httpClient;
        private readonly string _supabaseUrl;
        private readonly string _supabaseKey;

        // Session courante (apr√®s login)
        private string? _accessToken;    // JWT utilisateur
        private string? _currentUserId;  // GUID string

        private readonly Client _client;

        public SupabaseService(string url, string key)
        {
            _supabaseUrl = url ?? throw new ArgumentNullException(nameof(url));
            _supabaseKey = key ?? throw new ArgumentNullException(nameof(key));

            _httpClient = new HttpClient { Timeout = TimeSpan.FromSeconds(30) };

            var options = new ClientOptions
            {
                Headers = new Dictionary<string, string>
                {
                    { "apikey", key },
                    // Tant qu'on n'est pas connect√©, on reste en "anon"
                    { "Authorization", $"Bearer {key}" }
                }
            };

            _client = new Client($"{url}/rest/v1", options);
        }

        // =========================
        // SESSION
        // =========================

        public void SetSession(string accessToken, string userId)
        {
            if (string.IsNullOrWhiteSpace(accessToken))
                throw new ArgumentException("accessToken manquant", nameof(accessToken));

            if (string.IsNullOrWhiteSpace(userId))
                throw new ArgumentException("userId manquant", nameof(userId));

            _accessToken = accessToken;
            _currentUserId = userId;

            // IMPORTANT: PostgREST doit utiliser le JWT utilisateur pour RLS
            _client.Options.Headers["Authorization"] = $"Bearer {_accessToken}";
        }

        public void ClearSession()
        {
            _accessToken = null;
            _currentUserId = null;

            // Retour "anon"
            _client.Options.Headers["Authorization"] = $"Bearer {_supabaseKey}";
        }

        public string? GetCurrentUserId() => _currentUserId;

        private Guid RequireCurrentUserGuid()
        {
            if (string.IsNullOrWhiteSpace(_currentUserId))
                throw new InvalidOperationException("Utilisateur non connect√©. Veuillez vous reconnecter.");

            if (!Guid.TryParse(_currentUserId, out var guid))
                throw new InvalidOperationException("Identifiant utilisateur invalide. Veuillez vous reconnecter.");

            return guid;
        }

        private void RequireAccessToken()
        {
            if (string.IsNullOrWhiteSpace(_accessToken))
                throw new InvalidOperationException("Session invalide. Veuillez vous reconnecter.");
        }

        // =========================
        // AUTH REST
        // =========================

        public async Task<(bool success, string? userId, string? error)> SignUpAsync(string email, string password)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(email) || !email.Contains("@"))
                    return (false, null, "Adresse email invalide");

                if (string.IsNullOrWhiteSpace(password) || password.Length < 6)
                    return (false, null, "Le mot de passe doit contenir au moins 6 caract√®res");

                var request = new { email = email.Trim(), password };

                _httpClient.DefaultRequestHeaders.Clear();
                _httpClient.DefaultRequestHeaders.Add("apikey", _supabaseKey);
                _httpClient.DefaultRequestHeaders.Authorization =
                    new AuthenticationHeaderValue("Bearer", _supabaseKey);

                var response = await _httpClient.PostAsJsonAsync($"{_supabaseUrl}/auth/v1/signup", request);
                var content = await response.Content.ReadAsStringAsync();

                if (!response.IsSuccessStatusCode)
                    return (false, null, ExtractSupabaseError(content, response.StatusCode));

                // Supabase renvoie souvent { user: { id: ... } }, parfois { id: ... }
                try
                {
                    var json = JsonDocument.Parse(content);

                    if (json.RootElement.TryGetProperty("user", out var userEl) &&
                        userEl.TryGetProperty("id", out var uidEl))
                    {
                        var uid = uidEl.GetString();
                        if (!string.IsNullOrWhiteSpace(uid))
                            return (true, uid, null);
                    }

                    if (json.RootElement.TryGetProperty("id", out var idEl))
                    {
                        var uid = idEl.GetString();
                        if (!string.IsNullOrWhiteSpace(uid))
                            return (true, uid, null);
                    }

                    return (true, "unknown", null);
                }
                catch
                {
                    return (true, "unknown", null);
                }
            }
            catch (HttpRequestException)
            {
                return (false, null, "Erreur de connexion au serveur. V√©rifiez votre connexion internet.");
            }
            catch (TaskCanceledException)
            {
                return (false, null, "La requ√™te a expir√©. V√©rifiez votre connexion internet.");
            }
            catch (Exception ex)
            {
                return (false, null, $"Erreur inattendue : {ex.Message}");
            }
        }

        public async Task<(bool success, string? accessToken, string? userId, string? error)> SignInAsync(string email, string password)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(email) || !email.Contains("@"))
                    return (false, null, null, "Adresse email invalide");

                if (string.IsNullOrWhiteSpace(password))
                    return (false, null, null, "Le mot de passe est requis");

                var request = new { email = email.Trim(), password };

                _httpClient.DefaultRequestHeaders.Clear();
                _httpClient.DefaultRequestHeaders.Add("apikey", _supabaseKey);

                var response = await _httpClient.PostAsJsonAsync(
                    $"{_supabaseUrl}/auth/v1/token?grant_type=password",
                    request);

                var content = await response.Content.ReadAsStringAsync();

                if (!response.IsSuccessStatusCode)
                    return (false, null, null, ExtractSupabaseError(content, response.StatusCode));

                var json = JsonDocument.Parse(content);

                var token = json.RootElement.GetProperty("access_token").GetString();
                var userId = json.RootElement.GetProperty("user").GetProperty("id").GetString();

                if (string.IsNullOrWhiteSpace(token) || string.IsNullOrWhiteSpace(userId))
                    return (false, null, null, "R√©ponse Supabase invalide (token/userId manquant).");

                SetSession(token, userId);
                return (true, token, userId, null);
            }
            catch (HttpRequestException)
            {
                return (false, null, null, "Erreur de connexion au serveur. V√©rifiez votre connexion internet.");
            }
            catch (TaskCanceledException)
            {
                return (false, null, null, "La requ√™te a expir√©. V√©rifiez votre connexion internet.");
            }
            catch (Exception ex)
            {
                return (false, null, null, $"Erreur inattendue : {ex.Message}");
            }
        }

        public async Task<(bool success, string? accessToken, string? userId, string? error)>
            SignUpThenSignInAsync(string email, string password)
        {
            var (signUpSuccess, _, signUpError) = await SignUpAsync(email, password);
            if (!signUpSuccess)
                return (false, null, null, signUpError);

            var (signInSuccess, accessToken, userId, signInError) = await SignInAsync(email, password);
            if (!signInSuccess)
                return (false, null, null, signInError);

            return (true, accessToken, userId, null);
        }

        public async Task<(bool success, string? error)> SendPasswordResetAsync(string email)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(email) || !email.Contains("@"))
                    return (false, "Adresse email invalide");

                _httpClient.DefaultRequestHeaders.Clear();
                _httpClient.DefaultRequestHeaders.Add("apikey", _supabaseKey);

                var request = new
                {
                    email = email.Trim(),
                    redirect_to = "https://logecui.fr/logecui-reset-password/index.html"
                };

                var response = await _httpClient.PostAsJsonAsync($"{_supabaseUrl}/auth/v1/recover", request);
                var content = await response.Content.ReadAsStringAsync();

                return response.IsSuccessStatusCode
                    ? (true, null)
                    : (false, ExtractSupabaseError(content, response.StatusCode));
            }
            catch
            {
                return (false, "Erreur r√©seau. R√©essayez plus tard.");
            }
        }

        public async Task<(bool success, string? error)> UpdatePasswordAsync(string accessToken, string newPassword)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(newPassword) || newPassword.Length < 6)
                    return (false, "Le mot de passe doit contenir au moins 6 caract√®res.");

                _httpClient.DefaultRequestHeaders.Clear();
                _httpClient.DefaultRequestHeaders.Add("apikey", _supabaseKey);
                _httpClient.DefaultRequestHeaders.Add("Authorization", $"Bearer {accessToken}");

                var response = await _httpClient.PutAsJsonAsync(
                    $"{_supabaseUrl}/auth/v1/user",
                    new { password = newPassword });

                var content = await response.Content.ReadAsStringAsync();

                return response.IsSuccessStatusCode
                    ? (true, null)
                    : (false, ExtractSupabaseError(content, response.StatusCode));
            }
            catch
            {
                return (false, "Erreur r√©seau.");
            }
        }

        // =========================
        // EDGE FUNCTION : DELETE ACCOUNT
        // =========================

        public async Task<(bool success, string? error)> DeleteAccountAsync()
        {
            try
            {
                RequireAccessToken();

                System.Diagnostics.Debug.WriteLine("=== DELETE ACCOUNT DEBUG ===");
                System.Diagnostics.Debug.WriteLine($"Token: {_accessToken?.Substring(0, 30)}");

                // ‚úÖ IMPORTANT : Cr√©er une nouvelle requ√™te √† chaque fois
                using var request = new HttpRequestMessage(HttpMethod.Post,
                    $"{_supabaseUrl}/functions/v1/delete-account");

                // ‚úÖ Ajouter les headers dans le bon ordre
                request.Headers.TryAddWithoutValidation("apikey", _supabaseKey);
                request.Headers.TryAddWithoutValidation("Authorization", $"Bearer {_accessToken}");

                System.Diagnostics.Debug.WriteLine($"Headers added: {request.Headers.Count()}");

                var response = await _httpClient.SendAsync(request);
                var content = await response.Content.ReadAsStringAsync();

                System.Diagnostics.Debug.WriteLine($"Response: {(int)response.StatusCode} - {content}");

                if (!response.IsSuccessStatusCode)
                {
                    return (false, $"Erreur : {content}");
                }

                // Nettoyage local
                var userGuid = RequireCurrentUserGuid();
                await _client.Table<ArticleCourseDb>()
                    .Filter("user_id", Supabase.Postgrest.Constants.Operator.Equals, userGuid.ToString())
                    .Delete();

                await _client.Table<IngredientDb>()
                    .Filter("user_id", Supabase.Postgrest.Constants.Operator.Equals, userGuid.ToString())
                    .Delete();

                ClearSession();
                return (true, null);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Exception: {ex.Message}");
                return (false, $"Erreur : {ex.Message}");
            }
        }



        // =========================
        // ARTICLES (Liste de courses)
        // =========================

        public async Task<List<ArticleCourse>> GetArticlesAsync()
        {
            var userGuid = RequireCurrentUserGuid();

            var response = await _client
                .Table<ArticleCourseDb>()
                .Filter("user_id", Supabase.Postgrest.Constants.Operator.Equals, userGuid.ToString())
                .Get();

            return response.Models.Select(db => new ArticleCourse
            {
                Id = db.Id,
                Nom = db.Nom ?? "",
                Quantite = db.Quantite ?? "",
                Unite = db.Unite ?? "",
                EstAchete = db.EstAchete,
                // IMPORTANT: si ton mod√®le ArticleCourse.UserId est Guid (non nullable),
                // on prot√®ge avec ?? Guid.Empty
                UserId = db.UserId ?? Guid.Empty
            }).ToList();
        }

        public async Task<ArticleCourse?> AddArticleAsync(ArticleCourse article)
        {
            var userGuid = RequireCurrentUserGuid();

            var dbArticle = new ArticleCourseDb
            {
                Nom = article.Nom,
                Quantite = article.Quantite,
                Unite = article.Unite,
                EstAchete = article.EstAchete,
                UserId = (Guid?)userGuid // ‚úÖ Guid -> Guid?
            };

            var response = await _client.Table<ArticleCourseDb>().Insert(dbArticle);
            var inserted = response.Models.FirstOrDefault();
            if (inserted == null) return null;

            return new ArticleCourse
            {
                Id = inserted.Id,
                Nom = inserted.Nom ?? "",
                Quantite = inserted.Quantite ?? "",
                Unite = inserted.Unite ?? "",
                EstAchete = inserted.EstAchete,
                UserId = inserted.UserId ?? Guid.Empty
            };
        }

        public async Task<bool> UpdateArticleAsync(int id, ArticleCourse article)
        {
            var userGuid = RequireCurrentUserGuid();

            var dbArticle = new ArticleCourseDb
            {
                Id = id,
                Nom = article.Nom,
                Quantite = article.Quantite,
                Unite = article.Unite,
                EstAchete = article.EstAchete,
                UserId = (Guid?)userGuid // ‚úÖ Guid -> Guid?
            };

            await _client.Table<ArticleCourseDb>().Update(dbArticle);
            return true;
        }

        public async Task<bool> DeleteArticleAsync(int id)
        {
            var userGuid = RequireCurrentUserGuid();

            // S√©curise par user_id (sinon RLS peut bloquer ou pire, toucher autre chose si policy permissive)
            await _client.Table<ArticleCourseDb>()
                .Filter("user_id", Supabase.Postgrest.Constants.Operator.Equals, userGuid.ToString())
                .Filter("id", Supabase.Postgrest.Constants.Operator.Equals, id)
                .Delete();

            return true;
        }

        public async Task<bool> DeleteAchetesAsync()
        {
            var userGuid = RequireCurrentUserGuid();

            await _client.Table<ArticleCourseDb>()
                .Filter("user_id", Supabase.Postgrest.Constants.Operator.Equals, userGuid.ToString())
                .Filter("est_achete", Supabase.Postgrest.Constants.Operator.Equals, true)
                .Delete();

            return true;
        }

        // =========================
        // INGREDIENTS
        // =========================

        public async Task<List<Ingredient>> GetIngredientsAsync()
        {
            var userGuid = RequireCurrentUserGuid();

            var response = await _client
                .Table<IngredientDb>()
                .Filter("user_id", Supabase.Postgrest.Constants.Operator.Equals, userGuid.ToString())
                .Get();

            return response.Models.Select(db => new Ingredient
            {
                Id = db.Id,
                // Si Ingredient.UserId est Guid (non nullable), on prot√®ge :
                UserId = db.UserId ?? Guid.Empty,
                Nom = db.Nom ?? "",
                Quantite = db.Quantite ?? "",
                Unite = db.Unite ?? "",
                EstDisponible = db.EstDisponible
            }).ToList();
        }

        public async Task<Ingredient?> AddIngredientAsync(Ingredient ingredient)
        {
            var userGuid = RequireCurrentUserGuid();

            var db = new IngredientDb
            {
                Nom = ingredient.Nom,
                Quantite = ingredient.Quantite,
                Unite = ingredient.Unite,
                EstDisponible = ingredient.EstDisponible,
                UserId = (Guid?)userGuid // ‚úÖ Guid -> Guid?
            };

            var response = await _client.Table<IngredientDb>().Insert(db);
            var inserted = response.Models.FirstOrDefault();
            if (inserted == null) return null;

            return new Ingredient
            {
                Id = inserted.Id,
                UserId = inserted.UserId ?? Guid.Empty,
                Nom = inserted.Nom ?? "",
                Quantite = inserted.Quantite ?? "",
                Unite = inserted.Unite ?? "",
                EstDisponible = inserted.EstDisponible
            };
        }

        public async Task<bool> UpdateIngredientAsync(Ingredient ingredient)
        {
            var userGuid = RequireCurrentUserGuid();

            if (ingredient.Id == Guid.Empty)
                throw new InvalidOperationException("Id ingr√©dient manquant.");

            var db = new IngredientDb
            {
                Id = ingredient.Id,
                Nom = ingredient.Nom,
                Quantite = ingredient.Quantite,
                Unite = ingredient.Unite,
                EstDisponible = ingredient.EstDisponible,
                UserId = (Guid?)userGuid // ‚úÖ Guid -> Guid?
            };

            await _client.Table<IngredientDb>().Update(db);
            return true;
        }

        public async Task<bool> DeleteIngredientAsync(Guid id)
        {
            var userGuid = RequireCurrentUserGuid();

            if (id == Guid.Empty)
                throw new InvalidOperationException("Id ingr√©dient manquant.");

            await _client.Table<IngredientDb>()
                .Filter("user_id", Supabase.Postgrest.Constants.Operator.Equals, userGuid.ToString())
                .Filter("id", Supabase.Postgrest.Constants.Operator.Equals, id.ToString())
                .Delete();

            return true;
        }

        // =========================
        // UTIL
        // =========================

        private static string ExtractSupabaseError(string content, System.Net.HttpStatusCode code)
        {
            if (!string.IsNullOrWhiteSpace(content))
            {
                try
                {
                    var json = JsonDocument.Parse(content);

                    if (json.RootElement.TryGetProperty("msg", out var msg)) return msg.GetString() ?? $"Erreur {code}";
                    if (json.RootElement.TryGetProperty("error_description", out var ed)) return ed.GetString() ?? $"Erreur {code}";
                    if (json.RootElement.TryGetProperty("message", out var m)) return m.GetString() ?? $"Erreur {code}";
                    if (json.RootElement.TryGetProperty("error", out var e)) return e.GetString() ?? $"Erreur {code}";
                }
                catch
                {
                    if (content.Length < 400) return content;
                }
            }

            return $"Erreur {code}";
        }
    }

    // =========================
    // MODELES DB
    // =========================

    [Table("articles_courses")]
    public class ArticleCourseDb : BaseModel
    {
        [PrimaryKey("id", false)]
        public int Id { get; set; }

        [Column("nom")]
        public string? Nom { get; set; }

        [Column("quantite")]
        public string? Quantite { get; set; }

        [Column("unite")]
        public string? Unite { get; set; }

        [Column("est_achete")]
        public bool EstAchete { get; set; }

        [Column("user_id")]
        public Guid? UserId { get; set; } // DB nullable -> mapping prot√®ge avec ?? Guid.Empty
    }

    [Table("ingredients")]
    public class IngredientDb : BaseModel
    {
        [PrimaryKey("id", false)]
        public Guid Id { get; set; }

        [Column("nom")]
        public string? Nom { get; set; }

        [Column("quantite")]
        public string? Quantite { get; set; }

        [Column("unite")]
        public string? Unite { get; set; }

        [Column("est_disponible")]
        public bool EstDisponible { get; set; }

        [Column("user_id")]
        public Guid? UserId { get; set; } // DB nullable -> mapping prot√®ge avec ?? Guid.Empty
    }
}



================================================================================
FILE: LoGeCuiShared\Services\updateService.cs
================================================================================

Ôªøusing System;
using System.Linq;
using System.Threading.Tasks;
using Supabase.Postgrest;
using Supabase.Postgrest.Attributes;
using Supabase.Postgrest.Models;

namespace LoGeCuiShared.Services
{
    public class UpdateService
    {
        private readonly Client _client;

        public UpdateService(string url, string key)
        {
            var options = new ClientOptions
            {
                Headers = new Dictionary<string, string>
                {
                    { "apikey", key },
                    { "Authorization", $"Bearer {key}" }
                }
            };

            _client = new Client($"{url}/rest/v1", options);
        }

        public async Task<AppVersionInfo?> CheckForUpdateAsync(string platform, string currentVersion)
        {
            try
            {
                var response = await _client
                    .Table<AppVersionDb>()
                    .Filter("platform", Supabase.Postgrest.Constants.Operator.Equals, platform)
                    .Order("created_at", Supabase.Postgrest.Constants.Ordering.Descending)
                    .Limit(1)
                    .Get();

                var latestVersion = response.Models.FirstOrDefault();

                if (latestVersion == null)
                    return null;

                // Comparer les versions
                if (IsNewerVersion(latestVersion.Version, currentVersion))
                {
                    return new AppVersionInfo
                    {
                        Version = latestVersion.Version ?? "",
                        DownloadUrl = latestVersion.DownloadUrl ?? "",
                        IsMandatory = latestVersion.IsMandatory,
                        ReleaseNotes = latestVersion.ReleaseNotes ?? ""
                    };
                }

                return null; // Pas de mise √† jour disponible
            }
            catch
            {
                return null;
            }
        }

        private bool IsNewerVersion(string? latestVersion, string currentVersion)
        {
            if (string.IsNullOrEmpty(latestVersion))
                return false;

            try
            {
                var latest = new Version(latestVersion);
                var current = new Version(currentVersion);
                return latest > current;
            }
            catch
            {
                return false;
            }
        }
    }

    // Mod√®le pour la table app_versions
    [Table("app_versions")]
    public class AppVersionDb : BaseModel
    {
        [PrimaryKey("id", false)]
        public int Id { get; set; }

        [Column("platform")]
        public string? Platform { get; set; }

        [Column("version")]
        public string? Version { get; set; }

        [Column("download_url")]
        public string? DownloadUrl { get; set; }

        [Column("is_mandatory")]
        public bool IsMandatory { get; set; }

        [Column("release_notes")]
        public string? ReleaseNotes { get; set; }

        [Column("created_at")]
        public DateTime CreatedAt { get; set; }
    }

    // Classe pour retourner les infos de version
    public class AppVersionInfo
    {
        public string Version { get; set; } = "";
        public string DownloadUrl { get; set; } = "";
        public bool IsMandatory { get; set; }
        public string ReleaseNotes { get; set; } = "";
    }
}

================================================================================
FILE: output_concat.txt
================================================================================

# CONCAT OUTPUT
# Root: C:\Users\Francois\source\repos\LoGeCui
# Files: 102


================================================================================
FILE: LoGeCui\App.xaml
================================================================================

Ôªø<Application x:Class="LoGeCui.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    <Application.Resources>
         
    </Application.Resources>
</Application>

================================================================================
FILE: LoGeCui\App.xaml.cs
================================================================================

Ôªøusing System;
using System.Windows;
using LoGeCuiShared.Services;

namespace LoGeCui
{
    public partial class App : Application
    {
        // AJOUT√â : Instance unique de SupabaseService
        public static SupabaseService SupabaseService { get; private set; }
        public static SupabaseRestClient? RestClient { get; private set; }
        public static RecipesService? RecipesService { get; private set; }
        public static Guid? CurrentUserId { get; private set; }

        protected override void OnStartup(StartupEventArgs e)
        {
            base.OnStartup(e);

            // AJOUT√â : Initialiser le service Supabase UNE SEULE FOIS
            string url = ConfigurationHelper.GetSupabaseUrl();
            string key = ConfigurationHelper.GetSupabaseKey(); // Remplace par ta cl√© anon

            // Cr√©er l'instance UNE SEULE FOIS
            SupabaseService = new SupabaseService(url, key);

            // afficher login
            new LoginWindow().Show();

            // Ouvrir la fen√™tre de connexion en premier
            var loginWindow = new LoginWindow();
            loginWindow.Show();
        }

        public static void InitRestServices(string accessToken, Guid userId)
        {
            string url = ConfigurationHelper.GetSupabaseUrl();
            string key = ConfigurationHelper.GetSupabaseKey();

            var client = new SupabaseRestClient(url, key);
            client.SetBearerToken(accessToken);

            RestClient = client;
            RecipesService = new RecipesService(client);
            CurrentUserId = userId;
        }
    }
}

================================================================================
FILE: LoGeCui\appsettings.example.json
================================================================================

Ôªø{
  "Supabase": {
    "Url": "https://VOTRE_PROJECT_ID.supabase.co",
    "Key": "VOTRE_PUBLISHABLE_KEY"
  }
}

================================================================================
FILE: LoGeCui\appsettings.json
================================================================================

{
  "Supabase": {
    "Url": "https://wzctiypsadqktzcnswri.supabase.co",
    "Key": "sb_publishable_ZFk8ONON5qMA0vZ3V0nVAg_TZZrO1F1"
  }

}

================================================================================
FILE: LoGeCui\AssemblyInfo.cs
================================================================================

using System.Windows;

[assembly: ThemeInfo(
    ResourceDictionaryLocation.None,            //where theme specific resource dictionaries are located
                                                //(used if a resource is not found in the page,
                                                // or application resource dictionaries)
    ResourceDictionaryLocation.SourceAssembly   //where the generic resource dictionary is located
                                                //(used if a resource is not found in the page,
                                                // app, or any theme specific resource dictionaries)
)]

================================================================================
FILE: LoGeCui\ConfigurationHelper.cs
================================================================================

Ôªøusing Microsoft.Extensions.Configuration;
using System;
using System.IO;

namespace LoGeCui
{
    public static class ConfigurationHelper
    {
        private static IConfiguration? _configuration;

        public static IConfiguration Configuration
        {
            get
            {
                if (_configuration == null)
                {
                    var builder = new ConfigurationBuilder()
                        .SetBasePath(AppDomain.CurrentDomain.BaseDirectory)
                        .AddJsonFile("appsettings.json", optional: false, reloadOnChange: true);

                    _configuration = builder.Build();
                }
                return _configuration;
            }
        }

        public static string GetSupabaseUrl()
        {
            return Configuration["Supabase:Url"] ?? throw new Exception("Supabase URL non configur√©e");
        }

        public static string GetSupabaseKey()
        {
            return Configuration["Supabase:Key"] ?? throw new Exception("Supabase Key non configur√©e");
        }
    }
}

================================================================================
FILE: LoGeCui\Dialogs\AjouterArticleCourseDialog.xaml
================================================================================

Ôªø<Window x:Class="LoGeCui.Dialogs.AjouterArticleCourseDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Ajouter un article" 
        Height="400" 
        Width="400"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize"
        Background="#ECF0F1">

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0"
                   Text="üõí Ajouter √† la liste de courses"
                   FontSize="18"
                   FontWeight="Bold"
                   Foreground="#2C3E50"
                   Margin="0,0,0,15"/>

        <StackPanel Grid.Row="1" Margin="0,0,0,10">
            <TextBlock Text="Nom *"
                       FontSize="13"
                       FontWeight="SemiBold"
                       Margin="0,0,0,5"/>
            <TextBox x:Name="TxtNom"
                     Height="30"
                     FontSize="13"
                     Padding="5"/>
        </StackPanel>

        <StackPanel Grid.Row="2" Margin="0,0,0,10">
            <TextBlock Text="Quantit√© *"
                       FontSize="13"
                       FontWeight="SemiBold"
                       Margin="0,0,0,5"/>
            <TextBox x:Name="TxtQuantite"
                     Height="30"
                     FontSize="13"
                     Padding="5"/>
        </StackPanel>

        <StackPanel Grid.Row="3" Margin="0,0,0,10">
            <TextBlock Text="Unit√© *"
                       FontSize="13"
                       FontWeight="SemiBold"
                       Margin="0,0,0,5"/>
            <ComboBox x:Name="CmbUnite"
                      Height="30"
                      FontSize="13"
                      Padding="5">
                <ComboBoxItem Content="g"/>
                <ComboBoxItem Content="kg"/>
                <ComboBoxItem Content="ml"/>
                <ComboBoxItem Content="L"/>
                <ComboBoxItem Content="pi√®ces" IsSelected="True"/>
                <ComboBoxItem Content="bo√Ætes"/>
                <ComboBoxItem Content="sachets"/>
            </ComboBox>
        </StackPanel>

        <StackPanel Grid.Row="5"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    Margin="0,10,0,0">

            <Button Content="Annuler"
                    Width="100"
                    Height="35"
                    Margin="0,0,10,0"
                    Background="#95A5A6"
                    Foreground="White"
                    FontSize="13"
                    BorderThickness="0"
                    Click="BtnAnnuler_Click"/>

            <Button Content="Ajouter"
                    Width="100"
                    Height="35"
                    Background="#27AE60"
                    Foreground="White"
                    FontSize="13"
                    BorderThickness="0"
                    Click="BtnAjouter_Click"/>

        </StackPanel>

    </Grid>

</Window>

================================================================================
FILE: LoGeCui\Dialogs\AjouterArticleCourseDialog.xaml.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Shapes;
using LoGeCuiShared.Models;

namespace LoGeCui.Dialogs
{
    public partial class AjouterArticleCourseDialog : Window
    {
        public ArticleCourse? NouvelArticle { get; private set; }

        public AjouterArticleCourseDialog()
        {
            InitializeComponent();
            TxtNom.Focus();
        }

        private void BtnAjouter_Click(object sender, RoutedEventArgs e)
        {
            if (string.IsNullOrWhiteSpace(TxtNom.Text))
            {
                MessageBox.Show("Veuillez entrer un nom.", "Champ requis", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            if (string.IsNullOrWhiteSpace(TxtQuantite.Text))
            {
                MessageBox.Show("Veuillez entrer une quantit√©.", "Champ requis", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            NouvelArticle = new ArticleCourse
            {
                Nom = TxtNom.Text.Trim(),
                Quantite = TxtQuantite.Text.Trim(),
                Unite = (CmbUnite.SelectedItem as System.Windows.Controls.ComboBoxItem)?.Content.ToString() ?? "pi√®ces",
                EstAchete = false
            };

            DialogResult = true;
            Close();
        }

        private void BtnAnnuler_Click(object sender, RoutedEventArgs e)
        {
            DialogResult = false;
            Close();
        }
    }
}

================================================================================
FILE: LoGeCui\Dialogs\AjouterIngredientDialog.xaml
================================================================================

Ôªø<Window x:Class="LoGeCui.Dialogs.AjouterIngredientDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Ajouter un ingr√©dient" 
        Height="700" 
        Width="450"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize"
        Background="#ECF0F1">
    
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Titre -->
        <TextBlock Grid.Row="0"
                   Text="‚ûï Nouvel ingr√©dient"
                   FontSize="22"
                   FontWeight="Bold"
                   Foreground="#2C3E50"
                   Margin="0,0,0,20"/>
        
        <!-- Nom -->
        <StackPanel Grid.Row="1" Margin="0,0,0,15">
            <TextBlock Text="Nom de l'ingr√©dient *"
                       FontSize="14"
                       FontWeight="SemiBold"
                       Foreground="#34495E"
                       Margin="0,0,0,5"/>
            <TextBox x:Name="TxtNom"
                     Height="35"
                     FontSize="14"
                     Padding="8"
                     BorderBrush="#BDC3C7"
                     BorderThickness="1"/>
        </StackPanel>
        
        <!-- Quantit√© -->
        <StackPanel Grid.Row="2" Margin="0,0,0,15">
            <TextBlock Text="Quantit√© *"
                       FontSize="14"
                       FontWeight="SemiBold"
                       Foreground="#34495E"
                       Margin="0,0,0,5"/>
            <TextBox x:Name="TxtQuantite"
                     Height="35"
                     FontSize="14"
                     Padding="8"
                     BorderBrush="#BDC3C7"
                     BorderThickness="1"/>
        </StackPanel>
        
        <!-- Unit√© -->
        <StackPanel Grid.Row="3" Margin="0,0,0,15">
            <TextBlock Text="Unit√© *"
                       FontSize="14"
                       FontWeight="SemiBold"
                       Foreground="#34495E"
                       Margin="0,0,0,5"/>
            <ComboBox x:Name="CmbUnite"
                      Height="35"
                      FontSize="14"
                      Padding="8,5"
                      BorderBrush="#BDC3C7"
                      BorderThickness="1">
                <ComboBoxItem Content="kg" IsSelected="True"/>
                <ComboBoxItem Content="g"/>
                <ComboBoxItem Content="L"/>
                <ComboBoxItem Content="ml"/>
                <ComboBoxItem Content="pi√®ces"/>
                <ComboBoxItem Content="sachets"/>
                <ComboBoxItem Content="bo√Ætes"/>
            </ComboBox>
        </StackPanel>
        
        <!-- Boutons -->
        <StackPanel Grid.Row="5"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right">
            
            <Button Content="‚ùå Annuler"
                    Width="120"
                    Height="40"
                    Margin="0,0,10,0"
                    Background="#95A5A6"
                    Foreground="White"
                    FontSize="14"
                    FontWeight="Bold"
                    BorderThickness="0"
                    Cursor="Hand"
                    Click="BtnAnnuler_Click">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#95A5A6"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#7F8C8D"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>
            
            <Button Content="‚úÖ Ajouter"
                    Width="120"
                    Height="40"
                    Background="#27AE60"
                    Foreground="White"
                    FontSize="14"
                    FontWeight="Bold"
                    BorderThickness="0"
                    Cursor="Hand"
                    Click="BtnAjouter_Click">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#27AE60"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#229954"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>
            
        </StackPanel>
        
    </Grid>
    
</Window>

================================================================================
FILE: LoGeCui\Dialogs\AjouterIngredientDialog.xaml.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Shapes;
using LoGeCuiShared.Models;

namespace LoGeCui.Dialogs
{
    public partial class AjouterIngredientDialog : Window
    {
        // Propri√©t√© pour r√©cup√©rer l'ingr√©dient cr√©√©
        public Ingredient? NouvelIngredient { get; private set; }

        public AjouterIngredientDialog()
        {
            InitializeComponent();

            // Focus sur le premier champ
            TxtNom.Focus();
        }

        private void BtnAjouter_Click(object sender, RoutedEventArgs e)
        {
            // Validation : v√©rifier que tous les champs sont remplis
            if (string.IsNullOrWhiteSpace(TxtNom.Text))
            {
                MessageBox.Show("Veuillez entrer un nom d'ingr√©dient.",
                    "Champ requis",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
                TxtNom.Focus();
                return;
            }

            if (string.IsNullOrWhiteSpace(TxtQuantite.Text))
            {
                MessageBox.Show("Veuillez entrer une quantit√©.",
                    "Champ requis",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
                TxtQuantite.Focus();
                return;
            }

            // Cr√©er l'ingr√©dient
            NouvelIngredient = new Ingredient
            {
                Nom = TxtNom.Text.Trim(),
                Quantite = TxtQuantite.Text.Trim(),
                Unite = (CmbUnite.SelectedItem as ComboBoxItem)?.Content.ToString() ?? "pi√®ces",
                EstDisponible = true
            };

            // Fermer la fen√™tre avec succ√®s
            DialogResult = true;
            Close();
        }

        private void BtnAnnuler_Click(object sender, RoutedEventArgs e)
        {
            // Fermer sans rien faire
            DialogResult = false;
            Close();
        }
    }
}

================================================================================
FILE: LoGeCui\Dialogs\AjouterIngredientRecetteDialog.xaml
================================================================================

Ôªø<Window x:Class="LoGeCui.Dialogs.AjouterIngredientRecetteDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Ajouter un ingr√©dient" 
        Height="400" 
        Width="400"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize"
        Background="#ECF0F1">

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Titre -->
        <TextBlock Grid.Row="0"
                   Text="ü•ò Ajouter un ingr√©dient"
                   FontSize="18"
                   FontWeight="Bold"
                   Foreground="#2C3E50"
                   Margin="0,0,0,15"/>

        <!-- Nom -->
        <StackPanel Grid.Row="1" Margin="0,0,0,10">
            <TextBlock Text="Nom *"
                       FontSize="13"
                       FontWeight="SemiBold"
                       Margin="0,0,0,5"/>
            <TextBox x:Name="TxtNom"
                     Height="30"
                     FontSize="13"
                     Padding="5"/>
        </StackPanel>

        <!-- Quantit√© -->
        <StackPanel Grid.Row="2" Margin="0,0,0,10">
            <TextBlock Text="Quantit√© *"
                       FontSize="13"
                       FontWeight="SemiBold"
                       Margin="0,0,0,5"/>
            <TextBox x:Name="TxtQuantite"
                     Height="30"
                     FontSize="13"
                     Padding="5"/>
        </StackPanel>

        <!-- Unit√© -->
        <StackPanel Grid.Row="3" Margin="0,0,0,10">
            <TextBlock Text="Unit√© *"
                       FontSize="13"
                       FontWeight="SemiBold"
                       Margin="0,0,0,5"/>
            <ComboBox x:Name="CmbUnite"
                      Height="30"
                      FontSize="13"
                      Padding="5">
                <ComboBoxItem Content="g"/>
                <ComboBoxItem Content="kg"/>
                <ComboBoxItem Content="ml"/>
                <ComboBoxItem Content="L"/>
                <ComboBoxItem Content="pi√®ces" IsSelected="True"/>
                <ComboBoxItem Content="cuill√®res √† soupe"/>
                <ComboBoxItem Content="cuill√®res √† caf√©"/>
            </ComboBox>
        </StackPanel>

        <!-- Boutons -->
        <StackPanel Grid.Row="5"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    Margin="0,10,0,0">

            <Button Content="Annuler"
                    Width="100"
                    Height="35"
                    Margin="0,0,10,0"
                    Background="#95A5A6"
                    Foreground="White"
                    FontSize="13"
                    BorderThickness="0"
                    Click="BtnAnnuler_Click"/>

            <Button Content="Ajouter"
                    Width="100"
                    Height="35"
                    Background="#27AE60"
                    Foreground="White"
                    FontSize="13"
                    BorderThickness="0"
                    Click="BtnAjouter_Click"/>

        </StackPanel>

    </Grid>

</Window>

================================================================================
FILE: LoGeCui\Dialogs\AjouterIngredientRecetteDialog.xaml.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Shapes;
using LoGeCuiShared.Models;

namespace LoGeCui.Dialogs
{
    /// <summary>
    /// Logique d'interaction pour AjouterIngredientRecetteDialog.xaml
    /// </summary>
    public partial class AjouterIngredientRecetteDialog : Window
    {
        public IngredientRecette? NouvelIngredient { get; private set; }  // ‚Üê LIGNE AJOUT√âE !

        public AjouterIngredientRecetteDialog()
        {
            InitializeComponent();
            TxtNom.Focus();
        }

        private void BtnAjouter_Click(object sender, RoutedEventArgs e)
        {
            if (string.IsNullOrWhiteSpace(TxtNom.Text))
            {
                MessageBox.Show("Veuillez entrer un nom.", "Champ requis", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            if (string.IsNullOrWhiteSpace(TxtQuantite.Text))
            {
                MessageBox.Show("Veuillez entrer une quantit√©.", "Champ requis", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            NouvelIngredient = new IngredientRecette  // ‚Üê CHANG√â aussi ici !
            {
                Nom = TxtNom.Text.Trim(),
                Quantite = TxtQuantite.Text.Trim(),
                Unite = (CmbUnite.SelectedItem as System.Windows.Controls.ComboBoxItem)?.Content.ToString() ?? "pi√®ces"
            };

            DialogResult = true;
            Close();
        }

        private void BtnAnnuler_Click(object sender, RoutedEventArgs e)
        {
            DialogResult = false;
            Close();
        }
    }
}

================================================================================
FILE: LoGeCui\Dialogs\AjouterRecetteDialog.xaml
================================================================================

Ôªø<Window x:Class="LoGeCui.Dialogs.AjouterRecetteDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Ajouter une recette" 
        Height="700" 
        Width="600"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize"
        Background="#ECF0F1">

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <Grid Margin="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Titre -->
            <TextBlock Grid.Row="0"
                       Text="‚ûï Nouvelle recette"
                       FontSize="22"
                       FontWeight="Bold"
                       Foreground="#2C3E50"
                       Margin="0,0,0,20"/>

            <!-- Nom -->
            <StackPanel Grid.Row="1" Margin="0,0,0,15">
                <TextBlock Text="Nom de la recette *"
                           FontSize="14"
                           FontWeight="SemiBold"
                           Foreground="#34495E"
                           Margin="0,0,0,5"/>
                <TextBox x:Name="TxtNom"
                         Height="35"
                         FontSize="14"
                         Padding="8"
                         BorderBrush="#BDC3C7"
                         BorderThickness="1"/>
            </StackPanel>

            <!-- Type et Temps sur la m√™me ligne -->
            <Grid Grid.Row="2" Margin="0,0,0,15">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="10"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Type -->
                <StackPanel Grid.Column="0">
                    <TextBlock Text="Type *"
                               FontSize="14"
                               FontWeight="SemiBold"
                               Foreground="#34495E"
                               Margin="0,0,0,5"/>
                    <ComboBox x:Name="CmbType"
                              Height="35"
                              FontSize="14"
                              Padding="8,5"
                              BorderBrush="#BDC3C7"
                              BorderThickness="1">
                        <ComboBoxItem Content="Entr√©e" Tag="Entree"/>
                        <ComboBoxItem Content="Plat" Tag="Plat" IsSelected="True"/>
                        <ComboBoxItem Content="Dessert" Tag="Dessert"/>
                    </ComboBox>
                </StackPanel>

                <!-- Temps -->
                <StackPanel Grid.Column="2">
                    <TextBlock Text="Temps (minutes) *"
                               FontSize="14"
                               FontWeight="SemiBold"
                               Foreground="#34495E"
                               Margin="0,0,0,5"/>
                    <TextBox x:Name="TxtTemps"
                             Height="35"
                             FontSize="14"
                             Padding="8"
                             BorderBrush="#BDC3C7"
                             BorderThickness="1"/>
                </StackPanel>
            </Grid>

            <!-- Difficult√© -->
            <StackPanel Grid.Row="3" Margin="0,0,0,15">
                <TextBlock Text="Difficult√© *"
                           FontSize="14"
                           FontWeight="SemiBold"
                           Foreground="#34495E"
                           Margin="0,0,0,5"/>
                <StackPanel Orientation="Horizontal">
                    <Slider x:Name="SliderDifficulte"
                            Width="400"
                            Minimum="1"
                            Maximum="5"
                            Value="3"
                            TickFrequency="1"
                            IsSnapToTickEnabled="True"
                            VerticalAlignment="Center"
                            ValueChanged="SliderDifficulte_ValueChanged"/>
                    <TextBlock x:Name="TxtDifficulte"
                               Text="‚≠ê‚≠ê‚≠ê"
                               FontSize="18"
                               Margin="10,0,0,0"
                               VerticalAlignment="Center"/>
                </StackPanel>
            </StackPanel>

            <!-- Ingr√©dients -->
            <StackPanel Grid.Row="4" Margin="0,0,0,15">
                <TextBlock Text="Ingr√©dients *"
                           FontSize="14"
                           FontWeight="SemiBold"
                           Foreground="#34495E"
                           Margin="0,0,0,5"/>

                <!-- Liste des ingr√©dients ajout√©s -->
                <Border BorderBrush="#BDC3C7"
                        BorderThickness="1"
                        CornerRadius="3"
                        Background="White"
                        MinHeight="100"
                        MaxHeight="150"
                        Margin="0,0,0,10">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ListBox x:Name="ListeIngredients"
                                 BorderThickness="0"
                                 Background="Transparent">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="5">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <TextBlock Grid.Column="0"
                                                   Text="{Binding}"
                                                   VerticalAlignment="Center"/>

                                        <Button Grid.Column="1"
                                                Content="‚ùå"
                                                Width="25"
                                                Height="25"
                                                FontSize="10"
                                                Background="#E74C3C"
                                                Foreground="White"
                                                BorderThickness="0"
                                                Cursor="Hand"
                                                Click="BtnSupprimerIngredient_Click"
                                                Tag="{Binding}"/>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </ScrollViewer>
                </Border>

                <Button Content="‚ûï Ajouter un ingr√©dient"
                        Height="35"
                        Background="#27AE60"
                        Foreground="White"
                        FontSize="13"
                        FontWeight="Bold"
                        BorderThickness="0"
                        Cursor="Hand"
                        Click="BtnAjouterIngredient_Click"/>
            </StackPanel>

            <!-- Instructions -->
            <StackPanel Grid.Row="5" Margin="0,0,0,15">
                <TextBlock Text="Instructions *"
                           FontSize="14"
                           FontWeight="SemiBold"
                           Foreground="#34495E"
                           Margin="0,0,0,5"/>
                <TextBox x:Name="TxtInstructions"
                         Height="100"
                         FontSize="14"
                         Padding="8"
                         BorderBrush="#BDC3C7"
                         BorderThickness="1"
                         TextWrapping="Wrap"
                         AcceptsReturn="True"
                         VerticalScrollBarVisibility="Auto"/>
            </StackPanel>

            <!-- Boutons -->
            <StackPanel Grid.Row="8"
                        Orientation="Horizontal"
                        HorizontalAlignment="Right"
                        Margin="0,20,0,0">

                <Button Content="‚ùå Annuler"
                        Width="120"
                        Height="40"
                        Margin="0,0,10,0"
                        Background="#95A5A6"
                        Foreground="White"
                        FontSize="14"
                        FontWeight="Bold"
                        BorderThickness="0"
                        Cursor="Hand"
                        Click="BtnAnnuler_Click"/>

                <Button Content="‚úÖ Ajouter"
                        Width="120"
                        Height="40"
                        Background="#27AE60"
                        Foreground="White"
                        FontSize="14"
                        FontWeight="Bold"
                        BorderThickness="0"
                        Cursor="Hand"
                        Click="BtnAjouter_Click"/>

            </StackPanel>

        </Grid>
    </ScrollViewer>

</Window>

================================================================================
FILE: LoGeCui\Dialogs\AjouterRecetteDialog.xaml.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Shapes;
using System.Collections.ObjectModel;
using LoGeCuiShared.Models;


namespace LoGeCui.Dialogs
{
    /// <summary>
    /// Logique d'interaction pour AjouterRecetteDialog.xaml
    /// </summary>
    public partial class AjouterRecetteDialog : Window
    {

        public Recette? NouvelleRecette { get; private set; }
        private ObservableCollection<IngredientRecette> _ingredients;

        public AjouterRecetteDialog()
        {
            InitializeComponent();

            _ingredients = new ObservableCollection<IngredientRecette>();
            ListeIngredients.ItemsSource = _ingredients;

            TxtNom.Focus();
        }

        private void SliderDifficulte_ValueChanged(object sender, RoutedPropertyChangedEventArgs<double> e)
        {
            if (TxtDifficulte != null)
            {
                int valeur = (int)SliderDifficulte.Value;
                TxtDifficulte.Text = new string('‚≠ê', valeur);
            }
        }

        private void BtnAjouterIngredient_Click(object sender, RoutedEventArgs e)
        {
            // Cr√©er une petite fen√™tre pour ajouter un ingr√©dient
            var dialogIngredient = new AjouterIngredientRecetteDialog();
            dialogIngredient.Owner = this;

            bool? resultat = dialogIngredient.ShowDialog();

            if (resultat == true && dialogIngredient.NouvelIngredient != null)
            {
                _ingredients.Add(dialogIngredient.NouvelIngredient);
            }
        }

        private void BtnSupprimerIngredient_Click(object sender, RoutedEventArgs e)
        {
            var bouton = sender as System.Windows.Controls.Button;
            var ingredient = bouton?.Tag as IngredientRecette;

            if (ingredient != null)
            {
                _ingredients.Remove(ingredient);
            }
        }

        private void BtnAjouter_Click(object sender, RoutedEventArgs e)
        {
            // Validation
            if (string.IsNullOrWhiteSpace(TxtNom.Text))
            {
                MessageBox.Show("Veuillez entrer un nom de recette.",
                    "Champ requis",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
                TxtNom.Focus();
                return;
            }

            if (!int.TryParse(TxtTemps.Text, out int temps) || temps <= 0)
            {
                MessageBox.Show("Veuillez entrer un temps de pr√©paration valide.",
                    "Champ requis",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
                TxtTemps.Focus();
                return;
            }

            if (_ingredients.Count == 0)
            {
                MessageBox.Show("Veuillez ajouter au moins un ingr√©dient.",
                    "Ingr√©dients requis",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
                return;
            }

            if (string.IsNullOrWhiteSpace(TxtInstructions.Text))
            {
                MessageBox.Show("Veuillez entrer les instructions.",
                    "Champ requis",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
                TxtInstructions.Focus();
                return;
            }

            // R√©cup√©rer le type
            var selectedItem = CmbType.SelectedItem as System.Windows.Controls.ComboBoxItem;
            var typeTag = selectedItem?.Tag?.ToString() ?? "Plat";

            TypePlat type = typeTag switch
            {
                "Entree" => TypePlat.Entree,
                "Dessert" => TypePlat.Dessert,
                _ => TypePlat.Plat
            };

            // Cr√©er la recette
            NouvelleRecette = new Recette
            {
                Nom = TxtNom.Text.Trim(),
                Type = type,
                TempsPreparation = temps,
                Difficulte = (int)SliderDifficulte.Value,
                Ingredients = new System.Collections.Generic.List<IngredientRecette>(_ingredients),
                Instructions = TxtInstructions.Text.Trim()
            };

            DialogResult = true;
            Close();
        }

        private void BtnAnnuler_Click(object sender, RoutedEventArgs e)
        {
            DialogResult = false;
            Close();
        }
    }
}

================================================================================
FILE: LoGeCui\LoGeCui.csproj
================================================================================

Ôªø<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net10.0-windows</TargetFramework>
	  <SelfContained>true</SelfContained>
	  <PublishSingleFile>true</PublishSingleFile>
	  <IncludeNativeLibrariesForSelfExtract>true</IncludeNativeLibrariesForSelfExtract>
	  <IncludeAllContentForSelfExtract>true</IncludeAllContentForSelfExtract>
	  <RuntimeIdentifier>win-x64</RuntimeIdentifier>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <UseWPF>true</UseWPF>
    <Version>1.1.5</Version>
	  <ApplicationIcon>postriticone.ico</ApplicationIcon>
  </PropertyGroup>

	<ItemGroup>
		<EmbeddedResource Include="appsettings.json" />
	</ItemGroup>

  <ItemGroup>
    <None Remove="appsettings.json" />
    <None Remove="postriticone.ico" />
  </ItemGroup>

  <ItemGroup>
    <Content Include="appsettings.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </Content>
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.Extensions.Configuration.Json" Version="10.0.2" />
    <PackageReference Include="Supabase.Postgrest" Version="4.1.0" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\LoGeCuiShared\LoGeCuiShared.csproj" />
  </ItemGroup>

  <ItemGroup>
    <Resource Include="postriticone.ico">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </Resource>
  </ItemGroup>

</Project>

================================================================================
FILE: LoGeCui\LoginWindow.xaml
================================================================================

Ôªø<Window x:Class="LoGeCui.LoginWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="LoGeCui - Connexion"
        Height="600" Width="500"
        WindowStartupLocation="CenterScreen"
        ResizeMode="NoResize">
    <Grid Background="#F5F5F5">
        <Border Background="White"
                CornerRadius="10"
                Padding="40"
                Margin="40">
            <StackPanel>
                <!-- Logo / Titre -->
                <TextBlock Text="üõí LoGeCui"
                          FontSize="48"
                          FontWeight="Bold"
                          HorizontalAlignment="Center"
                          Foreground="#27AE60"
                          Margin="0,0,0,40"/>

                <!-- Email -->
                <TextBlock Text="Email :" FontWeight="SemiBold" Margin="0,0,0,5"/>
                <TextBox x:Name="TxtEmail"
                        Padding="10"
                        FontSize="14"
                        Margin="0,0,0,15"/>

                <!-- Mot de passe -->
                <TextBlock Text="Mot de passe :" FontWeight="SemiBold" Margin="0,0,0,5"/>
                <PasswordBox x:Name="TxtPassword"
                            Padding="10"
                            FontSize="14"
                            Margin="0,0,0,20"/>

                <!-- Boutons -->
                <Button x:Name="BtnConnexion"
                       Content="Se connecter"
                       Background="#27AE60"
                       Foreground="White"
                       Padding="15"
                       FontSize="16"
                       FontWeight="SemiBold"
                       BorderThickness="0"
                       Cursor="Hand"
                       Margin="0,0,0,10"
                       Click="BtnConnexion_Click"/>

                <Button x:Name="BtnInscription"
                       Content="Cr√©er un compte"
                       Background="#3498DB"
                       Foreground="White"
                       Padding="15"
                       FontSize="16"
                       FontWeight="SemiBold"
                       BorderThickness="0"
                       Cursor="Hand"
                       Click="BtnInscription_Click"/>

                <!-- Message -->
                <TextBlock x:Name="TxtMessage"
                          Foreground="Red"
                          TextWrapping="Wrap"
                          HorizontalAlignment="Center"
                          Margin="0,15,0,0"
                          FontSize="12"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>

================================================================================
FILE: LoGeCui\LoginWindow.xaml.cs
================================================================================

Ôªøusing System;
using System.Threading.Tasks;
using System.Windows;
using LoGeCuiShared.Services;

namespace LoGeCui
{
    public partial class LoginWindow : Window
    {
        public LoginWindow()
        {
            InitializeComponent();
        }

        private async void BtnConnexion_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                SetStatus("Connexion en cours...", isError: false);

                string email = TxtEmail.Text.Trim();
                string password = TxtPassword.Password;

                if (string.IsNullOrWhiteSpace(email) || string.IsNullOrWhiteSpace(password))
                {
                    SetStatus("Veuillez remplir tous les champs.", isError: true);
                    return;
                }

                var (success, accessToken, userIdString, error) = await App.SupabaseService.SignInAsync(email, password);


                if (!success)
                {
                    SetStatus(error ?? "Erreur de connexion", isError: true);
                    return;
                }
                if (!Guid.TryParse(userIdString, out var userId))
                {
                    SetStatus("ID utilisateur invalide.", isError: true);
                    return;
                }

                App.InitRestServices(accessToken, userId);


                // ‚¨áÔ∏è ICI : import des recettes locales vers Supabase (une seule fois)
                await ImporterRecettesLocalVersSupabaseSiBesoinAsync(userId);

                // V√©rifier les mises √† jour (optionnel)
                await CheckForUpdatesAsync();

                // Ouvrir l'app
                var mainWindow = new MainWindow();
                mainWindow.Show();
                Close();
            }
            catch (Exception ex)
            {
                SetStatus($"Erreur : {ex.Message}", isError: true);
            }
        }

        private async void BtnInscription_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                SetStatus("Inscription en cours...", isError: false);

                string email = TxtEmail.Text.Trim();
                string password = TxtPassword.Password;

                if (string.IsNullOrWhiteSpace(email) || string.IsNullOrWhiteSpace(password))
                {
                    SetStatus("Veuillez remplir tous les champs.", isError: true);
                    return;
                }

                if (password.Length < 6)
                {
                    SetStatus("Le mot de passe doit contenir au moins 6 caract√®res.", isError: true);
                    return;
                }

                var (success, userId, error) = await App.SupabaseService.SignUpAsync(email, password);

                if (success)
                {
                    MessageBox.Show(
                        "Compte cr√©√© avec succ√®s !\n\nVous pouvez maintenant vous connecter.",
                        "Inscription r√©ussie",
                        MessageBoxButton.OK,
                        MessageBoxImage.Information);

                    TxtPassword.Password = "";
                    SetStatus("Compte cr√©√© ! Connectez-vous.", isError: false);
                }
                else
                {
                    SetStatus(error ?? "Erreur lors de l'inscription", isError: true);
                }
            }
            catch (Exception ex)
            {
                SetStatus($"Erreur : {ex.Message}", isError: true);
            }
        }

        private void SetStatus(string message, bool isError)
        {
            TxtMessage.Text = message;
            TxtMessage.Foreground = isError
                ? System.Windows.Media.Brushes.Red
                : System.Windows.Media.Brushes.Blue;
        }

        private async Task CheckForUpdatesAsync()
        {
            try
            {
                string url = ConfigurationHelper.GetSupabaseUrl();
                string key = ConfigurationHelper.GetSupabaseKey();

                var updateService = new LoGeCuiShared.Services.UpdateService(url, key);
                var updateInfo = await updateService.CheckForUpdateAsync("wpf", "1.0.0");

                if (updateInfo != null)
                {
                    var result = MessageBox.Show(
                        $"Une nouvelle version {updateInfo.Version} est disponible !\n\n" +
                        $"Notes de version :\n{updateInfo.ReleaseNotes}\n\n" +
                        $"Voulez-vous t√©l√©charger la mise √† jour ?",
                        "Mise √† jour disponible",
                        MessageBoxButton.YesNo,
                        MessageBoxImage.Information);

                    if (result == MessageBoxResult.Yes)
                    {
                        System.Diagnostics.Process.Start(new System.Diagnostics.ProcessStartInfo
                        {
                            FileName = updateInfo.DownloadUrl,
                            UseShellExecute = true
                        });
                    }
                }
            }
            catch
            {
                // Erreur silencieuse
            }
        }

        private async Task ImporterRecettesLocalVersSupabaseSiBesoinAsync(Guid userId)
        {
            try
            {
                // üìÅ M√™me chemin que ton ancien RecetteService (JSON)
                string dossier = System.IO.Path.Combine(
                    Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
                    "LoGeCui"
                );

                string cheminJson = System.IO.Path.Combine(dossier, "recettes.json");

                // ‚ùå Pas de fichier ‚Üí rien √† importer
                if (!System.IO.File.Exists(cheminJson))
                    return;

                // üè∑Ô∏è Fichier "flag" pour √©viter de r√©importer √† chaque login
                string flagPath = System.IO.Path.Combine(dossier, "recettes_import_done.txt");
                if (System.IO.File.Exists(flagPath))
                    return;

                // üìñ Lecture du JSON
                var json = await System.IO.File.ReadAllTextAsync(cheminJson);

                var options = new System.Text.Json.JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                };

                var recettes = System.Text.Json.JsonSerializer
                    .Deserialize<List<LoGeCuiShared.Models.Recette>>(json, options)
                    ?? new List<LoGeCuiShared.Models.Recette>();

                if (recettes.Count == 0)
                {
                    // Rien √† importer mais on marque comme fait
                    await System.IO.File.WriteAllTextAsync(flagPath, "empty");
                    return;
                }

                // üîå Service Supabase d√©j√† initialis√© dans App.InitRestServices
                var recipesService = App.RecipesService;
                if (recipesService == null)
                    return;

                // üöÄ Import / upsert
                foreach (var r in recettes)
                {
                    // ExternalId obligatoire pour l'upsert
                    if (string.IsNullOrWhiteSpace(r.ExternalId))
                        r.ExternalId = Guid.NewGuid().ToString("N");

                    // Nettoyage cat√©gorie (important pour mobile)
                    if (!string.IsNullOrWhiteSpace(r.CategorieDb))
                        r.CategorieDb = r.CategorieDb.Trim();

                    await recipesService.UpsertRecetteAsync(userId, r);
                }

                // ‚úÖ Marqueur "import termin√©"
                await System.IO.File.WriteAllTextAsync(
                    flagPath,
                    $"done:{DateTime.UtcNow:O}"
                );
            }
            catch (Exception ex)
            {
                // ‚ö†Ô∏è Import non bloquant : on log mais on n'emp√™che pas le login
                System.Diagnostics.Debug.WriteLine("[ImportRecettes] " + ex);
            }
        }
    }
}


================================================================================
FILE: LoGeCui\MainWindow.xaml
================================================================================

Ôªø<Window x:Class="LoGeCui.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:LoGeCui"
        xmlns:views="clr-namespace:LoGeCui.Views"
        mc:Ignorable="d"
        Title="LoGeCui" Height="900" Width="1200"
        WindowStartupLocation="CenterScreen"
        Background="#ECF0F1">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="80"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="250"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        
        <!-- En T√™te (sur toute la largeur -->
        <Border Grid.Row="0"
                Grid.ColumnSpan="2"
                Background="#2C3E50">
            <StackPanel Orientation="Horizontal"
                        VerticalAlignment="Center"
                        Margin="20 , 0">
                <TextBlock Text="üç≥"
                           FontSize="40"
                           Margin="0, 0,15,0"/>
                <StackPanel>
                    <TextBlock Text="LoGeCui"
                           FontSize="28"
                           FontWeight="Bold"
                           Foreground="White"/>
                    <TextBlock Text=" Logiciel de Gestion de Cuisine"
                           FontSize="12"
                           Foreground="#BDC3C7"/>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- MENU GAUCHE -->
        <Border Grid.Row="1" 
                Grid.Column="0"
                Background="#34495E"
                BorderBrush="#2C3E50"
                BorderThickness="0,0,1,0">

            <StackPanel Margin="0,20,0,0">

                <!-- Bouton Ingr√©dients -->
                <Button Content="üì¶ Mes Ingr√©dients"
                        Height="60"
                        Background="#3498DB"
                        Foreground="White"
                        FontSize="16"
                        FontWeight="Bold"
                        Margin="10,5"
                        BorderThickness="0"
                        Cursor="Hand"
                        Click="BtnIngredients_Click">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="#3498DB"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#2980B9"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <!-- Bouton Recettes -->
                <Button Content="üìñ Mes Recettes"
                        Height="60"
                        Background="#2ECC71"
                        Foreground="White"
                        FontSize="16"
                        FontWeight="Bold"
                        Margin="10,5"
                        BorderThickness="0"
                        Cursor="Hand"
                        Click="BtnRecettes_Click">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="#2ECC71"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#27AE60"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <!-- Bouton Ajouter Recette -->
                <Button Content="‚ûï Ajouter Recette"
                        Height="60"
                        Background="#F39C12"
                        Foreground="White"
                        FontSize="16"
                        FontWeight="Bold"
                        Margin="10,5"
                        BorderThickness="0"
                        Cursor="Hand"
                        Click="BtnAjouterRecette_Click">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="#F39C12"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#E67E22"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
                <!-- Bouton Menu Al√©atoire -->
                <Button Content="üé≤ Menu Al√©atoire"
                        Height="60"
                        Background="#9B59B6"
                        Foreground="White"
                        FontSize="16"
                        FontWeight="Bold"
                        Margin="10,5"
                        BorderThickness="0"
                        Cursor="Hand"
                        Click="BtnMenuAleatoire_Click">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="#9B59B6"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#8E44AD"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <!-- Bouton Liste de Courses -->
                <Button Content="üõí Liste de Courses"
                        Height="60"
                        Background="#E74C3C"
                        Foreground="White"
                        FontSize="16"
                        FontWeight="Bold"
                        Margin="10,5"
                        BorderThickness="0"
                        Cursor="Hand"
                        Click="BtnListeCourses_Click">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="#E74C3C"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#C0392B"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <Button
                    Content="Synchroniser recettes"
                    Click="BtnSyncRecettes_Click"
                    Margin="10"/>

            </StackPanel>
        </Border>

        <!-- ZONE DE CONTENU PRINCIPAL -->
        <Border Grid.Row="1" 
        Grid.Column="1"
        Background="White"
        Margin="10">

            <ContentControl x:Name="MainContent">
                <TextBlock Text="Bienvenue dans LoGeCui ! üç≥&#x0a;&#x0a;S√©lectionnez une option dans le menu."
                   FontSize="24"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"
                   TextAlignment="Center"
                   Foreground="#7F8C8D"/>
            </ContentControl>

        </Border>



    </Grid>
</Window>

================================================================================
FILE: LoGeCui\MainWindow.xaml.cs
================================================================================

Ôªøusing LoGeCuiShared.Services;
using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;
using LoGeCui.Services;
using LoGeCui.Views;

namespace LoGeCui
{
    /// <summary>
    /// Interaction logic for MainWindow.xaml
    /// </summary>
    public partial class MainWindow : Window
    {
        // SUPPRIM√â : private SupabaseService _supabase;

        public MainWindow()
        {
            InitializeComponent();

            // SUPPRIM√â : Ne plus cr√©er une nouvelle instance !
            // _supabase = new SupabaseService(url, key);

            // Maintenant on utilisera App.SupabaseService partout
        }

        private void BtnIngredients_Click(object sender, RoutedEventArgs e)
        {
            MainContent.Content = new Views.IngredientsView();
        }

        private void BtnRecettes_Click(object sender, RoutedEventArgs e)
        {
            MainContent.Content = new Views.RecettesView();
        }

        private async void BtnAjouterRecette_Click(object sender, RoutedEventArgs e)
        {
            var dialog = new Dialogs.AjouterRecetteDialog();
            dialog.Owner = this;

            bool? resultat = dialog.ShowDialog();

            if (resultat == true && dialog.NouvelleRecette != null)
            {
                try
                {
                    if (App.RecipesService == null || App.CurrentUserId == null)
                    {
                        MessageBox.Show("Utilisateur non connect√© ou services non initialis√©s.");
                        return;
                    }

                    var r = dialog.NouvelleRecette;

                    // ExternalId obligatoire pour l'upsert (√©vite les doublons)
                    if (string.IsNullOrWhiteSpace(r.ExternalId))
                        r.ExternalId = Guid.NewGuid().ToString("N");

                    // Sauvegarde vers Supabase
                    await App.RecipesService.UpsertRecetteAsync(App.CurrentUserId.Value, r);

                    // Recharge la vue Recettes (qui doit lire Supabase)
                    var view = new RecettesView();
                    MainContent.Content = view;

                    MessageBox.Show(
                        $"La recette '{r.Nom}' a √©t√© ajout√©e avec succ√®s !",
                        "Succ√®s",
                        MessageBoxButton.OK,
                        MessageBoxImage.Information);
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Erreur lors de l'ajout :\n{ex}", "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }


        private void BtnMenuAleatoire_Click(object sender, RoutedEventArgs e)
        {
            MainContent.Content = new Views.MenuAleatoireView();
        }

        private void BtnListeCourses_Click(object sender, RoutedEventArgs e)
        {
            MainContent.Content = new Views.ListeCoursesView();
        }

        public async Task SyncRecettesToSupabaseAsync(IEnumerable<LoGeCuiShared.Models.Recette> recettesLocales)
        {
            if (App.RecipesService == null || App.CurrentUserId == null)
                throw new InvalidOperationException("Services REST non initialis√©s. Connecte-toi d'abord.");

            foreach (var r in recettesLocales)
            {
                if (string.IsNullOrWhiteSpace(r.ExternalId))
                    throw new InvalidOperationException($"Recette '{r.Nom}' sans ExternalId. Il faut un identifiant stable pour √©viter les doublons.");

                await App.RecipesService.UpsertRecetteAsync(App.CurrentUserId.Value, r);
            }
        }

        private async void BtnSyncRecettes_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                if (App.RecipesService == null || App.CurrentUserId == null)
                {
                    MessageBox.Show("Utilisateur non connect√© ou services non initialis√©s.");
                    return;
                }

                // üîπ ICI tu dois r√©cup√©rer TA liste de recettes WPF
                // Adapte cette ligne √† TON code existant

                MessageBox.Show("Synchronisation termin√©e avec succ√®s.");
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur de synchronisation :\n{ex.Message}");
            }
        }


    }
}

================================================================================
FILE: LoGeCui\Models\ArticleCourse.cs
================================================================================

Ôªønamespace LoGeCui.Models
{
    public class ArticleCourse
    {
        public string Nom { get; set; }
        public string Quantite { get; set; }
        public string Unite { get; set; }
        public bool EstAchete { get; set; }

        public ArticleCourse()
        {
            Nom = "";
            Quantite = "";
            Unite = "";
            EstAchete = false;
        }

        // Pour l'affichage
        public override string ToString()
        {
            return $"{Nom} - {Quantite} {Unite}";
        }
    }
}

================================================================================
FILE: LoGeCui\Models\Ingredient.cs
================================================================================

Ôªønamespace LoGeCui.Models
{
    public class Ingredient
    {
        public Guid Id { get; set; }          // correspond √† id
        public Guid? UserId { get; set; }
        public string Nom { get; set; }
        public string Quantite { get; set; }
        public string Unite { get; set; }
        public bool EstDisponible { get; set; }

        // Constructeur (optionnel mais pratique)
        public Ingredient()
        {
            Nom = "";
            Quantite = "";
            Unite = "";
            EstDisponible = true;
        }
    }
}

================================================================================
FILE: LoGeCui\Models\IngredientRecette.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;


namespace LoGeCui.Models
{
    public class IngredientRecette
    {
        public string Nom { get; set; }
        public string Quantite { get; set; }
        public string Unite { get; set; }

        public IngredientRecette()
        {
            Nom = "";
            Quantite = "";
            Unite = "";
        }

        // Pour l'affichage
        public override string ToString()
        {
            return $"{Nom} - {Quantite} {Unite}";
        }
    }
}

================================================================================
FILE: LoGeCui\Models\MenuJournalier.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using LoGeCuiShared.Models;

namespace LoGeCui.Models
{
    public class MenuJournalier
    {
        public DateTime Date { get; set; }
        public Recette? Entree { get; set; }
        public Recette? Plat { get; set; }
        public Recette? Dessert { get; set; }
        public List<IngredientRecette> IngredientsManquants { get; set; }

        public MenuJournalier()
        {
            Date = DateTime.Now;
            IngredientsManquants = new List<IngredientRecette>();
        }
    }
}

================================================================================
FILE: LoGeCui\Services\IngredientService.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.IO;
using System.Text.Json;
using LoGeCuiShared.Models;
using System.Linq;

namespace LoGeCui.Services
{
    public class IngredientService
    {
        // Chemin du fichier de sauvegarde
        private readonly string _cheminFichier;
        private List<Ingredient> _ingredients = new List<Ingredient>();

        public IngredientService()
        {
            // Le fichier sera sauvegard√© dans AppData de l'utilisateur
            string dossier = Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
                "LoGeCui"
            );

            // Cr√©er le dossier s'il n'existe pas
            Directory.CreateDirectory(dossier);

            _cheminFichier = Path.Combine(dossier, "ingredients.json");
        }

        /// <summary>
        /// Charge les ingr√©dients depuis le fichier JSON
        /// </summary>
        public List<Ingredient> ChargerIngredients()
        {
            try
            {
                // V√©rifier si le fichier existe
                if (!File.Exists(_cheminFichier))
                {
                    // Pas de fichier = liste vide
                    return new List<Ingredient>();
                }

                // Lire le contenu du fichier
                string json = File.ReadAllText(_cheminFichier);

                // Convertir le JSON en liste d'ingr√©dients
                var ingredients = JsonSerializer.Deserialize<List<Ingredient>>(json);

                return ingredients ?? new List<Ingredient>();
            }
            catch (Exception ex)
            {
                // En cas d'erreur, afficher un message et retourner une liste vide
                System.Windows.MessageBox.Show(
                    $"Erreur lors du chargement des ingr√©dients : {ex.Message}",
                    "Erreur",
                    System.Windows.MessageBoxButton.OK,
                    System.Windows.MessageBoxImage.Error);

                return new List<Ingredient>();
            }
        }

        public List<Ingredient> ObtenirTousLesIngredients()
        {
            return _ingredients.ToList();
        }

        public List<Ingredient> ObtenirIngredientsDisponibles()
        {
            return _ingredients.Where(i => i.EstDisponible).ToList();
        }

        /// <summary>
        /// Sauvegarde les ingr√©dients dans le fichier JSON
        /// </summary>
        public void SauvegarderIngredients(List<Ingredient> ingredients)
        {
            try
            {
                // Options pour rendre le JSON lisible (avec indentation)
                var options = new JsonSerializerOptions
                {
                    WriteIndented = true  // Pour avoir un JSON "joli"
                };

                // Convertir la liste en JSON
                string json = JsonSerializer.Serialize(ingredients, options);

                // √âcrire dans le fichier
                File.WriteAllText(_cheminFichier, json);
            }
            catch (Exception ex)
            {
                // En cas d'erreur, afficher un message
                System.Windows.MessageBox.Show(
                    $"Erreur lors de la sauvegarde des ingr√©dients : {ex.Message}",
                    "Erreur",
                    System.Windows.MessageBoxButton.OK,
                    System.Windows.MessageBoxImage.Error);
            }
        }

        /// <summary>
        /// Retourne le chemin du fichier de sauvegarde
        /// </summary>
        public string ObtenirCheminFichier()
        {
            return _cheminFichier;
        }
    }
}

================================================================================
FILE: LoGeCui\Services\ListeCoursesService.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.IO;
using System.Text.Json;
using LoGeCuiShared.Models;

namespace LoGeCui.Services
{
    public class ListeCoursesService
    {
        private readonly string _cheminFichier;

        public ListeCoursesService()
        {
            string dossier = Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
                "LoGeCui"
            );
                    Directory.CreateDirectory(dossier);
                    _cheminFichier = Path.Combine(dossier, "liste_courses.json");
        }

        public List<ArticleCourse> ChargerListeCourses()
        {
            try
            {
                if (!File.Exists(_cheminFichier))
                {
                    return new List<ArticleCourse>();
                }

                string json = File.ReadAllText(_cheminFichier);
                var liste = JsonSerializer.Deserialize<List<ArticleCourse>>(json);
                return liste ?? new List<ArticleCourse>();
            }
            catch (Exception ex)
            {
                System.Windows.MessageBox.Show(
                    $"Erreur lors du chargement de la liste de courses : {ex.Message}",
                    "Erreur",
                    System.Windows.MessageBoxButton.OK,
                    System.Windows.MessageBoxImage.Error);
                return new List<ArticleCourse>();
            }
        }

        public void SauvegarderListeCourses(List<ArticleCourse> articles)
        {
            try
            {
                var options = new JsonSerializerOptions { WriteIndented = true };
                string json = JsonSerializer.Serialize(articles, options);
                File.WriteAllText(_cheminFichier, json);
            }
            catch (Exception ex)
            {
                System.Windows.MessageBox.Show(
                    $"Erreur lors de la sauvegarde de la liste de courses : {ex.Message}",
                    "Erreur",
                    System.Windows.MessageBoxButton.OK,
                    System.Windows.MessageBoxImage.Error);
            }
        }
    }
}

================================================================================
FILE: LoGeCui\Services\RecetteService.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.IO;
using System.Text.Json;
using LoGeCuiShared.Models;

namespace LoGeCui.Services
{
    public class RecetteService
    {
        private readonly string _cheminFichier;

        public RecetteService()
        {
            string dossier = Path.Combine(
             Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
             "LoGeCui"
            );
            Directory.CreateDirectory(dossier);
            _cheminFichier = Path.Combine(dossier, "recettes.json");
        }

        public List<Recette> ChargerRecettes()
        {
            try
            {
                if (!File.Exists(_cheminFichier))
                {
                    return new List<Recette>();
                }

                string json = File.ReadAllText(_cheminFichier);
                var options = new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                };

                var recettes = JsonSerializer.Deserialize<List<Recette>>(json, options);
                return recettes ?? new List<Recette>();
            }
            catch (Exception ex)
            {
                System.Windows.MessageBox.Show(
                    $"Erreur lors du chargement des recettes : {ex.Message}",
                    "Erreur",
                    System.Windows.MessageBoxButton.OK,
                    System.Windows.MessageBoxImage.Error);
                return new List<Recette>();
            }
        }

        public void SauvegarderRecettes(List<Recette> recettes)
        {
            try
            {
                var options = new JsonSerializerOptions
                {
                    WriteIndented = true
                };
                string json = JsonSerializer.Serialize(recettes, options);
                File.WriteAllText(_cheminFichier, json);
            }
            catch (Exception ex)
            {
                System.Windows.MessageBox.Show(
                    $"Erreur lors de la sauvegarde des recettes : {ex.Message}",
                    "Erreur",
                    System.Windows.MessageBoxButton.OK,
                    System.Windows.MessageBoxImage.Error);
            }
        }
    }
}

================================================================================
FILE: LoGeCui\Views\IngredientsView.xaml
================================================================================

Ôªø<UserControl x:Class="LoGeCui.Views.IngredientsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Background="White">

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- Titre -->
            <RowDefinition Height="Auto"/>
            <!-- Boutons -->
            <RowDefinition Height="*"/>
            <!-- Liste -->
        </Grid.RowDefinitions>

        <!-- TITRE -->
        <TextBlock Grid.Row="0"
                   Text="üì¶ Gestion des Ingr√©dients"
                   FontSize="28"
                   FontWeight="Bold"
                   Foreground="#2C3E50"
                   Margin="0,0,0,20"/>

        <!-- ZONE DE BOUTONS -->
        <StackPanel Grid.Row="1" 
                    Orientation="Horizontal"
                    Margin="0,0,0,20">

            <Button Content="‚ûï Ajouter un ingr√©dient"
                    Height="40"
                    Width="200"
                    Background="#27AE60"
                    Foreground="White"
                    FontSize="14"
                    FontWeight="Bold"
                    BorderThickness="0"
                    Cursor="Hand"
                    Click="BtnAjouter_Click"/>

        </StackPanel>

        <!-- LISTE DES INGR√âDIENTS -->
        <Border Grid.Row="2"
                BorderBrush="#BDC3C7"
                BorderThickness="1"
                CornerRadius="5">

            <ListBox x:Name="ListeIngredients"
                     Background="#F8F9FA"
                     BorderThickness="0">

                <!-- Template pour afficher chaque ingr√©dient -->
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Border Background="White"
            BorderBrush="#E0E0E0"
            BorderThickness="1"
            CornerRadius="5"
            Margin="5"
            Padding="15">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- Informations de l'ingr√©dient -->
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="{Binding Nom}"
                           FontSize="16"
                           FontWeight="Bold"
                           Foreground="#2C3E50"/>
                                    <TextBlock Foreground="#7F8C8D"
                           FontSize="14">
                    <Run Text="Quantit√© : "/>
                    <Run Text="{Binding Quantite}"/>
                    <Run Text=" "/>
                    <Run Text="{Binding Unite}"/>
                                    </TextBlock>
                                </StackPanel>

                                <!-- CheckBox Disponible -->
                                <CheckBox Grid.Column="1"
                     IsChecked="{Binding EstDisponible}"
                     Content="Disponible"
                     VerticalAlignment="Center"
                     Margin="10,0"
                     Checked="ChkDisponible_Changed"
                     Unchecked="ChkDisponible_Changed"/>

                                <!-- Bouton Supprimer -->
                                <Button Grid.Column="2"
                    Content="üóëÔ∏è"
                    Width="40"
                    Height="40"
                    Background="#E74C3C"
                    Foreground="White"
                    FontSize="18"
                    BorderThickness="0"
                    Cursor="Hand"
                    ToolTip="Supprimer cet ingr√©dient"
                    Click="BtnSupprimer_Click"
                    Tag="{Binding}">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Background" Value="#E74C3C"/>
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="#C0392B"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>

                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListBox.ItemTemplate>

            </ListBox>
        </Border>

    </Grid>

</UserControl>

================================================================================
FILE: LoGeCui\Views\IngredientsView.xaml.cs
================================================================================

Ôªøusing System;
using System.Collections.ObjectModel;
using System.Linq;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using LoGeCuiShared.Models;

namespace LoGeCui.Views
{
    public partial class IngredientsView : UserControl
    {
        private readonly ObservableCollection<Ingredient> _ingredients = new();

        public IngredientsView()
        {
            InitializeComponent();

            ListeIngredients.ItemsSource = _ingredients;

            Loaded += IngredientsView_Loaded;
        }

        private async void IngredientsView_Loaded(object sender, RoutedEventArgs e)
        {
            // Evite de recharger plusieurs fois si Loaded se d√©clenche √† nouveau
            Loaded -= IngredientsView_Loaded;
            await ReloadIngredientsAsync();
        }

        private async Task ReloadIngredientsAsync()
        {
            try
            {
                var data = await App.SupabaseService.GetIngredientsAsync();

                _ingredients.Clear();
                foreach (var ing in data.OrderBy(i => i.Nom))
                    _ingredients.Add(ing);
            }
            catch (InvalidOperationException ex)
            {
                MessageBox.Show(ex.Message, "Connexion requise", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur chargement ingr√©dients (Supabase) : {ex.Message}",
                    "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private async void BtnAjouter_Click(object sender, RoutedEventArgs e)
        {
            var dialog = new Dialogs.AjouterIngredientDialog
            {
                Owner = Window.GetWindow(this)
            };

            bool? resultat = dialog.ShowDialog();
            if (resultat != true || dialog.NouvelIngredient == null)
                return;

            try
            {
                var saved = await App.SupabaseService.AddIngredientAsync(dialog.NouvelIngredient);

                if (saved == null)
                {
                    MessageBox.Show("L'ajout a √©chou√© (aucune donn√©e retourn√©e).",
                        "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
                    return;
                }

                _ingredients.Add(saved);

                MessageBox.Show(
                    $"L'ingr√©dient '{saved.Nom}' a √©t√© ajout√© avec succ√®s !",
                    "Succ√®s",
                    MessageBoxButton.OK,
                    MessageBoxImage.Information);
            }
            catch (InvalidOperationException ex)
            {
                MessageBox.Show(ex.Message, "Connexion requise", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur lors de l'ajout (Supabase) : {ex.Message}",
                    "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private async void BtnSupprimer_Click(object sender, RoutedEventArgs e)
        {
            if (sender is not Button bouton)
                return;

            // On r√©cup√®re l'objet li√© √† la ligne (plus fiable que Tag si ton XAML est bind√© correctement)
            if (bouton.DataContext is not Ingredient ingredient)
                return;

            var confirmation = MessageBox.Show(
                $"Voulez-vous vraiment supprimer '{ingredient.Nom}' ?",
                "Confirmation de suppression",
                MessageBoxButton.YesNo,
                MessageBoxImage.Question);

            if (confirmation != MessageBoxResult.Yes)
                return;

            try
            {
                if (ingredient.Id == Guid.Empty)
                {
                    MessageBox.Show("Impossible de supprimer : l'ingr√©dient n'a pas d'Id.",
                        "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
                    return;
                }

                bool ok = await App.SupabaseService.DeleteIngredientAsync(ingredient.Id);
                if (!ok)
                {
                    MessageBox.Show("La suppression a √©chou√© c√¥t√© serveur.",
                        "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
                    return;
                }

                _ingredients.Remove(ingredient);

                MessageBox.Show(
                    $"L'ingr√©dient '{ingredient.Nom}' a √©t√© supprim√©.",
                    "Suppression r√©ussie",
                    MessageBoxButton.OK,
                    MessageBoxImage.Information);
            }
            catch (InvalidOperationException ex)
            {
                MessageBox.Show(ex.Message, "Connexion requise", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur lors de la suppression (Supabase) : {ex.Message}",
                    "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private async void ChkDisponible_Changed(object sender, RoutedEventArgs e)
        {
            if (sender is not CheckBox cb)
                return;

            // Objet li√© √† la ligne
            if (cb.DataContext is not Ingredient ingredient)
                return;

            try
            {
                if (ingredient.Id == Guid.Empty)
                    return; // pas persist√© c√¥t√© Supabase

                bool ok = await App.SupabaseService.UpdateIngredientAsync(ingredient);
                if (!ok)
                {
                    MessageBox.Show("La mise √† jour a √©chou√© c√¥t√© serveur.",
                        "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
            catch (InvalidOperationException ex)
            {
                MessageBox.Show(ex.Message, "Connexion requise", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur mise √† jour (Supabase) : {ex.Message}",
                    "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }
    }
}

================================================================================
FILE: LoGeCui\Views\ListeCoursesView.xaml
================================================================================

Ôªø<UserControl x:Class="LoGeCui.Views.ListeCoursesView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Background="White">

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- TITRE -->
        <TextBlock Grid.Row="0"
                   Text="üõí Liste de Courses"
                   FontSize="28"
                   FontWeight="Bold"
                   Foreground="#2C3E50"
                   Margin="0,0,0,20"/>

        <!-- BOUTONS -->
        <!-- BOUTONS -->
        <StackPanel Grid.Row="1"
            Orientation="Horizontal"
            Margin="0,0,0,20">

            <Button Content="‚ûï Ajouter un article"
            Height="40"
            Width="180"
            Background="#27AE60"
            Foreground="White"
            FontSize="14"
            FontWeight="Bold"
            BorderThickness="0"
            Cursor="Hand"
            Click="BtnAjouterArticle_Click"
            Margin="0,0,10,0">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#27AE60"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#229954"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

            <Button Content="üóëÔ∏è Supprimer les articles achet√©s"
            Height="40"
            Width="230"
            Background="#E74C3C"
            Foreground="White"
            FontSize="14"
            FontWeight="Bold"
            BorderThickness="0"
            Cursor="Hand"
            Click="BtnSupprimerAchetes_Click"
            Margin="0,0,10,0">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#E74C3C"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#C0392B"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

            <!-- NOUVEAU : Tout s√©lectionner -->
            <Button Content="‚úÖ Tout s√©lectionner"
            Height="40"
            Width="170"
            Background="#3498DB"
            Foreground="White"
            FontSize="14"
            FontWeight="Bold"
            BorderThickness="0"
            Cursor="Hand"
            Click="BtnToutSelectionner_Click"
            Margin="0,0,10,0">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#3498DB"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#2E86C1"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

            <!-- NOUVEAU : Supprimer la s√©lection -->
            <Button Content="üóëÔ∏è Supprimer la s√©lection"
            Height="40"
            Width="210"
            Background="#E67E22"
            Foreground="White"
            FontSize="14"
            FontWeight="Bold"
            BorderThickness="0"
            Cursor="Hand"
            Click="BtnSupprimerSelection_Click">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#E67E22"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#D35400"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

        </StackPanel>

        <!-- LISTE DES COURSES -->
        <Border Grid.Row="2"
                BorderBrush="#BDC3C7"
                BorderThickness="1"
                CornerRadius="5">

            <ListBox x:Name="ListeCourses"
                     Background="#F8F9FA"
                     BorderThickness="0"
                     SelectionMode="Extended">

                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Border Background="White"
                                BorderBrush="#E0E0E0"
                                BorderThickness="1"
                                CornerRadius="5"
                                Margin="5"
                                Padding="15">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- CheckBox Achet√© -->
                                <CheckBox Grid.Column="0"
                                         IsChecked="{Binding EstAchete}"
                                         VerticalAlignment="Center"
                                         Margin="0,0,15,0"
                                         Checked="ChkAchete_Changed"
                                         Unchecked="ChkAchete_Changed"/>

                                <!-- Informations -->
                                <StackPanel Grid.Column="1">
                                    <TextBlock FontSize="16"
                                               FontWeight="Bold"
                                               Foreground="#2C3E50">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Text" Value="{Binding Nom}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding EstAchete}" Value="True">
                                                        <Setter Property="TextDecorations" Value="Strikethrough"/>
                                                        <Setter Property="Foreground" Value="#95A5A6"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>

                                    <TextBlock Foreground="#7F8C8D"
                                               FontSize="14">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding EstAchete}" Value="True">
                                                        <Setter Property="TextDecorations" Value="Strikethrough"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                        <Run Text="Quantit√© : "/>
                                        <Run Text="{Binding Quantite, Mode=OneWay}"/>
                                        <Run Text=" "/>
                                        <Run Text="{Binding Unite, Mode=OneWay}"/>
                                    </TextBlock>
                                </StackPanel>

                                <!-- Bouton Supprimer -->
                                <Button Grid.Column="2"
                                        Content="üóëÔ∏è"
                                        Width="40"
                                        Height="40"
                                        Background="#E74C3C"
                                        Foreground="White"
                                        FontSize="18"
                                        BorderThickness="0"
                                        Cursor="Hand"
                                        ToolTip="Supprimer cet article"
                                        Click="BtnSupprimerArticle_Click"
                                        Tag="{Binding}">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Background" Value="#E74C3C"/>
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="#C0392B"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>
                                

                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListBox.ItemTemplate>

            </ListBox>
        </Border>

    </Grid>

</UserControl>

================================================================================
FILE: LoGeCui\Views\ListeCoursesView.xaml.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using LoGeCuiShared.Models;

namespace LoGeCui.Views
{
    public partial class ListeCoursesView : UserControl
    {
        private readonly ObservableCollection<ArticleCourse> _articles = new ObservableCollection<ArticleCourse>();

        public ListeCoursesView()
        {
            InitializeComponent();

            // Binding une fois
            ListeCourses.ItemsSource = _articles;

            ChargerDonnees();
        }

        private async void ChargerDonnees()
        {
            try
            {
                var articles = await App.SupabaseService.GetArticlesAsync();

                _articles.Clear();
                foreach (var article in articles)
                    _articles.Add(article);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur de chargement : {ex.Message}", "Erreur",
                    MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private async void BtnAjouterArticle_Click(object sender, RoutedEventArgs e)
        {
            var dialog = new Dialogs.AjouterArticleCourseDialog
            {
                Owner = Window.GetWindow(this)
            };

            bool? resultat = dialog.ShowDialog();

            if (resultat == true && dialog.NouvelArticle != null)
            {
                try
                {
                    var added = await App.SupabaseService.AddArticleAsync(dialog.NouvelArticle);

                    if (added != null)
                    {
                        _articles.Add(added);
                        MessageBox.Show($"'{added.Nom}' ajout√© avec succ√®s !", "Succ√®s",
                            MessageBoxButton.OK, MessageBoxImage.Information);
                    }
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Erreur : {ex.Message}", "Erreur",
                        MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        private async void BtnSupprimerArticle_Click(object sender, RoutedEventArgs e)
        {
            var bouton = sender as Button;
            var article = bouton?.Tag as ArticleCourse;

            if (article == null)
                return;

            var resultat = MessageBox.Show(
                $"Voulez-vous vraiment supprimer '{article.Nom}' ?",
                "Confirmation",
                MessageBoxButton.YesNo,
                MessageBoxImage.Question);

            if (resultat != MessageBoxResult.Yes)
                return;

            try
            {
                await App.SupabaseService.DeleteArticleAsync(article.Id);
                _articles.Remove(article);

                MessageBox.Show("Article supprim√© !", "Succ√®s",
                    MessageBoxButton.OK, MessageBoxImage.Information);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur : {ex.Message}", "Erreur",
                    MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private async void ChkAchete_Changed(object sender, RoutedEventArgs e)
        {
            var checkbox = sender as CheckBox;
            var article = checkbox?.DataContext as ArticleCourse;

            if (article == null)
                return;

            try
            {
                await App.SupabaseService.UpdateArticleAsync(article.Id, article);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur de synchronisation : {ex.Message}", "Erreur",
                    MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void BtnToutSelectionner_Click(object sender, RoutedEventArgs e)
        {
            ListeCourses.SelectAll();
        }

        private async void BtnSupprimerSelection_Click(object sender, RoutedEventArgs e)
        {
            // NOTE: SelectedItems est un IList -> on copie avant toute suppression
            var selected = ListeCourses.SelectedItems.Cast<ArticleCourse>().ToList();

            if (!selected.Any())
            {
                MessageBox.Show("Aucun article s√©lectionn√©.", "Information",
                    MessageBoxButton.OK, MessageBoxImage.Information);
                return;
            }

            var resultat = MessageBox.Show(
                $"Voulez-vous supprimer {selected.Count} article(s) s√©lectionn√©(s) ?",
                "Confirmation",
                MessageBoxButton.YesNo,
                MessageBoxImage.Question);

            if (resultat != MessageBoxResult.Yes)
                return;

            try
            {
                // Variante qui fonctionne tout de suite, sans ajouter de m√©thode Supabase en lot :
                // on supprime en boucle via la m√©thode existante DeleteArticleAsync(id).
                foreach (var article in selected)
                {
                    await App.SupabaseService.DeleteArticleAsync(article.Id);
                    _articles.Remove(article);
                }

                MessageBox.Show($"{selected.Count} article(s) supprim√©(s).", "Succ√®s",
                    MessageBoxButton.OK, MessageBoxImage.Information);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur : {ex.Message}", "Erreur",
                    MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private async void BtnSupprimerAchetes_Click(object sender, RoutedEventArgs e)
        {
            var achetes = _articles.Where(a => a.EstAchete).ToList();

            if (!achetes.Any())
            {
                MessageBox.Show("Aucun article achet√© √† supprimer.", "Information",
                    MessageBoxButton.OK, MessageBoxImage.Information);
                return;
            }

            var resultat = MessageBox.Show(
                $"Voulez-vous supprimer les {achetes.Count} article(s) achet√©(s) ?",
                "Confirmation",
                MessageBoxButton.YesNo,
                MessageBoxImage.Question);

            if (resultat != MessageBoxResult.Yes)
                return;

            try
            {
                await App.SupabaseService.DeleteAchetesAsync();

                foreach (var article in achetes)
                    _articles.Remove(article);

                MessageBox.Show($"{achetes.Count} article(s) supprim√©(s).", "Succ√®s",
                    MessageBoxButton.OK, MessageBoxImage.Information);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur : {ex.Message}", "Erreur",
                    MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }
    }
}



================================================================================
FILE: LoGeCui\Views\MenuAleatoireView.xaml
================================================================================

Ôªø<UserControl x:Class="LoGeCui.Views.MenuAleatoireView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Background="White">

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <Grid Margin="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- TITRE -->
            <TextBlock Grid.Row="0"
                       Text="üé≤ Menu Al√©atoire"
                       FontSize="28"
                       FontWeight="Bold"
                       Foreground="#2C3E50"
                       Margin="0,0,0,20"/>

            <!-- BOUTON GENERER -->
            <Button Grid.Row="1"
                    Content="üé≤ G√©n√©rer un nouveau menu"
                    Width="250"
                    Height="50"
                    Background="#9B59B6"
                    Foreground="White"
                    FontSize="16"
                    FontWeight="Bold"
                    BorderThickness="0"
                    Cursor="Hand"
                    Click="BtnGenererMenu_Click"
                    HorizontalAlignment="Center"
                    Margin="0,0,0,30">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#9B59B6"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#8E44AD"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

            <!-- CONTENU DU MENU -->
            <StackPanel Grid.Row="2" x:Name="MenuPanel" Visibility="Collapsed">

                <!-- Date -->
                <TextBlock x:Name="TxtDate"
                           FontSize="16"
                           Foreground="#7F8C8D"
                           Margin="0,0,0,20"
                           HorizontalAlignment="Center"/>

                <!-- Entr√©e -->
                <Border Background="#E8F5E9"
                        CornerRadius="10"
                        Padding="20"
                        Margin="0,0,0,15">
                    <StackPanel>
                        <TextBlock Text="ü•ó ENTR√âE"
                                   FontSize="18"
                                   FontWeight="Bold"
                                   Foreground="#27AE60"
                                   Margin="0,0,0,10"/>

                        <TextBlock x:Name="TxtEntree"
                                   Text="Aucune entr√©e"
                                   FontSize="20"
                                   FontWeight="Bold"
                                   Foreground="#2C3E50"
                                   Margin="0,0,0,5"/>

                        <TextBlock x:Name="TxtEntreeDetails"
                                   FontSize="14"
                                   Foreground="#7F8C8D"
                                   TextWrapping="Wrap"/>
                    </StackPanel>
                </Border>

                <!-- Plat -->
                <Border Background="#E3F2FD"
                        CornerRadius="10"
                        Padding="20"
                        Margin="0,0,0,15">
                    <StackPanel>
                        <TextBlock Text="üçΩÔ∏è PLAT PRINCIPAL"
                                   FontSize="18"
                                   FontWeight="Bold"
                                   Foreground="#2196F3"
                                   Margin="0,0,0,10"/>

                        <TextBlock x:Name="TxtPlat"
                                   Text="Aucun plat"
                                   FontSize="20"
                                   FontWeight="Bold"
                                   Foreground="#2C3E50"
                                   Margin="0,0,0,5"/>

                        <TextBlock x:Name="TxtPlatDetails"
                                   FontSize="14"
                                   Foreground="#7F8C8D"
                                   TextWrapping="Wrap"/>
                    </StackPanel>
                </Border>

                <!-- Dessert -->
                <Border Background="#FFF3E0"
                        CornerRadius="10"
                        Padding="20"
                        Margin="0,0,0,20">
                    <StackPanel>
                        <TextBlock Text="üç∞ DESSERT"
                                   FontSize="18"
                                   FontWeight="Bold"
                                   Foreground="#FF9800"
                                   Margin="0,0,0,10"/>

                        <TextBlock x:Name="TxtDessert"
                                   Text="Aucun dessert"
                                   FontSize="20"
                                   FontWeight="Bold"
                                   Foreground="#2C3E50"
                                   Margin="0,0,0,5"/>

                        <TextBlock x:Name="TxtDessertDetails"
                                   FontSize="14"
                                   Foreground="#7F8C8D"
                                   TextWrapping="Wrap"/>
                    </StackPanel>
                </Border>

                <!-- Ingr√©dients manquants -->
                <Border x:Name="IngredientsManquantsPanel"
                        Background="#FFEBEE"
                        CornerRadius="10"
                        Padding="20"
                        Margin="0,0,0,20"
                        Visibility="Collapsed">
                    <StackPanel>
                        <TextBlock Text="‚ö†Ô∏è INGR√âDIENTS MANQUANTS"
                                   FontSize="18"
                                   FontWeight="Bold"
                                   Foreground="#E74C3C"
                                   Margin="0,0,0,10"/>

                        <ListBox x:Name="ListeIngredientsManquants"
                                 BorderThickness="0"
                                 Background="Transparent"
                                 MaxHeight="200">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding}"
                                               FontSize="14"
                                               Foreground="#E74C3C"
                                               Margin="5"/>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>

                        <Button Content="‚ûï Ajouter √† la liste de courses"
                                Height="40"
                                Background="#E74C3C"
                                Foreground="White"
                                FontSize="14"
                                FontWeight="Bold"
                                BorderThickness="0"
                                Cursor="Hand"
                                Click="BtnAjouterListeCourses_Click"
                                Margin="0,10,0,0"/>
                    </StackPanel>
                </Border>

                <!-- Tout est disponible -->
                <Border x:Name="ToutDisponiblePanel"
                        Background="#E8F5E9"
                        CornerRadius="10"
                        Padding="20"
                        Visibility="Collapsed">
                    <StackPanel Orientation="Horizontal"
                               HorizontalAlignment="Center">
                        <TextBlock Text="‚úÖ"
                                   FontSize="24"
                                   Margin="0,0,10,0"/>
                        <TextBlock Text="Tous les ingr√©dients sont disponibles !"
                                   FontSize="16"
                                   FontWeight="Bold"
                                   Foreground="#27AE60"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                </Border>

            </StackPanel>

        </Grid>
    </ScrollViewer>

</UserControl>

================================================================================
FILE: LoGeCui\Views\MenuAleatoireView.xaml.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using LoGeCuiShared.Models;
using LoGeCui.Services;

namespace LoGeCui.Views
{
    public partial class MenuAleatoireView : UserControl
    {
        private readonly RecetteService _recetteService;
        private MenuJournalier? _menuCourant;

        public MenuAleatoireView()
        {
            InitializeComponent();
            _recetteService = new RecetteService();
        }

        private void BtnGenererMenu_Click(object sender, RoutedEventArgs e)
        {
            // Charger les recettes (source locale actuelle)
            var recettes = _recetteService.ChargerRecettes();

            if (recettes.Count == 0)
            {
                MessageBox.Show(
                    "Vous n'avez aucune recette !\n\nAjoutez des recettes d'abord.",
                    "Aucune recette",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
                return;
            }

            // Filtrer par type
            var entrees = recettes.Where(r => r.Type == TypePlat.Entree).ToList();
            var plats = recettes.Where(r => r.Type == TypePlat.Plat).ToList();
            var desserts = recettes.Where(r => r.Type == TypePlat.Dessert).ToList();

            // Cr√©er le menu
            _menuCourant = new MenuJournalier
            {
                Date = DateTime.Now,
                Entree = ChoisirRecetteAleatoire(entrees),
                Plat = ChoisirRecetteAleatoire(plats),
                Dessert = ChoisirRecetteAleatoire(desserts)
            };

            // Afficher le menu
            AfficherMenu();

            // V√©rifier les ingr√©dients (async, Supabase)
            _ = VerifierIngredientsAsync();
        }

        private Recette? ChoisirRecetteAleatoire(List<Recette> recettes)
        {
            if (recettes.Count == 0)
                return null;

            var random = new Random();
            return recettes[random.Next(recettes.Count)];
        }

        private void AfficherMenu()
        {
            if (_menuCourant == null)
                return;

            MenuPanel.Visibility = Visibility.Visible;

            TxtDate.Text = $"Menu g√©n√©r√© le {_menuCourant.Date:dd/MM/yyyy √† HH:mm}";

            if (_menuCourant.Entree != null)
            {
                TxtEntree.Text = _menuCourant.Entree.Nom;
                TxtEntreeDetails.Text = $"{_menuCourant.Entree.DifficulteTexte} ‚Ä¢ {_menuCourant.Entree.TempsPreparation} min";
            }
            else
            {
                TxtEntree.Text = "Aucune entr√©e disponible";
                TxtEntreeDetails.Text = "Ajoutez des recettes de type 'Entr√©e'";
            }

            if (_menuCourant.Plat != null)
            {
                TxtPlat.Text = _menuCourant.Plat.Nom;
                TxtPlatDetails.Text = $"{_menuCourant.Plat.DifficulteTexte} ‚Ä¢ {_menuCourant.Plat.TempsPreparation} min";
            }
            else
            {
                TxtPlat.Text = "Aucun plat disponible";
                TxtPlatDetails.Text = "Ajoutez des recettes de type 'Plat'";
            }

            if (_menuCourant.Dessert != null)
            {
                TxtDessert.Text = _menuCourant.Dessert.Nom;
                TxtDessertDetails.Text = $"{_menuCourant.Dessert.DifficulteTexte} ‚Ä¢ {_menuCourant.Dessert.TempsPreparation} min";
            }
            else
            {
                TxtDessert.Text = "Aucun dessert disponible";
                TxtDessertDetails.Text = "Ajoutez des recettes de type 'Dessert'";
            }
        }

        /// <summary>
        /// V√©rifie les ingr√©dients disponibles dans Supabase et calcule les ingr√©dients manquants.
        /// </summary>
        private async System.Threading.Tasks.Task VerifierIngredientsAsync()
        {
            if (_menuCourant == null)
                return;

            try
            {
                // Ingr√©dients disponibles (Supabase)
                var ingredientsDisponibles = await App.SupabaseService.GetIngredientsAsync();

                var disponibles = ingredientsDisponibles
                    .Where(i => i.EstDisponible)
                    .Select(i => (i.Nom ?? "").Trim().ToLower())
                    .Where(n => !string.IsNullOrWhiteSpace(n))
                    .ToHashSet();

                // Collecter tous les ingr√©dients n√©cessaires du menu
                var necessaires = new List<IngredientRecette>();

                if (_menuCourant.Entree != null)
                    necessaires.AddRange(_menuCourant.Entree.Ingredients);

                if (_menuCourant.Plat != null)
                    necessaires.AddRange(_menuCourant.Plat.Ingredients);

                if (_menuCourant.Dessert != null)
                    necessaires.AddRange(_menuCourant.Dessert.Ingredients);

                _menuCourant.IngredientsManquants.Clear();

                foreach (var ingredient in necessaires)
                {
                    var nom = (ingredient.Nom ?? "").Trim();
                    if (string.IsNullOrWhiteSpace(nom))
                        continue;

                    if (!disponibles.Contains(nom.ToLower()))
                    {
                        // √©viter doublons
                        if (!_menuCourant.IngredientsManquants.Any(i =>
                                i.Nom.Equals(nom, StringComparison.OrdinalIgnoreCase)))
                        {
                            _menuCourant.IngredientsManquants.Add(ingredient);
                        }
                    }
                }

                // Afficher
                if (_menuCourant.IngredientsManquants.Any())
                {
                    IngredientsManquantsPanel.Visibility = Visibility.Visible;
                    ToutDisponiblePanel.Visibility = Visibility.Collapsed;

                    ListeIngredientsManquants.ItemsSource = _menuCourant.IngredientsManquants
                        .Select(i => $"‚Ä¢ {i.Nom} - {i.Quantite} {i.Unite}")
                        .ToList();
                }
                else
                {
                    IngredientsManquantsPanel.Visibility = Visibility.Collapsed;
                    ToutDisponiblePanel.Visibility = Visibility.Visible;

                    ListeIngredientsManquants.ItemsSource = null;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(
                    $"Erreur v√©rification ingr√©dients (Supabase) : {ex.Message}",
                    "Erreur",
                    MessageBoxButton.OK,
                    MessageBoxImage.Error);
            }
        }

        private async void BtnAjouterListeCourses_Click(object sender, RoutedEventArgs e)
        {
            if (_menuCourant == null || !_menuCourant.IngredientsManquants.Any())
            {
                MessageBox.Show("Aucun ingr√©dient √† ajouter.", "Information", MessageBoxButton.OK, MessageBoxImage.Information);
                return;
            }

            try
            {
                // IMPORTANT : utiliser l'instance connect√©e (session OK)
                var supabase = App.SupabaseService;

                var articlesExistants = await supabase.GetArticlesAsync();
                var nomsExistants = articlesExistants
                    .Select(a => (a.Nom ?? "").Trim().ToLower())
                    .Where(n => !string.IsNullOrWhiteSpace(n))
                    .ToHashSet();

                int nbAjoutes = 0;

                foreach (var ingredient in _menuCourant.IngredientsManquants)
                {
                    var nom = (ingredient.Nom ?? "").Trim();
                    if (string.IsNullOrWhiteSpace(nom))
                        continue;

                    if (!nomsExistants.Contains(nom.ToLower()))
                    {
                        var article = new ArticleCourse
                        {
                            Nom = nom,
                            Quantite = ingredient.Quantite,
                            Unite = ingredient.Unite,
                            EstAchete = false
                        };

                        await supabase.AddArticleAsync(article);
                        nbAjoutes++;

                        // Mettre √† jour le set pour √©viter doublons dans la m√™me ex√©cution
                        nomsExistants.Add(nom.ToLower());
                    }
                }

                if (nbAjoutes > 0)
                {
                    MessageBox.Show(
                        $"{nbAjoutes} ingr√©dient(s) ajout√©(s) √† la liste de courses !\n\n" +
                        "Consultez 'Liste de Courses' pour les voir.",
                        "Succ√®s",
                        MessageBoxButton.OK,
                        MessageBoxImage.Information);
                }
                else
                {
                    MessageBox.Show(
                        "Tous ces ingr√©dients sont d√©j√† dans votre liste de courses.",
                        "Information",
                        MessageBoxButton.OK,
                        MessageBoxImage.Information);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(
                    $"Erreur lors de l'ajout : {ex.Message}",
                    "Erreur",
                    MessageBoxButton.OK,
                    MessageBoxImage.Error);
            }
        }
    }
}


================================================================================
FILE: LoGeCui\Views\RecetteView.xaml
================================================================================

Ôªø<UserControl x:Class="LoGeCui.Views.RecettesView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Background="White">

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- TITRE -->
        <!-- TITRE ET BOUTON -->
        <Grid Grid.Row="0" Margin="0,0,0,20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <TextBlock Grid.Column="0"
               Text="üìñ Mes Recettes"
               FontSize="28"
               FontWeight="Bold"
               Foreground="#2C3E50"
               VerticalAlignment="Center"/>

            <Button Grid.Column="1"
            Content="‚ûï Nouvelle recette"
            Width="180"
            Height="45"
            Background="#27AE60"
            Foreground="White"
            FontSize="14"
            FontWeight="Bold"
            BorderThickness="0"
            Cursor="Hand"
            Click="BtnNouvelleRecette_Click">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#27AE60"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#229954"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>
        </Grid>

        <!-- FILTRES -->
        <StackPanel Grid.Row="1" 
                    Orientation="Horizontal"
                    Margin="0,0,0,20">

            <Button Content="Toutes"
                    Width="100"
                    Height="40"
                    Margin="0,0,10,0"
                    Background="#95A5A6"
                    Foreground="White"
                    FontSize="14"
                    FontWeight="Bold"
                    BorderThickness="0"
                    Cursor="Hand"
                    Click="BtnTous_Click">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#95A5A6"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#7F8C8D"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

            <Button Content="ü•ó Entr√©es"
                    Width="100"
                    Height="40"
                    Margin="0,0,10,0"
                    Background="#27AE60"
                    Foreground="White"
                    FontSize="14"
                    FontWeight="Bold"
                    BorderThickness="0"
                    Cursor="Hand"
                    Click="BtnEntrees_Click">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#27AE60"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#229954"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

            <Button Content="üçΩÔ∏è Plats"
                    Width="100"
                    Height="40"
                    Margin="0,0,10,0"
                    Background="#3498DB"
                    Foreground="White"
                    FontSize="14"
                    FontWeight="Bold"
                    BorderThickness="0"
                    Cursor="Hand"
                    Click="BtnPlats_Click">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#3498DB"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#2980B9"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

            <Button Content="üç∞ Desserts"
                    Width="100"
                    Height="40"
                    Margin="0,0,10,0"
                    Background="#F39C12"
                    Foreground="White"
                    FontSize="14"
                    FontWeight="Bold"
                    BorderThickness="0"
                    Cursor="Hand"
                    Click="BtnDesserts_Click">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Background" Value="#F39C12"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#E67E22"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>
            <Button Content="Synchroniser"
        Click="BtnSyncRecettes_Click"
        Margin="8"/>

        </StackPanel>

        <!-- LISTE DES RECETTES -->
        <Border Grid.Row="2"
                BorderBrush="#BDC3C7"
                BorderThickness="1"
                CornerRadius="5">

            <ListBox x:Name="ListeRecettes"
                     Background="#F8F9FA"
                     BorderThickness="0"
                     MouseDoubleClick="ListeRecettes_DoubleClick">

                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Border Background="White"
                                BorderBrush="#E0E0E0"
                                BorderThickness="1"
                                CornerRadius="5"
                                Margin="5"
                                Padding="15"
                                Cursor="Hand">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- Informations -->
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="{Binding Nom}"
                                               FontSize="18"
                                               FontWeight="Bold"
                                               Foreground="#2C3E50"/>

                                    <TextBlock Foreground="#7F8C8D"
                                               FontSize="13"
                                               Margin="0,5,0,0">
                                        <Run Text="{Binding TypeTexte, Mode=OneWay}"/>
                                        <Run Text=" ‚Ä¢ "/>
                                        <Run Text="{Binding TempsPreparation, Mode=OneWay}"/>
                                        <Run Text=" min"/>
                                    </TextBlock>

                                    <TextBlock Text="{Binding DifficulteTexte, Mode=OneWay}"
                                               FontSize="14"
                                               Margin="0,3,0,0"/>
                                </StackPanel>

                                <!-- Badge du type -->
                                <Border Grid.Column="1"
                                        Background="#E8F5E9"
                                        CornerRadius="10"
                                        Padding="10,5"
                                        Margin="10,0"
                                        VerticalAlignment="Center">
                                    <TextBlock Text="{Binding Type}"
                                       FontSize="12"
                                       FontWeight="SemiBold"
                                       Foreground="#27AE60"/>
                                </Border>

                                <!-- Bouton Supprimer -->
                                <Button Grid.Column="2"
                                        Content="üóëÔ∏è"
                                        Width="40"
                                        Height="40"
                                        Background="#E74C3C"
                                        Foreground="White"
                                        FontSize="18"
                                        BorderThickness="0"
                                        Cursor="Hand"
                                        ToolTip="Supprimer cette recette"
                                        Click="BtnSupprimerRecette_Click"
                                        Tag="{Binding}">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Background" Value="#E74C3C"/>
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="#C0392B"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>

                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListBox.ItemTemplate>

            </ListBox>
        </Border>

    </Grid>

</UserControl>

================================================================================
FILE: LoGeCui\Views\RecetteView.xaml.cs
================================================================================

Ôªøusing LoGeCuiShared.Models;
using LoGeCuiShared.Services;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;

namespace LoGeCui.Views
{
    public partial class RecettesView : UserControl
    {
        private ObservableCollection<Recette> _recettesAffichees = new();
        private List<Recette> _toutesLesRecettes = new();

        public RecettesView()
        {
            InitializeComponent();

            ListeRecettes.ItemsSource = _recettesAffichees;

            // Charge depuis Supabase d√®s que le contr√¥le est pr√™t
            Loaded += RecettesView_Loaded;
        }

        private async void RecettesView_Loaded(object sender, RoutedEventArgs e)
        {
            Loaded -= RecettesView_Loaded;
            await RefreshDepuisSupabaseAsync();
        }

        private async System.Threading.Tasks.Task RefreshDepuisSupabaseAsync()
        {
            if (App.RecipesService == null || App.CurrentUserId == null)
            {
                MessageBox.Show("Connecte-toi d'abord (services non initialis√©s).");
                return;
            }

            var recettes = await App.RecipesService.GetRecettesAsync(App.CurrentUserId.Value);

            _toutesLesRecettes = recettes ?? new List<Recette>();

            // Affichage initial = toutes
            _recettesAffichees.Clear();
            foreach (var r in _toutesLesRecettes)
                _recettesAffichees.Add(r);
        }

        private void BtnTous_Click(object sender, RoutedEventArgs e)
        {
            _recettesAffichees.Clear();
            foreach (var recette in _toutesLesRecettes)
                _recettesAffichees.Add(recette);
        }

        private void BtnEntrees_Click(object sender, RoutedEventArgs e) => FiltrerParType(TypePlat.Entree);
        private void BtnPlats_Click(object sender, RoutedEventArgs e) => FiltrerParType(TypePlat.Plat);
        private void BtnDesserts_Click(object sender, RoutedEventArgs e) => FiltrerParType(TypePlat.Dessert);

        private void FiltrerParType(TypePlat type)
        {
            _recettesAffichees.Clear();
            foreach (var recette in _toutesLesRecettes.Where(r => r.Type == type))
                _recettesAffichees.Add(recette);
        }

        private void ListeRecettes_DoubleClick(object sender, MouseButtonEventArgs e)
        {
            var recette = ListeRecettes.SelectedItem as Recette;
            if (recette != null)
                AfficherDetailsRecette(recette);
        }

        private async void AfficherDetailsRecette(Recette recette)
        {
            try
            {
                if (App.RestClient == null)
                {
                    MessageBox.Show("RestClient non initialis√©.");
                    return;
                }

                var ingSvc = new LoGeCuiShared.Services.RecetteIngredientsService(App.RestClient);
                var items = await ingSvc.GetForRecetteAsync(recette.Id);

                var ingredientsText = (items.Count == 0)
                    ? "(aucun ingr√©dient renseign√©)"
                    : string.Join("\n", items.Select(x =>
                        string.IsNullOrWhiteSpace(x.quantite) && string.IsNullOrWhiteSpace(x.unite)
                            ? $"  ‚Ä¢ {x.nom}"
                            : $"  ‚Ä¢ {x.quantite} {x.unite} {x.nom}".Replace("  ", " ").Trim()
                    ));

                MessageBox.Show(
                    $"üìñ {recette.Nom}\n\n" +
                    $"Cat√©gorie: {recette.CategorieDb}\n" +
                    $"Temps: {recette.TempsPreparation} minutes\n\n" +
                    $"Ingr√©dients:\n{ingredientsText}\n\n" +
                    $"Instructions:\n{recette.Instructions}",
                    "D√©tails de la recette",
                    MessageBoxButton.OK,
                    MessageBoxImage.Information);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur chargement ingr√©dients:\n{ex}");
            }
        }

        private async void BtnNouvelleRecette_Click(object sender, RoutedEventArgs e)
        {
            var dialog = new Dialogs.AjouterRecetteDialog();
            dialog.Owner = Window.GetWindow(this);

            bool? resultat = dialog.ShowDialog();
            if (resultat != true || dialog.NouvelleRecette == null)
                return;

            if (App.RecipesService == null || App.CurrentUserId == null)
            {
                MessageBox.Show("Connecte-toi d'abord (services non initialis√©s).");
                return;
            }

            var r = dialog.NouvelleRecette;

            if (string.IsNullOrWhiteSpace(r.ExternalId))
                r.ExternalId = System.Guid.NewGuid().ToString("N");

            await App.RecipesService.UpsertRecetteAsync(App.CurrentUserId.Value, r);

            // r√©cup√©rer recetteId DB (uuid) √† partir de ExternalId
            var recetteId = await App.RecipesService.GetRecetteIdByExternalIdAsync(r.ExternalId);
            if (recetteId == null) throw new Exception("Recette introuvable apr√®s upsert.");

            // envoyer ingr√©dients
            var ingSvc = new RecetteIngredientsService(App.RestClient!);
            var items = (r.Ingredients ?? new List<IngredientRecette>())
                .Select(i => (i.Nom, i.Quantite, i.Unite));

            await ingSvc.ReplaceForRecetteAsync(recetteId.Value, items);

            await RefreshDepuisSupabaseAsync();

            MessageBox.Show(
                $"La recette '{r.Nom}' a √©t√© ajout√©e avec succ√®s !",
                "Succ√®s",
                MessageBoxButton.OK,
                MessageBoxImage.Information);
        }

        private async void BtnSupprimerRecette_Click(object sender, RoutedEventArgs e)
        {
            var bouton = sender as Button;
            var recette = bouton?.Tag as Recette;

            if (recette == null)
                return;

            var resultat = MessageBox.Show(
                $"Voulez-vous vraiment supprimer la recette '{recette.Nom}' ?",
                "Confirmation de suppression",
                MessageBoxButton.YesNo,
                MessageBoxImage.Question);

            if (resultat != MessageBoxResult.Yes)
                return;

            try
            {
                if (App.RecipesService == null || App.CurrentUserId == null)
                {
                    MessageBox.Show("Connecte-toi d'abord (services non initialis√©s).");
                    return;
                }

                // Suppression c√¥t√© Supabase (il faut une m√©thode dans RecipesService)
                await App.RecipesService.DeleteRecetteAsync(recette.Id);

                await RefreshDepuisSupabaseAsync();

                MessageBox.Show(
                    $"La recette '{recette.Nom}' a √©t√© supprim√©e.",
                    "Suppression r√©ussie",
                    MessageBoxButton.OK,
                    MessageBoxImage.Information);
            }
            catch (System.Exception ex)
            {
                MessageBox.Show($"Erreur suppression :\n{ex}");
            }
        }

        private async void BtnSyncRecettes_Click(object sender, RoutedEventArgs e)
        {
            // En mode Supabase-first, ce bouton devient un "Rafra√Æchir"
            await RefreshDepuisSupabaseAsync();
            MessageBox.Show("Recettes recharg√©es depuis Supabase.");
        }
    }
}

================================================================================
FILE: LoGeCuiMobile\App.xaml
================================================================================

Ôªø<?xml version = "1.0" encoding = "UTF-8" ?>
<Application xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:LoGeCuiMobile"
             x:Class="LoGeCuiMobile.App">
    <Application.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="Resources/Styles/Colors.xaml" />
                <ResourceDictionary Source="Resources/Styles/Styles.xaml" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Application.Resources>
</Application>

================================================================================
FILE: LoGeCuiMobile\App.xaml.cs
================================================================================

Ôªøusing LoGeCuiMobile.Pages;
using LoGeCuiShared.Services;
using Microsoft.Maui.Storage;
using Microsoft.Maui.ApplicationModel;
using System;
using Microsoft.Extensions.Configuration;
using Microsoft.Maui.Storage;


namespace LoGeCuiMobile
{
    public partial class App : Application
    {
        public RecetteIngredientsService? RecetteIngredientsService { get; private set; }

        public SupabaseService? Supabase { get; private set; }
        public SupabaseRestClient? RestClient { get; private set; }

        public RecipesService? RecipesService { get; private set; }
        public IngredientsService? IngredientsService { get; private set; }
        public ListeCoursesSupabaseService? ListeCoursesSupabaseService { get; private set; }


        public Guid? CurrentUserId { get; private set; }
        public string OcrApiKey { get; private set; } = "";

        public bool IsConnected =>
            CurrentUserId != null &&
            RestClient != null &&
            RecipesService != null &&
            IngredientsService != null &&
            ListeCoursesSupabaseService != null;

        public App()
        {
            InitializeComponent();

            MainPage = RootPage.CreateLoginRoot();
            Init();
            Task.Run(async () =>
            {
                await InitConfigurationAsync();
                MainThread.BeginInvokeOnMainThread(Init);
            });
        }

        private IConfigurationRoot? _config;


        private void Init()
        {
            // SUPABASE (anon)
            var url = ConfigurationHelper.GetSupabaseUrl();
            var key = ConfigurationHelper.GetSupabaseKey();
            Supabase = new SupabaseService(url, key);

            // OCR (charg√©e UNE FOIS)
            try
            {
                OcrApiKey = ConfigurationHelper.GetOcrApiKey();
                System.Diagnostics.Debug.WriteLine($"‚úÖ OCR Key charg√©e: {OcrApiKey.Substring(0, 5)}...");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå ERREUR OCR: {ex.Message}");
                // Temporairement, hardcodez pour tester
                OcrApiKey = "K86867725288957"; // ‚ö†Ô∏è METTEZ VOTRE VRAIE CL√â ICI TEMPORAIREMENT
            }

            // ‚ùå PAS d‚Äôauto-login : nettoyage SYNCHRONE (API correcte)
            SecureStorage.Remove("sb_access_token");
            SecureStorage.Remove("sb_user_id");
        }

        // APPEL√â UNIQUEMENT APR√àS LOGIN
        public void OnLoginSuccess(string accessToken, string userId)
        {
            Supabase!.SetSession(accessToken, userId);
            CurrentUserId = Guid.Parse(userId);

            InitRestServices(accessToken);
            ShowAppShell();
        }

        private void InitRestServicesInternal(string accessToken)
        {
            var url = ConfigurationHelper.GetSupabaseUrl();
            var key = ConfigurationHelper.GetSupabaseKey();

            var client = new SupabaseRestClient(url, key);
            client.SetBearerToken(accessToken);

            RestClient = client;
            RecipesService = new RecipesService(client);
            IngredientsService = new IngredientsService(client);
            ListeCoursesSupabaseService = new ListeCoursesSupabaseService(client);
            // ‚úÖ AJOUTER CETTE LIGNE ICI
            RecetteIngredientsService = new RecetteIngredientsService(client);
        }

        private async Task InitConfigurationAsync()
        {
            using var stream = await FileSystem.OpenAppPackageFileAsync("appsettings.json");

            var builder = new ConfigurationBuilder()
                .AddJsonStream(stream);

            _config = builder.Build();

            
        }


        public void ShowAppShell()
        {
            if (!IsConnected)
            {
                ShowLogin();
                return;
            }

            MainThread.BeginInvokeOnMainThread(() =>
            {
                MainPage = new AppShell();
            });
        }

        // ‚úÖ M√âTHODE R√âTABLIE (utilis√©e ailleurs)
        public void ShowLogin()
        {
            MainThread.BeginInvokeOnMainThread(() =>
            {
                MainPage = RootPage.CreateLoginRoot();
            });
        }

        public void Logout()
        {
            SecureStorage.Remove("sb_access_token");
            SecureStorage.Remove("sb_user_id");

            Supabase?.ClearSession();
            CurrentUserId = null;
            RestClient = null;
            RecipesService = null;
            IngredientsService = null;
            ListeCoursesSupabaseService = null;

            ShowLogin();
        }

        // =========================
        // M√âTHODES DE COMPATIBILIT√â
        // (utilis√©es ailleurs dans l'app)
        // =========================

        // Ancien point d'entr√©e DeepLink (Android)
        public async Task HandleDeepLinkAsync(Uri uri)
        {
            // Tu peux garder la logique existante si elle est ailleurs.
            // Ici, on emp√™che juste le crash / erreur de compilation.
            await Task.CompletedTask;
        }

        // Ancien setter Supabase (appel√© depuis LoginPage)
        public void SetSupabase(SupabaseService supabase)
        {
            Supabase = supabase;
        }

        // Ancien setter UserId
        public void SetCurrentUserId(Guid userId)
        {
            CurrentUserId = userId;
        }

        // Ancienne m√©thode publique (appel√©e depuis LoginPage)
        public void InitRestServices(string accessToken)
        {
            // Appelle la m√©thode priv√©e existante
            InitRestServicesInternal(accessToken);
        }

        // üîí On renomme l'ancienne m√©thode priv√©e
       

    }
}







================================================================================
FILE: LoGeCuiMobile\appsettings.json
================================================================================

{
  "Supabase": {
    "Url": "https://wzctiypsadqktzcnswri.supabase.co",
    "Key": "sb_publishable_ZFk8ONON5qMA0vZ3V0nVAg_TZZrO1F1"
  },

  "OCR": {
    "ApiKey": "K86867725288957"
  }

}

================================================================================
FILE: LoGeCuiMobile\AppShell.xaml
================================================================================

<?xml version="1.0" encoding="UTF-8" ?>
<Shell
    x:Class="LoGeCuiMobile.AppShell"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:pages="clr-namespace:LoGeCuiMobile.Pages"
    FlyoutBehavior="Flyout">

    <FlyoutItem Title="Liste de course" Route="liste-courses">
        <ShellContent Route="liste-courses"
                      ContentTemplate="{DataTemplate pages:ListeCoursesPage}" />
    </FlyoutItem>

    <FlyoutItem Title="Mes Recettes" Route="mes-recettes">
        <ShellContent Route="mes-recettes"
                      ContentTemplate="{DataTemplate pages:MesRecettesPage}" />
    </FlyoutItem>

    <FlyoutItem Title="Menu Al√©atoire" Route="menu-aleatoire">
        <ShellContent Route="menu-aleatoire"
                      ContentTemplate="{DataTemplate pages:MenuAleatoirePage}" />
    </FlyoutItem>

    <FlyoutItem Title="Mes ingr√©dients" Route="mes-ingredients">
        <ShellContent Route="mes-ingredients"
                      ContentTemplate="{DataTemplate pages:MesIngredientsPage}" />
    </FlyoutItem>

    <FlyoutItem Title="Param√®tres" Route="settings">
        <ShellContent Route="settings"
                      ContentTemplate="{DataTemplate pages:SettingsPage}" />
    </FlyoutItem>

</Shell>


================================================================================
FILE: LoGeCuiMobile\AppShell.xaml.cs
================================================================================

Ôªøusing LoGeCuiMobile.Pages;
using LoGeCuiMobile; // si ForgotPasswordPage est √† la racine du projet

namespace LoGeCuiMobile;

public partial class AppShell : Shell
{
    public AppShell()
    {
        InitializeComponent();

        Routing.RegisterRoute(nameof(ListeCoursesPage), typeof(ListeCoursesPage));
        Routing.RegisterRoute(nameof(ForgotPasswordPage), typeof(ForgotPasswordPage));

    }
}

================================================================================
FILE: LoGeCuiMobile\ConfigurationHelper.cs
================================================================================

Ôªøusing Microsoft.Extensions.Configuration;
using Microsoft.Maui.Storage;
using System;
using System.IO;

namespace LoGeCuiMobile
{
    public static class ConfigurationHelper
    {
        private static IConfiguration? _configuration;
        private static readonly object _lock = new();

        private static IConfiguration Configuration
        {
            get
            {
                if (_configuration != null)
                    return _configuration;

                lock (_lock)
                {
                    if (_configuration != null)
                        return _configuration;

                    try
                    {
                        // Lire le fichier depuis le package MAUI
                        using var streamTask = FileSystem.OpenAppPackageFileAsync("appsettings.json");
                        streamTask.Wait();
                        using var stream = streamTask.Result;

                        // Copie en m√©moire pour √©viter tout souci de stream non seekable / lecture partielle
                        using var ms = new MemoryStream();
                        stream.CopyTo(ms);
                        ms.Position = 0;

                        var builder = new ConfigurationBuilder()
                            .AddJsonStream(ms);

                        _configuration = builder.Build();

#if DEBUG
                        System.Diagnostics.Debug.WriteLine("[CONFIG] appsettings.json charg√©");
                        System.Diagnostics.Debug.WriteLine("[CONFIG] Supabase:Url=" + (_configuration["Supabase:Url"] ?? "<null>"));
                        System.Diagnostics.Debug.WriteLine("[CONFIG] OCR:ApiKey present=" + (!string.IsNullOrWhiteSpace(_configuration["OCR:ApiKey"])));
#endif

                        return _configuration;
                    }
                    catch (Exception ex)
                    {
                        throw new Exception(
                            "Impossible de charger appsettings.json depuis le package MAUI. " +
                            "V√©rifie qu'il est bien dans LoGeCuiMobile, Build Action = MauiAsset, et que tu as fait Clean/Rebuild. " +
                            $"D√©tail: {ex.Message}", ex);
                    }
                }
            }
        }


        // =========================
        // SUPABASE
        // =========================

        public static string GetSupabaseUrl()
            => Configuration["Supabase:Url"]
               ?? throw new Exception("Supabase:Url manquant dans appsettings.json");

        public static string GetSupabaseKey()
            => Configuration["Supabase:Key"]
               ?? throw new Exception("Supabase:Key manquant dans appsettings.json");

        // =========================
        // OCR
        // =========================

        public static string GetOcrApiKey()
        {
            var key = Configuration["OCR:ApiKey"];

            if (string.IsNullOrWhiteSpace(key))
                throw new Exception("OCR:ApiKey manquant dans appsettings.json");

            return key;
        }
    }
}





================================================================================
FILE: LoGeCuiMobile\Converters\BoolToStrikethroughConverter.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;
using System.Globalization;

namespace LoGeCuiMobile.Converters
{
    public class BoolToStrikethroughConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
            => (value is bool b && b) ? TextDecorations.Strikethrough : TextDecorations.None;

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
            => throw new NotImplementedException();
    }
}

================================================================================
FILE: LoGeCuiMobile\ForgotPasswordPage.xaml
================================================================================

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="LoGeCuiMobile.ForgotPasswordPage"
    Title="Mot de passe oubli√©">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="12">

            <Label Text="Mot de passe oubli√©"
                   FontSize="20"
                   FontAttributes="Bold" />

            <Label Text="Entrez votre email pour recevoir un lien de r√©initialisation."
                   FontSize="14" />

            <Entry x:Name="EmailEntry"
                   Placeholder="Adresse email"
                   Keyboard="Email" />

            <Button x:Name="SendButton"
                    Text="Envoyer"
                    Clicked="OnSendClicked" />

            <Label x:Name="StatusLabel"
                   FontSize="13" />

            <Button Text="Retour"
                    Clicked="OnBackClicked" />

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>

================================================================================
FILE: LoGeCuiMobile\ForgotPasswordPage.xaml.cs
================================================================================

Ôªøusing LoGeCuiShared.Services;
using Microsoft.Maui.Controls;
using Microsoft.Maui.Graphics;
using System;

namespace LoGeCuiMobile
{
    // Optionnel : permet de pr√©-remplir l'email si tu navigues avec ?email=...
    [QueryProperty(nameof(PrefillEmail), "email")]
    public partial class ForgotPasswordPage : ContentPage
    {
        private readonly SupabaseService _supabaseService;

        // Valeur pass√©e via Shell : ?email=...
        public string PrefillEmail
        {
            set
            {
                // Evite crash si EmailEntry n'est pas encore pr√™t
                try
                {
                    var decoded = Uri.UnescapeDataString(value ?? "");
                    if (!string.IsNullOrWhiteSpace(decoded))
                        EmailEntry.Text = decoded;
                }
                catch { /* ignore */ }
            }
        }

        public ForgotPasswordPage()
        {
            InitializeComponent();

            var url = ConfigurationHelper.GetSupabaseUrl();
            var key = ConfigurationHelper.GetSupabaseKey();

            _supabaseService = new SupabaseService(url, key);

            StatusLabel.Text = "";
        }

        private async void OnSendClicked(object sender, EventArgs e)
        {
            try
            {
                // S√©curit√© si un contr√¥le est null (mauvais x:Name / x:Class)
                if (EmailEntry == null || SendButton == null || StatusLabel == null)
                {
                    await DisplayAlert("Erreur", "Interface non initialis√©e (XAML). V√©rifie x:Class et x:Name.", "OK");
                    return;
                }

                var email = (EmailEntry.Text ?? "").Trim();

                // ‚úÖ Validation obligatoire
                if (string.IsNullOrWhiteSpace(email) || !email.Contains("@") || !email.Contains("."))
                {
                    StatusLabel.TextColor = Colors.Red;
                    StatusLabel.Text = "Veuillez saisir une adresse email valide.";
                    return;
                }

                SendButton.IsEnabled = false;
                StatusLabel.TextColor = Colors.Black;
                StatusLabel.Text = "Envoi en cours‚Ä¶";

                var result = await _supabaseService.SendPasswordResetAsync(email);

                if (result.success)
                {
                    StatusLabel.TextColor = Colors.Green;
                    StatusLabel.Text = "Email envoy√© ‚úÖ V√©rifiez votre bo√Æte mail (et les spams).";
                }
                else
                {
                    StatusLabel.TextColor = Colors.Red;
                    StatusLabel.Text = result.error ?? "Impossible d'envoyer l'email.";
                }
            }
            catch (Exception ex)
            {
                // ‚úÖ √©vite le crash et donne une erreur lisible
                StatusLabel.TextColor = Colors.Red;
                StatusLabel.Text = "Erreur : " + ex.Message;
            }
            finally
            {
                if (SendButton != null)
                    SendButton.IsEnabled = true;
            }
        }

        private async void OnBackClicked(object sender, EventArgs e)
        {
            try
            {
                await Navigation.PopAsync();
            }
            catch
            {
                // au cas o√π
                await Shell.Current?.GoToAsync("..");
            }
        }
    }
}

================================================================================
FILE: LoGeCuiMobile\LoGeCuiMobile.csproj
================================================================================

Ôªø<Project Sdk="Microsoft.NET.Sdk">

	<PropertyGroup>
		<TargetFrameworks>net10.0-android;net10.0-ios;net10.0-maccatalyst</TargetFrameworks>
		<TargetFrameworks Condition="$([MSBuild]::IsOSPlatform('windows'))">$(TargetFrameworks);net10.0-windows10.0.19041.0</TargetFrameworks>

		<!-- Note for MacCatalyst:
		The default runtime is maccatalyst-x64, except in Release config, in which case the default is maccatalyst-x64;maccatalyst-arm64.
		When specifying both architectures, use the plural <RuntimeIdentifiers> instead of the singular <RuntimeIdentifier>.
		The Mac App Store will NOT accept apps with ONLY maccatalyst-arm64 indicated;
		either BOTH runtimes must be indicated or ONLY macatalyst-x64. -->
		<!-- For example: <RuntimeIdentifiers>maccatalyst-x64;maccatalyst-arm64</RuntimeIdentifiers> -->

		<OutputType>Exe</OutputType>
		<RootNamespace>LoGeCuiMobile</RootNamespace>
		<UseMaui>true</UseMaui>
		<SingleProject>true</SingleProject>
		<ImplicitUsings>enable</ImplicitUsings>
		<Nullable>enable</Nullable>

		<!-- Display name -->
		<ApplicationTitle>LoGeCuiMobile</ApplicationTitle>

		<!-- App Identifier -->
		<ApplicationId>com.companyname.logecuimobile</ApplicationId>

		<!-- Versions -->
		<ApplicationDisplayVersion>2.0.0</ApplicationDisplayVersion>
		<ApplicationVersion>6</ApplicationVersion>

		<!-- To develop, package, and publish an app to the Microsoft Store, see: https://aka.ms/MauiTemplateUnpackaged -->
		<WindowsPackageType>None</WindowsPackageType>

		<SupportedOSPlatformVersion Condition="$([MSBuild]::GetTargetPlatformIdentifier('$(TargetFramework)')) == 'ios'">15.0</SupportedOSPlatformVersion>
		<SupportedOSPlatformVersion Condition="$([MSBuild]::GetTargetPlatformIdentifier('$(TargetFramework)')) == 'maccatalyst'">15.0</SupportedOSPlatformVersion>
		<SupportedOSPlatformVersion Condition="$([MSBuild]::GetTargetPlatformIdentifier('$(TargetFramework)')) == 'android'">21.0</SupportedOSPlatformVersion>
		<SupportedOSPlatformVersion Condition="$([MSBuild]::GetTargetPlatformIdentifier('$(TargetFramework)')) == 'windows'">10.0.17763.0</SupportedOSPlatformVersion>
		<TargetPlatformMinVersion Condition="$([MSBuild]::GetTargetPlatformIdentifier('$(TargetFramework)')) == 'windows'">10.0.17763.0</TargetPlatformMinVersion>
		<AndroidSigningKeyStore>logecui.keystore</AndroidSigningKeyStore>
	</PropertyGroup>

	<PropertyGroup>
		<UserSecretsId>votre-guid-unique</UserSecretsId>
	</PropertyGroup>

	<PropertyGroup Condition="'$(Configuration)|$(TargetFramework)|$(Platform)'=='Debug|net10.0-android|AnyCPU'">
	  <AndroidKeyStore>True</AndroidKeyStore>
	  <AndroidSigningStorePass>LoGeCui2025</AndroidSigningStorePass>
	  <AndroidSigningKeyAlias>LoGeCui</AndroidSigningKeyAlias>
	  <AndroidSigningKeyPass>LoGeCui2025</AndroidSigningKeyPass>
	  <EmbedAssembliesIntoApk>False</EmbedAssembliesIntoApk>
	  <AndroidCreatePackagePerAbi>False</AndroidCreatePackagePerAbi>
	</PropertyGroup>

	<PropertyGroup Condition="'$(Configuration)|$(TargetFramework)|$(Platform)'=='Release|net10.0-android|AnyCPU'">
	  <AndroidKeyStore>True</AndroidKeyStore>
	  <AndroidSigningStorePass>LoGeCui2025</AndroidSigningStorePass>
	  <AndroidSigningKeyAlias>LoGeCui</AndroidSigningKeyAlias>
	  <AndroidSigningKeyPass>LoGeCui2025</AndroidSigningKeyPass>
	  <AndroidCreatePackagePerAbi>False</AndroidCreatePackagePerAbi>
	</PropertyGroup>

	<ItemGroup>
		<!-- App Icon -->
		<MauiIcon Include="Resources\AppIcon\postriticone.png" />

		<!-- Splash Screen -->
		<MauiSplashScreen Include="Resources\Splash\postriticone.png" Color="#FFFFFF" BaseSize="128,128" />

		<!-- Images -->
		<MauiImage Include="Resources\Images\*" />
		<MauiImage Update="Resources\Images\dotnet_bot.png" Resize="True" BaseSize="300,185" />
		
		<!-- Custom Fonts -->
		<MauiFont Include="Resources\Fonts\*" />

		<!-- Raw Assets (also remove the "Resources\Raw" prefix) -->
		<MauiAsset Include="Resources\Raw\**" LogicalName="%(RecursiveDir)%(Filename)%(Extension)" />
	</ItemGroup>

	<ItemGroup>
		<MauiAsset Include="appsettings.json">
		  <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
		</MauiAsset>
	</ItemGroup>

	<ItemGroup>
		<PackageReference Include="Microsoft.Extensions.Configuration.Json" Version="10.0.2" />
		<PackageReference Include="Microsoft.Maui.Controls" Version="10.0.30" />
		<PackageReference Include="Microsoft.Extensions.Logging.Debug" Version="10.0.2" />
		<PackageReference Include="SkiaSharp" Version="3.119.1" />
		<PackageReference Include="Supabase.Postgrest" Version="4.1.0" />
	</ItemGroup>

	<ItemGroup>
	  <ProjectReference Include="..\LoGeCuiShared\LoGeCuiShared.csproj" />
	</ItemGroup>

	<ItemGroup>
	  <MauiXaml Update="ForgotPasswordPage.xaml">
	    <Generator>MSBuild:Compile</Generator>
	  </MauiXaml>
	  <MauiXaml Update="LoginPage.xaml">
	    <Generator>MSBuild:Compile</Generator>
	  </MauiXaml>
	  <MauiXaml Update="Pages\AjouterIngredientPage.xaml">
	    <Generator>MSBuild:Compile</Generator>
	  </MauiXaml>
	  <MauiXaml Update="Pages\AjouterRecettePage.xaml">
	    <Generator>MSBuild:Compile</Generator>
	  </MauiXaml>
	  <MauiXaml Update="Pages\ListeCoursesPage.xaml">
	    <Generator>MSBuild:Compile</Generator>
	  </MauiXaml>
	  <MauiXaml Update="Pages\MenuAleatoirePage.xaml">
	    <Generator>MSBuild:Compile</Generator>
	  </MauiXaml>
	  <MauiXaml Update="Pages\MesIngredientsPage.xaml">
	    <Generator>MSBuild:Compile</Generator>
	  </MauiXaml>
	  <MauiXaml Update="Pages\MesRecettesPage.xaml">
	    <Generator>MSBuild:Compile</Generator>
	  </MauiXaml>
	  <MauiXaml Update="Pages\ResetPasswordPage.xaml">
	    <Generator>MSBuild:Compile</Generator>
	  </MauiXaml>
	  <MauiXaml Update="Pages\SettingsPage.xaml">
	    <Generator>MSBuild:Compile</Generator>
	  </MauiXaml>
	</ItemGroup>

	<ItemGroup>
	  <Folder Include="Platforms\Android\Resources\Raw\" />
	</ItemGroup>

</Project>

================================================================================
FILE: LoGeCuiMobile\LoginPage.xaml
================================================================================

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Class="LoGeCuiMobile.Pages.LoginPage"
             Title="LoGeCui - Connexion"
             BackgroundColor="#F5F5F5">

    <ScrollView>
        <VerticalStackLayout Padding="30" Spacing="20" VerticalOptions="Center">

            <!-- Logo / Titre -->
            <Label Text="üõí LoGeCui"
                   FontSize="48"
                   FontAttributes="Bold"
                   HorizontalOptions="Center"
                   TextColor="#27AE60"
                   Margin="0,0,0,40"/>

            <!-- Email -->
            <Label Text="Email :"
                   FontAttributes="Bold"
                   FontSize="16"/>
            <Entry x:Name="TxtEmail"
                   Placeholder="votre.email@example.com"
                   Keyboard="Email"
                   FontSize="16"
                   BackgroundColor="White"/>

            <!-- Mot de passe -->
            <Label Text="Mot de passe :"
                   FontAttributes="Bold"
                   FontSize="16"/>
            <Grid ColumnDefinitions="*, Auto"
                  BackgroundColor="White">

                <Entry x:Name="TxtPassword"
                       Placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                       IsPassword="True"
                       FontSize="16"
                       BackgroundColor="White"/>

                <Button Grid.Column="1"
                        Text="üëÅ"
                        FontSize="18"
                        BackgroundColor="Transparent"
                        Clicked="TogglePassword"/>


            </Grid>

            <!-- Bouton Connexion -->
            <Button x:Name="BtnConnexion"
                    Text="Se connecter"
                    BackgroundColor="#27AE60"
                    TextColor="White"
                    FontSize="18"
                    FontAttributes="Bold"
                    HeightRequest="50"
                    CornerRadius="10"
                    Clicked="BtnConnexion_Clicked"/>

            <!-- Bouton Inscription -->
            <Button x:Name="BtnInscription"
                    Text="Cr√©er un compte"
                    BackgroundColor="#3498DB"
                    TextColor="White"
                    FontSize="18"
                    FontAttributes="Bold"
                    HeightRequest="50"
                    CornerRadius="10"
                    Clicked="BtnInscription_Clicked"/>

            <!-- Message -->
            <Label x:Name="TxtMessage"
                   TextColor="Red"
                   FontSize="14"
                   HorizontalOptions="Center"
                   HorizontalTextAlignment="Center"
                   IsVisible="False"/>

            <Button Text="Mot de passe oubli√© ?"
                    FontSize="14"
                    TextColor="Blue"
                    BackgroundColor="Transparent"
                    Clicked="BtnForgotPassword_Clicked"/>

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>

================================================================================
FILE: LoGeCuiMobile\LoginPage.xaml.cs
================================================================================

Ôªøusing LoGeCuiShared.Services;
using Microsoft.Maui.Storage;
using LoGeCuiMobile; // si ForgotPasswordPage est √† la racine du projet

namespace LoGeCuiMobile.Pages
{
    public partial class LoginPage : ContentPage
    {
        private readonly SupabaseService _supabase;

        private bool _isPasswordVisible = false;

        public LoginPage()
        {
            InitializeComponent();

            var url = ConfigurationHelper.GetSupabaseUrl();
            var key = ConfigurationHelper.GetSupabaseKey();

            _supabase = new SupabaseService(url, key);
        }

        private async void BtnConnexion_Clicked(object sender, EventArgs e)
        {
            try
            {
                SetStatus("Connexion en cours...", Colors.Blue);

                var email = TxtEmail.Text?.Trim() ?? "";
                var password = TxtPassword.Text ?? "";

                if (string.IsNullOrWhiteSpace(email) || string.IsNullOrWhiteSpace(password))
                {
                    SetStatus("Veuillez remplir tous les champs.", Colors.Red);
                    return;
                }

                var (success, accessToken, userId, error) =
                    await _supabase.SignInAsync(email, password);

                System.Diagnostics.Debug.WriteLine("ACCESS_TOKEN=" + accessToken);


                if (!success)
                {
                    SetStatus(error ?? "Erreur de connexion", Colors.Red);
                    await Application.Current.MainPage.DisplayAlert("DEBUG", "Bouton cliqu√©", "OK");

                    return;
                }

                // 1) Sauvegarde session pour d√©sinscription / relance app
                await SecureStorage.SetAsync("sb_access_token", accessToken ?? "");
                await SecureStorage.SetAsync("sb_user_id", userId ?? "");

                // 2) Assure que le SupabaseService a bien la session (utile pour DeleteAccountAsync)
                _supabase.SetSession(accessToken!, userId!);

                // 3) Mise √† dispo pour le reste de l'app + bascule Shell
                var app = (App)Application.Current;
                app.SetSupabase(_supabase);
                app.SetCurrentUserId(Guid.Parse(userId!));
                app.InitRestServices(accessToken!);
                app.ShowAppShell();
            }
            catch (Exception ex)
            {
                SetStatus($"Erreur : {ex.Message}", Colors.Red);
            }
        }

        private async void BtnForgotPassword_Clicked(object sender, EventArgs e)
        {
            try
            {
                await Navigation.PushAsync(new ForgotPasswordPage());
            }
            catch (Exception ex)
            {
                await DisplayAlert("Erreur", ex.ToString(), "OK");
            }
        }



        private async void BtnInscription_Clicked(object sender, EventArgs e)
        {
            try
            {
                SetStatus("Cr√©ation du compte...", Colors.Blue);

                var email = TxtEmail.Text?.Trim() ?? "";
                var password = TxtPassword.Text ?? "";

                if (string.IsNullOrWhiteSpace(email) || string.IsNullOrWhiteSpace(password))
                {
                    SetStatus("Veuillez remplir tous les champs.", Colors.Red);
                    return;
                }

                var (success, accessToken, userId, error) =
                    await _supabase.SignUpThenSignInAsync(email, password);

                if (!success)
                {
                    SetStatus(error ?? "Erreur lors de l'inscription", Colors.Red);
                    return;
                }

                // Sauvegarde session
                await SecureStorage.SetAsync("sb_access_token", accessToken ?? "");
                await SecureStorage.SetAsync("sb_user_id", userId ?? "");

                _supabase.SetSession(accessToken!, userId!);

                var app = (App)Application.Current;
                app.SetSupabase(_supabase);
                app.SetCurrentUserId(Guid.Parse(userId!));
                app.InitRestServices(accessToken!);
                app.ShowAppShell();
            }
            catch (Exception ex)
            {
                SetStatus($"Erreur : {ex.Message}", Colors.Red);
            }
        }

        private void TogglePassword(object sender, EventArgs e)
        {
            _isPasswordVisible = !_isPasswordVisible;

            // Affiche/masque le mot de passe
            TxtPassword.IsPassword = !_isPasswordVisible;

            // Optionnel: change l'ic√¥ne texte
            if (sender is Button btn)
                btn.Text = _isPasswordVisible ? "üôà" : "üëÅ";

            // Optionnel Android: force refresh / curseur fin
            if (!string.IsNullOrEmpty(TxtPassword.Text))
            {
                var t = TxtPassword.Text;
                TxtPassword.Text = string.Empty;
                TxtPassword.Text = t;
            }
        }


        private void SetStatus(string message, Color color)
        {
            TxtMessage.Text = message;
            TxtMessage.TextColor = color;
            TxtMessage.IsVisible = true;
        }
    }
}




================================================================================
FILE: LoGeCuiMobile\MainPage.xaml
================================================================================

Ôªø<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="LoGeCuiMobile.MainPage">

    <ScrollView>
        <VerticalStackLayout
            Padding="30,0"
            Spacing="25">
            <Image
                Source="dotnet_bot.png"
                HeightRequest="185"
                Aspect="AspectFit"
                SemanticProperties.Description="dot net bot in a submarine number ten" />

            <Label
                Text="Hello, World!"
                Style="{StaticResource Headline}"
                SemanticProperties.HeadingLevel="Level1" />

            <Label
                Text="Welcome to &#10;.NET Multi-platform App UI"
                Style="{StaticResource SubHeadline}"
                SemanticProperties.HeadingLevel="Level2"
                SemanticProperties.Description="Welcome to dot net Multi platform App U I" />

            <Button
                x:Name="CounterBtn"
                Text="Click me" 
                SemanticProperties.Hint="Counts the number of times you click"
                Clicked="OnCounterClicked"
                HorizontalOptions="Fill" />
        </VerticalStackLayout>
    </ScrollView>

</ContentPage>

================================================================================
FILE: LoGeCuiMobile\MainPage.xaml.cs
================================================================================

Ôªønamespace LoGeCuiMobile
{
    public partial class MainPage : ContentPage
    {
        int count = 0;

        public MainPage()
        {
            InitializeComponent();
        }

        private void OnCounterClicked(object? sender, EventArgs e)
        {
            count++;

            if (count == 1)
                CounterBtn.Text = $"Clicked {count} time";
            else
                CounterBtn.Text = $"Clicked {count} times";

            SemanticScreenReader.Announce(CounterBtn.Text);
        }
    }
}

================================================================================
FILE: LoGeCuiMobile\MauiProgram.cs
================================================================================

Ôªøusing System;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
using Microsoft.Maui.Storage;

namespace LoGeCuiMobile
{
    public static class MauiProgram
    {
        public static IConfiguration Configuration { get; private set; } = new ConfigurationBuilder().Build();

        public static MauiApp CreateMauiApp()
        {
            var builder = MauiApp.CreateBuilder();

            builder
                .UseMauiApp<App>()
                .ConfigureFonts(fonts =>
                {
                    fonts.AddFont("OpenSans-Regular.ttf", "OpenSansRegular");
                    fonts.AddFont("OpenSans-Semibold.ttf", "OpenSansSemibold");
                });

#if DEBUG
            builder.Logging.AddDebug();
#endif

            // ‚úÖ Charge appsettings.json (MauiAsset) sans faire crasher l'app si absent
            try
            {
                using var stream = FileSystem.OpenAppPackageFileAsync("appsettings.json")
                                             .GetAwaiter()
                                             .GetResult();

                builder.Configuration.AddJsonStream(stream);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine("========== CONFIG ERROR ==========");
                System.Diagnostics.Debug.WriteLine("Impossible de charger appsettings.json depuis le package MAUI.");
                System.Diagnostics.Debug.WriteLine(ex.ToString());
                System.Diagnostics.Debug.WriteLine("==================================");
                // On continue volontairement pour √©viter le crash.
            }

            Configuration = builder.Configuration;

            // ‚úÖ IMPORTANT: on force le namespace exact (√©vite conflits)
            try
            {
                LoGeCuiShared.Services.ConfigurationHelper.Configure(key => Configuration[key]);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine("========== CONFIGHELPER ERROR ==========");
                System.Diagnostics.Debug.WriteLine(ex.ToString());
                System.Diagnostics.Debug.WriteLine("========================================");
                // On continue; l'erreur r√©elle ressortira quand une cl√© sera demand√©e.
            }

            return builder.Build();
        }
    }
}


================================================================================
FILE: LoGeCuiMobile\Pages\AjouterIngredientPage.xaml
================================================================================

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="LoGeCuiMobile.Pages.AjouterIngredientPage"
    Title="Ajouter un ingr√©dient">

    <VerticalStackLayout Padding="20" Spacing="14">

        <Entry
            x:Name="NomEntry"
            Placeholder="Nom de l‚Äôingr√©dient" />

        <Entry
            x:Name="QuantiteEntry"
            Placeholder="Quantit√© (ex: 10)"
            Keyboard="Numeric" />

        <Entry
            x:Name="UniteEntry"
            Placeholder="Unit√© (ex: kg, pi√®ces)" />

        <HorizontalStackLayout Spacing="10">
            <CheckBox x:Name="DisponibleCheckBox" IsChecked="True"/>
            <Label Text="Disponible"
                   VerticalTextAlignment="Center"/>
        </HorizontalStackLayout>

        <Button
            Text="üíæ Enregistrer"
            BackgroundColor="#28a745"
            TextColor="White"
            Clicked="OnSaveClicked"/>

    </VerticalStackLayout>
</ContentPage>

================================================================================
FILE: LoGeCuiMobile\Pages\AjouterIngredientPage.xaml.cs
================================================================================

using LoGeCuiShared.Models;
using Microsoft.Maui.Controls;

namespace LoGeCuiMobile.Pages;

[QueryProperty(nameof(Result), "result")]
public partial class AjouterIngredientPage : ContentPage
{
    public Ingredient? Result { get; set; }

    public AjouterIngredientPage()
    {
        InitializeComponent();
    }

    private async void OnSaveClicked(object sender, EventArgs e)
    {
        if (string.IsNullOrWhiteSpace(NomEntry.Text))
        {
            await DisplayAlert("Erreur", "Le nom est obligatoire.", "OK");
            return;
        }

        Result = new Ingredient
        {
            Nom = NomEntry.Text.Trim(),
            Quantite = QuantiteEntry.Text?.Trim() ?? "",
            Unite = UniteEntry.Text?.Trim() ?? "",
            EstDisponible = DisponibleCheckBox.IsChecked
        };

        // retour vers la page prÔøΩcÔøΩdente
        await Shell.Current.GoToAsync("..");
    }
}


================================================================================
FILE: LoGeCuiMobile\Pages\AjouterRecettePage.xaml
================================================================================

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="LoGeCuiMobile.Pages.AjouterRecettePage"
             Title="Ajouter une recette">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="12">

            <Label Text="Nom" />
            <Entry x:Name="NomEntry" Placeholder="Nom de la recette" />

            <Label Text="Cat√©gorie" />
            <Picker x:Name="CategoriePicker" />

            <Label Text="Temps (minutes)" />
            <Entry x:Name="TempsEntry" Keyboard="Numeric" />

            <Label Text="Ingr√©dients (1 par ligne)" />
            <Editor x:Name="IngredientsEditor" AutoSize="TextChanges" HeightRequest="140" />

            <Label Text="Instructions" />
            <Editor x:Name="InstructionsEditor" AutoSize="TextChanges" HeightRequest="180" />

            <Button Text="Scanner (OCR)" Clicked="OnScanClicked" />
            <Button Text="Enregistrer" Clicked="OnSaveClicked" />

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>


================================================================================
FILE: LoGeCuiMobile\Pages\AjouterRecettePage.xaml.cs
================================================================================

using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using LoGeCuiShared.Models;
using LoGeCuiShared.Services;
using LoGeCuiMobile.Services;
using Microsoft.Maui.ApplicationModel;
using Microsoft.Maui.Controls;
using Microsoft.Maui.Media;

namespace LoGeCuiMobile.Pages
{
    public partial class AjouterRecettePage : ContentPage
    {
        public AjouterRecettePage()
        {
            InitializeComponent();

            // Valeurs conformes ÔøΩ ta DB Supabase (Entree / Plat / Dessert)
            CategoriePicker.ItemsSource = new List<string> { "Entree", "Plat", "Dessert" };
            CategoriePicker.SelectedIndex = 1; // Plat par dÔøΩfaut
        }

        private async void OnSaveClicked(object sender, EventArgs e)
        {
            try
            {
                var app = (App)Application.Current;

                if (app.CurrentUserId == null || app.RecipesService == null)
                {
                    await DisplayAlert("Erreur", "Vous devez ÔøΩtre connectÔøΩ.", "OK");
                    return;
                }

                if (app.RecetteIngredientsService == null)
                {
                    await DisplayAlert("Erreur", "RecetteIngredientsService non initialisÔøΩ (InitRestServices).", "OK");
                    return;
                }

                if (string.IsNullOrWhiteSpace(NomEntry.Text))
                {
                    await DisplayAlert("Erreur", "Le nom est obligatoire.", "OK");
                    return;
                }

                var categorie = (CategoriePicker.SelectedItem as string) ?? "Plat";
                int temps = int.TryParse(TempsEntry.Text, out var t) ? t : 0;

                // ExternalId stable pour retrouver l'id aprÔøΩs upsert
                var externalId = Guid.NewGuid().ToString("N");

                var recette = new Recette
                {
                    Nom = NomEntry.Text.Trim(),
                    CategorieDb = categorie,
                    TempsPreparation = temps,
                    Difficulte = 1,
                    Instructions = InstructionsEditor.Text ?? "",
                    IsFavorite = false,
                    ExternalId = externalId
                };

                // 1) Upsert recette (table recettes)
                await app.RecipesService.UpsertRecetteAsync(app.CurrentUserId.Value, recette);

                // 2) RÔøΩcupÔøΩrer l'id rÔøΩel de la recette (UUID en DB) via ExternalId
                var recetteId = await app.RecipesService.GetRecetteIdByExternalIdAsync(externalId);
                if (recetteId == null)
                {
                    await DisplayAlert("Erreur", "Impossible de retrouver l'ID de la recette aprÔøΩs sauvegarde.", "OK");
                    return;
                }

                // 3) Parser les ingrÔøΩdients (1 par ligne)
                //    Format acceptÔøΩ: "pomme" OU "2 kg pomme" (simple)
                var lines = (IngredientsEditor.Text ?? "")
                    .Split('\n', StringSplitOptions.RemoveEmptyEntries)
                    .Select(l => l.Trim())
                    .Where(l => l.Length > 0)
                    .ToList();

                var items = new List<(string nom, string? quantite, string? unite)>();

                foreach (var line in lines)
                {
                    // Si vous ne gÔøΩrez pas quantite/unite maintenant, gardez simple:
                    // tout va dans ingredient_nom
                    items.Add((line, null, null));
                }

                // 4) ÔøΩcriture dans recette_ingredients (delete + insert)
                await app.RecetteIngredientsService.ReplaceForRecetteAsync(recetteId.Value, items);

                await DisplayAlert("OK", "Recette enregistrÔøΩe.", "OK");
                await Navigation.PopAsync();
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine(ex.ToString());
                await DisplayAlert("Erreur", ex.Message, "OK");
            }
        }


        // Transforme le texte du multi-line editor en liste (nom, quantite, unite)
        private static List<(string nom, string? quantite, string? unite)> ParseIngredientsEditor(string? text)
        {
            text ??= "";

            return text
                .Replace("\r\n", "\n")
                .Split('\n', StringSplitOptions.RemoveEmptyEntries)
                .Select(l => l.Trim())
                .Where(l => !string.IsNullOrWhiteSpace(l))
                .Select(ParseIngredientLine)
                .Where(x => !string.IsNullOrWhiteSpace(x.nom))
                .ToList();
        }

        // Supporte:
        // - "Tomate"
        // - "200 g Farine"
        // - "2 pcs Tomate"
        // - "Farine - 200 g" (si tu colles depuis ToString)
        private static (string nom, string? quantite, string? unite) ParseIngredientLine(string line)
        {
            // "Nom - Quantite Unite"
            var dashSplit = line.Split(" - ", StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
            if (dashSplit.Length >= 2)
            {
                var nomPart = dashSplit[0];
                var qtePart = dashSplit[1];

                var parts = qtePart.Split(' ', StringSplitOptions.RemoveEmptyEntries);
                if (parts.Length >= 2)
                    return (nomPart, parts[0], string.Join(" ", parts.Skip(1)));

                return (nomPart, qtePart, null);
            }

            // "200 g Farine"
            var tokens = line.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            if (tokens.Length >= 3 && char.IsDigit(tokens[0][0]))
            {
                var quantite = tokens[0];
                var unite = tokens[1];
                var nom = string.Join(" ", tokens.Skip(2));
                return (nom, quantite, unite);
            }

            // Sinon : juste le nom
            return (line, null, null);
        }

        private async void OnScanClicked(object sender, EventArgs e)
        {
            try
            {
                // Permission camÔøΩra (Android 6+)
                var status = await Permissions.CheckStatusAsync<Permissions.Camera>();
                if (status != PermissionStatus.Granted)
                    status = await Permissions.RequestAsync<Permissions.Camera>();

                if (status != PermissionStatus.Granted)
                {
                    await DisplayAlert("Permission", "L'accÔøΩs ÔøΩ la camÔøΩra est requis pour scanner.", "OK");
                    return;
                }

                // Capture supportÔøΩe ?
                if (!MediaPicker.Default.IsCaptureSupported)
                {
                    await DisplayAlert("Erreur", "Capture photo non supportÔøΩe sur cet appareil.", "OK");
                    return;
                }

                var photo = await MediaPicker.Default.CapturePhotoAsync(new MediaPickerOptions
                {
                    Title = "Scanner une recette"
                });

                if (photo == null)
                    return;

                byte[] bytes;
                using (var stream = await photo.OpenReadAsync())
                using (var ms = new MemoryStream())
                {
                    await stream.CopyToAsync(ms);
                    bytes = ms.ToArray();
                }

                Debug.WriteLine($"Image originale: {bytes.Length / 1024} KB");

                // Compression pour rester sous la limite OCR.Space (souvent 1024 KB)
                bytes = ImageCompressionHelper.CompressJpeg(bytes, maxWidth: 1600, jpegQuality: 75);
                Debug.WriteLine($"Image compressÔøΩe: {bytes.Length / 1024} KB");

                // Si encore trop gros, on retente plus agressif automatiquement
                if (bytes.Length > 1024 * 1024)
                {
                    bytes = ImageCompressionHelper.CompressJpeg(bytes, maxWidth: 1200, jpegQuality: 65);
                    Debug.WriteLine($"Image recompressÔøΩe: {bytes.Length / 1024} KB");
                }

                if (bytes.Length > 1024 * 1024)
                {
                    await DisplayAlert(
                        "Erreur",
                        "L'image est toujours trop lourde (> 1 Mo) pour l'OCR. Essayez de cadrer plus serrÔøΩ ou baissez la rÔøΩsolution.",
                        "OK");
                    return;
                }

                // OCR
                var ocrKey = LoGeCuiShared.Services.ConfigurationHelper.GetOcrApiKey();
                var ocr = new OcrService(ocrKey);

                var fullText = await ocr.ExtractTextFromImageAsync(bytes, photo.FileName);

                if (string.IsNullOrWhiteSpace(fullText))
                {
                    await DisplayAlert("OCR", "Aucun texte dÔøΩtectÔøΩ. Essayez avec plus de lumiÔøΩre et sans flou.", "OK");
                    return;
                }

                fullText = NormalizeOcrText(fullText);

                var (ingredients, instructions) = SplitRecipeText(fullText);

                if (!string.IsNullOrWhiteSpace(instructions))
                    InstructionsEditor.Text = instructions.Trim();

                if (!string.IsNullOrWhiteSpace(ingredients))
                    IngredientsEditor.Text = ingredients.Trim();

                if (string.IsNullOrWhiteSpace(NomEntry.Text))
                {
                    var title = GuessTitle(fullText);
                    if (!string.IsNullOrWhiteSpace(title))
                        NomEntry.Text = title;
                }

                await DisplayAlert("OK", "Texte scannÔøΩ et champs prÔøΩ-remplis. VÔøΩrifiez et corrigez si besoin.", "OK");
            }
            catch (Exception ex)
            {
                var msg = ex.Message ?? "Erreur inconnue.";

                if (msg.Contains("File failed validation", StringComparison.OrdinalIgnoreCase) ||
                    msg.Contains("maximum permissible file size", StringComparison.OrdinalIgnoreCase) ||
                    msg.Contains("1024kb", StringComparison.OrdinalIgnoreCase))
                {
                    msg = "L'image dÔøΩpasse la limite (1 Mo) du service OCR. Essayez de recadrer plus serrÔøΩ ou compresser davantage.";
                }

                await DisplayAlert("Erreur", msg, "OK");
            }
        }

        private static string NormalizeOcrText(string s)
        {
            s = s.Replace("\r\n", "\n").Replace("\r", "\n");
            while (s.Contains("\n\n\n")) s = s.Replace("\n\n\n", "\n\n");
            return s.Trim();
        }

        private static (string ingredients, string instructions) SplitRecipeText(string text)
        {
            var lower = text.ToLowerInvariant();

            int idxIng = IndexOfAny(lower, "ingrÔøΩdients", "ingredients");
            int idxPrep = IndexOfAny(lower, "prÔøΩparation", "preparation", "instructions", "rÔøΩalisation", "realisation", "ÔøΩtapes", "etapes");

            if (idxIng >= 0 && idxPrep > idxIng)
            {
                var ingPart = text.Substring(idxIng, idxPrep - idxIng);
                var prepPart = text.Substring(idxPrep);

                ingPart = RemoveHeaderLine(ingPart);
                prepPart = RemoveHeaderLine(prepPart);

                return (CleanupListLike(ingPart), CleanupParagraph(prepPart));
            }

            if (idxPrep >= 0)
            {
                var before = text.Substring(0, idxPrep);
                var after = text.Substring(idxPrep);

                after = RemoveHeaderLine(after);
                return (CleanupListLike(before), CleanupParagraph(after));
            }

            var lines = text.Split('\n').Select(l => l.Trim()).Where(l => l.Length > 0).ToList();

            var ingLines = new List<string>();
            var instrLines = new List<string>();

            bool inInstructions = false;
            foreach (var line in lines)
            {
                if (!inInstructions && LooksLikeStep(line))
                    inInstructions = true;

                if (!inInstructions && LooksLikeIngredientLine(line))
                    ingLines.Add(line);
                else
                    instrLines.Add(line);
            }

            return (string.Join("\n", ingLines), string.Join("\n", instrLines));
        }

        private static int IndexOfAny(string haystack, params string[] needles)
        {
            int best = -1;
            foreach (var n in needles)
            {
                var i = haystack.IndexOf(n, StringComparison.OrdinalIgnoreCase);
                if (i >= 0 && (best < 0 || i < best)) best = i;
            }
            return best;
        }

        private static string RemoveHeaderLine(string block)
        {
            var lines = block.Replace("\r\n", "\n").Split('\n').ToList();
            if (lines.Count == 0) return block;
            lines.RemoveAt(0);
            return string.Join("\n", lines).Trim();
        }

        private static string CleanupListLike(string s)
        {
            var lines = s.Replace("\r\n", "\n").Split('\n')
                .Select(l => l.Trim())
                .Where(l => l.Length > 0)
                .Select(l => l.TrimStart('-', 'ÔøΩ', '*', 'ÔøΩ', 'ÔøΩ', 'ÔøΩ', ' '))
                .Where(l => l.Length > 0);

            return string.Join("\n", lines);
        }

        private static string CleanupParagraph(string s)
        {
            var lines = s.Replace("\r\n", "\n").Split('\n')
                .Select(l => l.Trim())
                .Where(l => l.Length > 0);

            return string.Join("\n", lines);
        }

        private static bool LooksLikeIngredientLine(string line)
        {
            if (line.StartsWith("-") || line.StartsWith("ÔøΩ") || line.StartsWith("*")) return true;

            var l = line.ToLowerInvariant();
            string[] units = { " g", "kg", " ml", "cl", " l", "cÔøΩs", "cas", "cÔøΩc", "cac", "cuillÔøΩre", "pincÔøΩe", "tranche", "sachet" };
            if (units.Any(u => l.Contains(u))) return true;

            if (char.IsDigit(line.FirstOrDefault())) return true;

            return false;
        }

        private static bool LooksLikeStep(string line)
        {
            var l = line.Trim();
            if (l.StartsWith("1)") || l.StartsWith("1.") ||
                l.StartsWith("ÔøΩtape", StringComparison.OrdinalIgnoreCase) ||
                l.StartsWith("Etape", StringComparison.OrdinalIgnoreCase))
                return true;

            if (l.Length >= 2 && char.IsDigit(l[0]) && (l[1] == ')' || l[1] == '.'))
                return true;

            return false;
        }

        private static string GuessTitle(string text)
        {
            var first = text.Split('\n').Select(l => l.Trim()).FirstOrDefault(l => l.Length > 0) ?? "";
            if (first.Length >= 3 && first.Length <= 50) return first;
            return "";
        }
    }
}

================================================================================
FILE: LoGeCuiMobile\Pages\ListeCoursesPage.xaml
================================================================================

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:conv="clr-namespace:LoGeCuiMobile.Converters"
             x:Class="LoGeCuiMobile.Pages.ListeCoursesPage"
             Title="üõí Liste de Courses">

    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:BoolToStrikethroughConverter x:Key="BoolToStrikethroughConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid Padding="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Label Grid.Row="0"
               Text="Ma liste de courses"
               FontSize="24"
               FontAttributes="Bold"
               HorizontalOptions="Center"
               Margin="0,10,0,10"/>

        <Grid Grid.Row="1" ColumnSpacing="10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Button Grid.Column="0"
                    Text="‚ûï Ajouter un article"
                    BackgroundColor="#27AE60"
                    TextColor="White"
                    FontAttributes="Bold"
                    Clicked="BtnAjouter_Clicked" />

            <Button Grid.Column="1"
                    x:Name="BtnSupprimerSelection"
                    Text="üóëÔ∏è Supprimer s√©lection"
                    BackgroundColor="#E67E22"
                    TextColor="White"
                    FontAttributes="Bold"
                    Clicked="BtnSupprimerSelection_Clicked"/>
        </Grid>

        <Label Grid.Row="2"
               x:Name="SelectionInfoLabel"
               Text=""
               TextColor="Gray"
               Margin="0,8,0,8"/>

        <CollectionView Grid.Row="3"
                        x:Name="ListeCourses"
                        SelectionMode="None">

            <CollectionView.EmptyView>
                <Label Text="Aucun article pour l'instant."
                       HorizontalOptions="Center"
                       Margin="0,20,0,0"
                       TextColor="Gray"/>
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Frame Margin="6"
               Padding="14"
               BackgroundColor="White"
               BorderColor="#DDDDDD"
               CornerRadius="12"
               HasShadow="True">

                        <VerticalStackLayout Spacing="8">

                            <!-- Nom -->
                            <Label Text="{Binding Nom}"
                       FontSize="18"
                       FontAttributes="Bold"
                       TextDecorations="{Binding EstAchete, Converter={StaticResource BoolToStrikethroughConverter}}"/>

                            <!-- Quantit√© -->
                            <Label FontSize="14"
                       TextColor="Gray">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="{Binding Quantite}"/>
                                        <Span Text=" "/>
                                        <Span Text="{Binding Unite}"/>
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>

                            <!-- Actions -->
                            <HorizontalStackLayout Spacing="20">

                                <!-- Achet√© -->
                                <HorizontalStackLayout Spacing="6">
                                    <CheckBox IsChecked="{Binding EstAchete, Mode=TwoWay}"
                                  CheckedChanged="CheckBox_CheckedChanged"/>
                                    <Label Text="Achet√©"
                               VerticalOptions="Center"/>
                                </HorizontalStackLayout>

                                <!-- S√©lection suppression -->
                                <HorizontalStackLayout Spacing="6">
                                    <CheckBox IsChecked="{Binding IsSelectedForDelete}"/>
                                    <Label Text="Supprimer"
                               VerticalOptions="Center"/>
                                </HorizontalStackLayout>

                            </HorizontalStackLayout>

                        </VerticalStackLayout>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>

        </CollectionView>
    </Grid>

</ContentPage>




================================================================================
FILE: LoGeCuiMobile\Pages\ListeCoursesPage.xaml.cs
================================================================================

Ôªøusing System;
using System.Collections.ObjectModel;
using System.Linq;
using LoGeCuiShared.Models;
using LoGeCuiShared.Services;
using LoGeCuiMobile.Models;

namespace LoGeCuiMobile.Pages
{
    public partial class ListeCoursesPage : ContentPage
    {
        private readonly ObservableCollection<ArticleCourseUi> _articles = new();
        private readonly SupabaseService _supabase;

        public ListeCoursesPage()
        {
            InitializeComponent();

            _supabase = ((App)Application.Current).Supabase
                ?? throw new InvalidOperationException("Supabase non initialis√©.");

            // Plus besoin de SelectionChanged / SelectedItems : on passe par IsSelectedForDelete
            BtnSupprimerSelection.Clicked += BtnSupprimerSelection_Clicked;

            ListeCourses.ItemsSource = _articles;

            // Bouton actif en permanence; il affichera un message si rien n‚Äôest coch√©
            BtnSupprimerSelection.IsEnabled = true;

            if (SelectionInfoLabel != null)
                SelectionInfoLabel.Text = "";

            ChargerDonnees();
        }

        private async void ChargerDonnees()
        {
            try
            {
                var articles = await _supabase.GetArticlesAsync();

                _articles.Clear();
                foreach (var a in articles)
                    _articles.Add(new ArticleCourseUi(a));

                if (SelectionInfoLabel != null)
                    SelectionInfoLabel.Text = "";
            }
            catch (Exception ex)
            {
                await DisplayAlert("Erreur", $"Impossible de charger : {ex.Message}", "OK");
            }
        }

        private async void BtnSupprimerSelection_Clicked(object sender, EventArgs e)
        {
            var selected = _articles.Where(a => a.IsSelectedForDelete).ToList();

            if (selected.Count == 0)
            {
                await DisplayAlert("Information", "Aucun article s√©lectionn√©.", "OK");
                return;
            }

            bool confirm = await DisplayAlert(
                "Confirmation",
                $"Supprimer {selected.Count} article(s) s√©lectionn√©(s) ?",
                "Oui",
                "Non");

            if (!confirm)
                return;

            try
            {
                foreach (var articleUi in selected)
                {
                    await _supabase.DeleteArticleAsync(articleUi.Id);
                    _articles.Remove(articleUi);
                }

                if (SelectionInfoLabel != null)
                    SelectionInfoLabel.Text = "";

                await DisplayAlert("Succ√®s", $"{selected.Count} article(s) supprim√©(s).", "OK");
            }
            catch (Exception ex)
            {
                await DisplayAlert("Erreur", $"Suppression impossible : {ex.Message}", "OK");
                ChargerDonnees();
            }
        }

        private async void CheckBox_CheckedChanged(object sender, CheckedChangedEventArgs e)
        {
            var checkbox = (CheckBox)sender;
            var articleUi = checkbox.BindingContext as ArticleCourseUi;
            if (articleUi == null) return;

            var article = articleUi.Model;

            checkbox.IsEnabled = false;
            var oldValue = !e.Value;

            try
            {
                await _supabase.UpdateArticleAsync(article.Id, article);
            }
            catch (Exception ex)
            {
                article.EstAchete = oldValue;
                checkbox.IsChecked = oldValue;

                await DisplayAlert("Erreur", $"Synchronisation √©chou√©e : {ex.Message}", "OK");
            }
            finally
            {
                checkbox.IsEnabled = true;
            }
        }

        private async void BtnAjouter_Clicked(object sender, EventArgs e)
        {
            string nom = await DisplayPromptAsync("Ajouter", "Nom de l'article :");
            if (string.IsNullOrWhiteSpace(nom))
                return;

            string quantite = await DisplayPromptAsync("Ajouter", "Quantit√© :");
            if (string.IsNullOrWhiteSpace(quantite))
                return;

            string unite = await DisplayPromptAsync("Ajouter", "Unit√© (g, kg, L, pi√®ces...) :");
            if (string.IsNullOrWhiteSpace(unite))
                return;

            try
            {
                var app = (App)Application.Current;
                if (app.CurrentUserId == null)
                {
                    await DisplayAlert("Erreur", "Vous devez √™tre connect√©.", "OK");
                    return;
                }

                var article = new ArticleCourse
                {
                    UserId = app.CurrentUserId.Value,
                    Nom = nom,
                    Quantite = quantite,
                    Unite = unite,
                    EstAchete = false
                };

                var added = await _supabase.AddArticleAsync(article);
                if (added != null)
                {
                    _articles.Add(new ArticleCourseUi(added));
                    await DisplayAlert("Succ√®s", $"'{added.Nom}' ajout√© !", "OK");
                }
            }
            catch (Exception ex)
            {
                await DisplayAlert("Erreur", $"Impossible d'ajouter : {ex.Message}", "OK");
            }
        }
    }
}

================================================================================
FILE: LoGeCuiMobile\Pages\MenuAleatoirePage.xaml
================================================================================

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="LoGeCuiMobile.Pages.MenuAleatoirePage"
             Title="Menu al√©atoire">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">

            <Button
                Text="üé≤ Menu al√©atoire"
                Clicked="OnMenuAleatoireClicked" />

            <Label
                x:Name="ResultLabel"
                Text="Appuyez sur le bouton pour g√©n√©rer un menu"
                FontSize="18"
                HorizontalTextAlignment="Center" />

            <!-- Bouton visible uniquement apr√®s g√©n√©ration si ingr√©dients manquants -->
            <Button x:Name="SendMissingButton"
                    Text="üõí Envoyer les ingr√©dients manquants dans la liste de courses"
                    Clicked="OnSendMissingClicked"
                    HorizontalOptions="FillAndExpand"
                    IsVisible="False"
                    IsEnabled="False" />

            <Button
                Text="üõí Ouvrir la liste de courses"
                Clicked="OnOpenListeCoursesClicked"
                HorizontalOptions="FillAndExpand" />

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>



================================================================================
FILE: LoGeCuiMobile\Pages\MenuAleatoirePage.xaml.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using LoGeCuiShared.Models;
using Microsoft.Maui.Controls;

namespace LoGeCuiMobile.Pages;

public partial class MenuAleatoirePage : ContentPage
{
    private static readonly Random _random = new();

    private List<string> _lastMissing = new();
    private Guid? _lastUserId;
    private bool _lastIngredientsKnown = false;

    public MenuAleatoirePage()
    {
        InitializeComponent();
        SendMissingButton.IsVisible = false;
        SendMissingButton.IsEnabled = false;
    }

    // ------------------ UTIL ------------------

    private static string Norm(string s)
    {
        if (string.IsNullOrWhiteSpace(s))
            return "";

        var normalized = s.Trim().ToLowerInvariant().Normalize(NormalizationForm.FormD);
        var sb = new StringBuilder();

        foreach (var c in normalized)
            if (CharUnicodeInfo.GetUnicodeCategory(c) != UnicodeCategory.NonSpacingMark)
                sb.Append(c);

        return sb.ToString();
    }

    private sealed class RecetteIngredientRow
    {
        public string? ingredient_nom { get; set; }
    }

    private async Task<List<string>> GetRecetteIngredientsAsync(App app, Guid recetteId)
    {
        if (app.RestClient == null)
            return new List<string>();

        // Sch√©ma confirm√© : recette_ingredients(recette_id, ingredient_nom, quantite, unite)
        var q = $"recette_ingredients?select=ingredient_nom&recette_id=eq.{recetteId}";

        var rows = await app.RestClient.GetAsync<List<RecetteIngredientRow>>(q)
                   ?? new List<RecetteIngredientRow>();

        return rows
            .Select(r => r.ingredient_nom ?? "")
            .Where(n => !string.IsNullOrWhiteSpace(n))
            .Distinct()
            .ToList();
    }

    private async Task<List<string>> GetUserIngredientsAsync(App app, Guid userId)
    {
        if (app.IngredientsService == null)
            return new List<string>();

        var rows = await app.IngredientsService.GetIngredientsAsync(userId)
                   ?? new List<Ingredient>();

        // On ne consid√®re que ceux disponibles
        return rows
            .Where(i => i.EstDisponible)
            .Select(i => i.Nom ?? "")
            .Where(n => !string.IsNullOrWhiteSpace(n))
            .Distinct()
            .ToList();
    }

    // ------------------ EVENTS ------------------

    private async void OnMenuAleatoireClicked(object sender, EventArgs e)
    {
        try
        {
            await RunMenuAleatoireAsync();
        }
        catch (Exception ex)
        {
            await DisplayAlert("Erreur", ex.Message, "OK");
        }
    }

    private async void OnOpenListeCoursesClicked(object sender, EventArgs e)
    {
        try
        {
            var app = Application.Current as App;
            if (app?.ListeCoursesSupabaseService == null)
            {
                await DisplayAlert("Erreur", "Service indisponible.", "OK");
                return;
            }

            await Shell.Current.GoToAsync(nameof(ListeCoursesPage));
        }
        catch (Exception ex)
        {
            await DisplayAlert("Erreur", ex.Message, "OK");
        }
    }

    private async void OnSendMissingClicked(object sender, EventArgs e)
    {
        try
        {
            var app = Application.Current as App;

            if (app?.ListeCoursesSupabaseService == null || app.CurrentUserId == null)
                return;

            if (!_lastIngredientsKnown || _lastMissing.Count == 0)
                return;

            bool confirm = await DisplayAlert(
                "Envoyer ?",
                "Il manque :\n- " + string.Join("\n- ", _lastMissing),
                "Oui",
                "Non");

            if (!confirm)
                return;

            await app.ListeCoursesSupabaseService.AddMissingAsync(
                app.CurrentUserId.Value,
                _lastMissing);

            SendMissingButton.IsEnabled = false;
            SendMissingButton.Text = "üõí Ingr√©dients envoy√©s";
        }
        catch (Exception ex)
        {
            await DisplayAlert("Erreur", ex.Message, "OK");
        }
    }

    // ------------------ LOGIQUE ------------------

    private async Task RunMenuAleatoireAsync()
    {
        var app = Application.Current as App;
        if (app == null)
            return;

        // Reset UI
        SendMissingButton.IsVisible = false;
        SendMissingButton.IsEnabled = false;
        SendMissingButton.Text = "üõí Envoyer les ingr√©dients manquants dans la liste de courses";
        _lastMissing = new List<string>();
        _lastIngredientsKnown = false;
        _lastUserId = app.CurrentUserId;

        if (app.CurrentUserId == null ||
            app.RestClient == null ||
            app.RecipesService == null ||
            app.IngredientsService == null ||
            app.ListeCoursesSupabaseService == null)
        {
            ResultLabel.Text = "Vous devez √™tre connect√©.";
            return;
        }

        var userId = app.CurrentUserId.Value;
        ResultLabel.Text = "G√©n√©ration du menu (Entr√©e / Plat / Dessert)‚Ä¶";

        // 1) Recettes utilisateur
        var recettes = await app.RecipesService.GetMyRecettesAsync();

        if (recettes == null || recettes.Count == 0)
        {
            ResultLabel.Text = "Aucune recette disponible.";
            return;
        }

        // 2) Par type (enum)
        var entrees = recettes.Where(r => r.Type == TypePlat.Entree).ToList();
        var plats = recettes.Where(r => r.Type == TypePlat.Plat).ToList();
        var desserts = recettes.Where(r => r.Type == TypePlat.Dessert).ToList();

        if (entrees.Count == 0 || plats.Count == 0 || desserts.Count == 0)
        {
            ResultLabel.Text =
                "Impossible de g√©n√©rer un menu Entr√©e/Plat/Dessert.\n\n" +
                $"Entr√©es: {entrees.Count}\nPlats: {plats.Count}\nDesserts: {desserts.Count}\n\n" +
                "V√©rifie que tes recettes ont bien 'categorie' = Entree / Plat / Dessert en DB.";
            return;
        }

        // 3) Tirage al√©atoire
        var entree = entrees[_random.Next(entrees.Count)];
        var plat = plats[_random.Next(plats.Count)];
        var dessert = desserts[_random.Next(desserts.Count)];

        // 4) Ingr√©dients utilisateur
        var userIngredients = await GetUserIngredientsAsync(app, userId);
        var userSet = userIngredients
            .Select(Norm)
            .Where(x => !string.IsNullOrWhiteSpace(x))
            .ToHashSet();

        // 5) Analyse recette (avec garde-fou si pas d'ingr√©dients en DB)
        async Task<(List<string> ingredients, List<string> missing, bool hasData)> AnalyzeAsync(Recette r)
        {
            var ingredients = await GetRecetteIngredientsAsync(app, r.Id);
            var distinct = ingredients
                .Where(s => !string.IsNullOrWhiteSpace(s))
                .Distinct()
                .ToList();

            if (distinct.Count == 0)
                return (distinct, new List<string>(), false);

            var missing = distinct
                .Where(i => !userSet.Contains(Norm(i)))
                .Distinct()
                .ToList();

            return (distinct, missing, true);
        }

        var entreeA = await AnalyzeAsync(entree);
        var platA = await AnalyzeAsync(plat);
        var dessertA = await AnalyzeAsync(dessert);

        // 6) Agr√©gation des manquants (uniquement si on a des donn√©es)
        var allHaveData = entreeA.hasData && platA.hasData && dessertA.hasData;

        if (allHaveData)
        {
            _lastMissing = entreeA.missing
                .Concat(platA.missing)
                .Concat(dessertA.missing)
                .Where(s => !string.IsNullOrWhiteSpace(s))
                .Distinct()
                .ToList();
            _lastIngredientsKnown = true;
        }
        else
        {
            _lastMissing = new List<string>();
            _lastIngredientsKnown = false;
        }

        // 7) UI
        var sb = new StringBuilder();

        sb.AppendLine("Menu g√©n√©r√© :");
        sb.AppendLine($"- {entree.TypeTexte} : {entree.Nom}");
        sb.AppendLine($"- {plat.TypeTexte} : {plat.Nom}");
        sb.AppendLine($"- {dessert.TypeTexte} : {dessert.Nom}");
        sb.AppendLine();

        void AppendRecetteBlock(Recette r, List<string> ingredients, List<string> missing, bool hasData)
        {
            sb.AppendLine($"{r.TypeTexte} ‚Äî {r.Nom}");

            if (!hasData)
            {
                sb.AppendLine("Ingr√©dients : (aucun ingr√©dient enregistr√© pour cette recette)");
                sb.AppendLine();
                return;
            }

            sb.AppendLine("Ingr√©dients :");
            foreach (var i in ingredients)
                sb.AppendLine("- " + i);

            if (missing.Count == 0)
            {
                sb.AppendLine("Manquants : aucun");
            }
            else
            {
                sb.AppendLine("Manquants :");
                foreach (var m in missing)
                    sb.AppendLine("- " + m);
            }

            sb.AppendLine();
        }

        AppendRecetteBlock(entree, entreeA.ingredients, entreeA.missing, entreeA.hasData);
        AppendRecetteBlock(plat, platA.ingredients, platA.missing, platA.hasData);
        AppendRecetteBlock(dessert, dessertA.ingredients, dessertA.missing, dessertA.hasData);

        if (!allHaveData)
        {
            sb.AppendLine("Impossible de calculer les ingr√©dients manquants : certaines recettes n‚Äôont pas d‚Äôingr√©dients enregistr√©s.");
            SendMissingButton.IsVisible = false;
            SendMissingButton.IsEnabled = false;
        }
        else if (_lastMissing.Count == 0)
        {
            sb.AppendLine("Tout est disponible. Aucun ingr√©dient manquant.");
            SendMissingButton.IsVisible = false;
            SendMissingButton.IsEnabled = false;
        }
        else
        {
            sb.AppendLine("Liste globale des ingr√©dients manquants :");
            foreach (var m in _lastMissing)
                sb.AppendLine("- " + m);

            SendMissingButton.IsVisible = true;
            SendMissingButton.IsEnabled = true;
        }

        ResultLabel.Text = sb.ToString();
    }
}

================================================================================
FILE: LoGeCuiMobile\Pages\MesIngredientsPage.xaml
================================================================================

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="LoGeCuiMobile.Pages.MesIngredientsPage"
    Title="Gestion des ingr√©dients">

    <Grid Padding="16" RowDefinitions="Auto,*" RowSpacing="12">

        <!-- Bouton ajouter -->
        <Button
            Grid.Row="0"
            Text="‚ûï Ajouter un ingr√©dient"
            BackgroundColor="#28a745"
            TextColor="White"
            Clicked="OnAddIngredientClicked" />

        <!-- Liste des ingr√©dients (scroll natif) -->
        <CollectionView
            Grid.Row="1"
            x:Name="IngredientsCollection"
            SelectionMode="Single"
            SelectionChanged="OnIngredientSelected">

            <CollectionView.ItemTemplate>
                <DataTemplate>

                    <Frame
                        Padding="12"
                        Margin="0,4"
                        BorderColor="#ddd"
                        CornerRadius="10">

                        <Grid ColumnDefinitions="*,Auto">

                            <VerticalStackLayout Spacing="4">

                                <Label
                                    Text="{Binding Nom}"
                                    FontSize="18"
                                    FontAttributes="Bold" />

                                <Label FontSize="14" TextColor="Gray">
                                    <Label.Text>
                                        <MultiBinding StringFormat="Quantit√© : {0} {1}">
                                            <Binding Path="Quantite"/>
                                            <Binding Path="Unite"/>
                                        </MultiBinding>
                                    </Label.Text>
                                </Label>

                                <HorizontalStackLayout Spacing="6">
                                    <CheckBox IsChecked="{Binding EstDisponible}" />
                                    <Label Text="Disponible" VerticalTextAlignment="Center"/>
                                </HorizontalStackLayout>

                            </VerticalStackLayout>

                            <Button
                                Grid.Column="1"
                                Text="üóë"
                                BackgroundColor="#e74c3c"
                                TextColor="White"
                                Clicked="OnDeleteIngredientClicked" />

                        </Grid>
                    </Frame>

                </DataTemplate>
            </CollectionView.ItemTemplate>

        </CollectionView>

    </Grid>
</ContentPage>


================================================================================
FILE: LoGeCuiMobile\Pages\MesIngredientsPage.xaml.cs
================================================================================

using System.Collections.ObjectModel;
using LoGeCuiShared.Models;

namespace LoGeCuiMobile.Pages;

public partial class MesIngredientsPage : ContentPage
{
    private ObservableCollection<Ingredient> _ingredients =
        new ObservableCollection<Ingredient>();

    public MesIngredientsPage()
    {
        InitializeComponent();

        // DonnÔøΩes de test (comme ta capture)
        _ingredients.Add(new Ingredient { Nom = "Chocolat", Quantite = "1", Unite = "piÔøΩces", EstDisponible = true });
        _ingredients.Add(new Ingredient { Nom = "Nutella", Quantite = "1", Unite = "boÔøΩtes", EstDisponible = true });
        _ingredients.Add(new Ingredient { Nom = "Pain", Quantite = "1", Unite = "kg", EstDisponible = true });
        _ingredients.Add(new Ingredient { Nom = "Poivre", Quantite = "1", Unite = "kg", EstDisponible = true });
        _ingredients.Add(new Ingredient { Nom = "Poulet", Quantite = "1", Unite = "piÔøΩces", EstDisponible = true });
        _ingredients.Add(new Ingredient { Nom = "Sel", Quantite = "10", Unite = "kg", EstDisponible = true });

        IngredientsCollection.ItemsSource = _ingredients;
    }

    private async void OnAddIngredientClicked(object sender, EventArgs e)
    {
        await Shell.Current.GoToAsync(nameof(AjouterIngredientPage));
    }

    private void OnDeleteIngredientClicked(object sender, EventArgs e)
    {
        if (sender is Button btn && btn.BindingContext is Ingredient ingredient)
        {
            _ingredients.Remove(ingredient);
        }
    }

    private void OnIngredientSelected(object sender, SelectionChangedEventArgs e)
    {
        if (e.CurrentSelection.FirstOrDefault() is Ingredient ingredient)
        {
            // Plus tard : voir les recettes liÔøΩes
            DisplayAlert("IngrÔøΩdient", ingredient.Nom, "OK");
            IngredientsCollection.SelectedItem = null;
        }
    }
}

================================================================================
FILE: LoGeCuiMobile\Pages\MesRecettesPage.xaml
================================================================================

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="LoGeCuiMobile.Pages.MesRecettesPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    Title="Mes Recettes">

    <Grid Padding="12" RowDefinitions="Auto,*" RowSpacing="10">

        <!-- Zone haute fixe -->
        <VerticalStackLayout Grid.Row="0" Spacing="10">

            <Picker Title="Cat√©gorie"
                    ItemsSource="{Binding Categories}"
                    SelectedItem="{Binding SelectedCategorie}" />

            <HorizontalStackLayout Spacing="10">
                <Button Text="Rafra√Æchir"
                        Command="{Binding RefreshCommand}"
                        HorizontalOptions="StartAndExpand" />

                <Button Text="Ajouter une recette"
                        Clicked="OnAjouterRecetteClicked"
                        HorizontalOptions="EndAndExpand" />
            </HorizontalStackLayout>

            <ActivityIndicator IsRunning="{Binding IsBusy}"
                               IsVisible="{Binding IsBusy}" />

        </VerticalStackLayout>

        <!-- Liste scrollable -->
        <CollectionView Grid.Row="1"
                        x:Name="RecettesCollection"
                        ItemsSource="{Binding Recettes}"
                        SelectionMode="None">

            <CollectionView.EmptyView>
                <Label Text="Aucune recette pour l'instant."
                       HorizontalTextAlignment="Center"
                       VerticalTextAlignment="Center"
                       Margin="0,30,0,0" />
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Frame Padding="10"
                           Margin="0,6"
                           BorderColor="LightGray"
                           HasShadow="False">

                        <Frame.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnRecetteTapped"
                                                  CommandParameter="{Binding .}" />
                        </Frame.GestureRecognizers>

                        <VerticalStackLayout Spacing="4">
                            <Label Text="{Binding Nom}"
                                   FontSize="18" />

                            <Label Text="{Binding TypeTexte}" />

                            <Label Text="{Binding TempsPreparation, StringFormat='Temps: {0} min'}" />

                            <Label Text="{Binding DifficulteTexte}" />
                        </VerticalStackLayout>

                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>

        </CollectionView>

    </Grid>
</ContentPage>

================================================================================
FILE: LoGeCuiMobile\Pages\MesRecettesPage.xaml.cs
================================================================================

Ôªøusing LoGeCuiMobile.ViewModels;
using LoGeCuiShared.Models;

namespace LoGeCuiMobile.Pages;

public partial class MesRecettesPage : ContentPage
{
    private MesRecettesViewModel? _vm;

    public MesRecettesPage()
    {
        InitializeComponent();

        var app = (App)Application.Current;

        if (app.RecipesService == null)
        {
            MainThread.BeginInvokeOnMainThread(async () =>
                await DisplayAlert(
                    "Erreur",
                    "RecipesService est NULL (InitRestServices n'a pas √©t√© appel√© apr√®s login).",
                    "OK"));

            return;
        }

        _vm = new MesRecettesViewModel(app.RecipesService);
        BindingContext = _vm;
    }

    protected override async void OnAppearing()
    {
        base.OnAppearing();

        if (_vm == null)
            return;

        await _vm.LoadAsync();
    }

    private async void OnAjouterRecetteClicked(object sender, EventArgs e)
    {
        await Navigation.PushAsync(new AjouterRecettePage());
    }

    // ‚úÖ Tap fiable sur une recette
    private async void OnRecetteTapped(object sender, TappedEventArgs e)
    {
        if (e.Parameter is not Recette recette)
            return;

        var app = (App)Application.Current;

        if (app.RecetteIngredientsService == null)
        {
            await DisplayAlert("Erreur", "RecetteIngredientsService non initialis√©.", "OK");
            return;
        }

        // üîé Charge les ingr√©dients depuis la table recette_ingredients
        var items = await app.RecetteIngredientsService.GetForRecetteAsync(recette.Id);

        var ingredientsText = (items.Count == 0)
            ? "(aucun ingr√©dient renseign√©)"
            : string.Join("\n", items.Select(x =>
                string.IsNullOrWhiteSpace(x.quantite) && string.IsNullOrWhiteSpace(x.unite)
                    ? $"‚Ä¢ {x.nom}"
                    : $"‚Ä¢ {x.quantite} {x.unite} {x.nom}".Replace("  ", " ").Trim()
            ));

        await DisplayAlert(
            recette.Nom,
            $"Cat√©gorie: {recette.CategorieDb}\n" +
            $"Temps: {recette.TempsPreparation} min\n\n" +
            $"Ingr√©dients:\n{ingredientsText}\n\n" +
            $"Instructions:\n{recette.Instructions}",
            "OK"
        );
    }
}

================================================================================
FILE: LoGeCuiMobile\Pages\ResetPasswordPage.xaml
================================================================================

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="LoGeCuiMobile.Pages.ResetPasswordPage"
             Title="R√©initialisation">
    <VerticalStackLayout Padding="24" Spacing="12">
        <Label Text="R√©initialiser votre mot de passe"
               FontSize="20"
               FontAttributes="Bold" />

        <Entry x:Name="Pwd1" IsPassword="True" Placeholder="Nouveau mot de passe" />
        <Entry x:Name="Pwd2" IsPassword="True" Placeholder="Confirmer le mot de passe" />

        <Button Text="Valider" Clicked="OnSubmit" />

        <Label x:Name="Msg" />
    </VerticalStackLayout>
</ContentPage>


================================================================================
FILE: LoGeCuiMobile\Pages\ResetPasswordPage.xaml.cs
================================================================================

Ôªøusing System.Collections.ObjectModel;
using LoGeCuiShared.Models;
using LoGeCuiShared.Services;

namespace LoGeCuiMobile.Pages;

public partial class ResetPasswordPage : ContentPage
{
    private readonly string _accessToken;
    private readonly SupabaseService _supabase;

    public ResetPasswordPage(string accessToken)
    {
        InitializeComponent();
        _accessToken = accessToken;

        string url = ConfigurationHelper.GetSupabaseUrl();
        string key = ConfigurationHelper.GetSupabaseKey();
        _supabase = new SupabaseService(url, key);
    }

    private async void OnSubmit(object sender, EventArgs e)
    {
        var p1 = Pwd1.Text ?? "";
        var p2 = Pwd2.Text ?? "";

        if (string.IsNullOrWhiteSpace(p1) || p1.Length < 6)
        {
            Msg.Text = "Le mot de passe doit contenir au moins 6 caract√®res.";
            Msg.TextColor = Colors.Red;
            return;
        }

        if (p1 != p2)
        {
            Msg.Text = "Les mots de passe ne correspondent pas.";
            Msg.TextColor = Colors.Red;
            return;
        }

        Msg.Text = "Mise √† jour en cours...";
        Msg.TextColor = Colors.Blue;

        var (success, error) = await _supabase.UpdatePasswordAsync(_accessToken, p1);

        if (success)
        {
            await DisplayAlert("‚úÖ Termin√©", "Votre mot de passe a √©t√© modifi√©. Vous pouvez vous connecter.", "OK");
            await Navigation.PopToRootAsync();
        }
        else
        {
            Msg.Text = error ?? "Impossible de modifier le mot de passe.";
            Msg.TextColor = Colors.Red;
        }
    }
}

================================================================================
FILE: LoGeCuiMobile\Pages\SettingsPage.xaml
================================================================================

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="LoGeCuiMobile.Pages.SettingsPage"
             Title="Param√®tres">

    <ScrollView>
        <VerticalStackLayout Padding="16" Spacing="16">

            <Label Text="Compte"
                   FontSize="18"
                   FontAttributes="Bold" />

            <Frame Padding="12"
                   CornerRadius="12"
                   BorderColor="#DDDDDD"
                   BackgroundColor="White"
                   HasShadow="True">
                <VerticalStackLayout Spacing="12">

                    <Button Text="D√©connexion"
                            BackgroundColor="#34495E"
                            TextColor="White"
                            FontAttributes="Bold"
                            Clicked="OnLogoutClicked" />

                    <Label Text="Zone dangereuse"
                           FontSize="14"
                           TextColor="Gray"
                           Margin="0,6,0,0" />

                    <Button Text="D√©sinscription"
                            BackgroundColor="IndianRed"
                            TextColor="White"
                            FontAttributes="Bold"
                            Clicked="OnDesinscriptionClicked" />

                </VerticalStackLayout>
            </Frame>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>

================================================================================
FILE: LoGeCuiMobile\Pages\SettingsPage.xaml.cs
================================================================================

Ôªøusing System;
using LoGeCuiShared.Services;
using Microsoft.Maui.Storage;

namespace LoGeCuiMobile.Pages;

public partial class SettingsPage : ContentPage
{
    public SettingsPage()
    {
        InitializeComponent();
    }

    private async void OnDesinscriptionClicked(object sender, EventArgs e)
    {
        bool confirm = await DisplayAlert(
            "D√©sinscription",
            "Es-tu s√ªr de vouloir supprimer ton compte ? Cette action est irr√©versible.",
            "Oui, supprimer",
            "Annuler");

        if (!confirm) return;

        var app = (App)Application.Current;

        if (app.Supabase == null)
        {
            await DisplayAlert("Erreur", "Supabase non initialis√©. Reconnectez-vous.", "OK");
            app.ShowLogin();
            return;
        }

        // 1) Lire la session stock√©e
        var token = await SecureStorage.GetAsync("sb_access_token");
        var userId = await SecureStorage.GetAsync("sb_user_id");

        
        System.Diagnostics.Debug.WriteLine($"TOKEN_START={token?.Substring(0, Math.Min(10, token.Length))}");
        System.Diagnostics.Debug.WriteLine($"TOKEN_LEN={token?.Length ?? 0}");
        System.Diagnostics.Debug.WriteLine($"APP_SUPABASE_URL={ConfigurationHelper.GetSupabaseUrl()}");

        if (string.IsNullOrWhiteSpace(token) || string.IsNullOrWhiteSpace(userId))
        {
            await DisplayAlert("Session", "Session absente/expir√©e. Veuillez vous reconnecter.", "OK");
            app.ShowLogin();
            return;
        }

        // 2) CRUCIAL : r√©injecter la session dans SupabaseService AVANT delete
        app.Supabase.SetSession(token, userId);

        // 3) Appel Edge Function
        var (ok, err) = await app.Supabase.DeleteAccountAsync();

        if (!ok)
        {
            await DisplayAlert("Erreur", $"Suppression impossible : {err}", "OK");

            // Si JWT invalide ‚Üí forcer reconnexion
            if (!string.IsNullOrWhiteSpace(err) &&
                err.Contains("Invalid JWT", StringComparison.OrdinalIgnoreCase))
            {
                app.ShowLogin();
            }

            return;
        }

        // Nettoyage local (bonne pratique apr√®s suppression)
        SecureStorage.Remove("sb_access_token");
        SecureStorage.Remove("sb_user_id");

        await DisplayAlert("OK", "Votre compte a √©t√© supprim√©.", "OK");
        app.ShowLogin();
    }

    private void OnLogoutClicked(object sender, EventArgs e)
    {
        var app = (App)Application.Current;

        app.Supabase?.ClearSession();

        SecureStorage.Remove("sb_access_token");
        SecureStorage.Remove("sb_user_id");

        app.ShowLogin();
    }
}





================================================================================
FILE: LoGeCuiMobile\Platforms\Android\AndroidManifest.xml
================================================================================

Ôªø<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
	<application android:allowBackup="true" android:icon="@mipmap/postriticone" android:supportsRtl="true"></application>
	<uses-permission android:name="android.permission.INTERNET" />
	<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
	<uses-permission android:name="android.permission.CAMERA" />
	<queries>
		<intent>
			<action android:name="android.intent.action.VIEW" />
			<data android:scheme="logecui" />
		</intent>
	</queries>
</manifest>

================================================================================
FILE: LoGeCuiMobile\Platforms\Android\MainActivity.cs
================================================================================

Ôªøusing Android.App;
using Android.Content;
using Android.Content.PM;
using Android.OS;
using Microsoft.Maui.Controls;

namespace LoGeCuiMobile
{
    [Activity(
        Theme = "@style/Maui.SplashTheme",
        MainLauncher = true,
        LaunchMode = LaunchMode.SingleTop,
        ConfigurationChanges = ConfigChanges.ScreenSize | ConfigChanges.Orientation | ConfigChanges.UiMode | ConfigChanges.ScreenLayout | ConfigChanges.SmallestScreenSize | ConfigChanges.Density)]

    // Configuration du Deep Link pour la confirmation email
    [IntentFilter(
        new[] { Intent.ActionView },
        Categories = new[] { Intent.CategoryDefault, Intent.CategoryBrowsable },
        DataScheme = "logecui",
        DataHost = "confirm",
        AutoVerify = true)]

    // Deep Link - reset password
    [IntentFilter(
        new[] { Intent.ActionView },
        Categories = new[] { Intent.CategoryDefault, Intent.CategoryBrowsable },
        DataScheme = "logecui",
        DataHost = "reset-password")]

    public class MainActivity : MauiAppCompatActivity
    {
        protected override void OnCreate(Bundle? savedInstanceState)
        {
            base.OnCreate(savedInstanceState);

            // G√©rer le deep link si l'app est lanc√©e via un lien
            HandleIntent(Intent);
        }

        protected override void OnNewIntent(Intent? intent)
        {
            base.OnNewIntent(intent);

            if (intent != null)
            {
                Intent = intent;
                HandleIntent(intent);
            }
        }

        private void HandleIntent(Intent? intent)
        {
            var data = intent?.DataString;
            if (string.IsNullOrEmpty(data))
                return;

            var uri = new Uri(data);

            MainThread.BeginInvokeOnMainThread(async () =>
            {
                if (Microsoft.Maui.Controls.Application.Current is App app)
                    await app.HandleDeepLinkAsync(uri);
            });
        }
    }
}

================================================================================
FILE: LoGeCuiMobile\Platforms\Android\MainApplication.cs
================================================================================

Ôªøusing Android.App;
using Android.Runtime;

namespace LoGeCuiMobile
{
    [Application]
    public class MainApplication : MauiApplication
    {
        public MainApplication(IntPtr handle, JniHandleOwnership ownership)
            : base(handle, ownership)
        {
        }

        protected override MauiApp CreateMauiApp() => MauiProgram.CreateMauiApp();
    }
}

================================================================================
FILE: LoGeCuiMobile\Platforms\Android\Resources\values\colors.xml
================================================================================

<?xml version="1.0" encoding="utf-8"?>
<resources>
    <color name="colorPrimary">#512BD4</color>
    <color name="colorPrimaryDark">#2B0B98</color>
    <color name="colorAccent">#2B0B98</color>
</resources>

================================================================================
FILE: LoGeCuiMobile\Platforms\iOS\AppDelegate.cs
================================================================================

Ôªøusing Foundation;

namespace LoGeCuiMobile
{
    [Register("AppDelegate")]
    public class AppDelegate : MauiUIApplicationDelegate
    {
        protected override MauiApp CreateMauiApp() => MauiProgram.CreateMauiApp();
    }
}

================================================================================
FILE: LoGeCuiMobile\Platforms\iOS\Program.cs
================================================================================

Ôªøusing ObjCRuntime;
using UIKit;

namespace LoGeCuiMobile
{
    public class Program
    {
        // This is the main entry point of the application.
        static void Main(string[] args)
        {
            // if you want to use a different Application Delegate class from "AppDelegate"
            // you can specify it here.
            UIApplication.Main(args, null, typeof(AppDelegate));
        }
    }
}

================================================================================
FILE: LoGeCuiMobile\Platforms\MacCatalyst\AppDelegate.cs
================================================================================

Ôªøusing Foundation;

namespace LoGeCuiMobile
{
    [Register("AppDelegate")]
    public class AppDelegate : MauiUIApplicationDelegate
    {
        protected override MauiApp CreateMauiApp() => MauiProgram.CreateMauiApp();
    }
}

================================================================================
FILE: LoGeCuiMobile\Platforms\MacCatalyst\Program.cs
================================================================================

Ôªøusing ObjCRuntime;
using UIKit;

namespace LoGeCuiMobile
{
    public class Program
    {
        // This is the main entry point of the application.
        static void Main(string[] args)
        {
            // if you want to use a different Application Delegate class from "AppDelegate"
            // you can specify it here.
            UIApplication.Main(args, null, typeof(AppDelegate));
        }
    }
}

================================================================================
FILE: LoGeCuiMobile\Platforms\Windows\App.xaml
================================================================================

Ôªø<maui:MauiWinUIApplication
    x:Class="LoGeCuiMobile.WinUI.App"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:maui="using:Microsoft.Maui"
    xmlns:local="using:LoGeCuiMobile.WinUI">

</maui:MauiWinUIApplication>

================================================================================
FILE: LoGeCuiMobile\Platforms\Windows\App.xaml.cs
================================================================================

Ôªøusing Microsoft.UI.Xaml;

// To learn more about WinUI, the WinUI project structure,
// and more about our project templates, see: http://aka.ms/winui-project-info.

namespace LoGeCuiMobile.WinUI
{
    /// <summary>
    /// Provides application-specific behavior to supplement the default Application class.
    /// </summary>
    public partial class App : MauiWinUIApplication
    {
        /// <summary>
        /// Initializes the singleton application object.  This is the first line of authored code
        /// executed, and as such is the logical equivalent of main() or WinMain().
        /// </summary>
        public App()
        {
            this.InitializeComponent();
        }

        protected override MauiApp CreateMauiApp() => MauiProgram.CreateMauiApp();
    }

}

================================================================================
FILE: LoGeCuiMobile\Properties\launchSettings.json
================================================================================

{
  "profiles": {
    "Windows Machine": {
      "commandName": "Project",
      "nativeDebugging": false
    }
  }
}

================================================================================
FILE: LoGeCuiMobile\Resources\Raw\AboutAssets.txt
================================================================================

ÔªøAny raw assets you want to be deployed with your application can be placed in
this directory (and child directories). Deployment of the asset to your application
is automatically handled by the following `MauiAsset` Build Action within your `.csproj`.

	<MauiAsset Include="Resources\Raw\**" LogicalName="%(RecursiveDir)%(Filename)%(Extension)" />

These files will be deployed with your package and will be accessible using Essentials:

	async Task LoadMauiAsset()
	{
		using var stream = await FileSystem.OpenAppPackageFileAsync("AboutAssets.txt");
		using var reader = new StreamReader(stream);

		var contents = reader.ReadToEnd();
	}

================================================================================
FILE: LoGeCuiMobile\Resources\Styles\Colors.xaml
================================================================================

Ôªø<?xml version="1.0" encoding="UTF-8" ?>
<ResourceDictionary 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml">

    <!-- Note: For Android please see also Platforms\Android\Resources\values\colors.xml -->

    <Color x:Key="Primary">#512BD4</Color>
    <Color x:Key="PrimaryDark">#ac99ea</Color>
    <Color x:Key="PrimaryDarkText">#242424</Color>
    <Color x:Key="Secondary">#DFD8F7</Color>
    <Color x:Key="SecondaryDarkText">#9880e5</Color>
    <Color x:Key="Tertiary">#2B0B98</Color>

    <Color x:Key="White">White</Color>
    <Color x:Key="Black">Black</Color>
    <Color x:Key="Magenta">#D600AA</Color>
    <Color x:Key="MidnightBlue">#190649</Color>
    <Color x:Key="OffBlack">#1f1f1f</Color>

    <Color x:Key="Gray100">#E1E1E1</Color>
    <Color x:Key="Gray200">#C8C8C8</Color>
    <Color x:Key="Gray300">#ACACAC</Color>
    <Color x:Key="Gray400">#919191</Color>
    <Color x:Key="Gray500">#6E6E6E</Color>
    <Color x:Key="Gray600">#404040</Color>
    <Color x:Key="Gray900">#212121</Color>
    <Color x:Key="Gray950">#141414</Color>

    <SolidColorBrush x:Key="PrimaryBrush" Color="{StaticResource Primary}"/>
    <SolidColorBrush x:Key="SecondaryBrush" Color="{StaticResource Secondary}"/>
    <SolidColorBrush x:Key="TertiaryBrush" Color="{StaticResource Tertiary}"/>
    <SolidColorBrush x:Key="WhiteBrush" Color="{StaticResource White}"/>
    <SolidColorBrush x:Key="BlackBrush" Color="{StaticResource Black}"/>

    <SolidColorBrush x:Key="Gray100Brush" Color="{StaticResource Gray100}"/>
    <SolidColorBrush x:Key="Gray200Brush" Color="{StaticResource Gray200}"/>
    <SolidColorBrush x:Key="Gray300Brush" Color="{StaticResource Gray300}"/>
    <SolidColorBrush x:Key="Gray400Brush" Color="{StaticResource Gray400}"/>
    <SolidColorBrush x:Key="Gray500Brush" Color="{StaticResource Gray500}"/>
    <SolidColorBrush x:Key="Gray600Brush" Color="{StaticResource Gray600}"/>
    <SolidColorBrush x:Key="Gray900Brush" Color="{StaticResource Gray900}"/>
    <SolidColorBrush x:Key="Gray950Brush" Color="{StaticResource Gray950}"/>
</ResourceDictionary>

================================================================================
FILE: LoGeCuiMobile\Resources\Styles\Styles.xaml
================================================================================

Ôªø<?xml version="1.0" encoding="UTF-8" ?>
<ResourceDictionary 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml">

    <Style TargetType="ActivityIndicator">
        <Setter Property="Color" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource White}}" />
    </Style>

    <Style TargetType="IndicatorView">
        <Setter Property="IndicatorColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray500}}"/>
        <Setter Property="SelectedIndicatorColor" Value="{AppThemeBinding Light={StaticResource Gray950}, Dark={StaticResource Gray100}}"/>
    </Style>

    <Style TargetType="Border">
        <Setter Property="Stroke" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray500}}" />
        <Setter Property="StrokeShape" Value="Rectangle"/>
        <Setter Property="StrokeThickness" Value="1"/>
    </Style>

    <Style TargetType="BoxView">
        <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource Gray950}, Dark={StaticResource Gray200}}" />
    </Style>

    <Style TargetType="Button">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource PrimaryDarkText}}" />
        <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
        <Setter Property="FontFamily" Value="OpenSansRegular"/>
        <Setter Property="FontSize" Value="14"/>
        <Setter Property="BorderWidth" Value="0"/>
        <Setter Property="CornerRadius" Value="8"/>
        <Setter Property="Padding" Value="14,10"/>
        <Setter Property="MinimumHeightRequest" Value="44"/>
        <Setter Property="MinimumWidthRequest" Value="44"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray950}, Dark={StaticResource Gray200}}" />
                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                    <VisualState x:Name="PointerOver" />
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="CheckBox">
        <Setter Property="Color" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource White}}" />
        <Setter Property="MinimumHeightRequest" Value="44"/>
        <Setter Property="MinimumWidthRequest" Value="44"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="Color" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="DatePicker">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
        <Setter Property="BackgroundColor" Value="Transparent" />
        <Setter Property="FontFamily" Value="OpenSansRegular"/>
        <Setter Property="FontSize" Value="14"/>
        <Setter Property="MinimumHeightRequest" Value="44"/>
        <Setter Property="MinimumWidthRequest" Value="44"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray500}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="Editor">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}" />
        <Setter Property="BackgroundColor" Value="Transparent" />
        <Setter Property="FontFamily" Value="OpenSansRegular"/>
        <Setter Property="FontSize" Value="14" />
        <Setter Property="PlaceholderColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray500}}" />
        <Setter Property="MinimumHeightRequest" Value="44"/>
        <Setter Property="MinimumWidthRequest" Value="44"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="Entry">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}" />
        <Setter Property="BackgroundColor" Value="Transparent" />
        <Setter Property="FontFamily" Value="OpenSansRegular"/>
        <Setter Property="FontSize" Value="14" />
        <Setter Property="PlaceholderColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray500}}" />
        <Setter Property="MinimumHeightRequest" Value="44"/>
        <Setter Property="MinimumWidthRequest" Value="44"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="ImageButton">
        <Setter Property="Opacity" Value="1" />
        <Setter Property="BorderColor" Value="Transparent"/>
        <Setter Property="BorderWidth" Value="0"/>
        <Setter Property="CornerRadius" Value="0"/>
        <Setter Property="MinimumHeightRequest" Value="44"/>
        <Setter Property="MinimumWidthRequest" Value="44"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="Opacity" Value="0.5" />
                        </VisualState.Setters>
                    </VisualState>
                    <VisualState x:Name="PointerOver" />
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="Label">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}" />
        <Setter Property="BackgroundColor" Value="Transparent" />
        <Setter Property="FontFamily" Value="OpenSansRegular" />
        <Setter Property="FontSize" Value="14" />
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="Label" x:Key="Headline">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource MidnightBlue}, Dark={StaticResource White}}" />
        <Setter Property="FontSize" Value="32" />
        <Setter Property="HorizontalOptions" Value="Center" />
        <Setter Property="HorizontalTextAlignment" Value="Center" />
    </Style>

    <Style TargetType="Label" x:Key="SubHeadline">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource MidnightBlue}, Dark={StaticResource White}}" />
        <Setter Property="FontSize" Value="24" />
        <Setter Property="HorizontalOptions" Value="Center" />
        <Setter Property="HorizontalTextAlignment" Value="Center" />
    </Style>

    <Style TargetType="Picker">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
        <Setter Property="TitleColor" Value="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray200}}" />
        <Setter Property="BackgroundColor" Value="Transparent" />
        <Setter Property="FontFamily" Value="OpenSansRegular"/>
        <Setter Property="FontSize" Value="14" />
        <Setter Property="MinimumHeightRequest" Value="44"/>
        <Setter Property="MinimumWidthRequest" Value="44"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                            <Setter Property="TitleColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="ProgressBar">
        <Setter Property="ProgressColor" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource White}}" />
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="ProgressColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="RadioButton">
        <Setter Property="BackgroundColor" Value="Transparent"/>
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}" />
        <Setter Property="FontFamily" Value="OpenSansRegular"/>
        <Setter Property="FontSize" Value="14"/>
        <Setter Property="MinimumHeightRequest" Value="44"/>
        <Setter Property="MinimumWidthRequest" Value="44"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="RefreshView">
        <Setter Property="RefreshColor" Value="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray200}}" />
    </Style>

    <Style TargetType="SearchBar">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
        <Setter Property="PlaceholderColor" Value="{StaticResource Gray500}" />
        <Setter Property="CancelButtonColor" Value="{StaticResource Gray500}" />
        <Setter Property="BackgroundColor" Value="Transparent" />
        <Setter Property="FontFamily" Value="OpenSansRegular" />
        <Setter Property="FontSize" Value="14" />
        <Setter Property="MinimumHeightRequest" Value="44"/>
        <Setter Property="MinimumWidthRequest" Value="44"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                            <Setter Property="PlaceholderColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="SearchHandler">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
        <Setter Property="PlaceholderColor" Value="{StaticResource Gray500}" />
        <Setter Property="BackgroundColor" Value="Transparent" />
        <Setter Property="FontFamily" Value="OpenSansRegular" />
        <Setter Property="FontSize" Value="14" />
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                            <Setter Property="PlaceholderColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="Shadow">
        <Setter Property="Radius" Value="15" />
        <Setter Property="Opacity" Value="0.5" />
        <Setter Property="Brush" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}" />
        <Setter Property="Offset" Value="10,10" />
    </Style>

    <Style TargetType="Slider">
        <Setter Property="MinimumTrackColor" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource White}}" />
        <Setter Property="MaximumTrackColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}" />
        <Setter Property="ThumbColor" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource White}}" />
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="MinimumTrackColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"/>
                            <Setter Property="MaximumTrackColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"/>
                            <Setter Property="ThumbColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"/>
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="SwipeItem">
        <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Black}}" />
    </Style>

    <Style TargetType="Switch">
        <Setter Property="OnColor" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource White}}" />
        <Setter Property="ThumbColor" Value="{StaticResource White}" />
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="OnColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                            <Setter Property="ThumbColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                    <VisualState x:Name="On">
                        <VisualState.Setters>
                            <Setter Property="OnColor" Value="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource Gray200}}" />
                            <Setter Property="ThumbColor" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource White}}" />
                        </VisualState.Setters>
                    </VisualState>
                    <VisualState x:Name="Off">
                        <VisualState.Setters>
                            <Setter Property="ThumbColor" Value="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>

    <Style TargetType="TimePicker">
        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
        <Setter Property="BackgroundColor" Value="Transparent"/>
        <Setter Property="FontFamily" Value="OpenSansRegular"/>
        <Setter Property="FontSize" Value="14"/>
        <Setter Property="MinimumHeightRequest" Value="44"/>
        <Setter Property="MinimumWidthRequest" Value="44"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="CommonStates">
                    <VisualState x:Name="Normal" />
                    <VisualState x:Name="Disabled">
                        <VisualState.Setters>
                            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>
  
    <!--
    <Style TargetType="TitleBar">
        <Setter Property="MinimumHeightRequest" Value="32"/>
        <Setter Property="VisualStateManager.VisualStateGroups">
            <VisualStateGroupList>
                <VisualStateGroup x:Name="TitleActiveStates">
                    <VisualState x:Name="TitleBarTitleActive">
                        <VisualState.Setters>
                            <Setter Property="BackgroundColor" Value="Transparent" />
                            <Setter Property="ForegroundColor" Value="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}" />
                        </VisualState.Setters>
                    </VisualState>
                    <VisualState x:Name="TitleBarTitleInactive">
                        <VisualState.Setters>
                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Black}}" />
                            <Setter Property="ForegroundColor" Value="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateGroupList>
        </Setter>
    </Style>
    -->

    <Style TargetType="Page" ApplyToDerivedTypes="True">
        <Setter Property="Padding" Value="0"/>
        <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource OffBlack}}" />
    </Style>

    <Style TargetType="Shell" ApplyToDerivedTypes="True">
        <Setter Property="Shell.BackgroundColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource OffBlack}}" />
        <Setter Property="Shell.ForegroundColor" Value="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource SecondaryDarkText}}" />
        <Setter Property="Shell.TitleColor" Value="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource SecondaryDarkText}}" />
        <Setter Property="Shell.DisabledColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray950}}" />
        <Setter Property="Shell.UnselectedColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray200}}" />
        <Setter Property="Shell.NavBarHasShadow" Value="False" />
        <Setter Property="Shell.TabBarBackgroundColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Black}}" />
        <Setter Property="Shell.TabBarForegroundColor" Value="{AppThemeBinding Light={StaticResource Magenta}, Dark={StaticResource White}}" />
        <Setter Property="Shell.TabBarTitleColor" Value="{AppThemeBinding Light={StaticResource Magenta}, Dark={StaticResource White}}" />
        <Setter Property="Shell.TabBarUnselectedColor" Value="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray200}}" />
    </Style>

    <Style TargetType="NavigationPage">
        <Setter Property="BarBackgroundColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource OffBlack}}" />
        <Setter Property="BarTextColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource White}}" />
        <Setter Property="IconColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource White}}" />
    </Style>

    <Style TargetType="TabbedPage">
        <Setter Property="BarBackgroundColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray950}}" />
        <Setter Property="BarTextColor" Value="{AppThemeBinding Light={StaticResource Magenta}, Dark={StaticResource White}}" />
        <Setter Property="UnselectedTabColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray950}}" />
        <Setter Property="SelectedTabColor" Value="{AppThemeBinding Light={StaticResource Gray950}, Dark={StaticResource Gray200}}" />
    </Style>

</ResourceDictionary>

================================================================================
FILE: LoGeCuiMobile\RootPage.cs
================================================================================

namespace LoGeCuiMobile;

public static class RootPage
{
    public static Page CreateLoginRoot()
        => new NavigationPage(new Pages.LoginPage());

    public static Page CreateAppShellRoot()
        => new AppShell();
}

================================================================================
FILE: LoGeCuiMobile\Services\OcrService.cs
================================================================================

Ôªøusing System.Net.Http.Headers;
using System.Text.Json;

namespace LoGeCuiMobile.Services
{
    public sealed class OcrService
    {
        private readonly HttpClient _http;
        private readonly string _apiKey;

        public OcrService(string apiKey)
        {
            _apiKey = apiKey ?? throw new ArgumentNullException(nameof(apiKey));
            _http = new HttpClient { Timeout = TimeSpan.FromSeconds(60) };
        }

        public async Task<string> ExtractTextFromImageAsync(byte[] imageBytes, string fileName = "scan.jpg")
        {
            if (imageBytes is null || imageBytes.Length == 0)
                throw new ArgumentException("Image vide.", nameof(imageBytes));

            if (string.IsNullOrWhiteSpace(_apiKey))
                throw new InvalidOperationException("Cl√© OCR manquante (apiKey).");

            var url = "https://api.ocr.space/parse/image";

            using var content = new MultipartFormDataContent();

            // Param√®tres utiles
            content.Add(new StringContent("fre"), "language");          // fre = fran√ßais
            content.Add(new StringContent("false"), "isOverlayRequired");
            content.Add(new StringContent("2"), "OCREngine");           // 1 ou 2 (2 souvent meilleur)
            content.Add(new StringContent("true"), "scale");
            content.Add(new StringContent("true"), "detectOrientation");

            var fileContent = new ByteArrayContent(imageBytes);
            fileContent.Headers.ContentType = MediaTypeHeaderValue.Parse("image/jpeg");
            content.Add(fileContent, "file", fileName);

            using var request = new HttpRequestMessage(HttpMethod.Post, url);
            request.Headers.Add("apikey", _apiKey); // ‚úÖ endroit le plus fiable
            request.Content = content;

            using var resp = await _http.SendAsync(request);
            var json = await resp.Content.ReadAsStringAsync();

            if (!resp.IsSuccessStatusCode)
                throw new Exception($"OCR HTTP {(int)resp.StatusCode}: {json}");

            using var doc = JsonDocument.Parse(json);

            // Si l‚ÄôAPI retourne une erreur applicative
            if (doc.RootElement.TryGetProperty("IsErroredOnProcessing", out var errored)
                && errored.ValueKind == JsonValueKind.True)
            {
                string msg = "Erreur OCR.";
                if (doc.RootElement.TryGetProperty("ErrorMessage", out var em))
                {
                    // ErrorMessage peut √™tre string ou tableau selon les cas
                    msg = em.ValueKind switch
                    {
                        JsonValueKind.Array => string.Join(" | ", em.EnumerateArray().Select(x => x.ToString())),
                        _ => em.ToString()
                    };
                }
                throw new Exception(msg);
            }

            if (!doc.RootElement.TryGetProperty("ParsedResults", out var parsedResults)
                || parsedResults.ValueKind != JsonValueKind.Array
                || parsedResults.GetArrayLength() == 0)
            {
                return "";
            }

            var first = parsedResults[0];
            if (!first.TryGetProperty("ParsedText", out var parsedTextEl))
                return "";

            return parsedTextEl.GetString() ?? "";
        }
    }
}



================================================================================
FILE: LoGeCuiMobile\Services\Skiasharp.cs
================================================================================

Ôªøusing SkiaSharp;

namespace LoGeCuiMobile.Services
{
    public static class ImageCompressionHelper
    {
        public static byte[] CompressJpeg(
            byte[] input,
            int maxWidth = 1600,
            int jpegQuality = 75)
        {
            using var inputStream = new SKMemoryStream(input);
            using var codec = SKCodec.Create(inputStream);
            using var bitmap = SKBitmap.Decode(codec);

            if (bitmap == null)
                throw new InvalidOperationException("Impossible de d√©coder l'image.");

            var width = bitmap.Width;
            var height = bitmap.Height;

            if (width > maxWidth)
            {
                var ratio = (float)maxWidth / width;
                var newW = maxWidth;
                var newH = (int)(height * ratio);

                using var resized = bitmap.Resize(
                    new SKImageInfo(newW, newH),
                    SKFilterQuality.Medium);

                using var image = SKImage.FromBitmap(resized);
                using var data = image.Encode(
                    SKEncodedImageFormat.Jpeg,
                    jpegQuality);

                return data.ToArray();
            }
            else
            {
                using var image = SKImage.FromBitmap(bitmap);
                using var data = image.Encode(
                    SKEncodedImageFormat.Jpeg,
                    jpegQuality);

                return data.ToArray();
            }
        }
    }
}


================================================================================
FILE: LoGeCuiMobile\Services\SupabaseConfig.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using LoGeCuiShared.Services;

namespace LoGeCuiMobile.Services
{
    public static class SupabaseConfig
    {
        public static string Url { get; } = ConfigurationHelper.GetSupabaseUrl();
        public static string Key { get; } = ConfigurationHelper.GetSupabaseKey();
    }
}

================================================================================
FILE: LoGeCuiMobile\ViewModels\ArticleCourseUi.cs
================================================================================

Ôªøusing System.ComponentModel;
using System.Runtime.CompilerServices;
using LoGeCuiShared.Models;

namespace LoGeCuiMobile.Models
{
    // Wrapper UI: on conserve ArticleCourse et on ajoute une s√©lection locale (non persist√©e)
    public class ArticleCourseUi : INotifyPropertyChanged
    {
        public ArticleCourseUi(ArticleCourse model) => Model = model;

        public ArticleCourse Model { get; }

        public int Id => Model.Id;

        public string Nom
        {
            get => Model.Nom;
            set { if (Model.Nom != value) { Model.Nom = value; OnPropertyChanged(); } }
        }

        public string Quantite
        {
            get => Model.Quantite;
            set { if (Model.Quantite != value) { Model.Quantite = value; OnPropertyChanged(); } }
        }

        public string Unite
        {
            get => Model.Unite;
            set { if (Model.Unite != value) { Model.Unite = value; OnPropertyChanged(); } }
        }

        public bool EstAchete
        {
            get => Model.EstAchete;
            set { if (Model.EstAchete != value) { Model.EstAchete = value; OnPropertyChanged(); } }
        }

        private bool _isSelectedForDelete;
        public bool IsSelectedForDelete
        {
            get => _isSelectedForDelete;
            set { if (_isSelectedForDelete != value) { _isSelectedForDelete = value; OnPropertyChanged(); } }
        }

        public event PropertyChangedEventHandler? PropertyChanged;
        private void OnPropertyChanged([CallerMemberName] string? name = null)
            => PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(name));
    }
}


================================================================================
FILE: LoGeCuiMobile\ViewModels\MesRecettesViewModel.cs
================================================================================

Ôªøusing System.Collections.ObjectModel;
using System.Windows.Input;
using LoGeCuiShared.Models;
using LoGeCuiShared.Services;

namespace LoGeCuiMobile.ViewModels
{
    public sealed class MesRecettesViewModel : BindableObject
    {
        private readonly RecipesService _recipesService;

        public ObservableCollection<Recette> Recettes { get; } = new();

        private bool _isBusy;
        public bool IsBusy
        {
            get => _isBusy;
            set { _isBusy = value; OnPropertyChanged(); }
        }

        private string _selectedCategorie = "Toutes";
        public string SelectedCategorie
        {
            get => _selectedCategorie;
            set
            {
                if (_selectedCategorie == value) return;
                _selectedCategorie = value;
                OnPropertyChanged();
                _ = LoadAsync(); // recharge quand le filtre change
            }
        }

        public IReadOnlyList<string> Categories { get; } = new[] { "Toutes", "Entree", "Plat", "Dessert" };

        public ICommand RefreshCommand { get; }

        public MesRecettesViewModel(RecipesService recipesService)
        {
            _recipesService = recipesService;
            RefreshCommand = new Command(async () => await LoadAsync());
        }

        public async Task LoadAsync()
        {
            if (IsBusy) return;

            try
            {
                IsBusy = true;
                Recettes.Clear();

                var cat = SelectedCategorie == "Toutes" ? null : SelectedCategorie;

                List<Recette> list;
                try
                {
                    list = await _recipesService.GetMyRecettesAsync(cat);
                }
                catch (Exception ex)
                {
                    await MainThread.InvokeOnMainThreadAsync(() =>
                        Application.Current.MainPage.DisplayAlert("Erreur API", ex.Message, "OK"));
                    return;
                }

                foreach (var r in list)
                    Recettes.Add(r);
            }
            finally
            {
                IsBusy = false;
            }
        }
    
    }
}


================================================================================
FILE: LoGeCuiShared\LoGeCuiShared.csproj
================================================================================

Ôªø<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net10.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Supabase" Version="1.1.1" />
    <PackageReference Include="Supabase.Core" Version="1.0.0" />
    <PackageReference Include="Supabase.Postgrest" Version="4.1.0" />
  </ItemGroup>

</Project>

================================================================================
FILE: LoGeCuiShared\Models\ArticleCourse.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;
using System.Text.Json.Serialization;
using System.ComponentModel;
using System.Runtime.CompilerServices;

namespace LoGeCuiShared.Models
{
    public class ArticleCourse : INotifyPropertyChanged
    {
        public event PropertyChangedEventHandler? PropertyChanged;

        private int _id;
        private Guid _userId;
        private string _nom = "";
        private string _quantite = "";
        private string _unite = "";
        private bool _estAchete;

        [JsonPropertyName("id")]
        public int Id
        {
            get => _id;
            set { _id = value; OnPropertyChanged(); }
        }

        [JsonPropertyName("user_id")]
        public Guid UserId
        {
            get => _userId;
            set { _userId = value; OnPropertyChanged(); }
        }

        [JsonPropertyName("nom")]
        public string Nom
        {
            get => _nom;
            set { _nom = value; OnPropertyChanged(); }
        }

        [JsonPropertyName("quantite")]
        public string Quantite
        {
            get => _quantite;
            set { _quantite = value; OnPropertyChanged(); }
        }

        [JsonPropertyName("unite")]
        public string Unite
        {
            get => _unite;
            set { _unite = value; OnPropertyChanged(); }
        }

        [JsonPropertyName("est_achete")]
        public bool EstAchete
        {
            get => _estAchete;
            set { _estAchete = value; OnPropertyChanged(); }
        }

        private void OnPropertyChanged([CallerMemberName] string? name = null)
            => PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(name));
    }
}

================================================================================
FILE: LoGeCuiShared\Models\Ingredient.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;

namespace LoGeCuiShared.Models
{
    public class Ingredient
    {
        public Guid Id { get; set; }          // id (uuid) dans Supabase
        public Guid? UserId { get; set; }     // user_id (uuid) dans Supabase
        public string Nom { get; set; }
        public string Quantite { get; set; }
        public string Unite { get; set; }
        public bool EstDisponible { get; set; }

        public Ingredient()
        {
            Nom = "";
            Quantite = "";
            Unite = "";
            EstDisponible = true;
        }
    }
}

================================================================================
FILE: LoGeCuiShared\Models\IngredientRecette.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;

namespace LoGeCuiShared.Models
{
    public class IngredientRecette
    {
        public string Nom { get; set; }
        public string Quantite { get; set; }
        public string Unite { get; set; }

        public IngredientRecette()
        {
            Nom = "";
            Quantite = "";
            Unite = "";
        }

        public override string ToString()
        {
            return $"{Nom} - {Quantite} {Unite}";
        }
    }
}

================================================================================
FILE: LoGeCuiShared\Models\MenuJournalier.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;

namespace LoGeCuiShared.Models
{
    public class MenuJournalier
    {
        public DateTime Date { get; set; }
        public Recette? Entree { get; set; }
        public Recette? Plat { get; set; }
        public Recette? Dessert { get; set; }
        public List<IngredientRecette> IngredientsManquants { get; set; }

        public MenuJournalier()
        {
            Date = DateTime.Now;
            IngredientsManquants = new List<IngredientRecette>();
        }
    }
}

================================================================================
FILE: LoGeCuiShared\Models\Recette.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text.Json.Serialization;

namespace LoGeCuiShared.Models
{
    public enum TypePlat
    {
        Entree,
        Plat,
        Dessert
    }

    public class Recette
    {
        // ----------------------------
        // Champs DB / JSON (Supabase)
        // ----------------------------

        [JsonPropertyName("id")]
        public Guid Id { get; set; }

        [JsonPropertyName("created_at")]
        public DateTimeOffset CreatedAt { get; set; }

        [JsonPropertyName("owner_user_id")]
        public Guid? OwnerUserId { get; set; }   // <-- nullable

        [JsonPropertyName("external_id")]
        public string? ExternalId { get; set; }

        [JsonPropertyName("nom")]
        public string Nom { get; set; } = "";

        [JsonPropertyName("categorie")]
        public string CategorieDb
        {
            get => Type switch
            {
                TypePlat.Entree => "Entree",
                TypePlat.Plat => "Plat",
                TypePlat.Dessert => "Dessert",
                _ => "Plat"
            };
            set
            {
                Type = value switch
                {
                    "Entree" => TypePlat.Entree,
                    "Plat" => TypePlat.Plat,
                    "Dessert" => TypePlat.Dessert,
                    _ => TypePlat.Plat
                };
            }
        }

        [JsonPropertyName("temps_minutes")]
        public int TempsMinutesDb
        {
            get => TempsPreparation;
            set => TempsPreparation = value;
        }

        [JsonPropertyName("note")]
        public int? NoteDb
        {
            get => Difficulte;
            set => Difficulte = Math.Clamp(value ?? 1, 1, 5);
        }

        [JsonPropertyName("is_favorite")]
        public bool IsFavorite { get; set; }

        [JsonPropertyName("instructions")]
        public string InstructionsDb
        {
            get => Instructions;
            set => Instructions = value ?? "";
        }

        // ----------------------------
        // Propri√©t√©s m√©tier
        // ----------------------------

        [JsonIgnore]
        public TypePlat Type { get; set; } = TypePlat.Plat;

        [JsonIgnore]
        public int TempsPreparation { get; set; } = 0;

        [JsonIgnore]
        public int Difficulte { get; set; } = 1;

        [JsonIgnore]
        public List<IngredientRecette> Ingredients { get; set; } = new();

        [JsonIgnore]
        public string Instructions { get; set; } = "";
    

    [JsonIgnore]
        public string TypeTexte => Type switch
        {
            TypePlat.Entree => "Entr√©e",
            TypePlat.Plat => "Plat",
            TypePlat.Dessert => "Dessert",
            _ => "Inconnu"
        };

        [JsonIgnore]
        public string DifficulteTexte => new string('‚≠ê', Math.Clamp(Difficulte, 1, 5));
    }
}




================================================================================
FILE: LoGeCuiShared\Services\ConfigurationHelper.cs
================================================================================

Ôªøusing System;

namespace LoGeCuiShared.Services
{
    public static class ConfigurationHelper
    {
        private static Func<string, string?>? _get;

        // Appel√© 1 fois au d√©marrage par le projet MAUI
        public static void Configure(Func<string, string?> getValue)
        {
            _get = getValue ?? throw new ArgumentNullException(nameof(getValue));
        }

        private static string Get(string key)
        {
            if (_get == null)
                throw new InvalidOperationException("ConfigurationHelper n'est pas configur√©. Appelez ConfigurationHelper.Configure(...) au d√©marrage.");

            return _get(key) ?? throw new InvalidOperationException($"Cl√© manquante : {key}");
        }

        // Versions s√ªres qui renvoient null si la cl√© est absente (pour permettre un d√©marrage sans crash)
        public static string? GetSupabaseUrlSafe() => _get?.Invoke("Supabase:Url");
        public static string? GetSupabaseKeySafe() => _get?.Invoke("Supabase:AnonKey");
        public static string? GetOcrApiKeySafe() => _get?.Invoke("OCR:ApiKey");

        // Les anciennes m√©thodes conservent le comportement strict (throw) ‚Äî vous pouvez les remplacer par les versions Safe si n√©cessaire.
        public static string GetSupabaseUrl() => Get("Supabase:Url");
        public static string GetSupabaseKey() => Get("Supabase:AnonKey");
        public static string GetOcrApiKey() => Get("OCR:ApiKey");
    }
}



================================================================================
FILE: LoGeCuiShared\Services\IngredientsService.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Threading.Tasks;
using LoGeCuiShared.Models;
using Supabase;

namespace LoGeCuiShared.Services
{
    public sealed class IngredientsService
    {
        private readonly SupabaseRestClient _client;
        private const string Table = "ingredients";

        public IngredientsService(SupabaseRestClient client)
        {
            _client = client ?? throw new ArgumentNullException(nameof(client));
        }

        public async Task<List<Ingredient>> GetIngredientsAsync(Guid userId)
        {
            var q =
                $"{Table}?" +
                "select=id,user_id,nom,quantite,unite,est_disponible,created_at" +
                $"&user_id=eq.{userId}" +
                "&order=created_at.desc";

            return await _client.GetAsync<List<Ingredient>>(q) ?? new List<Ingredient>();
        }

        public async Task<Ingredient?> CreateIngredientAsync(Guid userId, Ingredient i)
        {
            if (i == null) throw new ArgumentNullException(nameof(i));
            if (string.IsNullOrWhiteSpace(i.Nom)) throw new ArgumentException("Nom requis.", nameof(i));

            var payload = new
            {
                user_id = userId,
                nom = i.Nom,
                quantite = string.IsNullOrWhiteSpace(i.Quantite) ? null : i.Quantite,
                unite = string.IsNullOrWhiteSpace(i.Unite) ? null : i.Unite,
                est_disponible = i.EstDisponible
            };

            var created = await _client.PostAsync<List<Ingredient>>(
                $"{Table}?select=id,user_id,nom,quantite,unite,est_disponible,created_at",
                payload,
                returnRepresentation: true);

            return created?.Count > 0 ? created[0] : null;
        }

        public async Task UpdateDisponibiliteAsync(Guid ingredientId, bool estDisponible)
        {
            var payload = new { est_disponible = estDisponible };
            await _client.PatchAsync($"{Table}?id=eq.{ingredientId}", payload);
        }

        public async Task DeleteIngredientAsync(Guid ingredientId)
        {
            await _client.DeleteAsync($"{Table}?id=eq.{ingredientId}");
        }
    }
}



================================================================================
FILE: LoGeCuiShared\Services\ListeCoursesService.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Text;
using System.IO;
using System.Text.Json;
using LoGeCuiShared.Models;

namespace LoGeCuiShared.Services
{
    public class ListeCoursesService
    {
        private readonly string _cheminFichier;

        public ListeCoursesService(string cheminFichier)
        {
            _cheminFichier = cheminFichier;
        }

        public List<ArticleCourse> ChargerListeCourses()
        {
            try
            {
                if (!File.Exists(_cheminFichier))
                {
                    return new List<ArticleCourse>();
                }

                string json = File.ReadAllText(_cheminFichier);
                var liste = JsonSerializer.Deserialize<List<ArticleCourse>>(json);
                return liste ?? new List<ArticleCourse>();
            }
            catch (Exception)
            {
                return new List<ArticleCourse>();
            }
        }

        public void SauvegarderListeCourses(List<ArticleCourse> articles)
        {
            try
            {
                var options = new JsonSerializerOptions { WriteIndented = true };
                string json = JsonSerializer.Serialize(articles, options);

                // Cr√©er le dossier si n√©cessaire
                var dossier = Path.GetDirectoryName(_cheminFichier);
                if (!string.IsNullOrEmpty(dossier) && !Directory.Exists(dossier))
                {
                    Directory.CreateDirectory(dossier);
                }

                File.WriteAllText(_cheminFichier, json);
            }
            catch (Exception)
            {
                throw;
            }
        }
    }
}

================================================================================
FILE: LoGeCuiShared\Services\ListeCoursesSupabaseService.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Supabase;

namespace LoGeCuiShared.Services
{
    public sealed class ListeCoursesSupabaseService
    {
        private readonly SupabaseRestClient _client;
        private const string Table = "articles_courses";

        public ListeCoursesSupabaseService(SupabaseRestClient client)
        {
            _client = client ?? throw new ArgumentNullException(nameof(client));
        }

        /// <summary>
        /// Ajoute √† la liste de courses les ingr√©dients manquants (sans doublons),
        /// en s'appuyant sur le trigger set_user_id_on_insert (donc on n'envoie pas user_id).
        /// </summary>
        public async Task AddMissingAsync(Guid userId, IEnumerable<string> missingNames)
        {
            var names = missingNames
                .Where(n => !string.IsNullOrWhiteSpace(n))
                .Select(n => n.Trim())
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .ToList();

            if (names.Count == 0)
                return;

            // 1) Lire ce qui existe d√©j√† pour cet utilisateur (non achet√©)
            // (On filtre par user_id car ta table l'a bien, et le token bearer doit donner acc√®s via RLS/trigger)
            var existingQuery =
                $"{Table}?select=nom&user_id=eq.{userId}&est_achete=eq.false";

            var existingRows = await _client.GetAsync<List<Row>>(existingQuery) ?? new List<Row>();

            var existing = existingRows
                .Where(r => !string.IsNullOrWhiteSpace(r.nom))
                .Select(r => r.nom!.Trim())
                .ToHashSet(StringComparer.OrdinalIgnoreCase);

            // 2) Garder uniquement ceux qui n'existent pas
            var toInsert = names
                .Where(n => !existing.Contains(n))
                .Select(n => new
                {
                    nom = n,
                    quantite = (string?)null,
                    unite = (string?)null,
                    est_achete = false
                    // user_id est mis par trigger set_user_id_on_insert
                })
                .ToArray();

            if (toInsert.Length == 0)
                return;

            // 3) Insert batch
            await _client.PostAsync<object>(
                Table,
                toInsert,
                returnRepresentation: false);
        }

        private sealed class Row
        {
            public string? nom { get; set; }
        }
    }
}

================================================================================
FILE: LoGeCuiShared\Services\RecetteIngredientsService.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Supabase;

namespace LoGeCuiShared.Services
{
    public sealed class RecetteIngredientsService
    {
        private readonly SupabaseRestClient _client;
        private const string Table = "recette_ingredients";

        public RecetteIngredientsService(SupabaseRestClient client)
        {
            _client = client ?? throw new ArgumentNullException(nameof(client));
        }

        // DTO conforme au sch√©ma DB
        private sealed class Row
        {
            public string? ingredient_nom { get; set; }
            public string? quantite { get; set; }
            public string? unite { get; set; }
        }

        public async Task<List<(string nom, string? quantite, string? unite)>> GetForRecetteAsync(Guid recetteId)
        {
            var q = $"{Table}?select=ingredient_nom,quantite,unite&recette_id=eq.{recetteId}&order=created_at.asc";
            var rows = await _client.GetAsync<List<Row>>(q) ?? new List<Row>();

            return rows
                .Where(r => !string.IsNullOrWhiteSpace(r.ingredient_nom))
                .Select(r => (r.ingredient_nom!.Trim(), r.quantite, r.unite))
                .ToList();
        }

        // Remplace la liste compl√®te (simple et robuste)
        public async Task ReplaceForRecetteAsync(Guid recetteId, IEnumerable<(string nom, string? quantite, string? unite)> items)
        {
            // 1) delete
            await _client.DeleteAsync($"{Table}?recette_id=eq.{recetteId}");

            // 2) insert
            var payload = items
                .Where(i => !string.IsNullOrWhiteSpace(i.nom))
                .Select(i => new
                {
                    recette_id = recetteId,
                    ingredient_nom = i.nom.Trim(),
                    quantite = string.IsNullOrWhiteSpace(i.quantite) ? null : i.quantite.Trim(),
                    unite = string.IsNullOrWhiteSpace(i.unite) ? null : i.unite.Trim()
                })
                .ToArray();

            if (payload.Length == 0)
                return;

            await _client.PostAsync<object>(Table, payload, returnRepresentation: false);
        }
    }
}

================================================================================
FILE: LoGeCuiShared\Services\RecipesService.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using LoGeCuiShared.Models;
using Supabase;

namespace LoGeCuiShared.Services
{
    public sealed class RecipesService
    {
        private readonly SupabaseRestClient _client;

        public RecipesService(SupabaseRestClient client)
        {
            _client = client ?? throw new ArgumentNullException(nameof(client));
        }

        /// <summary>
        /// R√©cup√®re TOUTES les recettes de l‚Äôutilisateur courant
        /// (utilis√© notamment pour le menu al√©atoire)
        /// </summary>
        public async Task<List<Recette>> GetRecettesAsync(Guid userId)
        {
            var q =
                "recettes?" +
                "select=id,created_at,owner_user_id,nom,categorie,temps_minutes,note,is_favorite,instructions" +
                $"&owner_user_id=eq.{userId}" +
                "&order=created_at.desc";

            return await _client.GetAsync<List<Recette>>(q)
                   ?? new List<Recette>();
        }

        /// <summary>
        /// R√©cup√®re les recettes (optionnellement filtr√©es par cat√©gorie)
        /// </summary>
        public async Task<List<Recette>> GetMyRecettesAsync(string? categorie = null)
        {
            var q =
                "recettes?" +
                "select=id,created_at,owner_user_id,nom,categorie,temps_minutes,note,is_favorite,instructions" +
                "&order=created_at.desc";

            if (!string.IsNullOrWhiteSpace(categorie) &&
                !string.Equals(categorie, "Toutes", StringComparison.OrdinalIgnoreCase))
            {
                q += $"&categorie=eq.{Uri.EscapeDataString(categorie)}";
            }

            return await _client.GetAsync<List<Recette>>(q)
                   ?? new List<Recette>();
        }

        /// <summary>
        /// Cr√©e une recette et retourne la recette cr√©√©e
        /// </summary>
        public async Task<Recette?> CreateRecetteAsync(Guid ownerUserId, Recette r)
        {
            if (r == null) throw new ArgumentNullException(nameof(r));

            var payload = new
            {
                owner_user_id = ownerUserId,
                nom = r.Nom,
                categorie = r.CategorieDb,
                temps_minutes = r.TempsMinutesDb,
                note = r.NoteDb,
                is_favorite = r.IsFavorite,
                instructions = r.InstructionsDb
            };

            var created = await _client.PostAsync<List<Recette>>(
                "recettes?select=id,created_at,owner_user_id,nom,categorie,temps_minutes,note,is_favorite,instructions",
                payload,
                returnRepresentation: true);

            return created?.FirstOrDefault();
        }

        /// <summary>
        /// Supprime une recette
        /// </summary>
        public async Task DeleteRecetteAsync(Guid recetteId)
        {
            await _client.DeleteAsync($"recettes?id=eq.{recetteId}");
        }

        /// <summary>
        /// Insert ou met √† jour une recette via external_id
        /// </summary>
        public async Task UpsertRecetteAsync(Guid ownerUserId, Recette r)
        {
            if (r == null) throw new ArgumentNullException(nameof(r));

            if (string.IsNullOrWhiteSpace(r.ExternalId))
                throw new ArgumentException("ExternalId est requis pour upsert.", nameof(r));

            var payload = new[]
            {
                new
                {
                    owner_user_id = ownerUserId,
                    external_id = r.ExternalId,
                    nom = r.Nom,
                    categorie = r.CategorieDb,
                    temps_minutes = r.TempsMinutesDb,
                    note = r.NoteDb,
                    is_favorite = r.IsFavorite,
                    instructions = r.InstructionsDb
                }
            };

            await _client.PostAsync<object>(
                "recettes?on_conflict=external_id",
                payload,
                returnRepresentation: false,
                mergeDuplicates: true);
        }
        public async Task<Guid?> GetRecetteIdByExternalIdAsync(string externalId)
        {
            if (string.IsNullOrWhiteSpace(externalId))
                throw new ArgumentException("externalId requis", nameof(externalId));

            var q =
                "recettes?" +
                "select=id" +
                $"&external_id=eq.{Uri.EscapeDataString(externalId)}" +
                "&limit=1";

            var rows = await _client.GetAsync<List<RecetteIdRow>>(q);

            return rows?.FirstOrDefault()?.id;
        }

        private sealed class RecetteIdRow
        {
            public Guid id { get; set; }
        }

    }
}


================================================================================
FILE: LoGeCuiShared\Services\SupabaseRestClient.cs
================================================================================

Ôªøusing System.Net.Http.Headers;
using System.Text;
using System.Text.Json;

namespace LoGeCuiShared.Services
{
    public sealed class SupabaseRestClient
    {
        private readonly HttpClient _http;
        private readonly string _baseRestUrl;

        public SupabaseRestClient(string supabaseUrl, string supabaseAnonKey)
        {
            if (string.IsNullOrWhiteSpace(supabaseUrl)) throw new ArgumentException("supabaseUrl is required");
            if (string.IsNullOrWhiteSpace(supabaseAnonKey)) throw new ArgumentException("supabaseAnonKey is required");

            _baseRestUrl = supabaseUrl.TrimEnd('/') + "/rest/v1/";

            _http = new HttpClient();
            _http.DefaultRequestHeaders.Add("apikey", supabaseAnonKey);
            _http.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));
        }

        public void SetBearerToken(string accessToken)
        {
            _http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);
        }

        public async Task<T?> GetAsync<T>(string pathAndQuery)
        {
            var url = _baseRestUrl + pathAndQuery;

            using var resp = await _http.GetAsync(url);
            var body = await resp.Content.ReadAsStringAsync();

            if (!resp.IsSuccessStatusCode)
                throw new Exception($"Supabase GET failed: {(int)resp.StatusCode} {resp.ReasonPhrase}\n{body}");

            return JsonSerializer.Deserialize<T>(body, JsonOptions());
        }

        public async Task<T?> PostAsync<T>(string pathAndQuery, object payload, bool returnRepresentation = false)
        {
            var url = _baseRestUrl + pathAndQuery;
            var json = JsonSerializer.Serialize(payload, JsonOptions());

            using var req = new HttpRequestMessage(HttpMethod.Post, url)
            {
                Content = new StringContent(json, Encoding.UTF8, "application/json")
            };

            if (returnRepresentation)
                req.Headers.Add("Prefer", "return=representation");

            using var resp = await _http.SendAsync(req);
            var body = await resp.Content.ReadAsStringAsync();

            if (!resp.IsSuccessStatusCode)
                throw new Exception($"Supabase POST failed: {(int)resp.StatusCode} {resp.ReasonPhrase}\n{body}");

            if (string.IsNullOrWhiteSpace(body))
                return default;

            return JsonSerializer.Deserialize<T>(body, JsonOptions());
        }

        public async Task PatchAsync(string pathAndQuery, object payload)
        {
            var url = _baseRestUrl + pathAndQuery;
            var json = JsonSerializer.Serialize(payload, JsonOptions());

            using var req = new HttpRequestMessage(new HttpMethod("PATCH"), url)
            {
                Content = new StringContent(json, Encoding.UTF8, "application/json")
            };

            using var resp = await _http.SendAsync(req);
            var body = await resp.Content.ReadAsStringAsync();

            if (!resp.IsSuccessStatusCode)
                throw new Exception($"Supabase PATCH failed: {(int)resp.StatusCode} {resp.ReasonPhrase}\n{body}");
        }

        public async Task DeleteAsync(string pathAndQuery)
        {
            var url = _baseRestUrl + pathAndQuery;

            using var resp = await _http.DeleteAsync(url);
            var body = await resp.Content.ReadAsStringAsync();

            if (!resp.IsSuccessStatusCode)
                throw new Exception($"Supabase DELETE failed: {(int)resp.StatusCode} {resp.ReasonPhrase}\n{body}");
        }

        private static JsonSerializerOptions JsonOptions() => new()
        {
            PropertyNameCaseInsensitive = true
        };

        public async Task<T?> PostAsync<T>(
        string pathAndQuery,
        object payload,
        bool returnRepresentation = false,
        bool mergeDuplicates = false)
        {
            var url = _baseRestUrl + pathAndQuery;
            var json = JsonSerializer.Serialize(payload, JsonOptions());

            using var req = new HttpRequestMessage(HttpMethod.Post, url)
            {
                Content = new StringContent(json, Encoding.UTF8, "application/json")
            };

            // PostgREST Prefer headers
            if (returnRepresentation)
                req.Headers.Add("Prefer", "return=representation");

            if (mergeDuplicates)
                req.Headers.Add("Prefer", "resolution=merge-duplicates");

            using var resp = await _http.SendAsync(req);
            var body = await resp.Content.ReadAsStringAsync();

            if (!resp.IsSuccessStatusCode)
                throw new Exception($"Supabase POST failed: {(int)resp.StatusCode} {resp.ReasonPhrase}\n{body}");

            if (string.IsNullOrWhiteSpace(body))
                return default;

            return JsonSerializer.Deserialize<T>(body, JsonOptions());
        }

    }
}


================================================================================
FILE: LoGeCuiShared\Services\SupabaseService.cs
================================================================================

Ôªøusing System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Text.Json;
using System.Threading.Tasks;
using LoGeCuiShared.Models;
using Supabase.Postgrest;
using Supabase.Postgrest.Attributes;
using Supabase.Postgrest.Models;
using System.Net.Http.Headers;


namespace LoGeCuiShared.Services
{
    public class SupabaseService
    {
        private readonly HttpClient _httpClient;
        private readonly string _supabaseUrl;
        private readonly string _supabaseKey;

        // Session courante (apr√®s login)
        private string? _accessToken;    // JWT utilisateur
        private string? _currentUserId;  // GUID string

        private readonly Client _client;

        public SupabaseService(string url, string key)
        {
            _supabaseUrl = url ?? throw new ArgumentNullException(nameof(url));
            _supabaseKey = key ?? throw new ArgumentNullException(nameof(key));

            _httpClient = new HttpClient { Timeout = TimeSpan.FromSeconds(30) };

            var options = new ClientOptions
            {
                Headers = new Dictionary<string, string>
                {
                    { "apikey", key },
                    // Tant qu'on n'est pas connect√©, on reste en "anon"
                    { "Authorization", $"Bearer {key}" }
                }
            };

            _client = new Client($"{url}/rest/v1", options);
        }

        // =========================
        // SESSION
        // =========================

        public void SetSession(string accessToken, string userId)
        {
            if (string.IsNullOrWhiteSpace(accessToken))
                throw new ArgumentException("accessToken manquant", nameof(accessToken));

            if (string.IsNullOrWhiteSpace(userId))
                throw new ArgumentException("userId manquant", nameof(userId));

            _accessToken = accessToken;
            _currentUserId = userId;

            // IMPORTANT: PostgREST doit utiliser le JWT utilisateur pour RLS
            _client.Options.Headers["Authorization"] = $"Bearer {_accessToken}";
        }

        public void ClearSession()
        {
            _accessToken = null;
            _currentUserId = null;

            // Retour "anon"
            _client.Options.Headers["Authorization"] = $"Bearer {_supabaseKey}";
        }

        public string? GetCurrentUserId() => _currentUserId;

        private Guid RequireCurrentUserGuid()
        {
            if (string.IsNullOrWhiteSpace(_currentUserId))
                throw new InvalidOperationException("Utilisateur non connect√©. Veuillez vous reconnecter.");

            if (!Guid.TryParse(_currentUserId, out var guid))
                throw new InvalidOperationException("Identifiant utilisateur invalide. Veuillez vous reconnecter.");

            return guid;
        }

        private void RequireAccessToken()
        {
            if (string.IsNullOrWhiteSpace(_accessToken))
                throw new InvalidOperationException("Session invalide. Veuillez vous reconnecter.");
        }

        // =========================
        // AUTH REST
        // =========================

        public async Task<(bool success, string? userId, string? error)> SignUpAsync(string email, string password)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(email) || !email.Contains("@"))
                    return (false, null, "Adresse email invalide");

                if (string.IsNullOrWhiteSpace(password) || password.Length < 6)
                    return (false, null, "Le mot de passe doit contenir au moins 6 caract√®res");

                var request = new { email = email.Trim(), password };

                _httpClient.DefaultRequestHeaders.Clear();
                _httpClient.DefaultRequestHeaders.Add("apikey", _supabaseKey);
                _httpClient.DefaultRequestHeaders.Authorization =
                    new AuthenticationHeaderValue("Bearer", _supabaseKey);

                var response = await _httpClient.PostAsJsonAsync($"{_supabaseUrl}/auth/v1/signup", request);
                var content = await response.Content.ReadAsStringAsync();

                if (!response.IsSuccessStatusCode)
                    return (false, null, ExtractSupabaseError(content, response.StatusCode));

                // Supabase renvoie souvent { user: { id: ... } }, parfois { id: ... }
                try
                {
                    var json = JsonDocument.Parse(content);

                    if (json.RootElement.TryGetProperty("user", out var userEl) &&
                        userEl.TryGetProperty("id", out var uidEl))
                    {
                        var uid = uidEl.GetString();
                        if (!string.IsNullOrWhiteSpace(uid))
                            return (true, uid, null);
                    }

                    if (json.RootElement.TryGetProperty("id", out var idEl))
                    {
                        var uid = idEl.GetString();
                        if (!string.IsNullOrWhiteSpace(uid))
                            return (true, uid, null);
                    }

                    return (true, "unknown", null);
                }
                catch
                {
                    return (true, "unknown", null);
                }
            }
            catch (HttpRequestException)
            {
                return (false, null, "Erreur de connexion au serveur. V√©rifiez votre connexion internet.");
            }
            catch (TaskCanceledException)
            {
                return (false, null, "La requ√™te a expir√©. V√©rifiez votre connexion internet.");
            }
            catch (Exception ex)
            {
                return (false, null, $"Erreur inattendue : {ex.Message}");
            }
        }

        public async Task<(bool success, string? accessToken, string? userId, string? error)> SignInAsync(string email, string password)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(email) || !email.Contains("@"))
                    return (false, null, null, "Adresse email invalide");

                if (string.IsNullOrWhiteSpace(password))
                    return (false, null, null, "Le mot de passe est requis");

                var request = new { email = email.Trim(), password };

                _httpClient.DefaultRequestHeaders.Clear();
                _httpClient.DefaultRequestHeaders.Add("apikey", _supabaseKey);

                var response = await _httpClient.PostAsJsonAsync(
                    $"{_supabaseUrl}/auth/v1/token?grant_type=password",
                    request);

                var content = await response.Content.ReadAsStringAsync();

                if (!response.IsSuccessStatusCode)
                    return (false, null, null, ExtractSupabaseError(content, response.StatusCode));

                var json = JsonDocument.Parse(content);

                var token = json.RootElement.GetProperty("access_token").GetString();
                var userId = json.RootElement.GetProperty("user").GetProperty("id").GetString();

                if (string.IsNullOrWhiteSpace(token) || string.IsNullOrWhiteSpace(userId))
                    return (false, null, null, "R√©ponse Supabase invalide (token/userId manquant).");

                SetSession(token, userId);
                return (true, token, userId, null);
            }
            catch (HttpRequestException)
            {
                return (false, null, null, "Erreur de connexion au serveur. V√©rifiez votre connexion internet.");
            }
            catch (TaskCanceledException)
            {
                return (false, null, null, "La requ√™te a expir√©. V√©rifiez votre connexion internet.");
            }
            catch (Exception ex)
            {
                return (false, null, null, $"Erreur inattendue : {ex.Message}");
            }
        }

        public async Task<(bool success, string? accessToken, string? userId, string? error)>
            SignUpThenSignInAsync(string email, string password)
        {
            var (signUpSuccess, _, signUpError) = await SignUpAsync(email, password);
            if (!signUpSuccess)
                return (false, null, null, signUpError);

            var (signInSuccess, accessToken, userId, signInError) = await SignInAsync(email, password);
            if (!signInSuccess)
                return (false, null, null, signInError);

            return (true, accessToken, userId, null);
        }

        public async Task<(bool success, string? error)> SendPasswordResetAsync(string email)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(email) || !email.Contains("@"))
                    return (false, "Adresse email invalide");

                _httpClient.DefaultRequestHeaders.Clear();
                _httpClient.DefaultRequestHeaders.Add("apikey", _supabaseKey);

                var request = new
                {
                    email = email.Trim(),
                    redirect_to = "https://logecui.fr/logecui-reset-password/index.html"
                };

                var response = await _httpClient.PostAsJsonAsync($"{_supabaseUrl}/auth/v1/recover", request);
                var content = await response.Content.ReadAsStringAsync();

                return response.IsSuccessStatusCode
                    ? (true, null)
                    : (false, ExtractSupabaseError(content, response.StatusCode));
            }
            catch
            {
                return (false, "Erreur r√©seau. R√©essayez plus tard.");
            }
        }

        public async Task<(bool success, string? error)> UpdatePasswordAsync(string accessToken, string newPassword)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(newPassword) || newPassword.Length < 6)
                    return (false, "Le mot de passe doit contenir au moins 6 caract√®res.");

                _httpClient.DefaultRequestHeaders.Clear();
                _httpClient.DefaultRequestHeaders.Add("apikey", _supabaseKey);
                _httpClient.DefaultRequestHeaders.Add("Authorization", $"Bearer {accessToken}");

                var response = await _httpClient.PutAsJsonAsync(
                    $"{_supabaseUrl}/auth/v1/user",
                    new { password = newPassword });

                var content = await response.Content.ReadAsStringAsync();

                return response.IsSuccessStatusCode
                    ? (true, null)
                    : (false, ExtractSupabaseError(content, response.StatusCode));
            }
            catch
            {
                return (false, "Erreur r√©seau.");
            }
        }

        // =========================
        // EDGE FUNCTION : DELETE ACCOUNT
        // =========================

        public async Task<(bool success, string? error)> DeleteAccountAsync()
        {
            try
            {
                RequireAccessToken();

                System.Diagnostics.Debug.WriteLine("=== DELETE ACCOUNT DEBUG ===");
                System.Diagnostics.Debug.WriteLine($"Token: {_accessToken?.Substring(0, 30)}");

                // ‚úÖ IMPORTANT : Cr√©er une nouvelle requ√™te √† chaque fois
                using var request = new HttpRequestMessage(HttpMethod.Post,
                    $"{_supabaseUrl}/functions/v1/delete-account");

                // ‚úÖ Ajouter les headers dans le bon ordre
                request.Headers.TryAddWithoutValidation("apikey", _supabaseKey);
                request.Headers.TryAddWithoutValidation("Authorization", $"Bearer {_accessToken}");

                System.Diagnostics.Debug.WriteLine($"Headers added: {request.Headers.Count()}");

                var response = await _httpClient.SendAsync(request);
                var content = await response.Content.ReadAsStringAsync();

                System.Diagnostics.Debug.WriteLine($"Response: {(int)response.StatusCode} - {content}");

                if (!response.IsSuccessStatusCode)
                {
                    return (false, $"Erreur : {content}");
                }

                // Nettoyage local
                var userGuid = RequireCurrentUserGuid();
                await _client.Table<ArticleCourseDb>()
                    .Filter("user_id", Supabase.Postgrest.Constants.Operator.Equals, userGuid.ToString())
                    .Delete();

                await _client.Table<IngredientDb>()
                    .Filter("user_id", Supabase.Postgrest.Constants.Operator.Equals, userGuid.ToString())
                    .Delete();

                ClearSession();
                return (true, null);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Exception: {ex.Message}");
                return (false, $"Erreur : {ex.Message}");
            }
        }



        // =========================
        // ARTICLES (Liste de courses)
        // =========================

        public async Task<List<ArticleCourse>> GetArticlesAsync()
        {
            var userGuid = RequireCurrentUserGuid();

            var response = await _client
                .Table<ArticleCourseDb>()
                .Filter("user_id", Supabase.Postgrest.Constants.Operator.Equals, userGuid.ToString())
                .Get();

            return response.Models.Select(db => new ArticleCourse
            {
                Id = db.Id,
                Nom = db.Nom ?? "",
                Quantite = db.Quantite ?? "",
                Unite = db.Unite ?? "",
                EstAchete = db.EstAchete,
                // IMPORTANT: si ton mod√®le ArticleCourse.UserId est Guid (non nullable),
                // on prot√®ge avec ?? Guid.Empty
                UserId = db.UserId ?? Guid.Empty
            }).ToList();
        }

        public async Task<ArticleCourse?> AddArticleAsync(ArticleCourse article)
        {
            var userGuid = RequireCurrentUserGuid();

            var dbArticle = new ArticleCourseDb
            {
                Nom = article.Nom,
                Quantite = article.Quantite,
                Unite = article.Unite,
                EstAchete = article.EstAchete,
                UserId = (Guid?)userGuid // ‚úÖ Guid -> Guid?
            };

            var response = await _client.Table<ArticleCourseDb>().Insert(dbArticle);
            var inserted = response.Models.FirstOrDefault();
            if (inserted == null) return null;

            return new ArticleCourse
            {
                Id = inserted.Id,
                Nom = inserted.Nom ?? "",
                Quantite = inserted.Quantite ?? "",
                Unite = inserted.Unite ?? "",
                EstAchete = inserted.EstAchete,
                UserId = inserted.UserId ?? Guid.Empty
            };
        }

        public async Task<bool> UpdateArticleAsync(int id, ArticleCourse article)
        {
            var userGuid = RequireCurrentUserGuid();

            var dbArticle = new ArticleCourseDb
            {
                Id = id,
                Nom = article.Nom,
                Quantite = article.Quantite,
                Unite = article.Unite,
                EstAchete = article.EstAchete,
                UserId = (Guid?)userGuid // ‚úÖ Guid -> Guid?
            };

            await _client.Table<ArticleCourseDb>().Update(dbArticle);
            return true;
        }

        public async Task<bool> DeleteArticleAsync(int id)
        {
            var userGuid = RequireCurrentUserGuid();

            // S√©curise par user_id (sinon RLS peut bloquer ou pire, toucher autre chose si policy permissive)
            await _client.Table<ArticleCourseDb>()
                .Filter("user_id", Supabase.Postgrest.Constants.Operator.Equals, userGuid.ToString())
                .Filter("id", Supabase.Postgrest.Constants.Operator.Equals, id)
                .Delete();

            return true;
        }

        public async Task<bool> DeleteAchetesAsync()
        {
            var userGuid = RequireCurrentUserGuid();

            await _client.Table<ArticleCourseDb>()
                .Filter("user_id", Supabase.Postgrest.Constants.Operator.Equals, userGuid.ToString())
                .Filter("est_achete", Supabase.Postgrest.Constants.Operator.Equals, true)
                .Delete();

            return true;
        }

        // =========================
        // INGREDIENTS
        // =========================

        public async Task<List<Ingredient>> GetIngredientsAsync()
        {
            var userGuid = RequireCurrentUserGuid();

            var response = await _client
                .Table<IngredientDb>()
                .Filter("user_id", Supabase.Postgrest.Constants.Operator.Equals, userGuid.ToString())
                .Get();

            return response.Models.Select(db => new Ingredient
            {
                Id = db.Id,
                // Si Ingredient.UserId est Guid (non nullable), on prot√®ge :
                UserId = db.UserId ?? Guid.Empty,
                Nom = db.Nom ?? "",
                Quantite = db.Quantite ?? "",
                Unite = db.Unite ?? "",
                EstDisponible = db.EstDisponible
            }).ToList();
        }

        public async Task<Ingredient?> AddIngredientAsync(Ingredient ingredient)
        {
            var userGuid = RequireCurrentUserGuid();

            var db = new IngredientDb
            {
                Nom = ingredient.Nom,
                Quantite = ingredient.Quantite,
                Unite = ingredient.Unite,
                EstDisponible = ingredient.EstDisponible,
                UserId = (Guid?)userGuid // ‚úÖ Guid -> Guid?
            };

            var response = await _client.Table<IngredientDb>().Insert(db);
            var inserted = response.Models.FirstOrDefault();
            if (inserted == null) return null;

            return new Ingredient
            {
                Id = inserted.Id,
                UserId = inserted.UserId ?? Guid.Empty,
                Nom = inserted.Nom ?? "",
                Quantite = inserted.Quantite ?? "",
                Unite = inserted.Unite ?? "",
                EstDisponible = inserted.EstDisponible
            };
        }

        public async Task<bool> UpdateIngredientAsync(Ingredient ingredient)
        {
            var userGuid = RequireCurrentUserGuid();

            if (ingredient.Id == Guid.Empty)
                throw new InvalidOperationException("Id ingr√©dient manquant.");

            var db = new IngredientDb
            {
                Id = ingredient.Id,
                Nom = ingredient.Nom,
                Quantite = ingredient.Quantite,
                Unite = ingredient.Unite,
                EstDisponible = ingredient.EstDisponible,
                UserId = (Guid?)userGuid // ‚úÖ Guid -> Guid?
            };

            await _client.Table<IngredientDb>().Update(db);
            return true;
        }

        public async Task<bool> DeleteIngredientAsync(Guid id)
        {
            var userGuid = RequireCurrentUserGuid();

            if (id == Guid.Empty)
                throw new InvalidOperationException("Id ingr√©dient manquant.");

            await _client.Table<IngredientDb>()
                .Filter("user_id", Supabase.Postgrest.Constants.Operator.Equals, userGuid.ToString())
                .Filter("id", Supabase.Postgrest.Constants.Operator.Equals, id.ToString())
                .Delete();

            return true;
        }

        // =========================
        // UTIL
        // =========================

        private static string ExtractSupabaseError(string content, System.Net.HttpStatusCode code)
        {
            if (!string.IsNullOrWhiteSpace(content))
            {
                try
                {
                    var json = JsonDocument.Parse(content);

                    if (json.RootElement.TryGetProperty("msg", out var msg)) return msg.GetString() ?? $"Erreur {code}";
                    if (json.RootElement.TryGetProperty("error_description", out var ed)) return ed.GetString() ?? $"Erreur {code}";
                    if (json.RootElement.TryGetProperty("message", out var m)) return m.GetString() ?? $"Erreur {code}";
                    if (json.RootElement.TryGetProperty("error", out var e)) return e.GetString() ?? $"Erreur {code}";
                }
                catch
                {
                    if (content.Length < 400) return content;
                }
            }

            return $"Erreur {code}";
        }
    }

    // =========================
    // MODELES DB
    // =========================

    [Table("articles_courses")]
    public class ArticleCourseDb : BaseModel
    {
        [PrimaryKey("id", false)]
        public int Id { get; set; }

        [Column("nom")]
        public string? Nom { get; set; }

        [Column("quantite")]
        public string? Quantite { get; set; }

        [Column("unite")]
        public string? Unite { get; set; }

        [Column("est_achete")]
        public bool EstAchete { get; set; }

        [Column("user_id")]
        public Guid? UserId { get; set; } // DB nullable -> mapping prot√®ge avec ?? Guid.Empty
    }

    [Table("ingredients")]
    public class IngredientDb : BaseModel
    {
        [PrimaryKey("id", false)]
        public Guid Id { get; set; }

        [Column("nom")]
        public string? Nom { get; set; }

        [Column("quantite")]
        public string? Quantite { get; set; }

        [Column("unite")]
        public string? Unite { get; set; }

        [Column("est_disponible")]
        public bool EstDisponible { get; set; }

        [Column("user_id")]
        public Guid? UserId { get; set; } // DB nullable -> mapping prot√®ge avec ?? Guid.Empty
    }
}



================================================================================
FILE: supabase\functions\delete-account\Supabase.json
================================================================================

{
  "verify_jwt": false
}
