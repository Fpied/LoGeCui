<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="LoGeCuiMobile.Pages.MesRecettesPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:tr="clr-namespace:LoGeCuiMobile.Resources.Lang"
    xmlns:vm="clr-namespace:LoGeCuiMobile.ViewModels"
    Title="{tr:Translate Recipes_Title}">

    <Grid Padding="12" RowDefinitions="Auto,Auto,*" RowSpacing="10">

        <!-- ====== FILTRES + ACTIONS HAUT ====== -->
        <VerticalStackLayout Grid.Row="0" Spacing="10">

            <Picker Title="{tr:Translate Recipes_Category}"
                    ItemsSource="{Binding Categories}"
                    SelectedItem="{Binding SelectedCategorie}" />

            <HorizontalStackLayout Spacing="10">
                <Button Text="{tr:Translate Recipes_Refresh}"
                        Command="{Binding RefreshCommand}"
                        HorizontalOptions="StartAndExpand" />

                <Button Text="{tr:Translate Recipes_Add}"
                        Clicked="OnAjouterRecetteClicked"
                        HorizontalOptions="EndAndExpand" />
            </HorizontalStackLayout>

            <ActivityIndicator IsRunning="{Binding IsBusy}"
                               IsVisible="{Binding IsBusy}" />

        </VerticalStackLayout>

        <!-- ====== LIGNE SÃ‰LECTION MULTIPLE ====== -->
        <Grid Grid.Row="1" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10" VerticalOptions="Center">

            <HorizontalStackLayout Grid.Column="0" Spacing="8" VerticalOptions="Center">
                <CheckBox x:Name="ChkToutSelectionnerRecettes"
                          CheckedChanged="ChkToutSelectionnerRecettes_CheckedChanged"/>
                <Label Text="Tout sÃ©lectionner"
                       VerticalTextAlignment="Center"
                       TextColor="Gray"/>
            </HorizontalStackLayout>

            <Label Grid.Column="1"
                   x:Name="SelectionInfoLabel"
                   Text=""
                   TextColor="Gray"
                   VerticalTextAlignment="Center"/>

            <Button Grid.Column="2"
                    x:Name="BtnSupprimerSelection"
                    Text="Supprimer sÃ©lection"
                    BackgroundColor="#E67E22"
                    TextColor="White"
                    Clicked="BtnSupprimerSelection_Clicked"/>
        </Grid>

        <!-- ====== LISTE DES RECETTES ====== -->
        <CollectionView Grid.Row="2"
                        x:Name="RecettesCollection"
                        ItemsSource="{Binding Recettes}"
                        SelectionMode="None">

            <CollectionView.EmptyView>
                <Label Text="{tr:Translate Recipes_Empty}"
                       HorizontalTextAlignment="Center"
                       VerticalTextAlignment="Center"
                       Margin="0,30,0,0" />
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Frame Padding="10"
                           Margin="0,6"
                           HasShadow="False">

                        <!-- ðŸ”´ðŸŸ¢ Couleur bordure selon disponibilitÃ© -->
                        <Frame.Triggers>
                            <DataTrigger TargetType="Frame"
                                         Binding="{Binding AvailabilityState}"
                                         Value="{x:Static vm:AvailabilityState.Unknown}">
                                <Setter Property="BorderColor" Value="#B0B0B0"/>
                            </DataTrigger>

                            <DataTrigger TargetType="Frame"
                                         Binding="{Binding AvailabilityState}"
                                         Value="{x:Static vm:AvailabilityState.AllAvailable}">
                                <Setter Property="BorderColor" Value="#27AE60"/>
                            </DataTrigger>

                            <DataTrigger TargetType="Frame"
                                         Binding="{Binding AvailabilityState}"
                                         Value="{x:Static vm:AvailabilityState.Missing}">
                                <Setter Property="BorderColor" Value="#E74C3C"/>
                            </DataTrigger>
                        </Frame.Triggers>

                        <!-- âœ… Ajout d'une colonne pour la photo -->
                        <Grid ColumnDefinitions="Auto,Auto,*,Auto"
                              RowDefinitions="Auto,Auto"
                              ColumnSpacing="10">

                            <!-- Checkbox suppression multiple -->
                            <CheckBox Grid.Column="0"
                                      Grid.RowSpan="2"
                                      IsChecked="{Binding IsSelectedForDelete}"
                                      CheckedChanged="RecetteDeleteCheckBox_CheckedChanged"
                                      VerticalOptions="Center" />

                            <!-- âœ… Photo miniature -->
                            <Frame Grid.Column="1"
                                       Grid.RowSpan="2"
                                       WidthRequest="44"
                                       HeightRequest="44"
                                       CornerRadius="22"
                                       Padding="0"
                                       HasShadow="False"
                                       IsClippedToBounds="True"
                                       BorderColor="#DDDDDD"
                                       BackgroundColor="#F2F2F2"
                                       VerticalOptions="Center"
                                       IsVisible="{Binding HasPhoto}">
                                                                <Image Source="{Binding PhotoSource}"
                                           WidthRequest="44"
                                           HeightRequest="44"
                                           Aspect="AspectFill" />
                            </Frame>

                            <!-- Zone infos recette (tap = dÃ©tails) -->
                            <Grid Grid.Column="2" Grid.RowSpan="2">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnRecetteTapped"
                                                          CommandParameter="{Binding Model}" />
                                </Grid.GestureRecognizers>

                                <VerticalStackLayout Spacing="4">

                                    <Label Text="{Binding Nom}"
                                           FontSize="18"
                                           FontAttributes="Bold" />

                                    <Label Text="{Binding TypeTexte}" />

                                    <Label Text="{Binding TempsPreparation, StringFormat='{tr:Translate Recipes_TimeFormat}'}" />

                                    <Label Text="{Binding DifficulteTexte}" />

                                    <Label Text="{Binding AvailabilityLabel}"
                                           FontSize="12"
                                           TextColor="Gray"/>

                                </VerticalStackLayout>
                            </Grid>

                            <!-- Boutons actions -->
                            <HorizontalStackLayout Grid.Column="3" Grid.RowSpan="2"
                                                   Spacing="8"
                                                   VerticalOptions="Center">

                                <Button Text="ðŸ›’"
                                        BackgroundColor="#3498DB"
                                        TextColor="White"
                                        Padding="8"
                                        Clicked="BtnAjouterManquants_Clicked"
                                        CommandParameter="{Binding .}"/>

                                <Button Text="ðŸ—‘"
                                        BackgroundColor="#e74c3c"
                                        TextColor="White"
                                        Padding="8"
                                        Clicked="BtnSupprimerRecette_Clicked"
                                        CommandParameter="{Binding .}"/>

                                <Button Text="âœï¸"
                                        BackgroundColor="#F1C40F"
                                        TextColor="Black"
                                        Padding="8"
                                        Clicked="BtnModifierRecette_Clicked"
                                        CommandParameter="{Binding Model}"/>

                            </HorizontalStackLayout>

                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>

        </CollectionView>

    </Grid>
</ContentPage>
